<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMS Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --gradient-secondary: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f43f5e 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-dark: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --gradient-glass: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.6) 100%);
            --gradient-glass-dark: linear-gradient(145deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.6) 100%);
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f1f5f9;
            /* Slate 100 */
            overflow-x: hidden;
        }

        .dark body {
            background-color: #020617;
            /* Slate 950 */
            color: #f8fafc;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .dark .glass-strong {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Print container hidden by default */
        #print-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            visibility: hidden;
        }

        /* Print Styles for PDF */
        /* Legacy Print Styles Removed to fix conflict */

        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(0.98);
            }
        }

        .animate-pulse-soft {
            animation: pulse-soft 2s infinite ease-in-out;
        }

        .hover-lift {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:active {
            transform: scale(0.98);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @media print {
            @page {
                margin: 0.5cm;
                size: A4 portrait;
            }

            body {
                visibility: hidden;
                background: white;
            }

            #payslip-container {
                visibility: visible;
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
                background: white;
                z-index: 9999;
            }

            #payslip-container * {
                visibility: visible;
            }

            #print-area {
                padding: 1rem !important;
                margin: 0 auto !important;
            }

            .no-print {
                display: none !important;
            }

            /* Ensure dark mode colors don't mess up print */
            .dark #payslip-container {
                background: white;
                color: black;
                border: none;
            }

            .dark #payslip-container * {
                color: black !important;
                border-color: #e2e8f0 !important;
            }
        }
    </style>
</head>

<body
    class="text-slate-800 dark:text-slate-200 antialiased min-h-screen transition-colors duration-300 bg-slate-50 dark:bg-slate-900">

    <div id="app" class="min-h-screen flex flex-col relative">
        <div id="loading-screen"
            class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center transition-opacity duration-500">
            <div class="flex flex-col items-center gap-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
                <p class="text-white text-sm font-medium animate-pulse">Connecting Admin Portal...</p>
            </div>
        </div>
    </div>

    <!-- Failsafe: Force remove loading screen after 3s no matter what -->
    <script>
        setTimeout(() => {
            const ls = document.getElementById('loading-screen');
            if (ls && ls.style.display !== 'none') {
                console.warn("Forcing loading screen removal via failsafe");
                ls.style.display = 'none';
                if (!document.getElementById('login-id')) { // If login form not rendered yet
                    // Try to manually trigger render if main script failed
                    if (window.render) window.render();
                    else document.getElementById('app').innerHTML = `<div class="p-8 text-center text-red-500">App failed to load. Please refresh.</div>`;
                }
            }
        }, 3000);
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { deleteField, getFirestore, collection, addDoc, getDocs, updateDoc, setDoc, deleteDoc, doc, onSnapshot, query, where, orderBy, serverTimestamp, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD1YRKvTHkK0QNMEdxfWbNCrKSWRzVOxdg",
            authDomain: "ams-service-f923f.firebaseapp.com",
            projectId: "ams-service-f923f",
            storageBucket: "ams-service-f923f.firebasestorage.app",
            messagingSenderId: "31368661696",
            appId: "1:31368661696:web:61b78217d78ed9cec8fb25",
            measurementId: "G-C0JVW9GMZJ"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ams-towing-v1';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const DRIVER_IDS = ['4455', '5566', '6677'];
        const ACCESS_CODES = {
            '2233': { role: 'superadmin', branch: 'All', name: 'Super Admin' },
            '3344': { role: 'admin', branch: 'Coimbatore', name: 'Coimbatore Admin' },
            '4455': { role: 'admin', branch: 'Trichy', name: 'Trichy Admin' },
            '5566': { role: 'admin', branch: 'Salem', name: 'Salem Admin' },
            '6677': { role: 'admin', branch: 'Kumbakonam', name: 'Kumbakonam Admin' }
        };

        const SOURCE_DRIVERS = {
            '6380664123': { name: 'Nandha Kumar', phone: '6380664123', id: '6380664123' },
            '8973475204': { name: 'Vignesh Kumar', phone: '8973475204', id: '8973475204' },
            '9080180377': { name: 'Madhan', phone: '9080180377', id: '9080180377' },
            '9751204576': { name: 'Dinesh', phone: '9751204576', id: '9751204576' },
            '9042160596': { name: 'Nasarjun', phone: '9042160596', id: '9042160596' }
        };
        const SOURCE_VEHICLES = ['TN 38 DJ 6740', 'TN 38 DM 4315', 'TN 38 DR 1843'];
        const SOURCE_LOCATIONS = ['Coimbatore', 'Tiruppur', 'Erode', 'Ooty', 'Pollachi'];
        const SOURCE_MODELS = ['Innova Crysta', 'Innova Hycross', 'Fortuner', 'Legender', 'Glanza', 'Urban Cruiser Hyryder', 'Rumion', 'Taisor', 'Camry', 'Vellfire', 'Hilux', 'Etios', 'Corolla Altis', 'Yaris', 'Urban Cruiser', 'Land Cruiser 300'];
        const CATEGORIES = { NEW: ['TVS', 'INT', 'FREE'], BREAKDOWN: ['TVS', 'Service', 'Direct'], EMPTY: [] };

        window.state = {
            user: null,
            view: 'login',
            adminTab: 'ops',
            trips: [],
            drivers: [],
            vehicles: [],
            models: [],
            locations: [],
            fuelLogs: [],
            maintenanceLogs: [],
            policeFines: [],
            tollLogs: [],
            vehicleDetail: null,
            vehReportTab: 'fuel',
            attendance: {},
            monthlyAttendance: [],
            payroll: {},
            leaveRequests: [],
            shiftRequests: [], // New for Shift Approvals
            reportDate: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 10),
            reportFilter: 'All',
            trashTrips: [],
            perfTab: 'drivers',
            editDriver: null,
            editVehicle: null,
            editVehicle: null,
            attendanceDate: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0],
            modal: null,
            searchQuery: '',
            typingQuery: '',
            billingFilters: { search: '', dateStart: '', dateEnd: '', status: ['All'], vehicle: '', driverName: '', type: ['New', 'Break Down'], class: ['All'], pickup: '', drop: '', netMin: '', netMax: '', invMin: '', invMax: '' },
            selectedAllowanceDriver: null,
            selectedAllowanceMonth: null,
            allowanceEntries: [],
            selectedSalaryDriver: null,
            selectedSalaryMonth: null,
            salaryEntries: [],
            darkMode: localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
        };

        const state = window.state;
        const appDiv = document.getElementById('app');
        const loadingScreen = document.getElementById('loading-screen');

        // Initialize Theme
        if (state.darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');

        window.toggleTheme = () => {
            state.darkMode = !state.darkMode;
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
            render();
        };

        const initAuth = async () => {
            // Failsafe: Remove loading screen quickly if Auth hangs
            setTimeout(() => {
                const ls = document.getElementById('loading-screen');
                if (ls && ls.style.display !== 'none' && !state.user) {
                    ls.style.opacity = '0';
                    setTimeout(() => { ls.style.display = 'none'; render(); }, 300);
                }
            }, 1500);

            try {
                let signedIn = false;
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        signedIn = true;
                    } catch (e) {
                        console.warn("Custom token mismatch, falling back to anonymous auth");
                    }
                }

                if (!signedIn) {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Failed", error);
                // Still allow entry to login screen on error
                loadingScreen.style.display = 'none';
                render();
            }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
                if (!state.user) render();
            }
        });

        let unsubscribers = [];

        const setupListeners = () => {
            const today = new Date().toISOString().split('T')[0];

            const qAtt = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'), where('date', '==', today));
            unsubscribers.push(onSnapshot(qAtt, (s) => {
                const map = {}; s.docs.forEach(d => { const data = d.data(); const id = data.driverId || data.driverPhone; if (id) map[id] = data.status; });
                state.attendance = map; render();
            }));

            const qTrips = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trips'));
            unsubscribers.push(onSnapshot(qTrips, { includeMetadataChanges: true }, (s) => {
                // Skip render for local optimistic updates to prevent double-refresh (flash)
                // We wait for the server timestamp/ack
                if (s.metadata.hasPendingWrites) return;

                const all = s.docs.map(d => ({ id: d.id, ...d.data() }));
                all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.trips = all; render();
            }));

            const qAllAtt = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'));
            unsubscribers.push(onSnapshot(qAllAtt, (s) => { state.monthlyAttendance = s.docs.map(d => d.data()); render(); }));

            const qLeave = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_leave_requests'));
            unsubscribers.push(onSnapshot(qLeave, (s) => {
                const all = s.docs.map(d => ({ id: d.id, ...d.data() }));
                all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.leaveRequests = all; render();
            }));

            // Shift Requests Listener
            const qShiftReq = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_shift_requests'));
            unsubscribers.push(onSnapshot(qShiftReq, (s) => {
                const all = s.docs.map(d => ({ id: d.id, ...d.data() }));
                // Sort pending first, then by date desc
                all.sort((a, b) => {
                    if (a.status === 'pending' && b.status !== 'pending') return -1;
                    if (a.status !== 'pending' && b.status === 'pending') return 1;
                    return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                });
                state.shiftRequests = all;
                render();
            }));

            const qDrivers = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_drivers'));
            unsubscribers.push(onSnapshot(qDrivers, (s) => {
                state.drivers = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));

            const qVehicles = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles'));
            unsubscribers.push(onSnapshot(qVehicles, (s) => {
                state.vehicles = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));

            const qLocations = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_locations'));
            unsubscribers.push(onSnapshot(qLocations, (s) => {
                state.locations = s.docs.map(d => ({ id: d.id, ...d.data() }));
                state.locations = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));

            const qModels = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_vehicle_models'));
            unsubscribers.push(onSnapshot(qModels, (s) => {
                state.models = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));

            const qFuel = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_fuel_logs'));
            unsubscribers.push(onSnapshot(qFuel, (s) => {
                const all = s.docs.map(d => ({ id: d.id, ...d.data() }));
                all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.fuelLogs = all;
                render();
            }));

            const qMaint = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_maintenance_logs'));
            unsubscribers.push(onSnapshot(qMaint, (s) => {
                const driversMap = {};
                state.drivers.forEach(d => driversMap[d.id] = d.name);

                const all = s.docs.map(d => {
                    const data = d.data();
                    return {
                        id: d.id,
                        ...data,
                        driverName: data.driverName || driversMap[data.driverId] || 'Unknown'
                    };
                });
                all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.maintenanceLogs = all;
                render();
            }));

            const qPolice = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_police_fines'));
            unsubscribers.push(onSnapshot(qPolice, (s) => {
                const driversMap = {};
                state.drivers.forEach(d => driversMap[d.id] = d.name);

                const all = s.docs.map(d => {
                    const data = d.data();
                    return {
                        id: d.id,
                        ...data,
                        driverName: data.driverName || driversMap[data.driverId] || 'Unknown'
                    };
                });
                all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.policeFines = all;
                render();
            }));

            const qToll = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_toll_logs'));

            // Payroll Listener
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'ams_payroll'), (s) => {
                const pMap = {};
                s.docs.forEach(d => { pMap[d.id] = d.data(); });
                state.payroll = pMap;
                render();
            }));
            unsubscribers.push(onSnapshot(qToll, (s) => {
                const driversMap = {};
                state.drivers.forEach(d => driversMap[d.id] = d.name);

                const all = s.docs.map(d => {
                    const data = d.data();
                    return {
                        id: d.id,
                        ...data,
                        driverName: data.driverName || driversMap[data.driverId] || 'Unknown'
                    };
                });
                all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.tollLogs = all;
                render();
            }));

            // Trash Bin Listener
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trash'), (s) => {
                state.trashTrips = s.docs.map(d => ({ trashDocId: d.id, ...d.data() }));
                render();
            }));
        };

        const formatTimeAMPM = (ts) => {
            if (!ts) return '-';
            const date = ts.toDate ? ts.toDate() : (ts.seconds ? new Date(ts.seconds * 1000) : new Date(ts));
            let hours = date.getHours();
            let minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = minutes < 10 ? '0' + minutes : minutes;
            return hours + ':' + minutes + ' ' + ampm;
        };

        window.showToast = (message, type = 'success') => {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'fixed top-6 right-6 z-[200] flex flex-col gap-3 pointer-events-none';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            const icon = type === 'success' ? 'ph-check-circle' : type === 'error' ? 'ph-x-circle' : 'ph-info';
            const grad = type === 'success' ? 'var(--gradient-success)' : type === 'error' ? 'var(--gradient-danger)' : 'var(--gradient-primary)';

            toast.className = 'flex items-center gap-3 px-6 py-4 rounded-2xl text-white font-bold shadow-xl border border-white/20 min-w-[300px] pointer-events-auto animate-slide-up';
            toast.style.background = grad;
            toast.innerHTML = `<i class="ph-fill ${icon} text-2xl"></i><span>${message}</span>`;

            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                toast.style.transition = 'all 0.5s ease';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };

        const getMsOnDate = (start, end, targetDate) => {
            if (!start || !end) return 0;
            const s = new Date(start);
            const e = new Date(end);

            // Safer parsing for YYYY-MM-DD to avoid UTC/Local shifts
            const parts = targetDate.split('-');
            if (parts.length < 3) return 0;
            const y = parseInt(parts[0]), m = parseInt(parts[1]) - 1, d = parseInt(parts[2]);
            const dayStart = new Date(y, m, d, 0, 0, 0, 0).getTime();
            const dayEnd = new Date(y, m, d, 23, 59, 59, 999).getTime();

            const effectiveStart = Math.max(s.getTime(), dayStart);
            const effectiveEnd = Math.min(e.getTime(), dayEnd);

            if (effectiveStart < effectiveEnd) {
                return effectiveEnd - effectiveStart;
            }
            return 0;
        };

        window.updateShiftRequestStatus = async (id, status) => {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_shift_requests', id), { status: status });
                showToast(`Shift request ${status}`);
            } catch (error) {
                console.error("Error updating shift request:", error);
                showToast("Failed to update status", "error");
            }
        };

        window.forceCheckOut = async (driverId, date) => {
            if (!confirm('Are you sure you want to force check-out this driver? Shift will end at 11:59 PM.')) return;
            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'),
                    where('driverId', '==', driverId),
                    where('date', '==', date),
                    where('status', '==', 'online'));
                const snapshot = await getDocs(q);

                const parts = date.split('-');
                const y = parseInt(parts[0]), m = parseInt(parts[1]) - 1, dy = parseInt(parts[2]);
                const endOfDay = new Date(y, m, dy, 23, 59, 59);

                await Promise.all(snapshot.docs.map(d => updateDoc(d.ref, {
                    status: 'offline',
                    checkOutTime: Timestamp.fromDate(endOfDay),
                    lastUpdated: serverTimestamp()
                })));
                showToast('Shift closed successfully', 'success');
            } catch (err) { alert(err.message); }
        };

        window.bulkForceCheckOut = async () => {
            const date = state.attendanceDate;
            const records = state.monthlyAttendance.filter(a => a.date === date && a.status === 'online');
            if (records.length === 0) {
                showToast('No incomplete sessions for this date', 'info');
                return;
            }

            if (!confirm(`Are you sure you want to CLOSE ALL ${records.length} incomplete shifts for ${date}? This cannot be undone.`)) return;

            try {
                showToast(`Closing ${records.length} shifts...`, 'info');
                const parts = date.split('-');
                const y = parseInt(parts[0]), m = parseInt(parts[1]) - 1, dy = parseInt(parts[2]);
                const endOfDay = new Date(y, m, dy, 23, 59, 59);

                // Fetch the latest references before updating
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'),
                    where('date', '==', date),
                    where('status', '==', 'online'));
                const snapshot = await getDocs(q);

                await Promise.all(snapshot.docs.map(d => updateDoc(d.ref, {
                    status: 'offline',
                    checkOutTime: Timestamp.fromDate(endOfDay),
                    lastUpdated: serverTimestamp()
                })));
                showToast('All shifts closed successfully', 'success');
            } catch (err) { alert(err.message); }
        };

        window.exportTodayAttendance = () => {
            const targetDate = state.attendanceDate;
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];

            // Filter using the same overlap logic as the table
            const attendance = state.monthlyAttendance.filter(record => {
                const start = record.checkInTime?.toDate ? record.checkInTime.toDate() : (record.checkInTime?.seconds ? new Date(record.checkInTime.seconds * 1000) : null);
                const end = record.checkOutTime?.toDate ? record.checkOutTime.toDate() : (record.checkOutTime?.seconds ? new Date(record.checkOutTime.seconds * 1000) : (record.status === 'online' ? new Date() : start));
                return getMsOnDate(start, end, targetDate) > 0;
            });

            const data = attendance.map(record => {
                const start = record.checkInTime?.toDate ? record.checkInTime.toDate() : (record.checkInTime?.seconds ? new Date(record.checkInTime.seconds * 1000) : null);
                const end = record.checkOutTime?.toDate ? record.checkOutTime.toDate() : (record.checkOutTime?.seconds ? new Date(record.checkOutTime.seconds * 1000) : (record.status === 'online' ? new Date() : null));

                const ms = getMsOnDate(start, end, targetDate);
                const dur = `${Math.floor(ms / 3600000)}h ${Math.floor((ms % 3600000) / 60000)}m`;

                const dayStart = new Date(targetDate + 'T00:00:00');
                const dayEnd = new Date(targetDate + 'T23:59:59');

                let inTime = formatTimeAMPM(record.checkInTime);
                if (start && start < dayStart) inTime = "12:00 AM (Cont.)";

                let outTime = formatTimeAMPM(record.checkOutTime);
                if (record.status === 'online') {
                    outTime = (targetDate === todayStr) ? 'Active' : 'Incomplete';
                } else if (end && end > dayEnd) {
                    outTime = "12:00 AM (Cont.)";
                }

                return {
                    'Driver': record.driverName,
                    'Date': targetDate,
                    'In Time': inTime,
                    'Out Time': outTime,
                    'Duration': dur
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance");
            XLSX.writeFile(wb, `Attendance_${targetDate}.xlsx`);
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            if (!auth.currentUser) await initAuth();
            const id = document.getElementById('login-id').value.trim();

            const user = ACCESS_CODES[id];
            if (user) {
                state.user = { ...user, id };
                state.selectedBranch = user.branch || 'All';
                state.view = 'dashboard';
                setupListeners();
            } else {
                alert('Invalid Access PIN');
            }
            render();
        };

        window.handleLogout = () => {
            state.user = null; state.view = 'login';
            unsubscribers.forEach(u => u()); unsubscribers = [];
            render();
        };

        window.seedDatabase = async (type) => {
            if (!confirm(`Import ${type} data from Driver App code to Database?`)) return;
            try {
                if (type === 'drivers') {
                    for (const [id, data] of Object.entries(SOURCE_DRIVERS)) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_drivers', id), { ...data, status: 'active', createdAt: serverTimestamp() }, { merge: true });
                    }
                    alert('Drivers Imported Successfully!');
                } else if (type === 'vehicles') {
                    for (const num of SOURCE_VEHICLES) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', num.replace(/\s/g, '')), { number: num, status: 'active', type: 'Truck', createdAt: serverTimestamp() }, { merge: true });
                    }
                    alert('Vehicles Imported Successfully!');
                } else if (type === 'locations') {
                    for (const loc of SOURCE_LOCATIONS) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_locations', loc), { name: loc, branch: 'All', status: 'Active', createdAt: serverTimestamp() }, { merge: true });
                    }
                    alert('Locations Imported Successfully!');
                } else if (type === 'models') {
                    for (const model of SOURCE_MODELS) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicle_models', model.replace(/\s/g, '')), { name: model, status: 'Active', createdAt: serverTimestamp() }, { merge: true });
                    }
                    alert('Models Imported Successfully!');
                }
            } catch (e) {
                console.error(e);
                alert('Import Failed: ' + e.message);
            }
        };

        window.updateLeaveStatus = async (id, status) => {
            if (!confirm(`Mark this as ${status}?`)) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_leave_requests', id), { status: status, updatedAt: serverTimestamp() });
        };

        window.clearAllTrips = async () => {
            if (!confirm("⚠️ CRITICAL WARNING ⚠️\n\nAre you sure you want to PERMANENTLY DELETE ALL TRIPS?\n\nThis action CANNOT be undone. All trip history will be erased.")) return;

            const pin = prompt("Please enter Admin PIN to confirm:");
            if (pin !== ADMIN_ID) return alert("Incorrect PIN. Action cancelled.");

            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trips'));
                const snapshot = await new Promise((resolve) => {
                    // Use getDocs inside logic or onSnapshot one-off
                    // Since we already have state.trips, we can iterate that, but better to fetch fresh to be safe
                    // We don't have getDocs imported in the import statement I recall seeing, let's allow using the state or add import
                    // Actually, let's just use the state.trips since it is live
                    resolve(state.trips);
                });

                let count = 0;
                for (const trip of state.trips) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', trip.id));
                    count++;
                }
                alert(`Successfully deleted ${count} trips.`);
            } catch (error) {
                console.error("Error clearing trips:", error);
                alert("Failed to clear trips: " + error.message);
            }
        };

        const renderLogin = () => `
            <div class="flex items-center justify-center min-h-screen p-4 relative overflow-hidden">
                <!-- Animated Background -->
                <div class="absolute inset-0 z-0">
                    <div class="absolute top-0 left-0 w-full h-full bg-slate-50 dark:bg-slate-900 transition-colors duration-500"></div>
                    <div class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] rounded-full opacity-20 blur-[100px] animate-pulse-soft" style="background: var(--gradient-primary);"></div>
                    <div class="absolute bottom-[-10%] left-[-10%] w-[400px] h-[400px] rounded-full opacity-20 blur-[80px] animate-pulse-soft" style="background: var(--gradient-secondary); animation-delay: 1s;"></div>
                </div>

                <div class="glass-strong rounded-3xl shadow-2xl p-8 md:p-12 w-full max-w-md text-center relative z-10 animate-fade-in hover-lift border border-white/20">
                    <div class="relative mb-8">
                        <a href="http://anaamalaismobilityservice.com/" target="_blank" class="block mb-6 group">
                            <img src="anaamalais-logo.png" alt="Anaamalais Mobility Service" class="h-20 max-w-[140px] mx-auto object-contain transition-transform group-hover:scale-105" />
                        </a>
                        <div class="absolute inset-0 bg-indigo-500 blur-2xl opacity-20 transform scale-150"></div>
                    </div>
                    
                    <h1 class="text-3xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">Admin Portal</h1>

                    
                    <form onsubmit="handleLogin(event)" class="space-y-6">
                        <div class="space-y-2 text-left">
                            <label class="text-xs font-bold uppercase text-slate-400 ml-1">Access PIN</label>
                            <div class="relative group">
                                <i class="ph-bold ph-lock-key absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl transition-colors group-focus-within:text-indigo-500"></i>
                                <input type="password" id="login-id" inputmode="numeric" class="w-full pl-12 pr-4 py-4 bg-slate-50 dark:bg-slate-800/50 border-2 border-slate-100 dark:border-slate-700/50 rounded-2xl outline-none text-lg font-bold tracking-widest text-center transition-all focus:border-indigo-500 dark:focus:border-indigo-400 focus:bg-white dark:focus:bg-slate-800 focus:shadow-lg dark:text-white placeholder:text-slate-300 dark:placeholder:text-slate-600 placeholder:font-normal placeholder:tracking-normal" placeholder="Enter PIN" required>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-4 text-white rounded-2xl font-bold text-lg shadow-xl relative overflow-hidden group hover:scale-[1.02] active:scale-[0.98] transition-all" style="background: var(--gradient-primary);">
                            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                            <span class="relative flex items-center justify-center gap-2">
                                <i class="ph-bold ph-sign-in"></i> Access Dashboard
                            </span>
                        </button>
                    </form>
                    
                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <div class="flex items-center justify-center gap-2 text-xs font-bold text-slate-400 mb-2">
                             <i class="ph-fill ph-shield-check text-green-500 text-sm"></i>
                             <span>Secure System 2.0</span>
                        </div>
                        <p class="text-[10px] text-slate-400 font-semibold opacity-70">
                            Developed by <span class="text-indigo-500">Anaamalais Digital Service</span>
                        </p>
                    </div>
                </div>
            </div>`;

        window.openReportModal = () => {
            state.adminTab = 'reports';
            render();
        };

        window.closeModal = () => {
            state.modal = null;
            state.editDriver = null;
            state.editVehicle = null;
            render();
        }

        /* --- Driver Management CRUD --- */
        window.openDriverModal = (driverId = null) => {
            if (driverId) {
                state.editDriver = state.drivers.find(d => d.id === driverId);
            } else {
                state.editDriver = null;
            }
            state.modal = renderDriverModalContent();
            render();
        };

        const renderDriverModalContent = () => {
            const d = state.editDriver || {};
            const isEdit = !!d.id;
            const branches = ['All', 'Coimbatore', 'Trichy', 'Salem', 'Kumbakonam'];

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in" style="z-index: 60;" onclick="if(event.target === this) closeModal()">
                <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden scale-in">
                    <div class="bg-slate-50 dark:bg-slate-900/50 px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            <i class="ph-bold ph-steering-wheel text-indigo-500"></i> ${isEdit ? 'Edit Driver' : 'Add Driver'}
                        </h3>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-slate-500"><i class="ph-bold ph-x"></i></button>
                    </div>
                    
                    <form onsubmit="saveDriver(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Driver Name</label>
                            <input type="text" name="name" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${d.name || ''}" placeholder="Full Name" required>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Phone Number</label>
                            <input type="tel" name="phone" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none font-mono" value="${d.phone || ''}" placeholder="10-digit number" required>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Username</label>
                            <div class="relative">
                                <i class="ph-bold ph-user absolute left-3 top-2.5 text-slate-400"></i>
                                <input type="text" name="username" class="w-full pl-9 px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${d.username || ''}" placeholder="Enter Username" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Password</label>
                            <div class="relative">
                                <i class="ph-bold ph-lock-key absolute left-3 top-2.5 text-slate-400"></i>
                                <input type="text" name="password" class="w-full pl-9 px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${d.password || ''}" placeholder="Enter Password" required>
                            </div>

                        ${state.user?.role === 'superadmin' ? `
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Branch</label>
                            <select name="branch" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                ${branches.map(b => `<option value="${b}" ${(d.branch || state.user.branch) === b ? 'selected' : ''}>${b}</option>`).join('')}
                            </select>
                        </div>
                        ` : ''}

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">License Number</label>
                            <input type="text" name="licenseNumber" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none uppercase" value="${d.licenseNumber || ''}" placeholder="DL-XXXXXXXXXX">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">License Expiry Date</label>
                            <input type="date" name="licenseExpiry" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${d.licenseExpiry || ''}">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Status</label>
                            <select name="status" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="Active" ${(d.status || 'Active') === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${d.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>

                        <div class="pt-4 flex justify-end gap-3">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-700 transition-colors">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center gap-2">
                                <i class="ph-bold ph-floppy-disk"></i> ${isEdit ? 'Update Driver' : 'Add Driver'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>`;
        };

        window.saveDriver = async (e) => {
            e.preventDefault();
            const form = e.target;
            const driverData = {
                name: form.name.value,
                phone: form.phone.value,
                username: form.username.value,
                password: form.password.value,
                branch: form.branch ? form.branch.value : state.user.branch,
                licenseNumber: form.licenseNumber.value,
                licenseExpiry: form.licenseExpiry.value,
                status: form.status.value || 'Active'
            };

            try {
                if (state.editDriver) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_drivers', state.editDriver.id), driverData);
                    showToast('Driver updated successfully', 'success');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_drivers'), { ...driverData, createdAt: new Date() });
                    showToast('Driver added successfully', 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving driver:", error);
                showToast('Error saving driver', 'error');
            }
        };

        window.deleteDriver = async (driverId) => {
            if (confirm('Are you sure you want to delete this driver?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_drivers', driverId));
                    showToast('Driver deleted', 'success');
                } catch (e) {
                    console.error(e);
                    showToast('Error deleting driver', 'error');
                }
            }
        };

        window.resetDriverTrips = async (driverId) => {
            const driver = state.drivers.find(d => d.id === driverId);
            if (!driver) return;

            if (!confirm(`⚠️ WARNING ⚠️\n\nAre you sure you want to PERMANENTLY DELETE current trips for ${driver.name}?\n\nThis will remove all trip history for this driver for the Jan 2026 pre-launch reset.`)) return;

            const pin = prompt("Please enter Admin PIN to confirm:");
            if (pin !== ADMIN_ID) return alert("Incorrect PIN. Action cancelled.");

            try {
                const tripsToDelete = state.trips.filter(t => t.driverName === driver.name);

                if (tripsToDelete.length === 0) return alert(`No trips found for ${driver.name}.`);

                let count = 0;
                for (const trip of tripsToDelete) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', trip.id));
                    count++;
                }
                alert(`Successfully deleted ${count} trips for ${driver.name}.`);
                render();
            } catch (e) {
                console.error(e);
                alert('Error resetting driver trips: ' + e.message);
            }
        };

        /* --- Vehicle Management CRUD --- */
        window.openVehicleModal = (vehicleId = null) => {
            if (vehicleId) {
                state.editVehicle = state.vehicles.find(v => v.id === vehicleId);
            } else {
                state.editVehicle = null;
            }
            state.modal = renderVehicleModalContent();
            render();
        };

        const renderVehicleModalContent = () => {
            const v = state.editVehicle || {};
            const isEdit = !!v.id;
            const branches = ['All', 'Coimbatore', 'Trichy', 'Salem', 'Kumbakonam'];
            const models = (state.models || []).map(m => m.name || m.id);

            return `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in" style="z-index: 60;" onclick="if(event.target === this) closeModal()">
        <div class="bg-white dark:bg-slate-800 w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden scale-in flex flex-col max-h-[90vh]">
            <div class="bg-slate-50 dark:bg-slate-900/50 px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center flex-shrink-0">
                <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                    <i class="ph-bold ph-truck text-blue-500"></i> ${isEdit ? 'Edit Vehicle' : 'Add Vehicle'}
                </h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-slate-500"><i class="ph-bold ph-x"></i></button>
            </div>
            
            <form onsubmit="saveVehicle(event)" class="p-6 space-y-6 overflow-y-auto">
                <!-- Basic Details -->
                <div class="space-y-4">
                    <h4 class="text-xs font-bold text-indigo-500 uppercase tracking-widest border-b border-indigo-100 pb-2 mb-4">Basic Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Vehicle Number</label>
                            <input type="text" name="vehicleNumber" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none uppercase font-mono" value="${v.vehicleNumber || v.number || ''}" placeholder="TN 00 XX 0000" required>
                        </div>
                        ${state.user?.role === 'superadmin' ? `
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Branch</label>
                            <select name="branch" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                ${branches.map(b => `<option value="${b}" ${(v.branch || state.user.branch) === b ? 'selected' : ''}>${b}</option>`).join('')}
                            </select>
                        </div>
                        ` : ''}
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Vehicle Type</label>
                            <select name="type" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="Truck" ${(v.type || 'Truck') === 'Truck' ? 'selected' : ''}>Truck</option>
                                <option value="Van" ${v.type === 'Van' ? 'selected' : ''}>Van</option>
                                <option value="Car" ${v.type === 'Car' ? 'selected' : ''}>Car</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Make</label>
                            <input type="text" name="make" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${v.make || ''}" placeholder="e.g. Tata" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Model</label>
                            <input type="text" name="model" list="model-list" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${v.model || ''}" placeholder="Vehicle Model">
                            <datalist id="model-list">
                                ${models.map(m => `<option value="${m}">`).join('')}
                            </datalist>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Status</label>
                            <select name="status" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="Active" ${(v.status || 'Active') === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${v.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                <option value="Maintenance" ${v.status === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                            </select>
                        </div>
                    </div>
                </div>



                <!-- Maintenance Info -->
                <div class="space-y-4">
                    <h4 class="text-xs font-bold text-amber-600 uppercase tracking-widest border-b border-amber-100 pb-2 mb-4">Maintenance Status</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Current Odometer (km)</label>
                            <input type="number" name="odometer" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none" value="${v.odometer || ''}" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Last Service Date</label>
                            <input type="date" name="lastServiceDate" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium text-slate-700 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none" value="${v.lastServiceDate || ''}">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Last Service KM</label>
                            <input type="number" name="lastServiceOdometer" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium text-slate-700 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none" value="${v.lastServiceOdometer || ''}" placeholder="0">
                        </div>
                    </div>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-slate-100 dark:border-slate-700 mt-6 sticky bottom-0 bg-white dark:bg-slate-800 py-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-700 transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center gap-2">
                        <i class="ph-bold ph-floppy-disk"></i> ${isEdit ? 'Update Vehicle' : 'Add Vehicle'}
                    </button>
                </div>
            </form>
        </div>
    </div>`;
        };

        window.saveVehicle = async (e) => {
            e.preventDefault();
            const form = e.target;

            try {
                // Determine branch to save
                let branchVal = state.user.branch;
                if (form.branch) branchVal = form.branch.value;

                const vehicleData = {
                    vehicleNumber: form.vehicleNumber ? form.vehicleNumber.value : '',
                    number: form.vehicleNumber ? form.vehicleNumber.value : '',
                    branch: branchVal,
                    odometer: form.odometer ? form.odometer.value : '',
                    type: form.type ? form.type.value : 'Truck',
                    model: form.model ? form.model.value : '',
                    make: form.make ? form.make.value : (state.editVehicle?.make || ''),
                    status: form.status ? form.status.value : 'Active',
                    // Maintenance Details
                    lastServiceDate: form.lastServiceDate ? form.lastServiceDate.value : '',
                    lastServiceOdometer: form.lastServiceOdometer ? form.lastServiceOdometer.value : ''
                };

                // Validate critical fields
                if (!vehicleData.vehicleNumber) throw new Error("Vehicle Number is required");

                if (state.editVehicle) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', state.editVehicle.id), vehicleData);
                    showToast('Vehicle updated successfully', 'success');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles'), { ...vehicleData, createdAt: new Date() });
                    showToast('Vehicle added successfully', 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving vehicle:", error);
                showToast('Error saving vehicle: ' + (error.message || 'Unknown error'), 'error');
            }
        };

        window.deleteVehicle = async (vehicleId) => {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', vehicleId));
                    showToast('Vehicle deleted', 'success');
                } catch (e) {
                    console.error(e);
                    showToast('Error deleting vehicle', 'error');
                }
            }
        };

        /* --- Location Management CRUD --- */
        window.openLocationModal = (locationId = null) => {
            if (locationId) {
                state.editLocation = state.locations.find(l => l.id === locationId);
            } else {
                state.editLocation = null;
            }
            state.modal = 'location';
            render();
        };

        window.saveLocation = async (e) => {
            e.preventDefault();
            const form = e.target;

            // Get selected branches
            const selectedBranches = Array.from(form.querySelectorAll('input[name="branches"]:checked')).map(cb => cb.value);

            const locationData = {
                name: form.name.value,
                branches: selectedBranches.length > 0 ? selectedBranches : ['All'], // Default to All if nothing selected
                branch: selectedBranches.includes('All') || selectedBranches.length === 0 ? 'All' : selectedBranches[0], // Legacy field compatibility
                status: form.status.value || 'Active'
            };

            try {
                if (state.editLocation) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_locations', state.editLocation.id), locationData);
                    showToast('Location updated successfully', 'success');
                } else {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_locations', locationData.name), { ...locationData, createdAt: new Date() });
                    showToast('Location added successfully', 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving location:", error);
                showToast('Error saving location', 'error');
            }
        };

        window.deleteLocation = async (locationId) => {
            if (confirm('Are you sure you want to delete this location?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_locations', locationId));
                    showToast('Location deleted', 'success');
                } catch (e) {
                    console.error(e);
                    showToast('Error deleting location', 'error');
                }
            }
        };

        window.deleteVehicle = async (vehicleId) => {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', vehicleId));
                    showToast('Vehicle deleted', 'success');
                } catch (e) {
                    console.error(e);
                    showToast('Error deleting vehicle', 'error');
                }
            }
        };

        const renderReportModal = () => {
            if (state.modal !== 'report') return '';
            const todayStr = new Date().toISOString().slice(0, 10);
            const trips = state.trips.filter(t => t.status === 'completed' && t.date === todayStr);

            let totalKm = 0;
            let totalMinutes = 0;

            const rows = trips.map(t => {
                const start = t.startTime?.seconds ? new Date(t.startTime.seconds * 1000) : null;
                const end = t.endTime?.seconds ? new Date(t.endTime.seconds * 1000) : null;
                const duration = start && end ? Math.round((end - start) / 60000) : 0; // minutes
                const km = (t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0;

                totalKm += km > 0 ? km : 0;
                totalMinutes += duration > 0 ? duration : 0;

                const durationStr = duration > 60 ? `${Math.floor(duration / 60)}h ${duration % 60}m` : `${duration}m`;

                return `
                    <tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                        <td class="p-3 font-bold text-slate-700 dark:text-slate-300">${t.truckNumber}</td>
                        <td class="p-3 text-slate-600 dark:text-slate-400 font-mono text-xs">${t.driverName}</td>
                        <td class="p-3 text-slate-600 dark:text-slate-400 text-xs">${t.pickupLocation} → ${t.dropLocation}</td>
                        <td class="p-3 text-right font-mono text-slate-700 dark:text-slate-300 font-bold">${km} km</td>
                        <td class="p-3 text-right font-mono text-slate-700 dark:text-slate-300 font-bold">${durationStr}</td>
                    </tr>
                `;
            }).join('');

            const totalHoursStr = totalMinutes > 60 ? `${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m` : `${totalMinutes}m`;

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <i class="ph-fill ph-check-circle text-green-500"></i> Daily Report
                            </h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 font-mono mt-1">${todayStr}</p>
                        </div>
                        <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-red-100 hover:text-red-500 dark:hover:bg-red-900/30 dark:hover:text-red-400 flex items-center justify-center transition-colors">
                            <i class="ph-bold ph-x text-xl"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-3 gap-4 p-6 bg-slate-50 dark:bg-slate-900/30 border-b border-slate-100 dark:border-slate-700">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                            <p class="text-xs uppercase font-bold text-slate-400 mb-1">Total Trips</p>
                            <p class="text-3xl font-bold text-slate-800 dark:text-white">${trips.length}</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                            <p class="text-xs uppercase font-bold text-slate-400 mb-1">Total Distance</p>
                            <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 font-mono">${totalKm} <span class="text-sm text-slate-400">km</span></p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                            <p class="text-xs uppercase font-bold text-slate-400 mb-1">Total Duration</p>
                            <p class="text-3xl font-bold text-blue-600 dark:text-blue-400 font-mono">${totalHoursStr}</p>
                        </div>
                    </div>

                    <div class="overflow-y-auto flex-1 p-0">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold sticky top-0 backdrop-blur-md">
                                <tr>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700">Truck</th>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700">Driver</th>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700">Route</th>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700 text-right">Distance</th>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700 text-right">Duration</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                ${rows || '<tr><td colspan="5" class="p-8 text-center text-slate-400">No completed trips for today.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }



        const getFilteredData = (data) => {
            if (!state.user) return data;

            let results = data;

            // 1. Branch Filter
            const filterBranch = state.selectedBranch || state.user.branch || 'All';
            if (filterBranch !== 'All') {
                results = results.filter(item => {
                    let itemBranch = item.branch;

                    // Implicit branch lookup for Trips (which lack branch field)
                    if (!itemBranch) {
                        // 1. Try Lookup by Vehicle (Truck Number)
                        const truckNo = item.truckNumber || item.vehicleNumber;
                        if (truckNo) {
                            const vehicle = state.vehicles.find(v => (v.vehicleNumber === truckNo || v.number === truckNo));
                            if (vehicle && vehicle.branch) itemBranch = vehicle.branch;
                        }
                    }

                    if (!itemBranch) {
                        // 2. Try Lookup by Driver
                        const dName = item.driverName || item.name;
                        if (item.driverName) {
                            const driver = state.drivers.find(d => d.name === item.driverName);
                            if (driver && driver.branch) itemBranch = driver.branch;
                        }
                    }

                    // Default to Coimbatore if still unknown (Legacy data support)
                    return (itemBranch || 'Coimbatore') === filterBranch;
                });
            }

            // 2. Global Search Filter
            if (state.searchQuery) {
                const query = state.searchQuery.toLowerCase();
                results = results.filter(item => {
                    // Search in top-level string/number values
                    return Object.values(item).some(val => {
                        if (val === null || val === undefined) return false;
                        if (typeof val === 'string' || typeof val === 'number') {
                            return val.toString().toLowerCase().includes(query);
                        }
                        return false;
                    });
                });
            }

            return results;
        };

        const renderOps = () => {
            const drivers = getFilteredData(state.drivers);
            const trips = getFilteredData(state.trips);
            const leaveRequests = getFilteredData(state.leaveRequests);

            const activeTrips = trips.filter(t => t.status === 'active');
            const completedTrips = trips.filter(t => t.status === 'completed');
            const onlineDrivers = drivers.filter(d => (state.attendance[d.phone] || state.attendance[d.id]) === 'online').length;
            const todayStr = new Date().toISOString().slice(0, 10);
            const todayCompleted = completedTrips.filter(t => t.date === todayStr).length;

            return `
            <div class="space-y-6">
                <!-- Summary Stats -->

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-wifi-high text-4xl text-indigo-600 dark:text-indigo-400"></i></div>
                        <span class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">Online Drivers</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800 dark:text-white">${onlineDrivers}</span>
                            <span class="text-xs font-medium text-slate-400">/ ${drivers.length}</span>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-truck text-4xl text-blue-600 dark:text-blue-400"></i></div>
                        <span class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">Active Trips</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800 dark:text-white">${activeTrips.length}</span>
                            ${activeTrips.length > 0 ? '<span class="flex h-2 w-2 rounded-full bg-blue-500 animate-pulse"></span>' : ''}
                        </div>
                    </div>
                    <div onclick="state.adminTab='reports'; render()" class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24 relative overflow-hidden group cursor-pointer hover:border-green-500 hover:shadow-md transition-all">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-check-circle text-4xl text-green-600 dark:text-green-400"></i></div>
                        <span class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-green-600 transition-colors">Completed Today</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800 dark:text-white">${todayCompleted}</span>
                            <span class="text-[10px] font-bold text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/30 px-2 py-0.5 rounded-full flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                View Report <i class="ph-bold ph-arrow-right"></i>
                            </span>
                        </div>
                    </div>
                     <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-files text-4xl text-orange-600 dark:text-orange-400"></i></div>
                        <span class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">Pending Leave</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800 dark:text-white">${leaveRequests.filter(r => r.status === 'pending').length}</span>
                        </div>
                    </div>
                </div>

                <!-- Live Driver Grid -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                    <h2 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-4 flex items-center gap-2">
                        <i class="ph-fill ph-broadcast text-indigo-500"></i> Live Fleet Status
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        ${drivers.map(d => {
                const hasActiveTrip = activeTrips.some(t => t.driverName === d.name);
                const status = hasActiveTrip ? 'online' : (state.attendance[d.phone] || state.attendance[d.id] || 'offline');
                return `
                            <div class="flex flex-col items-center justify-center p-3 rounded-xl border transition-all ${status === 'online' ? 'bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-900/30' : 'bg-slate-50 dark:bg-slate-700/30 border-slate-100 dark:border-slate-700 opacity-60'}">
                                <div class="relative mb-2">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 ${status === 'online' ? 'bg-white dark:bg-slate-800 border-green-500 text-green-700 dark:text-green-400' : 'bg-slate-200 dark:bg-slate-600 border-transparent text-slate-500'}">
                                        ${d.name.slice(0, 2)}
                                    </div>
                                    ${status === 'online' ? '<div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white dark:border-slate-800 rounded-full animate-pulse"></div>' : ''}
                                </div>
                                <span class="text-xs font-bold text-slate-700 dark:text-slate-300 text-center truncate w-full">${d.name}</span>
                                <span class="text-[10px] font-bold uppercase tracking-wider mt-1 ${status === 'online' ? 'text-green-600 dark:text-green-400' : 'text-slate-400'}">${status}</span>
                            </div>`;
            }).join('')}
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Active Trips Section (2/3 width) -->
                    <div class="lg:col-span-2 space-y-4">
                        <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            <span class="flex w-3 h-3 rounded-full bg-blue-500 animate-pulse"></span> Active Trips
                        </h3>
                        ${activeTrips.length > 0 ?
                    `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${activeTrips.map(t => `
                                    <div onclick="openEditTripModal('${t.id}')" class="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-blue-100 dark:border-blue-900/30 relative overflow-hidden cursor-pointer hover:shadow-md transition-all group">
                                        <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 dark:bg-blue-900/10 rounded-full -mr-10 -mt-10 blur-xl group-hover:bg-blue-100 dark:group-hover:bg-blue-900/20 transition-colors"></div>
                                        <div class="relative">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <div class="flex gap-2 mb-2">
                                                        <span class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded-lg inline-block">On-Going</span>
                                                        <span class="text-xs font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wider bg-purple-50 dark:bg-purple-900/30 px-2 py-1 rounded-lg inline-block">Type: ${t.tripType || 'TVS'}</span>
                                                    </div>
                                                    <h4 class="font-bold text-slate-800 dark:text-white">${t.truckNumber}</h4>
                                                </div>
                                                <div class="text-right">
                                                    <span class="block text-xs text-slate-400">Driver</span>
                                                    <span class="font-bold text-sm text-slate-700 dark:text-slate-300">${t.driverName}</span>
                                                </div>
                                            </div>
                                            
                                            <div class="flex items-center gap-4 mb-4">
                                                <div class="flex-1">
                                                    <p class="text-[10px] uppercase text-slate-400 font-bold">Pickup</p>
                                                    <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 truncate">${t.pickupLocation}</p>
                                                </div>
                                                <i class="ph-bold ph-arrow-right text-slate-300"></i>
                                                <div class="flex-1 text-right">
                                                    <p class="text-[10px] uppercase text-slate-400 font-bold">Drop</p>
                                                    <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 truncate">${t.dropLocation}</p>
                                                </div>
                                            </div>

                                            <div class="pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-700/20 -mx-4 -mb-4 px-4 py-3">
                                                <div class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1">
                                                    <i class="ph-fill ph-clock"></i> Started: ${t.startTime ? new Date(t.startTime.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Unknown'}
                                                </div>
                                                <button class="text-xs font-bold text-blue-600 dark:text-blue-400 flex items-center gap-1 hover:gap-2 transition-all">
                                                    Track Live <i class="ph-bold ph-arrow-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                    :
                    `<div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-8 text-center border-2 border-dashed border-slate-200 dark:border-slate-700">
                                <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400">
                                    <i class="ph-fill ph-coffee text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-slate-600 dark:text-slate-400">No Active Trips</h4>
                                <p class="text-xs text-slate-400 mt-1">All drivers are currently available or offline.</p>
                            </div>`
                }
                    </div>

                    <!-- Recent Activity (1/3 width) -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-end">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white">Recent Activity</h3>
                            <button class="text-xs font-bold text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 transition-colors">View All</button>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            ${completedTrips.slice(0, 5).map(t => `
                                <div class="p-4 border-b border-slate-100 dark:border-slate-700 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors cursor-pointer group">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-xs font-bold text-slate-800 dark:text-white group-hover:text-indigo-600 transition-colors">${t.truckNumber}</span>
                                        <span class="text-[10px] text-slate-400">${t.date}</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 mb-2">
                                        <span class="truncate max-w-[80px]">${t.pickupLocation}</span>
                                        <i class="ph-bold ph-arrow-right text-[10px] text-slate-300"></i>
                                        <span class="truncate max-w-[80px]">${t.dropLocation}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                       <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 uppercase">Completed</span>
                                       <span class="text-[10px] font-medium text-slate-400">${t.driverName}</span>
                                    </div>
                                </div>
                            `).join('')}
                            ${completedTrips.length === 0 ? '<div class="p-6 text-center text-xs text-slate-400">No recent history</div>' : ''}
                        </div>
                    </div>
                </div>
            </div>`;
        };

        const renderHR = () => {
            try {
                const drivers = getFilteredData(state.drivers);
                const leaveRequests = getFilteredData(state.leaveRequests);
                const completedTrips = getFilteredData(state.trips).filter(t => t.status === 'completed');

                // --- Payroll Month Logic ---
                if (!state.payrollMonth) state.payrollMonth = new Date().toISOString().slice(0, 7);

                const currDate = new Date(state.payrollMonth + '-01');
                const year = currDate.getFullYear();
                const month = currDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const monthName = currDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                const todayStr = new Date().toISOString().slice(0, 10); // Standard YYYY-MM-DD

                // Helpers for Month Navigation
                window.changePayrollMonth = (offset) => {
                    const d = new Date(state.payrollMonth + '-01');
                    d.setMonth(d.getMonth() + offset);
                    state.payrollMonth = d.toISOString().slice(0, 7);
                    render();
                };

                return `
            <div class="space-y-8">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="flex flex-col gap-6">
                        <!-- Shift Approvals -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800 dark:text-white">
                                <i class="ph-fill ph-clock-plus text-amber-500"></i> Second Shift Approvals
                            </h2>
                            <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                                ${state.shiftRequests && state.shiftRequests.filter(r => r.status === 'pending').map(req => `
                                    <div class="border border-slate-200 dark:border-slate-700 p-4 rounded-xl flex justify-between items-center bg-amber-50 dark:bg-amber-900/10 shadow-sm">
                                        <div>
                                            <div class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                                ${req.driverName}
                                                <span class="text-[10px] bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full uppercase">Pending</span>
                                            </div>
                                            <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                                                Requesting 2nd Shift for: <span class="font-mono text-slate-700 dark:text-slate-300 font-bold">${req.date}</span>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="updateShiftRequestStatus('${req.id}', 'approved')" class="w-10 h-10 flex items-center justify-center bg-green-100 hover:bg-green-200 text-green-700 dark:bg-green-900/30 dark:hover:bg-green-900/50 dark:text-green-400 rounded-xl transition-all shadow-sm hover:shadow-md" title="Approve">
                                                <i class="ph-bold ph-check text-xl"></i>
                                            </button>
                                            <button onclick="updateShiftRequestStatus('${req.id}', 'rejected')" class="w-10 h-10 flex items-center justify-center bg-red-100 hover:bg-red-200 text-red-700 dark:bg-red-900/30 dark:hover:bg-red-900/50 dark:text-red-400 rounded-xl transition-all shadow-sm hover:shadow-md" title="Reject">
                                                <i class="ph-bold ph-x text-xl"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                                ${(!state.shiftRequests || state.shiftRequests.filter(r => r.status === 'pending').length === 0) ?
                        `<div class="flex flex-col items-center justify-center py-6 text-slate-400">
                                        <i class="ph-duotone ph-check-circle text-2xl mb-1 opacity-50"></i>
                                        <p class="text-xs italic">No pending shift requests</p>
                                    </div>` : ''}
                            </div>
                        </div>

                        <!-- Leave Approvals -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex-1">
                            <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800 dark:text-white">
                                <i class="ph-fill ph-file-text text-indigo-500"></i> Leave Approvals
                            </h2>
                            <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                ${leaveRequests.filter(r => r.status === 'pending').map(req => `
                                    <div class="border border-slate-200 dark:border-slate-700 p-4 rounded-xl flex justify-between items-center bg-slate-50 dark:bg-slate-900/50 shadow-sm">
                                        <div>
                                            <div class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                                ${req.driverName}
                                                <span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full uppercase">Pending</span>
                                            </div>
                                            <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                                                <span class="font-mono text-slate-700 dark:text-slate-300">${req.startDate}</span> to <span class="font-mono text-slate-700 dark:text-slate-300">${req.endDate}</span>
                                            </div>
                                            <div class="text-xs text-slate-400 italic mt-1">"${req.reason}"</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="updateLeaveStatus('${req.id}', 'approved')" class="w-10 h-10 flex items-center justify-center bg-green-100 hover:bg-green-200 text-green-700 dark:bg-green-900/30 dark:hover:bg-green-900/50 dark:text-green-400 rounded-xl transition-all shadow-sm hover:shadow-md" title="Approve">
                                                <i class="ph-bold ph-check text-xl"></i>
                                            </button>
                                            <button onclick="updateLeaveStatus('${req.id}', 'rejected')" class="w-10 h-10 flex items-center justify-center bg-red-100 hover:bg-red-200 text-red-700 dark:bg-red-900/30 dark:hover:bg-red-900/50 dark:text-red-400 rounded-xl transition-all shadow-sm hover:shadow-md" title="Reject">
                                                <i class="ph-bold ph-x text-xl"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                                ${leaveRequests.filter(r => r.status === 'pending').length === 0 ?
                        `<div class="flex flex-col items-center justify-center py-10 text-slate-400">
                                        <i class="ph-duotone ph-check-circle text-4xl mb-2 opacity-50"></i>
                                        <p class="text-sm italic">No pending approvals</p>
                                    </div>` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Daily Attendance Details (Interactive) -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex flex-col gap-1">
                                <h2 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                                    <i class="ph-fill ph-clock-user text-indigo-500"></i> Daily Attendance Details
                                </h2>
                                <div class="flex items-center gap-2">
                                    <input type="date" value="${state.attendanceDate}" 
                                           onchange="state.attendanceDate = this.value; render()" 
                                           class="bg-slate-50 dark:bg-slate-700 border-none text-[10px] font-bold text-slate-700 dark:text-slate-300 rounded-lg p-1.5 focus:ring-0 cursor-pointer">
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${state.attendanceDate < todayStr ? `
                                    <button onclick="bulkForceCheckOut()" class="p-2 bg-orange-50 text-orange-600 hover:bg-orange-100 dark:bg-orange-900/20 dark:text-orange-400 rounded-lg text-xs font-bold transition-all flex items-center gap-2" title="Close All Incomplete Shifts">
                                        <i class="ph-bold ph-lightning"></i> Bulk Close
                                    </button>
                                ` : ''}
                                <button onclick="exportTodayAttendance()" class="p-2 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 dark:bg-emerald-900/20 dark:text-emerald-400 rounded-lg text-xs font-bold transition-all flex items-center gap-2">
                                    <i class="ph-bold ph-file-xls"></i> Export
                                </button>
                            </div>
                        </div>
                        <div class="overflow-auto flex-1 custom-scrollbar max-h-[400px]">
                            <table class="w-full text-xs text-left border-collapse">
                                <thead class="sticky top-0 z-10 bg-slate-50 dark:bg-slate-900/50 shadow-sm">
                                    <tr>
                                        <th class="p-3 border-b border-slate-200 dark:border-slate-700 text-slate-500 uppercase font-bold">Driver</th>
                                        <th class="p-3 border-b border-slate-200 dark:border-slate-700 text-slate-500 uppercase font-bold">In Time</th>
                                        <th class="p-3 border-b border-slate-200 dark:border-slate-700 text-slate-500 uppercase font-bold">Out Time</th>
                                        <th class="p-3 border-b border-slate-200 dark:border-slate-700 text-slate-500 uppercase font-bold text-right">Dur.</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50">
                                    ${(() => {
                        const targetDate = state.attendanceDate;
                        const rawAttendance = state.monthlyAttendance.filter(record => {
                            const start = record.checkInTime?.toDate ? record.checkInTime.toDate() : (record.checkInTime?.seconds ? new Date(record.checkInTime.seconds * 1000) : null);
                            const isOnline = record.status?.toLowerCase() === 'online' || !record.checkOutTime;
                            const end = record.checkOutTime?.toDate ? record.checkOutTime.toDate() : (record.checkOutTime?.seconds ? new Date(record.checkOutTime.seconds * 1000) : (isOnline ? new Date() : start));
                            return getMsOnDate(start, end, targetDate) > 0;

                        });

                        const groups = {};
                        rawAttendance.forEach(r => {
                            const key = r.driverId || r.driverPhone;
                            if (!groups[key]) groups[key] = { name: r.driverName, phone: r.driverPhone, id: key, records: [] };
                            groups[key].records.push(r);
                        });

                        const driverList = Object.values(groups);
                        driverList.sort((a, b) => a.name.localeCompare(b.name));

                        return driverList.map(driver => {
                            const intervals = [];
                            let earliestIn = null;
                            let latestOut = null;
                            let isCurrentlyActive = false;

                            driver.records.forEach(record => {
                                const start = record.checkInTime?.toDate ? record.checkInTime.toDate() : (record.checkInTime?.seconds ? new Date(record.checkInTime.seconds * 1000) : null);
                                // Check Real-Time Status for 'Active' determination
                                // If today, valid only if Live Fleet (state.attendance) says online.
                                const liveStatus = state.attendance[driver.id] || state.attendance[driver.phone] || 'offline';
                                const isRealTimeOnline = liveStatus === 'online';

                                // Logic: Record is 'online' if DB says so AND (it's in the past OR listener confirms online)
                                // If targetDate is today, we Enforce Live Status check to avoid "Ghost" active sessions
                                // CRITICAL FIX: Driver must have STARTED shift (checkInTime exists) AND NOT ended it (no checkOutTime)
                                // This ensures Punch IN (Start Shift) and Punch OUT (End Shift) logic is correctly followed
                                const hasStartedShift = !!record.checkInTime;
                                const hasNotEndedShift = !record.checkOutTime;
                                const dbStatusOnline = hasStartedShift && hasNotEndedShift && (record.status?.toLowerCase() === 'online' || hasNotEndedShift);
                                const isOnline = (targetDate === todayStr) ? (dbStatusOnline && isRealTimeOnline) : dbStatusOnline;

                                const end = record.checkOutTime?.toDate ? record.checkOutTime.toDate() : (record.checkOutTime?.seconds ? new Date(record.checkOutTime.seconds * 1000) : (isOnline ? new Date() : (dbStatusOnline ? new Date() : start)));
                                // Note: If dbStatusOnline is true but isOnline is false (stale), we still cap at Now for duration calculation? 
                                // Or cap at midnight? If it's today, cap at Now makes sense for "Incomplete".

                                if (start) {
                                    if (!earliestIn || start < earliestIn) earliestIn = start;
                                }

                                // Determine active session
                                const parts = targetDate.split('-');
                                const y = parseInt(parts[0]), m_idx = parseInt(parts[1]) - 1, dy = parseInt(parts[2]);
                                const dayStartMs = new Date(y, m_idx, dy, 0, 0, 0, 0).getTime();
                                const dayEndMs = new Date(y, m_idx, dy, 23, 59, 59, 999).getTime();

                                const sTime = Math.max(start ? start.getTime() : 0, dayStartMs);
                                const eTime = Math.min(end ? end.getTime() : 0, dayEndMs);

                                if (sTime < eTime) intervals.push([sTime, eTime]);

                                // Active if Online AND verified by Live Status
                                if (isOnline && targetDate === todayStr) isCurrentlyActive = true;

                                if (end && (!latestOut || end > latestOut)) latestOut = end;
                            });

                            // deduplicate intervals
                            let totalMs = 0;
                            if (intervals.length) {
                                intervals.sort((a, b) => a[0] - b[0]);
                                let current = intervals[0];
                                for (let idx = 1; idx < intervals.length; idx++) {
                                    let next = intervals[idx];
                                    if (next[0] <= current[1]) {
                                        current[1] = Math.max(current[1], next[1]);
                                    } else {
                                        totalMs += (current[1] - current[0]);
                                        current = next;
                                    }
                                }
                                totalMs += (current[1] - current[0]);
                            }

                            // Active Driving Time
                            const driverTrips = completedTrips.filter(t => t.driverName === driver.name);
                            const aIntervals = [];
                            driverTrips.forEach(t => {
                                if (t.startTime) {
                                    const start = t.startTime?.toDate ? t.startTime.toDate() : new Date(t.startTime.seconds * 1000);
                                    const end = t.endTime?.toDate ? t.endTime.toDate() : new Date(t.endTime.seconds * 1000);

                                    const parts = targetDate.split('-');
                                    const y = parseInt(parts[0]), m_idx = parseInt(parts[1]) - 1, dy = parseInt(parts[2]);
                                    const dayStartMs = new Date(y, m_idx, dy, 0, 0, 0, 0).getTime();
                                    const dayEndMs = new Date(y, m_idx, dy, 23, 59, 59, 999).getTime();

                                    const sTime = Math.max(start.getTime(), dayStartMs);
                                    const eTime = Math.min(end.getTime(), dayEndMs);
                                    if (sTime < eTime) aIntervals.push([sTime, eTime]);
                                }
                            });

                            // Dedupe Active
                            let activeMs = 0;
                            if (aIntervals.length) {
                                aIntervals.sort((a, b) => a[0] - b[0]);
                                let current = aIntervals[0];
                                for (let idx = 1; idx < aIntervals.length; idx++) {
                                    let next = aIntervals[idx];
                                    if (next[0] <= current[1]) {
                                        current[1] = Math.max(current[1], next[1]);
                                    } else {
                                        activeMs += (current[1] - current[0]);
                                        current = next;
                                    }
                                }
                                activeMs += (current[1] - current[0]);
                            }

                            const hrs = Math.floor(totalMs / 3600000);
                            const mins = Math.floor((totalMs % 3600000) / 60000);
                            const duration = `${hrs}h ${mins}m`;

                            const aHrs = Math.floor(activeMs / 3600000);
                            const aMins = Math.floor((activeMs % 3600000) / 60000);
                            const aDuration = activeMs > 0 ? `${aHrs}h ${aMins}m` : '-';

                            const dayStart = new Date(targetDate + 'T00:00:00');
                            const dayEnd = new Date(targetDate + 'T23:59:59');

                            let inTimeDisplay = earliestIn ? formatTimeAMPM(earliestIn) : '-';
                            if (earliestIn && earliestIn < dayStart) inTimeDisplay = '<span class="text-indigo-400 font-bold" title="Split from previous day">12:00 AM <span class="text-[9px] font-normal italic">(Split)</span></span>';

                            let outTimeDisplay = '-';
                            let actions = '';

                            if (isCurrentlyActive) {
                                outTimeDisplay = '<span class="text-green-500 font-bold flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Active</span>';
                            } else {
                                // Logic update: "Active" but Live Status Offline -> Treat as Incomplete
                                const hasIncomplete = driver.records.some(r => {
                                    // CRITICAL FIX: Only consider a record "online" if shift was actually started
                                    const dbOnline = r.checkInTime && (r.status === 'online' || !r.checkOutTime);
                                    // If today, also need live status confirmation. If not confirmed, it's incomplete.
                                    if (targetDate === todayStr) {
                                        const liveStatus = state.attendance[driver.id] || state.attendance[driver.phone] || 'offline';
                                        return dbOnline && liveStatus !== 'online';
                                    }
                                    return dbOnline;
                                });

                                if (hasIncomplete) {
                                    outTimeDisplay = '<span class="text-orange-500 font-bold italic text-[10px]">Incomplete</span>';
                                    actions = `<button onclick="forceCheckOut('${driver.id}', '${targetDate}')" class="text-[9px] font-bold text-slate-400 hover:text-red-500 transition-colors underline">Close Shift</button>`;
                                } else if (latestOut) {
                                    outTimeDisplay = formatTimeAMPM(latestOut);
                                    if (latestOut > dayEnd) outTimeDisplay = '<span class="text-indigo-400 font-bold" title="Split into next day">12:00 AM <span class="text-[9px] font-normal italic">(Split)</span></span>';
                                }
                            }

                            return `
                                                 <tr class="border-t border-slate-200 dark:border-slate-700/50 even:bg-slate-100 dark:even:bg-slate-800/50 hover:bg-slate-100/50 dark:hover:bg-slate-700/30 transition-shadow hover:shadow-sm">
                                                    <td class="p-3 font-bold text-slate-700 dark:text-slate-300">
                                                        <div class="flex flex-col text-[11px]">
                                                            <span>${driver.name}</span>
                                                            <span class="text-[8px] text-slate-400 font-normal">${driver.phone || ''}</span>
                                                        </div>
                                                    </td>
                                                    <td class="p-3 font-mono text-slate-500">${inTimeDisplay}</td>
                                                    <td class="p-3 font-mono text-slate-500">
                                                        <div class="flex flex-col gap-0.5">
                                                            ${outTimeDisplay}
                                                            ${actions}
                                                        </div>
                                                    </td>
                                                    <td class="p-3 text-right whitespace-nowrap">
                                                        <div class="flex flex-col gap-0.5">
                                                            <span class="font-bold text-indigo-600 dark:text-indigo-400" title="Shift/Duty Duration">S: ${duration}</span>
                                                            <span class="text-[10px] font-bold text-blue-500" title="Active Driving Duration">A: ${aDuration}</span>
                                                        </div>
                                                    </td>
                                                </tr>`;
                        }).join('');
                    })()}
                                    ${state.monthlyAttendance.filter(a => a.date === state.attendanceDate).length === 0 ? `
                                        <tr><td colspan="4" class="p-8 text-center text-slate-400 italic">No attendance records for this date</td></tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Monthly Payroll & Attendance Summary -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <div class="flex items-center gap-4">
                            <h2 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                                <i class="ph-fill ph-calendar-blank text-indigo-500"></i> Monthly Summary & Payroll
                            </h2>
                            <div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                                <button onclick="window.changePayrollMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 shadow-sm transition-all text-slate-500 dark:text-slate-300">
                                    <i class="ph-bold ph-caret-left"></i>
                                </button>
                                <span class="px-3 font-bold text-sm text-slate-700 dark:text-white w-32 text-center select-none">${monthName}</span>
                                <button onclick="window.changePayrollMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-slate-600 shadow-sm transition-all text-slate-500 dark:text-slate-300">
                                    <i class="ph-bold ph-caret-right"></i>
                                </button>
                            </div>
                        </div>
                         <div class="flex items-center gap-4 text-[10px]">
                            <div class="flex items-center gap-2 px-3 py-1.5 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-100 dark:border-green-800">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span> 
                                <span class="font-bold text-green-700 dark:text-green-400">Duty (S)</span>
                            </div>
                            <div class="flex items-center gap-2 px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800">
                                <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                                <span class="font-bold text-blue-700 dark:text-blue-400">Active (A)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto flex-1 custom-scrollbar pb-2">
                        <table class="w-full text-xs text-left border-collapse">
                            <thead>
                                <tr class="bg-indigo-50 dark:bg-indigo-900/20 text-slate-500 dark:text-slate-400">
                                    <th class="p-3 border border-slate-200 dark:border-slate-700 min-w-[150px] sticky left-0 bg-indigo-50 dark:bg-indigo-900/20 z-20 font-bold uppercase shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">Driver</th>
                                    ${Array.from({ length: daysInMonth }, (_, i) => `<th class="p-1 border-r border-b border-t border-slate-200 dark:border-slate-700 text-center min-w-[32px] font-medium bg-slate-50 dark:bg-slate-800">${i + 1}</th>`).join('')}
                                    <th class="p-3 border border-slate-200 dark:border-slate-700 min-w-[80px] font-bold uppercase text-center bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400">Total S</th>
                                    <th class="p-3 border border-slate-200 dark:border-slate-700 min-w-[80px] font-bold uppercase text-center bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400">Total A</th>
                                    <th class="p-3 border border-slate-200 dark:border-slate-700 min-w-[100px] font-bold uppercase text-right bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400">Salary</th>
                                    <th class="p-3 border border-slate-200 dark:border-slate-700 min-w-[100px] font-bold uppercase text-right bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400">Allowance</th>
                                    <th class="p-3 border border-slate-200 dark:border-slate-700 min-w-[100px] font-bold uppercase text-right bg-indigo-100 dark:bg-indigo-900/50 text-indigo-800 dark:text-indigo-200">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${drivers.map(d => {
                        // Calculate Monthly Totals for S and A
                        let totalShiftMs = 0;
                        let totalActiveMs = 0;

                        const monthCells = Array.from({ length: daysInMonth }, (_, i) => {
                            const day = i + 1;
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                            // Day-wise Shift
                            const attDocs = state.monthlyAttendance.filter(a => (a.driverId === d.phone || a.driverId === d.id));
                            const shiftIntervals = [];
                            attDocs.forEach(record => {
                                if (record.checkInTime) {
                                    const start = record.checkInTime?.toDate ? record.checkInTime.toDate() : (record.checkInTime?.seconds ? new Date(record.checkInTime.seconds * 1000) : null);
                                    const isOnline = record.status?.toLowerCase() === 'online' || !record.checkOutTime;
                                    const end = record.checkOutTime?.toDate ? record.checkOutTime.toDate() : (record.checkOutTime?.seconds ? new Date(record.checkOutTime.seconds * 1000) : (isOnline ? new Date() : start));

                                    if (start) {
                                        const parts = dateStr.split('-');
                                        const y = parseInt(parts[0]), m_idx = parseInt(parts[1]) - 1, dy = parseInt(parts[2]);
                                        const dayStart = new Date(y, m_idx, dy, 0, 0, 0, 0).getTime();
                                        const dayEnd = new Date(y, m_idx, dy, 23, 59, 59, 999).getTime();

                                        const sTime = Math.max(start.getTime(), dayStart);
                                        const eTime = Math.min(end ? end.getTime() : new Date().getTime(), dayEnd); // Safety fallback
                                        if (sTime < eTime) shiftIntervals.push([sTime, eTime]);
                                    }
                                }
                            });

                            let dayShiftMs = 0;
                            if (shiftIntervals.length) {
                                shiftIntervals.sort((a, b) => a[0] - b[0]);
                                let current = shiftIntervals[0];
                                for (let idx = 1; idx < shiftIntervals.length; idx++) {
                                    let next = shiftIntervals[idx];
                                    if (next[0] <= current[1]) {
                                        current[1] = Math.max(current[1], next[1]);
                                    } else {
                                        dayShiftMs += (current[1] - current[0]);
                                        current = next;
                                    }
                                }
                                dayShiftMs += (current[1] - current[0]);
                            }

                            // Day-wise Active
                            const driverTrips = completedTrips.filter(t => t.driverName === d.name);
                            const activeIntervals = [];
                            driverTrips.forEach(t => {
                                if (t.startTime) {
                                    const start = t.startTime?.toDate ? t.startTime.toDate() : new Date(t.startTime.seconds * 1000);
                                    const end = t.endTime?.toDate ? t.endTime.toDate() : new Date(t.endTime.seconds * 1000);

                                    const parts = dateStr.split('-');
                                    const y = parseInt(parts[0]), m_idx = parseInt(parts[1]) - 1, dy = parseInt(parts[2]);
                                    const dayStart = new Date(y, m_idx, dy, 0, 0, 0, 0).getTime();
                                    const dayEnd = new Date(y, m_idx, dy, 23, 59, 59, 999).getTime();

                                    const sTime = Math.max(start.getTime(), dayStart);
                                    const eTime = Math.min(end.getTime(), dayEnd);
                                    if (sTime < eTime) activeIntervals.push([sTime, eTime]);
                                }
                            });

                            let dayActiveMs = 0;
                            if (activeIntervals.length) {
                                activeIntervals.sort((a, b) => a[0] - b[0]);
                                let current = activeIntervals[0];
                                for (let idx = 1; idx < activeIntervals.length; idx++) {
                                    let next = activeIntervals[idx];
                                    if (next[0] <= current[1]) {
                                        current[1] = Math.max(current[1], next[1]);
                                    } else {
                                        dayActiveMs += (current[1] - current[0]);
                                        current = next;
                                    }
                                }
                                dayActiveMs += (current[1] - current[0]);
                            }

                            totalShiftMs += dayShiftMs;
                            totalActiveMs += dayActiveMs;

                            const sHrs = Math.floor(dayShiftMs / 3600000);
                            const sMins = Math.floor((dayShiftMs % 3600000) / 60000);
                            const aHrs = Math.floor(dayActiveMs / 3600000);
                            const aMins = Math.floor((dayActiveMs % 3600000) / 60000);

                            let content = '·';
                            let bg = '';
                            if (dayShiftMs > 0 || dayActiveMs > 0) {
                                const sF = `${sHrs}:${String(sMins).padStart(2, '0')}`;
                                const aF = dayActiveMs > 0 ? `${aHrs}:${String(aMins).padStart(2, '0')}` : '-';
                                content = `<div class="flex flex-col gap-0.5 leading-tight py-0.5"><span class="text-green-600 dark:text-green-400 font-bold">${sF}</span><div class="w-full border-t border-slate-200/50 my-0.5"></div><span class="text-blue-600 dark:text-blue-400 font-bold">${aF}</span></div>`;
                                bg = 'bg-white dark:bg-slate-800';
                            }

                            // Is Today?
                            const isToday = day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();
                            const borderClass = isToday ? 'border-indigo-500 border-x-2' : 'border-slate-200 dark:border-slate-700';

                            return `<td class="border-r border-b ${borderClass} text-center ${bg} p-1 text-[10px] text-slate-300">${content}</td>`;
                        }).join('');

                        // Format Totals
                        const totalSHrs = Math.floor(totalShiftMs / 3600000);
                        const totalSMins = Math.floor((totalShiftMs % 3600000) / 60000);
                        const totalAHrs = Math.floor(totalActiveMs / 3600000);
                        const totalAMins = Math.floor((totalActiveMs % 3600000) / 60000);

                        // Payroll Values
                        const payrollId = `${d.name}_${state.payrollMonth}`;
                        const record = state.payroll?.[payrollId] || {};
                        const salary = record.salary || 0;
                        const allowance = record.allowance || 0;
                        const totalPay = salary + allowance;

                        return `
                                    <tr class="hover:bg-indigo-50/20 dark:hover:bg-indigo-900/10 transition-colors">
                                        <td class="p-3 font-bold border-r border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 sticky left-0 bg-white dark:bg-slate-800 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] truncate max-w-[150px] flex items-center gap-2">
                                           <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-[10px] text-slate-500">${d.name.slice(0, 2)}</div>
                                           ${d.name}
                                        </td>
                                        ${monthCells}
                                        <td class="p-2 border border-slate-200 dark:border-slate-700 text-center font-bold text-green-700 dark:text-green-400 bg-green-50/30">
                                            ${totalSHrs}h ${totalSMins}m
                                        </td>
                                        <td class="p-2 border border-slate-200 dark:border-slate-700 text-center font-bold text-blue-700 dark:text-blue-400 bg-blue-50/30">
                                            ${totalAHrs}h ${totalAMins}m
                                        </td>
                                        <td class="p-2 border border-slate-200 dark:border-slate-700 text-right bg-amber-50/20">
                                             <button onclick="window.openSalaryModal('${d.name}', '${state.payrollMonth}')" 
                                                 class="flex items-center justify-end w-full px-2 py-1.5 hover:bg-white dark:hover:bg-slate-700 rounded transition-colors group">
                                                 <span class="text-slate-400 font-bold mr-1 group-hover:text-amber-500 transition-colors">₹</span>
                                                 <span class="font-bold text-slate-700 dark:text-slate-300">${(salary || 0).toLocaleString()}</span>
                                                 <i class="ph-bold ph-note-pencil ml-1.5 text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                                             </button>
                                        </td>
                                        <td class="p-2 border border-slate-200 dark:border-slate-700 text-right bg-amber-50/20">
                                             <button onclick="window.openAllowanceModal('${d.name}', '${state.payrollMonth}')" 
                                                 class="flex items-center justify-end w-full px-2 py-1.5 hover:bg-white dark:hover:bg-slate-700 rounded transition-colors group">
                                                 <span class="text-slate-400 font-bold mr-1 group-hover:text-amber-500 transition-colors">₹</span>
                                                 <span class="font-bold text-slate-700 dark:text-slate-300">${(allowance || 0).toLocaleString()}</span>
                                                 <i class="ph-bold ph-note-pencil ml-1.5 text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                                             </button>
                                        </td>
                                        <td class="p-2 border border-slate-200 dark:border-slate-700 text-right font-bold text-indigo-700 dark:text-indigo-300 bg-indigo-50/30">
                                            ₹${totalPay.toLocaleString()}
                                        </td>
                                    </tr>`;
                    }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            } catch (err) {
                console.error("RenderHR Error:", err);
                return `<div class="p-8 text-center text-red-500 bg-red-50 rounded-xl border border-red-200 m-4">
                    <i class="ph-bold ph-warning-circle text-4xl mb-2"></i>
                    <h3 class="font-bold text-lg">Something went wrong</h3>
                    <p class="font-mono text-xs mt-2 text-red-700">${err.message}</p>
                    <pre class="mt-4 text-[10px] text-left overflow-auto max-h-40 bg-white p-2 rounded border border-red-100">${err.stack}</pre>
                </div>`;
            }
        };

        const renderPerf = () => {
            // Initialize filter state if not set
            if (!state.perfFilterType) state.perfFilterType = 'month';
            if (!state.perfDate) state.perfDate = new Date().toISOString().slice(0, 7); // Default to current month YYYY-MM
            if (!state.perfDay) state.perfDay = new Date().toISOString().split('T')[0];
            if (!state.perfStart) state.perfStart = new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0];
            if (!state.perfEnd) state.perfEnd = new Date().toISOString().split('T')[0];

            const drivers = getFilteredData(state.drivers);
            const vehicles = getFilteredData(state.vehicles);
            const isDriver = state.perfTab === 'drivers';

            // --- Helper: Parse Amount ---
            const parseAmount = (val) => {
                if (typeof val === 'number') return val;
                if (!val) return 0;
                return parseFloat(val.toString().replace(/[^0-9.-]/g, '')) || 0;
            };

            // --- Filter Logic ---
            const filterByPerfDate = (item, dateField = 'date') => {
                const d = item[dateField];
                if (!d) return false;
                if (state.perfFilterType === 'mid') return false; // unused
                if (state.perfFilterType === 'day') return d === state.perfDay;
                if (state.perfFilterType === 'month') return d.startsWith(state.perfDate);
                if (state.perfFilterType === 'custom') return d >= state.perfStart && d <= state.perfEnd;
                return false;
            };

            // Filter Trips
            const rawTrips = getFilteredData(state.trips);
            const perfTrips = rawTrips.filter(t => t.status === 'completed' && filterByPerfDate(t));

            // Filter Financials (Only if showing vehicles to save perf, though JS is fast enough)
            const perfFuel = (state.fuelLogs || []).filter(f => filterByPerfDate(f));
            const perfMaint = (state.maintenanceLogs || []).filter(m => filterByPerfDate(m));
            const perfTolls = (state.tollLogs || []).filter(t => filterByPerfDate(t));
            const perfFines = (state.policeFines || []).filter(p => filterByPerfDate(p));

            const renderDriverCard = (d) => {
                const dTrips = perfTrips.filter(t => t.driverName === d.name);
                const total = dTrips.length;
                const tvs = dTrips.filter(t => t.tripType === 'TVS').length;
                const int = dTrips.filter(t => t.tripType === 'INT').length;
                const empty = dTrips.filter(t => t.tripType === 'Empty').length;
                const totalKm = dTrips.reduce((acc, t) => acc + ((t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0), 0);

                // Calculate participation (attendance) - Filter by same date logic if needed, or keep generic "Month" logic?
                // keeping original specific month logic for now or adapting to filter? 
                // Original used state.monthlyAttendance which scans generic month. Let's keep it simple for Driver Card (as user focused on Vehicle Details).
                // But let's at least try to match the view context if 'month'.
                const presentDays = state.monthlyAttendance.filter(a => (a.driverId === d.phone || a.driverId === d.id) && a.status === 'online').length;

                return `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden hover:shadow-md transition-shadow">
                    <div class="bg-slate-50 dark:bg-slate-900/30 p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-bold text-lg shadow-sm border border-indigo-200 dark:border-indigo-800">${d.name.slice(0, 2).toUpperCase()}</div>
                            <div>
                                <h3 class="font-bold text-slate-800 dark:text-white text-lg">${d.name}</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1"><i class="ph-fill ph-check-circle text-green-500"></i> ${presentDays} Days Present</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${total}</span>
                            <p class="text-[10px] uppercase font-bold text-slate-400">Total Trips</p>
                        </div>
                    </div>
                    <div class="p-5 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                             <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-xl border border-indigo-100 dark:border-indigo-800/30">
                                <p class="text-[10px] uppercase font-bold text-indigo-400 mb-1">Total Distance</p>
                                <p class="text-xl font-bold text-slate-700 dark:text-slate-300 font-mono">${totalKm} <span class="text-xs text-slate-400">km</span></p>
                             </div>
                             <div class="bg-emerald-50 dark:bg-emerald-900/20 p-3 rounded-xl border border-emerald-100 dark:border-emerald-800/30">
                                <p class="text-[10px] uppercase font-bold text-emerald-400 mb-1">Efficiency</p>
                                <p class="text-xl font-bold text-slate-700 dark:text-slate-300 font-mono">${total ? Math.round(totalKm / total) : 0} <span class="text-xs text-slate-400">km/trip</span></p>
                             </div>
                        </div>

                        <div>
                             <p class="text-xs font-bold text-slate-400 mb-2 uppercase">Trip Category Breakdown</p>
                             <div class="space-y-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-bold text-slate-600 dark:text-slate-400 w-12">TVS</span>
                                    <div class="flex-1 bg-slate-100 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                                        <div class="bg-blue-500 h-full rounded-full" style="width: ${total ? (tvs / total) * 100 : 0}%"></div>
                                    </div>
                                    <span class="text-xs font-mono font-bold text-slate-700 dark:text-slate-300 w-8 text-right">${tvs}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-bold text-slate-600 dark:text-slate-400 w-12">INT</span>
                                    <div class="flex-1 bg-slate-100 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                                        <div class="bg-purple-500 h-full rounded-full" style="width: ${total ? (int / total) * 100 : 0}%"></div>
                                    </div>
                                    <span class="text-xs font-mono font-bold text-slate-700 dark:text-slate-300 w-8 text-right">${int}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-bold text-slate-600 dark:text-slate-400 w-12">Empty</span>
                                    <div class="flex-1 bg-slate-100 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                                        <div class="bg-slate-400 h-full rounded-full" style="width: ${total ? (empty / total) * 100 : 0}%"></div>
                                    </div>
                                    <span class="text-xs font-mono font-bold text-slate-700 dark:text-slate-300 w-8 text-right">${empty}</span>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>`;
            };

            const renderVehicleCard = (v) => {
                // Trips & Revenue
                const vTrips = perfTrips.filter(t => (t.truckNumber === v || t.vehicleNumber === v));
                const totalTrips = vTrips.length;
                const totalKm = vTrips.reduce((acc, t) => acc + ((t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0), 0);
                const revenue = vTrips.reduce((acc, t) => acc + (parseAmount(t.billAmount) || 0), 0);

                // Expenses
                const vFuel = perfFuel.filter(f => f.vehicleNumber === v);
                const vMaint = perfMaint.filter(m => m.vehicleNumber === v);
                const vTolls = perfTolls.filter(t => t.vehicleNumber === v);
                const vFines = perfFines.filter(p => p.vehicleNumber === v);

                const fuelCost = vFuel.reduce((sum, f) => sum + (parseAmount(f.amount) || 0), 0);
                const maintCost = vMaint.reduce((sum, m) => sum + (parseAmount(m.price) || 0), 0);
                const tollCost = vTolls.reduce((sum, t) => sum + (parseAmount(t.amount) || 0), 0);
                const fineCost = vFines.reduce((sum, p) => sum + (parseAmount(p.amount) || 0), 0);

                const totalExpense = fuelCost + maintCost + tollCost + fineCost;
                const netProfit = revenue - totalExpense;

                // Efficiency Metrics
                const totalLitres = vFuel.reduce((sum, f) => sum + (parseAmount(f.litres) || 0), 0);
                const kmPerLiter = totalLitres > 0 ? (totalKm / totalLitres) : 0;
                const costPerKm = totalKm > 0 ? (totalExpense / totalKm) : 0;

                // Driver Analysis
                const driverCounts = {};
                vTrips.forEach(t => { driverCounts[t.driverName] = (driverCounts[t.driverName] || 0) + 1; });
                const topDriver = Object.keys(driverCounts).reduce((a, b) => driverCounts[a] > driverCounts[b] ? a : b, 'None');

                return `
                 <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden hover:shadow-md transition-shadow flex flex-col">
                    <!-- Header -->
                    <div class="bg-slate-50 dark:bg-slate-900/30 p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white dark:bg-slate-800 rounded-lg flex items-center justify-center text-slate-700 dark:text-slate-300 font-bold shadow-sm border border-slate-200 dark:border-slate-700">
                                <i class="ph-fill ph-truck text-emerald-500"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 dark:text-white text-base leading-tight">${v}</h3>
                                <p class="text-[10px] text-slate-500 dark:text-slate-400 flex items-center gap-1 uppercase tracking-wide">
                                    <i class="ph-bold ph-steering-wheel"></i> ${topDriver}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                             <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Net Profit</div>
                             <div class="text-lg font-bold ${netProfit >= 0 ? 'text-indigo-600 dark:text-indigo-400' : 'text-red-500'}">₹${netProfit.toLocaleString()}</div>
                        </div>
                    </div>

                    <div class="p-4 flex-1 flex flex-col gap-4">
                        <!-- Primary Split: Rev vs Exp -->
                        <div class="grid grid-cols-2 gap-3 pb-3 border-b border-dashed border-slate-200 dark:border-slate-700">
                             <div>
                                <div class="text-[10px] text-slate-400 uppercase font-bold mb-0.5">Revenue</div>
                                <div class="text-sm font-bold text-slate-700 dark:text-slate-300">₹${revenue.toLocaleString()}</div>
                                <div class="text-[10px] text-slate-400 mt-0.5">${totalTrips} Trips</div>
                             </div>
                             <div class="text-right">
                                <div class="text-[10px] text-slate-400 uppercase font-bold mb-0.5">Expense</div>
                                <div class="text-sm font-bold text-red-600 dark:text-red-400">₹${totalExpense.toLocaleString()}</div>
                                <div class="text-[10px] text-slate-400 mt-0.5">${(revenue > 0 ? (totalExpense / revenue) * 100 : 0).toFixed(0)}% of Rev</div>
                             </div>
                        </div>

                        <!-- Efficiency Grid -->
                        <div class="grid grid-cols-2 gap-3">
                             <div class="bg-emerald-50 dark:bg-emerald-900/10 p-2.5 rounded-xl border border-emerald-100 dark:border-emerald-900/30">
                                <div class="text-[10px] uppercase font-bold text-emerald-600 dark:text-emerald-400 mb-1 flex items-center gap-1"><i class="ph-bold ph-drop"></i> Mileage</div>
                                <div class="text-lg font-bold text-emerald-700 dark:text-emerald-300 leading-none">${kmPerLiter.toFixed(1)}</div>
                                <div class="text-[10px] text-emerald-600/70 dark:text-emerald-400/70 font-medium mt-1">km / Liter</div>
                             </div>
                             <div class="bg-slate-50 dark:bg-slate-700/30 p-2.5 rounded-xl border border-slate-100 dark:border-slate-700">
                                <div class="text-[10px] uppercase font-bold text-slate-500 dark:text-slate-400 mb-1">Cost / KM</div>
                                <div class="text-lg font-bold text-slate-700 dark:text-slate-300 leading-none">₹${costPerKm.toFixed(1)}</div>
                                <div class="text-[10px] text-slate-400 font-medium mt-1">Total run: ${totalKm} km</div>
                             </div>
                        </div>

                        <!-- Breakdown Mini -->
                        <div class="flex text-[10px] gap-2 pt-1 border-t border-slate-100 dark:border-slate-800">
                            <div class="flex-1 bg-amber-50 dark:bg-amber-900/20 rounded p-1.5 text-center border border-amber-100 dark:border-amber-900/30">
                                <span class="block text-amber-500 font-bold uppercase text-[9px]">Fuel</span>
                                <span class="font-bold text-slate-600 dark:text-slate-300">₹${fuelCost.toLocaleString()}</span>
                            </div>
                            <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded p-1.5 text-center border border-red-100 dark:border-red-900/30">
                                <span class="block text-red-500 font-bold uppercase text-[9px]">Maint</span>
                                <span class="font-bold text-slate-600 dark:text-slate-300">₹${maintCost.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                 </div>`;
            };

            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            return `
            <div class="space-y-6 animate-slide-up">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">Performance Analytics</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Fleet and Driver efficiency metrics</p>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3">
                         <!-- Filter Controls -->
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <select onchange="state.perfFilterType=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs font-bold text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0 cursor-pointer">
                                <option value="day" ${state.perfFilterType === 'day' ? 'selected' : ''}>Day View</option>
                                <option value="month" ${state.perfFilterType === 'month' ? 'selected' : ''}>Month View</option>
                                <option value="custom" ${state.perfFilterType === 'custom' ? 'selected' : ''}>Custom Range</option>
                            </select>
                            
                            <!-- Day Picker -->
                            ${state.perfFilterType === 'day' ? `
                                <input type="date" value="${state.perfDay}" onchange="state.perfDay=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                            ` : ''}

                            <!-- Month Picker -->
                             ${state.perfFilterType === 'month' ? `
                                <input type="month" value="${state.perfDate}" onchange="state.perfDate=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                            ` : ''}

                            <!-- Custom Range -->
                            ${state.perfFilterType === 'custom' ? `
                                <div class="flex items-center gap-1">
                                    <input type="date" value="${state.perfStart}" onchange="state.perfStart=this.value; render()" class="w-32 bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                                    <span class="text-slate-400">-</span>
                                    <input type="date" value="${state.perfEnd}" onchange="state.perfEnd=this.value; render()" class="w-32 bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                                </div>
                            ` : ''}
                        </div>

                        <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex gap-1 shadow-inner">
                            <button onclick="state.perfTab='drivers'; render()" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${isDriver ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400 hover:text-indigo-500'} flex items-center gap-2">
                                <i class="ph-bold ph-steering-wheel"></i> Drivers
                            </button>
                            <button onclick="state.perfTab='vehicles'; render()" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${!isDriver ? 'bg-white dark:bg-slate-600 shadow text-emerald-600 dark:text-emerald-400' : 'text-slate-500 dark:text-slate-400 hover:text-emerald-500'} flex items-center gap-2">
                                <i class="ph-bold ph-truck"></i> Vehicles
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${isDriver
                    ? (drivers.length ? drivers.filter(d => {
                        // Optional: Hide drivers with 0 trips if desired? For now showing all filtered
                        return true;
                    }).map(renderDriverCard).join('') : `<div class="col-span-3 text-center py-12 text-slate-400">No driver data available.</div>`)
                    : (vehicles.length ? vehicles.map(v => renderVehicleCard(v.vehicleNumber || v.number)).join('') : `<div class="col-span-3 text-center py-12 text-slate-400">No vehicle data available.</div>`)
                }
                </div>
            </div>`;
        };



        const renderCFO = () => {
            // State Init
            if (!state.cfoDateType) state.cfoDateType = 'month';
            if (!state.cfoMonth) state.cfoMonth = new Date().toISOString().slice(0, 7);
            if (!state.cfoStart) state.cfoStart = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
            if (!state.cfoEnd) state.cfoEnd = new Date().toISOString().split('T')[0];

            // Helper to parse "₹ 1,200.00" strings to floats
            const parseAmount = (val) => {
                if (typeof val === 'number') return val;
                if (!val) return 0;
                return parseFloat(val.toString().replace(/[^0-9.-]/g, '')) || 0;
            };

            // Filter Helpers
            const filterByDate = (item, dateField = 'date') => {
                const d = item[dateField];
                if (!d) return false;
                if (state.cfoDateType === 'month') return d.startsWith(state.cfoMonth);
                return d >= state.cfoStart && d <= state.cfoEnd;
            };

            // 1. Data Aggregation
            const trips = (state.trips || []).filter(t => t.status === 'completed' && filterByDate(t));
            const fuel = (state.fuelLogs || []).filter(f => filterByDate(f));
            const maint = (state.maintenanceLogs || []).filter(m => filterByDate(m));
            const tolls = (state.tollLogs || []).filter(t => filterByDate(t));
            const police = (state.policeFines || []).filter(p => filterByDate(p));

            // Payroll Estimate (Naive: Pro-rated by month if in range? Or just full month if month view?)
            // For MVP, if Month view, show full payroll for that month. If custom, alert 'Payroll Hidden'.
            let payrollCost = 0;
            if (state.cfoDateType === 'month') {
                // Sum all payroll entries for this month
                // Assuming payroll structure: { id: 'YYYY-MM-DriverId', amount: 12000, ... }
                // Need to check actual structure. If unknown, use placeholder.
                Object.values(state.payroll || {}).forEach(p => {
                    if (p.month === state.cfoMonth) payrollCost += (parseAmount(p.netSalary) || 0);
                });
            }

            // Financials
            const revenue = trips.reduce((sum, t) => sum + (parseAmount(t.billAmount) || 0), 0);
            const kmRun = trips.reduce((sum, t) => {
                const dist = (t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0;
                return sum + (dist > 0 ? dist : 0);
            }, 0);

            // Expenses
            // Note: Fuel logs might miss price. Using average rate if price missing? 
            // Better: Sum only if price/amount exists. If 0, maybe user tracks litres only.
            // For now, assume 'amount' exists or user added it via approval.
            const fuelCost = fuel.reduce((sum, f) => sum + (parseAmount(f.amount) || 0), 0);
            const maintCost = maint.reduce((sum, m) => sum + (parseAmount(m.price) || parseAmount(m.amount) || parseAmount(m.totalCost) || 0), 0);
            const tollCost = tolls.reduce((sum, t) => sum + (parseAmount(t.amount) || 0), 0);
            const policeCost = police.reduce((sum, p) => sum + (parseAmount(p.amount) || 0), 0);

            const totalExpense = fuelCost + maintCost + tollCost + policeCost + payrollCost;
            const netProfit = revenue - totalExpense;
            const margin = revenue > 0 ? (netProfit / revenue) * 100 : 0;

            const costPerKm = kmRun > 0 ? (totalExpense / kmRun) : 0;
            const revPerKm = kmRun > 0 ? (revenue / kmRun) : 0;
            const totalLitres = fuel.reduce((sum, f) => sum + (parseAmount(f.litres) || 0), 0);
            const kmPerLiter = totalLitres > 0 ? (kmRun / totalLitres) : 0;
            const fuelCostPerKm = kmRun > 0 ? (fuelCost / kmRun) : 0;

            // Vehicle Profitability
            const vehStats = {};
            trips.forEach(t => {
                const v = t.truckNumber || t.vehicleNumber || 'Unknown';
                if (!vehStats[v]) vehStats[v] = { revenue: 0, km: 0, trips: 0 };
                vehStats[v].revenue += (parseAmount(t.billAmount) || 0);
                const dist = (parseInt(t.endOdo) - parseInt(t.startOdo)) || 0;
                vehStats[v].km += dist > 0 ? dist : 0;
                vehStats[v].trips++;
            });

            // Distribute Expenses to Vehicles
            // Fuel/Maint/Toll/Police usually have vehicleNumber
            fuel.forEach(f => { if (vehStats[f.vehicleNumber]) vehStats[f.vehicleNumber].fuel = (vehStats[f.vehicleNumber].fuel || 0) + (parseAmount(f.amount) || 0); });
            maint.forEach(m => { if (vehStats[m.vehicleNumber]) vehStats[m.vehicleNumber].maint = (vehStats[m.vehicleNumber].maint || 0) + (parseAmount(m.price) || 0); });

            // Convert to Array & Sort
            const vehRanking = Object.entries(vehStats).map(([v, s]) => {
                const specExpense = (s.fuel || 0) + (s.maint || 0); // Direct costs
                // Allocate shared costs (Payroll, etc) by Km ratio? For now just Direct Operating Profit
                const operatingProfit = s.revenue - specExpense;
                return { v, ...s, specExpense, operatingProfit };
            }).sort((a, b) => b.operatingProfit - a.operatingProfit);


            return `
            <div class="max-w-7xl mx-auto space-y-8 animate-fade-in pb-10">
                <!-- Header & Controls -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
                            <span class="p-2 bg-indigo-600 rounded-xl text-white shadow-lg shadow-indigo-500/30"><i class="ph-bold ph-chart-pie-slice"></i></span>
                            CFO Dashboard
                        </h1>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 font-medium">Financial Health & Profitability Analysis</p>
                    </div>

                    <div class="flex items-center gap-2 bg-white dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                        <select onchange="state.cfoDateType=this.value; render()" class="bg-indigo-50 dark:bg-indigo-900/20 border-none text-xs font-bold text-indigo-700 dark:text-indigo-300 rounded-lg p-2 focus:ring-0 cursor-pointer">
                            <option value="month" ${state.cfoDateType === 'month' ? 'selected' : ''}>Monthly View</option>
                            <option value="custom" ${state.cfoDateType === 'custom' ? 'selected' : ''}>Custom Range</option>
                        </select>
                        
                        ${state.cfoDateType === 'month' ? `
                            <input type="month" value="${state.cfoMonth}" onchange="state.cfoMonth=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs font-bold text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                        ` : `
                            <div class="flex items-center gap-1">
                                <input type="date" value="${state.cfoStart}" onchange="state.cfoStart=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs font-bold text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                                <span class="text-slate-400 font-bold">-</span>
                                <input type="date" value="${state.cfoEnd}" onchange="state.cfoEnd=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs font-bold text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                            </div>
                        `}
                         <button onclick="window.print()" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors" title="Print Report"><i class="ph-bold ph-printer text-lg"></i></button>
                    </div>
                </div>

                <!-- Executive Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-br from-indigo-500 to-violet-600 rounded-2xl p-6 text-white shadow-xl shadow-indigo-500/20 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><i class="ph-fill ph-trend-up text-8xl"></i></div>
                        <p class="text-indigo-100 text-xs font-bold uppercase tracking-wider mb-1">Total Revenue</p>
                        <h2 class="text-3xl font-bold mb-2">₹${revenue.toLocaleString()}</h2>
                        <div class="flex items-center gap-1 text-xs bg-white/20 w-fit px-2 py-1 rounded-lg backdrop-blur-sm">
                            <i class="ph-bold ph-truck"></i> ${new Set(trips.map(t => t.truckNumber)).size} Active Trucks
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group hover:border-rose-200 dark:hover:border-rose-800 transition-colors">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity"><i class="ph-fill ph-trend-down text-8xl text-rose-500"></i></div>
                        <p class="text-rose-500 text-xs font-bold uppercase tracking-wider mb-1">Total Expenses</p>
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">₹${totalExpense.toLocaleString()}</h2>
                         <p class="text-xs text-slate-400">Includes Fuel, Maint, Payroll</p>
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group ${netProfit > 0 ? 'hover:border-emerald-200 dark:hover:border-emerald-800' : 'hover:border-red-200'} transition-colors">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity"><i class="ph-fill ph-wallet text-8xl ${netProfit > 0 ? 'text-emerald-500' : 'text-red-500'}"></i></div>
                        <p class="${netProfit >= 0 ? 'text-emerald-500' : 'text-red-500'} text-xs font-bold uppercase tracking-wider mb-1">Net Profit</p>
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">₹${netProfit.toLocaleString()}</h2>
                        <div class="flex items-center gap-1 text-xs ${netProfit >= 0 ? 'text-emerald-600 bg-emerald-50 dark:bg-emerald-900/30' : 'text-red-600 bg-red-50'} w-fit px-2 py-1 rounded-lg">
                            ${margin.toFixed(1)}% Margin
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group hover:border-emerald-200 dark:hover:border-emerald-800 transition-colors">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity"><i class="ph-fill ph-drop text-8xl text-emerald-500"></i></div>
                        <p class="text-emerald-500 text-xs font-bold uppercase tracking-wider mb-1">KM Per Liter</p>
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">${kmPerLiter.toFixed(1)}<span class="text-sm text-slate-400 font-medium"> km/L</span></h2>
                        <p class="text-xs text-slate-400">Total Fuel: <span class="font-bold text-slate-600 dark:text-slate-300">${totalLitres} L</span></p>
                        <p class="text-xs text-slate-400 mt-0.5">Cost/Km: <span class="font-bold text-amber-600 dark:text-amber-400">₹${fuelCostPerKm.toFixed(2)}</span></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- P&L Statement -->
                    <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2"><i class="ph-fill ph-receipt text-indigo-500"></i> Profit & Loss Statement</h3>
                            <button class="text-xs font-bold text-indigo-600 hover:underline">Download PDF</button>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 dark:bg-slate-900/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold sticky top-0">
                                    <tr>
                                        <th class="p-4">Category</th>
                                        <th class="p-4 text-right">Amount</th>
                                        <th class="p-4 text-right w-24">% of Rev</th>
                                    </tr>
                                </thead>
                                <tbody class="text-sm divide-y divide-slate-100 dark:divide-slate-700">
                                    <tr class="bg-slate-50/50 dark:bg-slate-900/20 font-bold">
                                        <td class="p-4 text-slate-700 dark:text-slate-300">Total Revenue</td>
                                        <td class="p-4 text-right text-indigo-600 dark:text-indigo-400">₹${revenue.toLocaleString()}</td>
                                        <td class="p-4 text-right text-slate-400">100%</td>
                                    </tr>
                                    <!-- Expenses -->
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                        <td class="p-4 pl-8 text-slate-600 dark:text-slate-400 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-amber-500"></div> Fuel Expense</td>
                                        <td class="p-4 text-right text-slate-700 dark:text-slate-300">₹${fuelCost.toLocaleString()}</td>
                                        <td class="p-4 text-right text-slate-400">${revenue ? ((fuelCost / revenue) * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                        <td class="p-4 pl-8 text-slate-600 dark:text-slate-400 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-red-500"></div> Maintenance (Parts & Labor)</td>
                                        <td class="p-4 text-right text-slate-700 dark:text-slate-300">₹${maintCost.toLocaleString()}</td>
                                        <td class="p-4 text-right text-slate-400">${revenue ? ((maintCost / revenue) * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                        <td class="p-4 pl-8 text-slate-600 dark:text-slate-400 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Driver Payroll (Est)</td>
                                        <td class="p-4 text-right text-slate-700 dark:text-slate-300">₹${payrollCost.toLocaleString()}</td>
                                        <td class="p-4 text-right text-slate-400">${revenue ? ((payrollCost / revenue) * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                        <td class="p-4 pl-8 text-slate-600 dark:text-slate-400 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-slate-400"></div> Tolls & Fines</td>
                                        <td class="p-4 text-right text-slate-700 dark:text-slate-300">₹${(tollCost + policeCost).toLocaleString()}</td>
                                        <td class="p-4 text-right text-slate-400">${revenue ? (((tollCost + policeCost) / revenue) * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr class="bg-slate-50/80 dark:bg-slate-700/50 font-bold border-t-2 border-slate-200 dark:border-slate-600">
                                        <td class="p-4 text-slate-800 dark:text-white">Total Operating Expense</td>
                                        <td class="p-4 text-right text-rose-600 dark:text-rose-400">₹${totalExpense.toLocaleString()}</td>
                                        <td class="p-4 text-right text-slate-400">${revenue ? ((totalExpense / revenue) * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr class="bg-indigo-50 dark:bg-indigo-900/20 font-bold text-lg">
                                        <td class="p-4 text-indigo-900 dark:text-indigo-100">Net Profit</td>
                                        <td class="p-4 text-right text-emerald-600 dark:text-emerald-400">₹${netProfit.toLocaleString()}</td>
                                        <td class="p-4 text-right text-emerald-600 dark:text-emerald-400">${margin.toFixed(1)}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Cost Composition Chart -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 flex flex-col">
                        <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-chart-pie text-indigo-500"></i> Expense Breakdown</h3>
                        
                         <div class="flex-1 flex flex-col justify-center items-center relative min-h-[200px]">
                            ${totalExpense > 0 ? `
                             <!-- CSS Donut Chart approximation or just bars -->
                             <div class="flex items-end gap-4 h-48 w-full px-4 border-b border-slate-200 dark:border-slate-700">
                                <div class="flex-1 flex flex-col items-center gap-2 group">
                                    <div class="w-full bg-amber-500 rounded-t-lg transition-all group-hover:opacity-90 relative" style="height: ${(fuelCost / totalExpense) * 100}%">
                                        <span class="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-amber-600 bg-amber-50 px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">₹${(fuelCost / 1000).toFixed(1)}k</span>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-500 uppercase">Fuel</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center gap-2 group">
                                    <div class="w-full bg-red-500 rounded-t-lg transition-all group-hover:opacity-90 relative" style="height: ${(maintCost / totalExpense) * 100}%">
                                        <span class="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-red-600 bg-red-50 px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">₹${(maintCost / 1000).toFixed(1)}k</span>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-500 uppercase">Maint</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center gap-2 group">
                                    <div class="w-full bg-blue-500 rounded-t-lg transition-all group-hover:opacity-90 relative" style="height: ${(payrollCost / totalExpense) * 100}%">
                                         <span class="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-blue-600 bg-blue-50 px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">₹${(payrollCost / 1000).toFixed(1)}k</span>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-500 uppercase">Staff</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center gap-2 group">
                                    <div class="w-full bg-slate-400 rounded-t-lg transition-all group-hover:opacity-90 relative" style="height: ${((tollCost + policeCost) / totalExpense) * 100}%">
                                         <span class="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-slate-600 bg-slate-100 px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">₹${((tollCost + policeCost) / 1000).toFixed(1)}k</span>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-500 uppercase">Other</span>
                                </div>
                             </div>
                            ` : `
                            <div class="text-center py-10">
                                <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400">
                                    <i class="ph-bold ph-chart-bar text-2xl"></i>
                                </div>
                                <p class="text-slate-500 dark:text-slate-400 font-medium">No Expense Data Available</p>
                                <p class="text-xs text-slate-400 mt-1">Add expenses or adjust the date filter.</p>
                            </div>
                            `}
                        </div>
                    </div>
                </div>

                <!-- Vehicle Profitability Table -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                        <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2"><i class="ph-fill ph-trophy text-amber-500"></i> Vehicle Profitability Ranking</h3>
                        <p class="text-xs text-slate-400 mt-1">Ranked by Operating Profit (Revenue - Direct Fuel/Maint Costs)</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 dark:bg-slate-900/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4">Rank</th>
                                    <th class="p-4">Vehicle</th>
                                    <th class="p-4 text-right">Trips</th>
                                    <th class="p-4 text-right">Km Run</th>
                                    <th class="p-4 text-right">Revenue</th>
                                    <th class="p-4 text-right">Direct Exp</th>
                                    <th class="p-4 text-right">Op. Profit</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${vehRanking.map((v, i) => `
                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group">
                                    <td class="p-4 text-slate-400 font-bold">#${i + 1}</td>
                                    <td class="p-4 font-bold text-slate-800 dark:text-white">${v.v}</td>
                                    <td class="p-4 text-right text-slate-600 dark:text-slate-400 font-mono">${v.trips}</td>
                                    <td class="p-4 text-right text-slate-600 dark:text-slate-400 font-mono">${v.km}</td>
                                    <td class="p-4 text-right text-indigo-600 dark:text-indigo-400 font-bold font-mono">₹${v.revenue.toLocaleString()}</td>
                                    <td class="p-4 text-right text-rose-500 font-mono">₹${v.specExpense.toLocaleString()}</td>
                                    <td class="p-4 text-right font-bold font-mono ${v.operatingProfit > 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600'}">
                                        ₹${v.operatingProfit.toLocaleString()}
                                    </td>
                                </tr>
                                `).join('')}
                                ${vehRanking.length === 0 ? '<tr><td colspan="7" class="p-8 text-center text-slate-400 italic">No vehicle data for this period</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };



        window.exportToExcel = () => {
            // Re-apply filters
            const trips = getFilteredData(state.trips);
            let reportTrips = trips.filter(t => t.status === 'completed');

            if (state.reportDateFilterType === 'day') {
                reportTrips = reportTrips.filter(t => t.date === state.reportDate);
            } else if (state.reportDateFilterType === 'month') {
                reportTrips = reportTrips.filter(t => t.date && t.date.startsWith(state.reportMonth));
            } else if (state.reportDateFilterType === 'custom') {
                reportTrips = reportTrips.filter(t => t.date >= state.reportStart && t.date <= state.reportEnd);
            }

            // Driver Filter
            if (state.reportDriverFilter && state.reportDriverFilter !== 'All') {
                reportTrips = reportTrips.filter(t => t.driverName === state.reportDriverFilter);
            }

            // Truck Filter
            if (state.reportTruckFilter && state.reportTruckFilter !== 'All') {
                reportTrips = reportTrips.filter(t => t.truckNumber === state.reportTruckFilter);
            }

            // Filter by Trip Type
            const displayTrips = state.reportFilter === 'All'
                ? reportTrips
                : reportTrips.filter(t => t.tripType === state.reportFilter);

            if (displayTrips.length === 0) return alert("No data to export.");

            // Build CSV Content
            let csvContent = "data:text/csv;charset=utf-8,";
            // Header - Updated order to match screenshot
            csvContent += "Sl No,Fb Date,Vehicle,Chassis No,Customer Name,Pick From,Drop To,Reefer By,Int/Cus,Driver Name,Starting Km,Closing Km,Trip Km,Starting Time,Ending Time,Duration (min)\n";

            // Rows
            displayTrips.forEach((t, index) => {
                const start = t.startTime?.seconds ? new Date(t.startTime.seconds * 1000) : null;
                const end = t.endTime?.seconds ? new Date(t.endTime.seconds * 1000) : null;
                const duration = start && end ? Math.round((end - start) / 60000) : 0;
                const km = (t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0;
                const fmtTime = (d) => d ? d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-';

                // Escape fields that might contain commas
                const escape = (val) => `"${(val || '').toString().replace(/"/g, '""')}"`;

                const row = [
                    index + 1, // Sl No
                    escape(t.date.split('-').reverse().join('-')), // Fb Date
                    escape(t.truckNumber), // Vehicle
                    escape(t.chassisNo || t.vehicleNumber || '-'), // Chassis No
                    escape(t.customerName || '-'), // Customer Name
                    escape(t.pickupLocation), // Pick From
                    escape(t.dropLocation), // Drop To
                    escape(t.reeferBy || '-'), // Reefer By
                    escape(t.tripType || '-'), // Int/Cus
                    escape(t.driverName), // Driver Name
                    escape(t.startOdo || '-'), // Starting Km
                    escape(t.endOdo || '-'), // Closing Km
                    km, // Trip Km
                    escape(fmtTime(start)), // Starting Time
                    escape(fmtTime(end)), // Ending Time
                    duration // Duration (min)
                ].join(",");
                csvContent += row + "\r\n";
            });

            // Trigger Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `Daily_Report_${state.reportDateFilterType}_${new Date().toISOString().slice(0, 10)}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const renderReports = () => {
            // Initialize report filter state if not set
            if (!state.reportDateFilterType) state.reportDateFilterType = 'day';
            if (!state.reportDate) state.reportDate = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0];
            if (!state.reportMonth) state.reportMonth = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 7);
            if (!state.reportStart) state.reportStart = new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0]; // Simple logical date math is fine here as it's relative
            if (!state.reportEnd) state.reportEnd = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0];

            const trips = getFilteredData(state.trips);

            // Filter Logic
            let reportTrips = trips.filter(t => t.status === 'completed');

            if (state.reportDateFilterType === 'day') {
                reportTrips = reportTrips.filter(t => t.date === state.reportDate);
            } else if (state.reportDateFilterType === 'month') {
                reportTrips = reportTrips.filter(t => t.date && t.date.startsWith(state.reportMonth));
            } else if (state.reportDateFilterType === 'custom') {
                reportTrips = reportTrips.filter(t => t.date >= state.reportStart && t.date <= state.reportEnd);
            }

            // Initialize Filter States if unused
            if (!state.reportDriverFilter) state.reportDriverFilter = 'All';
            if (!state.reportTruckFilter) state.reportTruckFilter = 'All';

            // Apply Driver Filter
            if (state.reportDriverFilter !== 'All') {
                reportTrips = reportTrips.filter(t => t.driverName === state.reportDriverFilter);
            }

            // Apply Truck Filter
            if (state.reportTruckFilter !== 'All') {
                reportTrips = reportTrips.filter(t => t.truckNumber === state.reportTruckFilter);
            }

            // Calculate breakdown counts
            const counts = {
                'All': reportTrips.length,
                'TVS': reportTrips.filter(t => t.tripType === 'TVS').length,
                'INT': reportTrips.filter(t => t.tripType === 'INT').length,
                'Empty': reportTrips.filter(t => t.tripType === 'Empty').length
            };

            // Filter by Trip Type for Table Display
            const displayTrips = state.reportFilter === 'All'
                ? reportTrips
                : reportTrips.filter(t => t.tripType === state.reportFilter);

            let totalKm = 0;
            let totalMinutes = 0;

            const rows = displayTrips.map(t => {
                const start = t.startTime?.seconds ? new Date(t.startTime.seconds * 1000) : null;
                const end = t.endTime?.seconds ? new Date(t.endTime.seconds * 1000) : null;
                const duration = start && end ? Math.round((end - start) / 60000) : 0; // minutes
                const km = (t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0;

                totalKm += km > 0 ? km : 0;
                totalMinutes += duration > 0 ? duration : 0;

                const durationStr = duration > 60 ? `${Math.floor(duration / 60)}h ${duration % 60}m` : `${duration}m`;
                const fmtTime = (d) => d ? d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-';

                return `
                    <tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                        <td class="p-4 font-bold text-slate-700 dark:text-slate-300">${t.truckNumber}</td>
                        <td class="p-4 text-slate-500 dark:text-slate-400 font-mono text-xs whitespace-nowrap">${t.date.split('-').reverse().join('-')}</td>
                        <td class="p-4 text-slate-600 dark:text-slate-400 font-mono text-sm">${t.driverName}</td>
                        <td class="p-4 text-slate-600 dark:text-slate-400 font-mono text-xs uppercase tracking-wider">${t.vehicleNumber || '-'}</td>
                        <td class="p-4 text-slate-500 dark:text-slate-400 font-mono text-xs whitespace-nowrap">${fmtTime(start)} - ${fmtTime(end)}</td>
                        <td class="p-4 text-slate-500 dark:text-slate-400 font-mono text-xs whitespace-nowrap">${t.startOdo} - ${t.endOdo || '-'}</td>
                        <td class="p-4 text-slate-600 dark:text-slate-400 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="truncate max-w-[150px] text-xs" title="${t.pickupLocation}">${t.pickupLocation}</span>
                                <i class="ph-bold ph-arrow-right text-[10px] text-slate-300"></i>
                                <span class="truncate max-w-[150px] text-xs" title="${t.dropLocation}">${t.dropLocation}</span>
                            </div>
                        </td>
                        <td class="p-4 text-right font-mono text-slate-700 dark:text-slate-300 font-bold">${km} km</td>
                        <td class="p-4 text-right font-mono text-slate-700 dark:text-slate-300 font-bold">${durationStr}</td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${t.tripType === 'TVS' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' : (t.tripType === 'INT' ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400' : 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400')}">${t.tripType || 'Reg'}</span>
                        </td>
                        <td class="p-4 text-right whitespace-nowrap">
                             <div class="flex justify-end gap-2">
                                <button onclick="openViewTripModal('${t.id}')" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/50 rounded-lg transition-colors" title="View Details">
                                    <i class="ph-bold ph-eye text-lg"></i>
                                </button>
                                ${t.hasPendingChanges ? `
                                <button onclick="openReviewTripModal('${t.id}')" class="p-2 bg-amber-100 text-amber-600 hover:bg-amber-200 rounded-lg transition-colors flex items-center gap-1" title="Review Pending Changes">
                                    <i class="ph-bold ph-warning-circle text-lg"></i> <span class="text-xs font-bold">Review</span>
                                </button>
                                ` : `
                                <button onclick="openEditTripModal('${t.id}')" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/50 rounded-lg transition-colors" title="Edit Trip">
                                    <i class="ph-bold ph-pencil-simple text-lg"></i>
                                </button>
                                `}
                                <button onclick="softDeleteTrip('${t.id}', 'ams_trips')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 rounded-lg transition-colors" title="Delete Trip">
                                    <i class="ph-bold ph-trash text-lg"></i>
                                </button>
                             </div>
                        </td>
                    </tr>
                `;
            }).join('');

            const totalHoursStr = totalMinutes > 60 ? `${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m` : `${totalMinutes}m`;

            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            let dateLabel = state.reportDate;
            if (state.reportDateFilterType === 'month') dateLabel = state.reportMonth;
            if (state.reportDateFilterType === 'custom') dateLabel = `${state.reportStart} to ${state.reportEnd}`;

            return `
            <div class="space-y-6 animate-fade-in">
                 <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">Daily Reports</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Detailed operational breakdown for <span class="font-mono font-bold text-slate-700 dark:text-slate-300">${dateLabel}</span></p>
                    </div>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex bg-slate-100 dark:bg-slate-700/50 p-1 rounded-xl">
                            ${['All', 'TVS', 'INT', 'Empty'].map(filter => `
                                <button onclick="state.reportFilter='${filter}'; render()" 
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${state.reportFilter === filter ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}">
                                    ${filter}
                                </button>
                            `).join('')}
                        </div>

                         <!-- Date Filters -->
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <select onchange="state.reportDateFilterType=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs font-bold text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0 cursor-pointer">
                                <option value="day" ${state.reportDateFilterType === 'day' ? 'selected' : ''}>Day View</option>
                                <option value="month" ${state.reportDateFilterType === 'month' ? 'selected' : ''}>Month View</option>
                                <option value="custom" ${state.reportDateFilterType === 'custom' ? 'selected' : ''}>Custom Range</option>
                            </select>
                            
                            <!-- Day Picker -->
                            ${state.reportDateFilterType === 'day' ? `
                                <input type="date" value="${state.reportDate}" onchange="state.reportDate=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                            ` : ''}

                            <!-- Month Picker -->
                             ${state.reportDateFilterType === 'month' ? `
                                <input type="month" value="${state.reportMonth}" onchange="state.reportMonth=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                            ` : ''}

                            <!-- Custom Range -->
                            ${state.reportDateFilterType === 'custom' ? `
                                <div class="flex items-center gap-1">
                                    <input type="date" value="${state.reportStart}" onchange="state.reportStart=this.value; render()" class="w-32 bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                                    <span class="text-slate-400">-</span>
                                    <input type="date" value="${state.reportEnd}" onchange="state.reportEnd=this.value; render()" class="w-32 bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                                </div>
                            ` : ''}
                        </div>

                        <!-- Driver & Truck Filters -->
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <select onchange="state.reportTruckFilter=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0 w-32 truncate">
                                <option value="All">All Trucks</option>
                                ${getFilteredData(state.vehicles).map(v => `<option value="${v.vehicleNumber || v.number}" ${state.reportTruckFilter === (v.vehicleNumber || v.number) ? 'selected' : ''}>${v.vehicleNumber || v.number}</option>`).join('')}
                            </select>

                            <select onchange="state.reportDriverFilter=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0 w-32 truncate">
                                <option value="All">All Drivers</option>
                                ${getFilteredData(state.drivers).map(d => `<option value="${d.name}" ${state.reportDriverFilter === d.name ? 'selected' : ''}>${d.name}</option>`).join('')}
                            </select>
                        </div>

                        <button onclick="window.exportToExcel()" class="px-3 py-2 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded-xl font-bold transition-all active:scale-95 flex items-center gap-2 text-xs border border-emerald-200">
                             <i class="ph-bold ph-microsoft-excel-logo text-lg"></i> Export Excel
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-100 dark:border-blue-800/30 flex flex-col justify-between h-24">
                        <div class="flex justify-between items-start">
                             <span class="text-[10px] font-bold uppercase text-blue-500 dark:text-blue-400 tracking-wider">TVS Trips</span>
                             <i class="ph-fill ph-steering-wheel text-blue-400 dark:text-blue-300 text-lg"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white">${counts['TVS']}</p>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-2xl border border-purple-100 dark:border-purple-800/30 flex flex-col justify-between h-24">
                        <div class="flex justify-between items-start">
                             <span class="text-[10px] font-bold uppercase text-purple-500 dark:text-purple-400 tracking-wider">INT Trips</span>
                             <i class="ph-fill ph-circles-three-plus text-purple-400 dark:text-purple-300 text-lg"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white">${counts['INT']}</p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24">
                        <div class="flex justify-between items-start">
                             <span class="text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 tracking-wider">Empty</span>
                             <i class="ph-fill ph-arrow-u-down-left text-slate-400 text-lg"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white">${counts['Empty']}</p>
                    </div>
                     <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24">
                        <div class="flex justify-between items-start">
                             <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Total</span>
                             <i class="ph-fill ph-sigma text-slate-300 text-lg"></i>
                        </div>
                        <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${counts['All']}</p>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Truck</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Date</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Driver</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Veh. No</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Time</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Odo</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Route</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Dist.</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Dur.</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-center">Type</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                ${rows || '<tr><td colspan="11" class="p-8 text-center text-slate-400">No completed trips found for this filter.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };



        const renderLocations = () => {
            const locations = getFilteredData(state.locations);

            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            return `
            <div class="h-full flex flex-col space-y-6">
                <!-- Header Section with Gradient -->
                <div class="relative overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 p-6 md:p-8">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-50 dark:bg-indigo-900/20 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                    <div class="relative flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2 flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center shadow-lg shadow-indigo-500/30">
                                    <i class="ph-fill ph-map-pin text-xl"></i>
                                </div>
                                Locations
                            </h2>
                            <p class="text-slate-500 dark:text-slate-400 font-medium">Manage pickup points for <span class="text-indigo-600 dark:text-indigo-400 font-bold">${displayBranch}</span></p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="window.seedDatabase('locations')" class="px-4 py-2.5 bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-600 rounded-xl text-sm font-bold transition-all hover:bg-slate-50 dark:hover:bg-slate-600 active:scale-95 flex items-center gap-2 shadow-sm">
                                <i class="ph-bold ph-cloud-arrow-up text-lg"></i> Sync Data
                            </button>
                            <button onclick="openLocationModal()" class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center gap-2">
                                <i class="ph-bold ph-plus text-lg"></i> Add Location
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Locations Table Card -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-200 dark:border-slate-700 overflow-hidden flex-1 flex flex-col">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/50 dark:bg-slate-700/30 border-b border-slate-100 dark:border-slate-700">
                                    <th class="p-5 pl-8 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Location Details</th>
                                    <th class="p-5 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Branch</th>
                                    <th class="p-5 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</th>
                                    <th class="p-5 pr-8 text-right text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${locations.length === 0 ? `
                                    <tr>
                                        <td colspan="4" class="p-12 text-center">
                                            <div class="flex flex-col items-center justify-center opacity-50">
                                                <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mb-4">
                                                    <i class="ph-duotone ph-map-pin text-3xl text-slate-400"></i>
                                                </div>
                                                <p class="text-slate-500 dark:text-slate-400 font-medium">No locations found</p>
                                                <button onclick="openLocationModal()" class="mt-4 text-indigo-600 font-bold hover:underline">Add your first location</button>
                                            </div>
                                        </td>
                                    </tr>` :
                    locations.map(l => `
                                    <tr class="group hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors even:bg-slate-100 dark:even:bg-slate-800/50">
                                        <td class="p-5 pl-8">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-12 rounded-2xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition-transform duration-300">
                                                    <i class="ph-fill ph-map-pin"></i>
                                                </div>
                                                <div>
                                                    <h3 class="font-bold text-slate-800 dark:text-white text-base">${l.name}</h3>
                                                    <p class="text-xs text-slate-400 dark:text-slate-500 font-mono mt-0.5">ID: ${l.id}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="p-5">
                                            <div class="flex flex-wrap gap-1.5">
                                                ${(l.branches && l.branches.length > 0 ? l.branches : [l.branch || 'All']).map(b => `
                                                <div class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50">
                                                    <i class="ph-bold ph-buildings text-slate-400 text-xs shadow-none"></i>
                                                    <span class="text-xs font-bold text-slate-600 dark:text-slate-300">${b}</span>
                                                </div>
                                                `).join('')}
                                            </div>
                                        </td>
                                        <td class="p-5">
                                            <div class="inline-flex items-center gap-2">
                                                <span class="relative flex h-2.5 w-2.5">
                                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full ${l.status === 'Inactive' ? 'bg-slate-400' : 'bg-green-400'} opacity-75"></span>
                                                  <span class="relative inline-flex rounded-full h-2.5 w-2.5 ${l.status === 'Inactive' ? 'bg-slate-500' : 'bg-green-500'}"></span>
                                                </span>
                                                <span class="text-sm font-bold ${l.status === 'Inactive' ? 'text-slate-500' : 'text-green-600 dark:text-green-400'}">
                                                    ${l.status || 'Active'}
                                                </span>
                                            </div>
                                        </td>
                                        <td class="p-5 pr-8 text-right">
                                            <div class="flex items-center justify-end gap-2">
                                                <button onclick="openLocationModal('${l.id}')" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/50 rounded-xl transition-all" title="Edit">
                                                    <i class="ph-bold ph-pencil-simple text-lg"></i>
                                                </button>
                                                <button onclick="deleteLocation('${l.id}')" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 rounded-xl transition-all" title="Delete">
                                                    <i class="ph-bold ph-trash text-lg"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        const renderLocationModal = () => {
            if (state.modal !== 'location') return '';
            const l = state.editLocation || {};
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">${l.id ? 'Edit Location' : 'Add New Location'}</h2>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <form onsubmit="saveLocation(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Location Name</label>
                            <input type="text" name="name" value="${l.name || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required placeholder="e.g. Coimbatore, Tiruppur">
                        </div>
                        <div>

                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-2">Branches</label>
                            <div class="grid grid-cols-2 gap-3">
                                ${['Coimbatore', 'Trichy', 'Salem', 'Kumbakonam', 'All'].map(b => {
                const isChecked = l.branches ? l.branches.includes(b) : (l.branch === b || (!l.branch && b === 'All'));
                return `
                                    <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer transition-colors ${isChecked ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800' : ''}">
                                        <input type="checkbox" name="branches" value="${b}" ${isChecked ? 'checked' : ''} class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-bold text-slate-700 dark:text-slate-200">${b}</span>
                                    </label>
                                    `;
            }).join('')}
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 italic">Select 'All' to make this location available to everyone, or select specific branches.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Status</label>
                            <select name="status" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                                <option value="Active" ${l.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${l.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/30">
                            ${l.id ? 'Save Changes' : 'Add Location'}
                        </button>
                    </form>
                </div>
            </div > `;
        };

        const renderDriverModal = () => {
            if (state.modal !== 'driver') return '';
            const d = state.editDriver || {};
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">${d.id ? 'Edit Driver' : 'Add New Driver'}</h2>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <form onsubmit="saveDriver(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Full Name</label>
                            <input type="text" name="name" value="${d.name || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Phone Number</label>
                            <input type="tel" name="phone" value="${d.phone || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-400 mb-1">License Number</label>
                                <input type="text" name="licenseNumber" value="${d.licenseNumber || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-400 mb-1">License Expiry</label>
                                <input type="date" name="licenseExpiry" value="${d.licenseExpiry || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Branch</label>
                            <select name="branch" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" ${state.user.role !== 'superadmin' ? 'disabled' : ''}>
                                <option value="Coimbatore" ${d.branch === 'Coimbatore' || (!d.branch && state.user.branch === 'Coimbatore') ? 'selected' : ''}>Coimbatore</option>
                                <option value="Trichy" ${d.branch === 'Trichy' || (state.user.branch === 'Trichy') ? 'selected' : ''}>Trichy</option>
                                <option value="Salem" ${d.branch === 'Salem' || (state.user.branch === 'Salem') ? 'selected' : ''}>Salem</option>
                                <option value="Kumbakonam" ${d.branch === 'Kumbakonam' || (state.user.branch === 'Kumbakonam') ? 'selected' : ''}>Kumbakonam</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Status</label>
                            <select name="status" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                                <option value="Active" ${d.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${d.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/30">
                            ${d.id ? 'Save Changes' : 'Add Driver'}
                        </button>
                    </form>
                </div>
            </div > `;
        }

        const renderVehicleModal = () => {
            if (state.modal !== 'vehicle') return '';
            const v = state.editVehicle || {};
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">${v.id ? 'Edit Vehicle' : 'Add New Vehicle'}</h2>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <form onsubmit="saveVehicle(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Vehicle Number</label>
                            <input type="text" name="vehicleNumber" value="${v.vehicleNumber || v.number || ''}" placeholder="TN 38 DJ 1234" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white font-mono uppercase" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Make</label>
                                <input type="text" name="make" value="${v.make || ''}" placeholder="e.g. Tata" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Model</label>
                                <input type="text" name="model" value="${v.model || ''}" placeholder="e.g. 1109" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Branch</label>
                            <select name="branch" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" ${state.user.role !== 'superadmin' ? 'disabled' : ''}>
                                <option value="Coimbatore" ${v.branch === 'Coimbatore' || (!v.branch && state.user.branch === 'Coimbatore') ? 'selected' : ''}>Coimbatore</option>
                                <option value="Trichy" ${v.branch === 'Trichy' || (state.user.branch === 'Trichy') ? 'selected' : ''}>Trichy</option>
                                <option value="Salem" ${v.branch === 'Salem' || (state.user.branch === 'Salem') ? 'selected' : ''}>Salem</option>
                                <option value="Kumbakonam" ${v.branch === 'Kumbakonam' || (state.user.branch === 'Kumbakonam') ? 'selected' : ''}>Kumbakonam</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Current Odometer</label>
                            <input type="number" name="odometer" value="${v.odometer || ''}" placeholder="e.g. 50000" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Type</label>
                            <select name="type" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                                <option value="Truck" ${v.type === 'Truck' ? 'selected' : ''}>Truck</option>
                                <option value="Van" ${v.type === 'Van' ? 'selected' : ''}>Van</option>
                                <option value="Car" ${v.type === 'Car' ? 'selected' : ''}>Car</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Status</label>
                            <select name="status" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                                <option value="Active" ${v.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Maintenance" ${v.status === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                                <option value="Inactive" ${v.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/30">
                            ${v.id ? 'Save Changes' : 'Add Vehicle'}
                        </button>
                    </form>
                </div>
            </div > `;
        }

        const renderAllowanceModal = () => {
            if (state.modal !== 'allowance') return '';
            const driverName = state.selectedAllowanceDriver;
            const month = state.selectedAllowanceMonth;
            const entries = state.allowanceEntries || [];
            const total = entries.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                        <div>
                           <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                             <i class="ph-fill ph-money text-amber-500"></i> Manage Allowance
                           </h2>
                           <p class="text-xs text-slate-500 font-medium">${driverName} - ${month}</p>
                        </div>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-500 hover:bg-red-100 hover:text-red-500 transition-colors flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto space-y-4">
                        <!-- Add Form -->
                        <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800/50">
                            <h3 class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest mb-3">Add Entry</h3>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Start Date</label>
                                    <input type="date" id="new-allowance-start" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">End Date</label>
                                    <input type="date" id="new-allowance-end" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <div class="flex-1">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Amount (₹)</label>
                                    <input type="number" id="new-allowance-amount" placeholder="0" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <button onclick="window.addAllowanceEntry()" class="mt-5 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm transition-all active:scale-95 flex items-center gap-1">
                                    <i class="ph-bold ph-plus"></i> Add
                                </button>
                            </div>
                        </div>

                        <!-- Entries List -->
                        <div class="space-y-2">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-1">Allowance Entries</h3>
                            ${entries.length === 0 ? `
                                <div class="text-center py-8 opacity-50 italic text-sm">No entries added yet</div>
                            ` : entries.map((e, i) => `
                                <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-700/50 border border-slate-100 dark:border-slate-700 rounded-xl group hover:border-indigo-200 dark:hover:border-indigo-800 transition-all">
                                    <div>
                                        <p class="text-sm font-bold text-slate-700 dark:text-slate-200">₹${Number(e.amount).toLocaleString()}</p>
                                        <p class="text-[11px] text-slate-500 dark:text-slate-400 italic">${e.startDate} to ${e.endDate}</p>
                                    </div>
                                    <button onclick="window.deleteAllowanceEntry(${i})" class="w-8 h-8 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 flex items-center justify-center transition-colors">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="p-5 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center whitespace-nowrap">
                        <div class="text-sm font-bold text-slate-500">Total Allowance</div>
                        <div class="text-xl font-bold text-amber-600 dark:text-amber-400">₹${total.toLocaleString()}</div>
                    </div>
                </div>
            </div>`;
        }

        const renderSalaryModal = () => {
            if (state.modal !== 'salary') return '';
            const driverName = state.selectedSalaryDriver;
            const month = state.selectedSalaryMonth;
            const entries = state.salaryEntries || [];
            const total = entries.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                        <div>
                           <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                             <i class="ph-fill ph-wallet text-indigo-500"></i> Manage Salary
                           </h2>
                           <p class="text-xs text-slate-500 font-medium">${driverName} - ${month}</p>
                        </div>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-500 hover:bg-red-100 hover:text-red-500 transition-colors flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto space-y-4">
                        <!-- Add Form -->
                        <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800/50">
                            <h3 class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest mb-3">Add Entry</h3>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Start Date</label>
                                    <input type="date" id="new-salary-start" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">End Date</label>
                                    <input type="date" id="new-salary-end" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <div class="flex-1">
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Amount (₹)</label>
                                    <input type="number" id="new-salary-amount" placeholder="0" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <button onclick="window.addSalaryEntry()" class="mt-5 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm transition-all active:scale-95 flex items-center gap-1">
                                    <i class="ph-bold ph-plus"></i> Add
                                </button>
                            </div>
                        </div>

                        <!-- Entries List -->
                        <div class="space-y-2">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-1">Salary Entries</h3>
                            ${entries.length === 0 ? `
                                <div class="text-center py-8 opacity-50 italic text-sm">No entries added yet</div>
                            ` : entries.map((e, i) => `
                                <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-700/50 border border-slate-100 dark:border-slate-700 rounded-xl group hover:border-indigo-200 dark:hover:border-indigo-800 transition-all">
                                    <div>
                                        <p class="text-sm font-bold text-slate-700 dark:text-slate-200">₹${Number(e.amount).toLocaleString()}</p>
                                        <p class="text-[11px] text-slate-500 dark:text-slate-400 italic">${e.startDate} to ${e.endDate}</p>
                                    </div>
                                    <button onclick="window.deleteSalaryEntry(${i})" class="w-8 h-8 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 flex items-center justify-center transition-colors">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="p-5 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center whitespace-nowrap">
                        <div class="text-sm font-bold text-slate-500">Total Salary</div>
                        <div class="text-xl font-bold text-indigo-600 dark:text-indigo-400">₹${total.toLocaleString()}</div>
                    </div>
                </div>
            </div>`;
        }



        const renderDrivers = () => {
            const drivers = getFilteredData(state.drivers);
            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-white">Driver Management</h2>
                     <div class="flex gap-2">
                        <button onclick="window.seedDatabase('drivers')" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-300 rounded-xl text-sm font-bold transition-colors flex items-center gap-2">
                            <i class="ph-bold ph-cloud-arrow-up"></i> Sync Data
                        </button>
                        <button onclick="openDriverModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold transition-colors flex items-center gap-2 shadow-lg shadow-indigo-500/30">
                            <i class="ph-bold ph-plus"></i> Add Driver
                        </button>
                     </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Name</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Phone</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Branch</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">License Exp</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Status</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            ${drivers.map(d => `
                                <tr class="border-b border-slate-100 dark:border-slate-700 even:bg-slate-100 dark:even:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group">
                                    <td class="p-4 font-bold text-slate-700 dark:text-slate-300 flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-600 flex items-center justify-center text-xs text-slate-500 dark:text-slate-300">${d.name.slice(0, 2)}</div>
                                        ${d.name}
                                    </td>
                                    <td class="p-4 text-slate-600 dark:text-slate-400 font-mono">${d.phone}</td>
                                    <td class="p-4">
                                        <div class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50">
                                            <i class="ph-bold ph-buildings text-slate-400 text-xs"></i>
                                            <span class="text-xs font-bold text-slate-600 dark:text-slate-300">${d.branch || 'Coimbatore'}</span>
                                        </div>
                                    </td>
                                    <td class="p-4 text-slate-600 dark:text-slate-400">${d.licenseExpiry || 'N/A'}</td>
                                    <td class="p-4">
                                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${d.status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}">${d.status || 'Active'}</span>
                                    </td>
                                    <td class="p-4 text-right">
                                        <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onclick="openDriverModal('${d.id}')" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                                <i class="ph-bold ph-pencil-simple"></i>
                                            </button>
                                            <button onclick="deleteDriver('${d.id}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete Driver">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                            <button onclick="resetDriverTrips('${d.id}')" class="p-2 text-slate-400 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors" title="Reset Driver Trips">
                                                <i class="ph-bold ph-clock-counter-clockwise"></i>
                                            </button>
                                            <button onclick="openCredentialsModal('${d.id}')" class="p-2 text-slate-400 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-colors" title="Manage Credentials">
                                                <i class="ph-bold ph-key"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        };

        const renderVehicles = () => {
            const vehicles = getFilteredData(state.vehicles);

            return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Vehicle Management</h2>
                     <div class="flex gap-2">
                        <button onclick="window.seedDatabase('models')" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-300 rounded-xl text-sm font-bold transition-colors flex items-center gap-2">
                            <i class="ph-bold ph-car"></i> Sync Models
                        </button>
                        <button onclick="window.seedDatabase('vehicles')" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-300 rounded-xl text-sm font-bold transition-colors flex items-center gap-2">
                           <i class="ph-bold ph-cloud-arrow-up"></i> Sync Vehicles
                        </button>
                        <button onclick="openVehicleModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold transition-colors flex items-center gap-2 shadow-lg shadow-indigo-500/30">
                            <i class="ph-bold ph-plus"></i> Add Vehicle
                        </button>
                     </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${vehicles.map(v => `
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition-all group relative">
                            <div class="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openVehicleModal('${v.id}')" class="p-2 bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-indigo-600 rounded-lg"><i class="ph-bold ph-pencil-simple"></i></button>
                                <button onclick="deleteVehicle('${v.id}')" class="p-2 bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-600 rounded-lg"><i class="ph-bold ph-trash"></i></button>
                            </div>
                            <div class="flex justify-between items-start mb-6">
                                <div class="w-12 h-12 rounded-xl bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                                    <i class="ph-fill ph-truck text-2xl"></i>
                                </div>
                                <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-[10px] font-bold uppercase rounded">${v.status || 'Active'}</span>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1 font-mono">${v.vehicleNumber || v.number || v.id}</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">${v.make || 'Truck'} ${v.model || ''}</p>
                            
                            <div class="pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase">Odometer</p>
                                    <p class="text-sm font-medium text-slate-600 dark:text-slate-300">${v.odometer || 'N/A'} km</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-bold text-slate-400 uppercase">Last Service</p>
                                    <p class="text-sm font-medium text-slate-600 dark:text-slate-300">N/A</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        };



        // --- Trip Editing ---
        window.openEditTripModal = (tripId) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip) return;
            state.editTrip = { ...trip };
            state.modal = 'editTrip';
            render();
        };

        window.saveTrip = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tripData = Object.fromEntries(formData.entries());
            const tripId = state.editTrip.id;

            // Basic validation
            if (tripData.endOdo && parseInt(tripData.endOdo) <= parseInt(tripData.startOdo)) {
                return showToast('End Odometer must be greater than Start Odometer', 'error');
            }

            // Data Sanitization based on Category
            if (tripData.tripCategory === 'Empty') {
                tripData.vehicleModel = '';
                tripData.vehicleNumber = ''; // Manual vehicle no
                tripData.customerName = '';
                tripData.referrer = '';
                tripData.tripType = 'Empty';
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), {
                    ...tripData,
                    updatedAt: serverTimestamp()
                });
                showToast('Trip updated successfully', 'success');
                state.modal = null;
                render();
            } catch (error) {
                console.error("Error updating trip:", error);
                showToast('Failed to update trip: ' + error.message, 'error');
            }
        };

        // --- Excel Reconciliation Logic ---
        window.handleExcelUpload = (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    reconcileData(json);
                } catch (err) {
                    console.error("Excel parse error:", err);
                    alert("Failed to parse Excel file. Please ensure it's a valid .xlsx file.");
                }
                input.value = ''; // Reset
            };
            reader.readAsArrayBuffer(file);
        };

        // let reconciliationMatches = []; // REMOVED: Causing scope issues in onclick

        window.reconcileData = (excelRows) => {
            const systemMap = {};
            // Map by vehicleNumber (Case Number)
            state.trips.forEach(t => {
                if (t.vehicleNumber) systemMap[t.vehicleNumber.trim()] = t;
            });

            const matches = [];
            const unmatchedSystem = []; // Not typically actionable from import, but good to know
            const unmatchedExcel = [];

            excelRows.forEach(row => {
                // Normalize keys to handle whitespace or casing issues
                const normalized = {};
                Object.keys(row).forEach(key => {
                    const cleanKey = key.trim().toUpperCase();
                    normalized[cleanKey] = row[key];
                });

                // Match using normalized keys
                // Standard keys might be "Case Number", "Net Amount", "Invoice Amount" -> "CASE NUMBER", "NET AMOUNT", "INVOICE AMOUNT"
                const caseNo = normalized['CASE NUMBER'];
                const netAmt = normalized['NET AMOUNT'];
                const invAmt = normalized['INVOICE AMOUNT'];

                // Target keys
                const billNo = normalized['CAA BILL NUMBER'];
                const billDateRaw = normalized['CAA BILL DATE'];

                // Parse date if needed
                let billDate = billDateRaw;
                if (billDateRaw && typeof billDateRaw === 'number') {
                    // Excel serial date to JS Date
                    const dateObj = new Date(Math.round((billDateRaw - 25569) * 86400 * 1000));
                    billDate = dateObj.toISOString().split('T')[0];
                } else if (billDateRaw && typeof billDateRaw === 'string') {
                    // Try to parse "DD-MM-YYYY" or just use if it looks ISO
                    if (billDateRaw.includes('-')) {
                        const parts = billDateRaw.split('-');
                        if (parts.length === 3) {
                            // naive specific check for DD-MM-YYYY
                            // If first part is > 1900, likely YYYY-MM-DD, else DD-MM-YYYY
                            if (parseInt(parts[0]) > 1900) {
                                billDate = billDateRaw; // Already YYYY-MM-DD
                            } else {
                                billDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                        }
                    }
                }

                if (caseNo && systemMap[caseNo]) {
                    matches.push({
                        trip: systemMap[caseNo],
                        excel: { caseNo, netAmt, invAmt, billNo, billDate }
                    });
                } else {
                    unmatchedExcel.push(row);
                }
            });

            state.reconciliationMatches = matches;
            state.reconciliationUnmatched = unmatchedExcel;
            state.reconciliationTab = 'matched'; // Default tab
            renderReconciliationModal();
        };

        window.downloadUnmatchedExcel = () => {
            if (!state.reconciliationUnmatched || state.reconciliationUnmatched.length === 0) {
                return showToast('No unmatched records to download', 'info');
            }
            try {
                const ws = XLSX.utils.json_to_sheet(state.reconciliationUnmatched);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Unmatched Data");
                XLSX.writeFile(wb, `Unmatched_Reconciliation_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('Unmatched list downloaded', 'success');
            } catch (e) {
                console.error(e);
                showToast('Download failed', 'error');
            }
        };

        window.renderReconciliationModal = () => {
            const matches = state.reconciliationMatches || [];
            const unmatchedCount = (state.reconciliationUnmatched || []).length;

            const modalHtml = `
                <div class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-fade-in">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[80vh] flex flex-col overflow-hidden animate-slide-up">
                        <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <i class="ph-fill ph-file-xls text-green-600"></i> Reconciliation Summary
                                </h3>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                                    Found <span class="font-bold text-indigo-600">${matches.length}</span> matches. <span class="text-amber-500">${unmatchedCount}</span> rows unmatched.
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="state.reconciliationTab = 'matched'; renderReconciliationModal()" 
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${state.reconciliationTab === 'matched' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}">
                                    Matched (${matches.length})
                                </button>
                                <button onclick="state.reconciliationTab = 'unmatched'; renderReconciliationModal()" 
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${state.reconciliationTab === 'unmatched' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}">
                                    Unmatched (${unmatchedCount})
                                </button>
                            </div>
                            <button onclick="state.modal = null; render()" class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center transition-colors">
                                <i class="ph-bold ph-x"></i>
                            </button>
                        </div>
                        
                        <div class="overflow-auto flex-1 p-0">
                            ${state.reconciliationTab === 'matched' ? `
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-slate-50 dark:bg-slate-700/50 text-xs uppercase font-bold text-slate-500 sticky top-0 z-10">
                                    <tr>
                                        <th class="p-4 border-b border-slate-100 dark:border-slate-700">Case ID (System)</th>
                                        <th class="p-4 border-b border-slate-100 dark:border-slate-700">Net Amount</th>
                                        <th class="p-4 border-b border-slate-100 dark:border-slate-700">Inv. Amount</th>
                                        <th class="p-4 border-b border-slate-100 dark:border-slate-700">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    ${matches.map(m => {
                const sysInv = m.trip.billAmount || 0;
                const excelInv = m.excel.invAmt || 0;
                const diff = excelInv - sysInv;
                const isVariance = Math.abs(diff) > 1; // Tolerance

                return `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30">
                                            <td class="p-4 font-mono text-slate-600 dark:text-slate-400">${m.trip.vehicleNumber}</td>
                                            <td class="p-4 font-bold text-slate-700 dark:text-slate-300">₹${(m.excel.netAmt || 0).toLocaleString()}</td>
                                            <td class="p-4">
                                                <div class="flex flex-col">
                                                    <span class="font-bold text-slate-800 dark:text-white">₹${(excelInv).toLocaleString()}</span>
                                                    ${isVariance ? `<span class="text-xs text-amber-500">Sys: ₹${sysInv}</span>` : '<span class="text-xs text-green-500">Matched</span>'}
                                                </div>
                                            </td>
                                            <td class="p-4">
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700">Results Ready</span>
                                            </td>
                                        </tr>`;
            }).join('')}
                                </tbody>
                            </table>
                            ` : `
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-slate-50 dark:bg-slate-700/50 text-xs uppercase font-bold text-slate-500 sticky top-0 z-10">
                                    <tr>
                                        ${Object.keys(state.reconciliationUnmatched[0] || {}).map(k => `<th class="p-4 border-b border-slate-100 dark:border-slate-700 whitespace-nowrap">${k}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    ${state.reconciliationUnmatched.map(row => `
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30">
                                        ${Object.values(row).map(v => {
                let display = v;
                if (v instanceof Date) {
                    display = v.toLocaleDateString('en-GB'); // DD/MM/YYYY
                }
                return `<td class="p-4 text-slate-600 dark:text-slate-400 whitespace-nowrap">${display}</td>`;
            }).join('')}
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            `}
                        </div>

                        <div class="p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-end gap-3 filter drop-shadow">
                             ${state.reconciliationTab === 'unmatched' ? `
                                <button onclick="downloadUnmatchedExcel()" class="px-4 py-2 bg-amber-50 text-amber-600 hover:bg-amber-100 border border-amber-200 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                                    <i class="ph-bold ph-download-simple"></i> Download Unmatched List
                                </button>
                            ` : ''}
                            <button onclick="state.modal = null; render()" class="px-4 py-2 text-slate-600 font-bold hover:bg-slate-200 rounded-lg transition-colors">Cancel</button>
                            ${state.reconciliationTab === 'matched' ? `
                            <button onclick="processReconciliation()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg hover:shadow-indigo-500/30 transition-all transform active:scale-95 flex items-center gap-2">
                                <i class="ph-bold ph-check-circle"></i> Confirm & Update ${matches.length} Trips
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            // Dirty hack to show modal without full re-render logic refactor, 
            // but ideally we set state.modal and call render(). 
            // Since main render() clobbers body, we'll assign to state.modal and call render().
            // But wait, render() consumes state.modal. 
            // I need to ensure render() handles string content for modal or I inject it.
            // Looking at render(), it doesn't seem to have a generic modal renderer. 
            // I'll add a placeholder in render() or just append to body for now to avoid breaking flow?
            // Actually, best practice: set state.modal to this HTML string, and update render() to show it if present.
            state.modal = modalHtml;
            render();
        };

        window.processReconciliation = async () => {
            const matches = state.reconciliationMatches || [];
            if (!confirm(`Are you sure you want to update ${matches.length} records?`)) return;

            // Show loading
            state.modal = `<div class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm"><div class="bg-white p-8 rounded-xl flex flex-col items-center gap-4"><div class="animate-spin text-4xl text-indigo-600"><i class="ph-bold ph-spinner"></i></div><p class="font-bold">Updating Records...</p></div></div>`;
            render();

            let count = 0;
            // Batch update (Firestore batch limit is 500, we'll do linear for simplicity/robustness or chunks if large)
            // For now, linear Promise.all to ensure individual failures don't halt everything? 
            // Or just loop. User has small dataset likely.
            try {
                const updates = matches.map(m => {
                    const payload = {
                        billAmount: parseFloat(m.excel.invAmt) || 0,
                        netAmount: parseFloat(m.excel.netAmt) || 0,
                        billingStatus: 'Approved',
                        financialUpdatedAt: serverTimestamp()
                    };
                    if (m.excel.billNo) payload.billNumber = m.excel.billNo;
                    if (m.excel.billDate) payload.billDate = m.excel.billDate;

                    return updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', m.trip.id), payload);
                });
                await Promise.all(updates);
                alert(`Successfully reconciled ${updates.length} trips!`);
            } catch (e) {
                console.error(e);
                alert("Some updates failed. Check console.");
            }

            state.modal = null;
            render();
        };

        // --- Excel Export Logic ---
        window.exportBillingToExcel = () => {
            try {
                // Get filtered trips (same logic as renderBilling)
                const trips = getFilteredData(state.trips)
                    .filter(t => t.status === 'completed')
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                const filters = state.billingFilters || {};
                const filteredTrips = trips.filter(t => {
                    let match = true;
                    if (filters.search) {
                        const s = filters.search.toLowerCase();
                        match = match && (
                            (t.billNumber && t.billNumber.toLowerCase().includes(s)) ||
                            (t.utrNumber && t.utrNumber.toLowerCase().includes(s))
                        );
                    }
                    if (filters.vehicle) match = match && t.truckNumber && t.truckNumber.toLowerCase().includes(filters.vehicle.toLowerCase());
                    if (filters.driverName) match = match && t.driverName && t.driverName.toLowerCase().includes(filters.driverName.toLowerCase());
                    if (filters.status && filters.status.length && !filters.status.includes('All')) {
                        match = match && filters.status.includes(t.billingStatus || 'Pending');
                    }
                    if (filters.pickup) match = match && t.pickupLocation && t.pickupLocation.toLowerCase().includes(filters.pickup.toLowerCase());
                    if (filters.drop) match = match && t.dropLocation && t.dropLocation.toLowerCase().includes(filters.drop.toLowerCase());
                    if (filters.type && filters.type.length && !filters.type.includes('All')) {
                        match = match && filters.type.includes(t.tripCategory || 'Empty');
                    }
                    if (filters.class && filters.class.length && !filters.class.includes('All')) {
                        match = match && filters.class.includes(t.tripType || 'Empty');
                    }
                    if (filters.dateStart) match = match && t.date >= filters.dateStart;
                    if (filters.dateEnd) match = match && t.date <= filters.dateEnd;
                    if (filters.netMin) match = match && (t.netAmount || 0) >= parseFloat(filters.netMin);
                    if (filters.netMax) match = match && (t.netAmount || 0) <= parseFloat(filters.netMax);
                    if (filters.invMin) match = match && (t.billAmount || 0) >= parseFloat(filters.invMin);
                    if (filters.invMax) match = match && (t.billAmount || 0) <= parseFloat(filters.invMax);
                    return match;
                });

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare data
                const excelData = [];

                // Header rows
                excelData.push(['Anaamalais Mobility Service']); // Company name
                excelData.push(['Billing Reconciliation Report']);
                excelData.push([`Generated: ${new Date().toLocaleString()}`]);
                excelData.push([`Total Records: ${filteredTrips.length}`]);
                excelData.push([]); // Empty row

                // Column headers
                excelData.push([
                    'SI NO.', 'DATE', 'VEH. NO', 'PICK FROM', 'DROP TO', 'VEHICLE ID',
                    'TYPE', 'CLASS', 'NET AMOUNT', 'INV. AMOUNT', 'BILL STATUS',
                    'BILL NUMBER', 'BILL DATE', 'UTR NUMBER', 'UTR DATE', 'DRIVER NAME',
                    'STARTING KM', 'CLOSING KM', 'TRIP KM', 'DURATION (MIN)'
                ]);

                // Data rows
                filteredTrips.forEach((t, idx) => {
                    const start = t.startTime ? new Date(t.startTime.seconds * 1000) : null;
                    const end = t.endTime ? new Date(t.endTime.seconds * 1000) : null;
                    const duration = (start && end) ? Math.round((end - start) / 60000) : 0;
                    const tripKm = (t.endOdo && t.startOdo) ? (t.endOdo - t.startOdo) : 0;

                    excelData.push([
                        idx + 1,
                        t.date || '',
                        t.truckNumber || '',
                        t.pickupLocation || '',
                        t.dropLocation || '',
                        t.vehicleNumber || '',
                        t.tripCategory || '',
                        t.tripType || '',
                        t.netAmount || 0,
                        t.billAmount || 0,
                        t.billingStatus || 'Pending',
                        t.billNumber || '',
                        t.billDate || '',
                        t.utrNumber || '',
                        t.utrDate || '',
                        t.driverName || '',
                        t.startOdo || 0,
                        t.endOdo || 0,
                        tripKm,
                        duration
                    ]);
                });

                // Summary row
                excelData.push([]);
                const totalNet = filteredTrips.reduce((sum, t) => sum + (t.netAmount || 0), 0);
                const totalInv = filteredTrips.reduce((sum, t) => sum + (t.billAmount || 0), 0);
                excelData.push(['', '', '', '', '', '', '', 'TOTAL:', totalNet, totalInv]);

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(excelData);

                // Set column widths
                ws['!cols'] = [
                    { wch: 8 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 20 }, { wch: 15 },
                    { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 12 },
                    { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 15 },
                    { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 12 }
                ];

                // Apply professional styling
                const range = XLSX.utils.decode_range(ws['!ref']);

                // Style company name (row 0)
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const addr = XLSX.utils.encode_cell({ r: 0, c: C });
                    if (!ws[addr]) continue;
                    ws[addr].s = {
                        font: { bold: true, sz: 16, color: { rgb: "4F46E5" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                // Style header row (row 5)
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const addr = XLSX.utils.encode_cell({ r: 5, c: C });
                    if (!ws[addr]) continue;
                    ws[addr].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "4F46E5" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                // Merge cells for company name
                ws['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 19 } },
                    { s: { r: 1, c: 0 }, e: { r: 1, c: 19 } }
                ];

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Billing Report');

                // Generate filename with date
                const filename = `Billing_Report_${new Date().toISOString().split('T')[0]}.xlsx`;

                // Download
                XLSX.writeFile(wb, filename);
                showToast(`Exported ${filteredTrips.length} records to Excel`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Failed to export. Please try again.', 'error');
            }
        };

        // --- PDF Print Logic ---
        window.printBillingPDF = () => {
            try {
                // Get filtered trips (same logic as export)
                const trips = getFilteredData(state.trips)
                    .filter(t => t.status === 'completed')
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                const filters = state.billingFilters || {};
                const filteredTrips = trips.filter(t => {
                    let match = true;
                    if (filters.search) {
                        const s = filters.search.toLowerCase();
                        match = match && (
                            (t.billNumber && t.billNumber.toLowerCase().includes(s)) ||
                            (t.utrNumber && t.utrNumber.toLowerCase().includes(s))
                        );
                    }
                    if (filters.vehicle) match = match && t.truckNumber && t.truckNumber.toLowerCase().includes(filters.vehicle.toLowerCase());
                    if (filters.driverName) match = match && t.driverName && t.driverName.toLowerCase().includes(filters.driverName.toLowerCase());
                    if (filters.status && filters.status.length && !filters.status.includes('All')) {
                        match = match && filters.status.includes(t.billingStatus || 'Pending');
                    }
                    if (filters.pickup) match = match && t.pickupLocation && t.pickupLocation.toLowerCase().includes(filters.pickup.toLowerCase());
                    if (filters.drop) match = match && t.dropLocation && t.dropLocation.toLowerCase().includes(filters.drop.toLowerCase());
                    if (filters.type && filters.type.length && !filters.type.includes('All')) {
                        match = match && filters.type.includes(t.tripCategory || 'Empty');
                    }
                    if (filters.class && filters.class.length && !filters.class.includes('All')) {
                        match = match && filters.class.includes(t.tripType || 'Empty');
                    }
                    if (filters.dateStart) match = match && t.date >= filters.dateStart;
                    if (filters.dateEnd) match = match && t.date <= filters.dateEnd;
                    if (filters.netMin) match = match && (t.netAmount || 0) >= parseFloat(filters.netMin);
                    if (filters.netMax) match = match && (t.netAmount || 0) <= parseFloat(filters.netMax);
                    if (filters.invMin) match = match && (t.billAmount || 0) >= parseFloat(filters.invMin);
                    if (filters.invMax) match = match && (t.billAmount || 0) <= parseFloat(filters.invMax);
                    return match;
                });

                // Calculate totals
                const totalNet = filteredTrips.reduce((sum, t) => sum + (t.netAmount || 0), 0);
                const totalInv = filteredTrips.reduce((sum, t) => sum + (t.billAmount || 0), 0);

                // Create print container if it doesn't exist
                let printContainer = document.getElementById('print-container');
                if (!printContainer) {
                    printContainer = document.createElement('div');
                    printContainer.id = 'print-container';
                    document.body.appendChild(printContainer);
                }

                // Build print HTML
                printContainer.innerHTML = `
                    <div class="print-header">
                        <h1 style="color: #4F46E5; font-size: 24px; margin: 0;">Anaamalais Mobility Service</h1>
                        <h2 style="color: #64748b; font-size: 16px; margin: 10px 0 5px;">Billing Reconciliation Report</h2>
                        <p style="font-size: 12px; color: #94a3b8; margin: 5px 0;">
                            Generated: ${new Date().toLocaleString()} | Total Records: ${filteredTrips.length}
                        </p>
                        <p style="font-size: 11px; color: #94a3b8; margin: 5px 0;">
                            Date Range: ${filters.dateStart || 'All'} to ${filters.dateEnd || 'All'} 
                            ${filters.vehicle ? ' | Vehicle: ' + filters.vehicle : ''}
                            ${filters.driverName ? ' | Driver: ' + filters.driverName : ''}
                        </p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>SI</th>
                                <th>DATE</th>
                                <th>VEH. NO</th>
                                <th>PICK FROM</th>
                                <th>DROP TO</th>
                                <th>TYPE</th>
                                <th>CLASS</th>
                                <th>NET AMT</th>
                                <th>INV AMT</th>
                                <th>STATUS</th>
                                <th>BILL NO</th>
                                <th>DRIVER</th>
                                <th>TRIP KM</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredTrips.map((t, idx) => {
                    const tripKm = (t.endOdo && t.startOdo) ? (t.endOdo - t.startOdo) : 0;
                    return `
                                <tr>
                                    <td style="text-align: center;">${idx + 1}</td>
                                    <td>${t.date || '-'}</td>
                                    <td style="font-weight: bold;">${t.truckNumber || '-'}</td>
                                    <td>${(t.pickupLocation || '-').substring(0, 20)}</td>
                                    <td>${(t.dropLocation || '-').substring(0, 20)}</td>
                                    <td>${t.tripCategory || '-'}</td>
                                    <td>${t.tripType || '-'}</td>
                                    <td style="text-align: right;">₹${(t.netAmount || 0).toLocaleString()}</td>
                                    <td style="text-align: right; font-weight: bold;">₹${(t.billAmount || 0).toLocaleString()}</td>
                                    <td style="font-size: 9px;">${t.billingStatus || 'Pending'}</td>
                                    <td>${t.billNumber || '-'}</td>
                                    <td>${t.driverName || '-'}</td>
                                    <td style="text-align: right;">${tripKm}</td>
                                </tr>
                                `;
                }).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: bold; background-color: #f1f5f9;">
                                <td colspan="7" style="text-align: right; padding-right: 20px;">TOTAL:</td>
                                <td style="text-align: right;">₹${totalNet.toLocaleString()}</td>
                                <td style="text-align: right;">₹${totalInv.toLocaleString()}</td>
                                <td colspan="4"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="print-footer">
                        <p>This is a computer-generated report. No signature required.</p>
                        <p>Page 1/1 | © ${new Date().getFullYear()} Anaamalais Mobility Service</p>
                        <p style="margin-top: 4px; font-weight: 500; color: #4F46E5;">Credits: Anaamalais Digital Service</p>
                    </div>
                `;

                // Give browser time to render, then trigger print
                setTimeout(() => {
                    window.print();
                }, 100);
            } catch (error) {
                console.error('Print error:', error);
                showToast('Failed to generate print view. Please try again.', 'error');
            }
        };

        // --- Trip Approval Workflow ---
        window.openReviewTripModal = (tripId) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip || !trip.pendingChanges) return;
            state.reviewTrip = { ...trip };
            state.modal = 'reviewTrip';
            render();
        };

        window.approveTripChange = async (tripId) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip || !trip.pendingChanges) return;
            const changes = trip.pendingChanges;

            try {
                // Apply changes and clear pending flag
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), {
                    ...changes,
                    hasPendingChanges: false,
                    pendingChanges: deleteField(),
                    lastApprovedBy: state.user.name,
                    lastApprovedAt: serverTimestamp()
                });
                showToast('Changes approved and applied', 'success');
                state.modal = null;
                render();
            } catch (error) {
                console.error("Error approving trip:", error);
                showToast('Error approving changes', 'error');
            }
        };

        window.rejectTripChange = async (tripId) => {
            try {
                // Clear pending flag without applying changes
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), {
                    hasPendingChanges: false,
                    pendingChanges: deleteField(),
                    lastRejectedBy: state.user.name,
                    lastRejectedAt: serverTimestamp()
                });
                showToast('Changes rejected', 'info');
                state.modal = null;
                render();
            } catch (error) {
                console.error("Error rejecting trip:", error);
                showToast('Error rejecting changes', 'error');
            }
        };

        window.openViewTripModal = (tripId) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip) return;
            state.viewTrip = { ...trip };
            state.modal = 'viewTrip';
            render();
        };

        const renderViewTripModal = () => {
            if (state.modal !== 'viewTrip') return '';
            const t = state.viewTrip || {};

            const row = (label, val) => `
                <div class="flex justify-between py-2 border-b border-slate-100 dark:border-slate-700 last:border-0">
                    <span class="text-xs font-bold text-slate-400 uppercase">${label}</span>
                    <span class="text-sm font-semibold text-slate-700 dark:text-slate-300 text-right break-all max-w-[60%]">${val || '-'}</span>
                </div>
            `;

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                        <div>
                           <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="ph-fill ph-check-circle text-green-500"></i> Trip Details</h2>
                           <p class="text-xs text-slate-500 dark:text-slate-400 font-mono">${t.id}</p>
                        </div>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-500 hover:bg-red-100 hover:text-red-500 transition-colors flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <div class="p-6 overflow-y-auto">
                        <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-xl p-4 mb-4 text-center">
                            <h3 class="text-2xl font-bold text-indigo-700 dark:text-indigo-400 font-mono">${t.truckNumber}</h3>
                            <p class="text-xs font-bold text-indigo-500 uppercase tracking-widest mt-1">${t.driverName}</p>
                        </div>

                        <div class="space-y-1">
                            ${row('Date', t.date)}
                            ${row('Status', `<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${t.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${t.status}</span>`)}
                            ${row('Type', t.tripType)}
                            ${row('Category', t.tripCategory)}
                            ${row('Vehicle No', t.vehicleNumber)}
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                             <h4 class="text-xs font-bold text-slate-800 dark:text-white uppercase mb-3 flex items-center gap-2"><i class="ph-fill ph-map-pin"></i> Route Info</h4>
                             <div class="space-y-1">
                                ${row('Pickup', t.pickupLocation)}
                                ${row('Drop', t.dropLocation)}
                                ${row('Distance', (t.endOdo && t.startOdo ? (t.endOdo - t.startOdo) + ' km' : '-'))}
                             </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                             <h4 class="text-xs font-bold text-slate-800 dark:text-white uppercase mb-3 flex items-center gap-2"><i class="ph-fill ph-gauge"></i> Odometer</h4>
                             <div class="flex items-center gap-4 bg-slate-50 dark:bg-slate-700/30 p-3 rounded-xl">
                                <div class="flex-1 text-center border-r border-slate-200 dark:border-slate-600">
                                    <p class="text-[10px] text-slate-400 uppercase">Start</p>
                                    <p class="font-mono font-bold text-slate-700 dark:text-slate-300">${t.startOdo}</p>
                                </div>
                                <div class="flex-1 text-center">
                                    <p class="text-[10px] text-slate-400 uppercase">End</p>
                                    <p class="font-mono font-bold text-slate-700 dark:text-slate-300">${t.endOdo || '-'}</p>
                                </div>
                             </div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30">
                        <button onclick="closeModal()" class="w-full py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 font-bold rounded-xl shadow-sm hover:shadow-md transition-all">Close</button>
                    </div>
                </div>
            </div>`;
        };

        const renderReviewTripModal = () => {
            if (state.modal !== 'reviewTrip') return '';
            const t = state.reviewTrip || {};
            const p = t.pendingChanges || {};

            // Helper to show diff
            const diffRow = (label, oldVal, newVal) => {
                // If newVal is undefined/null, it means no change requested for this field, so don't show unless we want to show everything
                // Usually pendingChanges only contains changed fields + metadata.
                // But for "Review", we usually want to see what IS changing.
                if (newVal === undefined || newVal === null) return '';

                const isChanged = oldVal != newVal; // loose equality
                // If not changed and not explicitly in pendingChanges (which it is if we are here), skip?
                // Actually pendingChanges usually contains the whole form from Driver App?
                // Driver App: `state.editTrip = { ...trip };` -> user modifies -> `saveTripEdit` sends `...tripData`.
                // `tripData` comes from `new FormData`. So it contains ALL fields in the form.
                // So pendingChanges contains fields that might NOT have changed.

                if (!isChanged) return ''; // Only show actual changes

                return `
                 <div class="grid grid-cols-3 gap-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg mb-2">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">${label}</span>
                    <span class="text-sm font-mono text-slate-600 dark:text-slate-400 break-all">${oldVal || '-'}</span>
                    <span class="text-sm font-mono font-bold text-slate-800 dark:text-white break-all flex items-center gap-2">
                        ${newVal || '-'}
                        <i class="ph-bold ph-arrow-left text-amber-500"></i>
                    </span>
                 </div>`;
            };

            return `
             <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                 <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                     <div class="p-6 border-b border-slate-100 dark:border-slate-700 bg-amber-50 dark:bg-amber-900/20 flex justify-between items-center flex-shrink-0">
                         <div>
                            <h2 class="text-xl font-bold text-amber-800 dark:text-amber-400 flex items-center gap-2"><i class="ph-fill ph-warning-circle"></i> Review Changes</h2>
                            <p class="text-xs text-amber-600 dark:text-amber-500">Requested by ${p.requestedBy || 'Driver'}</p>
                         </div>
                         <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white/50 hover:bg-white text-slate-500 hover:text-red-500 flex items-center justify-center transition-all"><i class="ph-bold ph-x"></i></button>
                     </div>
                     <div class="p-6 overflow-y-auto">
                        <div class="grid grid-cols-3 gap-4 mb-2 px-3">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Field</span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Current</span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Proposed</span>
                        </div>
                        
                        ${diffRow('Start Odo', t.startOdo, p.startOdo)}
                        ${diffRow('End Odo', t.endOdo, p.endOdo)}
                        ${diffRow('Date', t.date, p.date)}
                        ${diffRow('Pickup', t.pickupLocation, p.pickupLocation)}
                        ${diffRow('Drop', t.dropLocation, p.dropLocation)}
                        ${diffRow('Vehicle', t.truckNumber, p.truckNumber)}
                        ${diffRow('Driver', t.driverName, p.driverName)}
                        ${diffRow('Category', t.tripCategory, p.tripCategory)}
                        ${diffRow('Type', t.tripType, p.tripType)}
                        ${diffRow('Model', t.vehicleModel, p.vehicleModel)}
                        ${diffRow('Manual Veh.', t.vehicleNumber, p.vehicleNumber)}
                        ${diffRow('Customer', t.customerName, p.customerName)}
                        
                        ${!Object.keys(p).some(key => ['startOdo', 'endOdo', 'date', 'pickupLocation', 'dropLocation', 'truckNumber', 'driverName', 'tripCategory', 'tripType', 'vehicleModel', 'vehicleNumber', 'customerName'].includes(key) && p[key] != t[key]) ? '<p class="text-center text-slate-500 italic py-4">No significant changes detected.</p>' : ''}

                     </div>
                     <div class="p-6 border-t border-slate-100 dark:border-slate-700 flex gap-3 bg-slate-50 dark:bg-slate-800/50 flex-shrink-0">
                         <button onclick="rejectTripChange('${t.id}')" class="flex-1 py-3 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 font-bold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors shadow-sm text-sm">
                             Reject Changes
                         </button>
                         <button onclick="approveTripChange('${t.id}')" class="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-colors shadow-lg shadow-green-500/30 text-sm flex items-center justify-center gap-2">
                             <i class="ph-bold ph-check"></i> Approve & Apply
                         </button>
                     </div>
                 </div>
             </div > `;
        };

        const renderEditTripModal = () => {
            if (state.modal !== 'editTrip') return '';
            const t = state.editTrip || {};

            // Determine available types based on category
            const cat = t.tripCategory || 'New';
            let typeOptions = [];
            if (cat === 'New') typeOptions = CATEGORIES.NEW;
            else if (cat === 'Break Down') typeOptions = CATEGORIES.BREAKDOWN;

            // Helper to update local state logic without full render (or we rely on render)
            // We'll use onchange="state.editTrip[field] = value; render()" pattern for fields that affect others

            return `
             <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                 <div class="bg-white dark:bg-slate-800 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
                     <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50">
                         <div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Edit Trip Details</h2>
                            <p class="text-xs text-slate-500 font-mono">ID: ${t.id}</p>
                         </div>
                         <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                     </div>
                     
                     <form onsubmit="saveTrip(event)" class="flex-1 overflow-y-auto p-6 space-y-5">
                        <!-- Primary Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Vehicle (Truck)</label>
                                 <select name="truckNumber" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                                     <option value="" disabled>Select Truck</option>
                                     ${state.vehicles.map(v => `<option value="${v.vehicleNumber || v.number}" ${t.truckNumber === (v.vehicleNumber || v.number) ? 'selected' : ''}>${v.vehicleNumber || v.number}</option>`).join('')}
                                     ${!state.vehicles.find(v => (v.vehicleNumber || v.number) === t.truckNumber) && t.truckNumber ? `<option value="${t.truckNumber}" selected>${t.truckNumber} (Current)</option>` : ''}
                                 </select>
                             </div>
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Driver</label>
                                 <select name="driverName" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                                    <option value="" disabled>Select Driver</option>
                                    ${state.drivers.map(d => `<option value="${d.name}" ${t.driverName === d.name ? 'selected' : ''}>${d.name}</option>`).join('')}
                                    ${!state.drivers.find(d => d.name === t.driverName) && t.driverName ? `<option value="${t.driverName}" selected>${t.driverName} (Current)</option>` : ''}
                                 </select>
                             </div>
                        </div>

                        <!-- Trip Metadata -->
                        <div class="p-4 bg-slate-50 dark:bg-slate-900/30 rounded-xl border border-slate-100 dark:border-slate-700 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Category</label>
                                    <select name="tripCategory" onchange="state.editTrip.tripCategory=this.value; state.editTrip.tripType=''; render()" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm">
                                        <option value="New" ${cat === 'New' ? 'selected' : ''}>New</option>
                                        <option value="Break Down" ${cat === 'Break Down' ? 'selected' : ''}>Break Down</option>
                                        <option value="Empty" ${cat === 'Empty' ? 'selected' : ''}>Empty</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Type</label>
                                    ${cat === 'Empty' ?
                    `<input type="text" name="tripType" value="Empty" readonly class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 text-slate-500 border border-slate-200 dark:border-slate-600 rounded-lg text-sm">`
                    :
                    `<select name="tripType" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm" required>
                                            <option value="" disabled ${!t.tripType ? 'selected' : ''}>Select Type</option>
                                            ${typeOptions.map(type => `<option value="${type}" ${t.tripType === type ? 'selected' : ''}>${type}</option>`).join('')}
                                        </select>`
                }
                                </div>
                            </div>

                             ${cat !== 'Empty' ? `
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Model</label>
                                    <select name="vehicleModel" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm">
                                        <option value="">Select Model</option>
                                        ${(state.models && state.models.length ? state.models.map(m => m.name) : SOURCE_MODELS).map(m => `<option value="${m}" ${t.vehicleModel === m ? 'selected' : ''}>${m}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Vehicle No (Manual)</label>
                                    <input type="text" name="vehicleNumber" value="${t.vehicleNumber || ''}" placeholder="ABC-1234" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm uppercase">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Customer Name</label>
                                    <input type="text" name="customerName" value="${t.customerName || ''}" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Referred By</label>
                                    <input type="text" name="referrer" value="${t.referrer || ''}" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm">
                                </div>
                            </div>
                            ` : ''}
                        </div>

                         <!-- Odometer & Date -->
                         <div class="grid grid-cols-3 gap-4">
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Date</label>
                                 <input type="date" name="date" value="${t.date}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                             </div>
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Start Odo</label>
                                 <input type="number" name="startOdo" value="${t.startOdo}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                             </div>
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">End Odo</label>
                                 <input type="number" name="endOdo" value="${t.endOdo}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                             </div>
                         </div>

                         <!-- Locations -->
                         <div class="grid grid-cols-2 gap-4">
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Pickup</label>
                                 <div class="relative">
                                    <select name="pickupLocation" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white appearance-none" required>
                                        <option value="" disabled>Select Pickup</option>
                                        ${state.locations.map(l => `<option value="${l.name}" ${t.pickupLocation === l.name ? 'selected' : ''}>${l.name}</option>`).join('')}
                                        ${!state.locations.find(l => l.name === t.pickupLocation) && t.pickupLocation ? `<option value="${t.pickupLocation}" selected>${t.pickupLocation} (Current)</option>` : ''}
                                    </select>
                                    <i class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                 </div>
                             </div>
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Drop</label>
                                 <div class="relative">
                                     <select name="dropLocation" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white appearance-none" required>
                                         <option value="" disabled>Select Drop</option>
                                         ${state.locations.map(l => `<option value="${l.name}" ${t.dropLocation === l.name ? 'selected' : ''}>${l.name}</option>`).join('')}
                                         ${!state.locations.find(l => l.name === t.dropLocation) && t.dropLocation ? `<option value="${t.dropLocation}" selected>${t.dropLocation} (Current)</option>` : ''}
                                     </select>
                                     <i class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                 </div>
                             </div>
                         </div>

                         <div class="pt-2">
                             <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/30 ring-offset-2 focus:ring-2 focus:ring-indigo-500">
                                 <i class="ph-bold ph-floppy-disk mr-2"></i> Save Changes
                             </button>
                         </div>
                     </form>
                 </div>
             </div > `;
        };

        // Initialize Financial Tab State if not present
        if (!state.financialTab) state.financialTab = 'billing';

        window.toggleAllBilling = (checked) => {
            document.querySelectorAll('.billing-checkbox').forEach(cb => cb.checked = checked);
        };

        // Debounce timer variable
        window.billingFilterTimeout = null;

        window.updateBillingFilter = (key, value) => {
            state.billingFilters[key] = value;
            state.billingPage = 1; // Reset to first page on filter change

            // Clear existing timer
            if (window.billingFilterTimeout) clearTimeout(window.billingFilterTimeout);

            // Set new timer (Auto-filter after 800ms of inactivity)
            window.billingFilterTimeout = setTimeout(() => {
                // 1. Capture current focus state before render destroys it
                const activeEl = document.activeElement;
                const activeId = activeEl ? activeEl.id : null;
                const selectionStart = activeEl ? activeEl.selectionStart : null;
                const selectionEnd = activeEl ? activeEl.selectionEnd : null;

                // 2. Render (Updates the table and recreates inputs)
                render();

                // 3. Restore focus and cursor position
                if (activeId) {
                    const newEl = document.getElementById(activeId);
                    if (newEl) {
                        newEl.focus();
                        if (typeof selectionStart === 'number') {
                            newEl.setSelectionRange(selectionStart, selectionEnd);
                        }
                    }
                }
            }, 800);
        };


        window.updateTripFinancials = async (tripId) => {
            const row = document.getElementById(`fin-row-${tripId}`);
            if (!row) return;

            const billNumber = row.querySelector('.fin-bill-no').value;
            const billDate = row.querySelector('.fin-bill-date').value;
            const utrNumber = row.querySelector('.fin-utr').value;
            const utrDate = row.querySelector('.fin-utr-date').value;
            const amount = row.querySelector('.fin-amount').value;
            const netAmount = row.querySelector('.fin-net-amount').value;
            const status = row.querySelector('.fin-status').value;

            try {
                const btn = row.querySelector('.fin-save-btn');
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';
                btn.disabled = true;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), {
                    billNumber: billNumber,
                    billDate: billDate,
                    utrNumber: utrNumber,
                    utrDate: utrDate,
                    billAmount: amount ? parseFloat(amount) : 0,
                    netAmount: netAmount ? parseFloat(netAmount) : 0,
                    billingStatus: status,
                    financialUpdatedAt: serverTimestamp()
                });

                showToast('Financial details updated', 'success');
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            } catch (error) {
                console.error("Error updating financials:", error);
                showToast('Failed to update', 'error');
                const btn = row.querySelector('.fin-save-btn');
                if (btn) {
                    btn.innerHTML = '<i class="ph-bold ph-floppy-disk"></i>';
                    btn.disabled = false;
                }
            }
        };

        window.openVehicleDetail = (truck) => {
            console.log("Opening details for:", truck);
            // alert("Opening " + truck); // Verification debug
            window.state.vehicleDetail = truck;
            try {
                render();
            } catch (e) {
                console.error("Render failed:", e);
                alert("Error rendering details: " + e.message);
            }
        };

        /* ... skipping to renderExpenseTab ... */

        const renderExpenseTab = (logs, type) => `
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-blue-50/50 text-blue-900 text-xs uppercase font-bold">
                             <tr>
                                <th class="p-4">Date</th>
                                <th class="p-4">Driver</th>
                                <th class="p-4">Trip / Location</th>
                                <th class="p-4 text-right">Amount (₹)</th>
                                <th class="p-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                             ${logs.length ? logs.map(l => `
                            <tr class="hover:bg-slate-50 transition-colors even:bg-slate-100 dark:even:bg-slate-800/50">
                                <td class="p-4 font-mono text-sm">${l.date ? l.date.replace('T', ' ') : '-'}</td>
                                <td class="p-4 text-sm font-medium text-slate-700 dark:text-slate-300">
                                    ${l.driverName || '-'}
                                </td>
                                <td class="p-4 text-sm">
                                     ${l.pickup ? `<span class="font-medium">${l.pickup}</span> <i class="ph-bold ph-arrow-right text-xs text-slate-400"></i> <span class="font-medium">${l.drop}</span>` : 'General Entry'}
                                </td>
                                <td class="p-4 text-right">
                                     <input type="number" id="${type}-amt-${l.id}" value="${l.amount || ''}" 
                                        class="w-24 px-2 py-1 border border-slate-200 rounded text-right font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                                </td>
                                <td class="p-4 text-center">
                                    ${l.status === 'Approved' ?
                `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold"><i class="ph-bold ph-check"></i> Approved</span>` :
                `<button onclick="approveExpense('${type === 'police' ? 'ams_police_fines' : 'ams_toll_logs'}', '${l.id}', document.getElementById('${type}-amt-${l.id}').value)" 
                                            class="px-3 py-1 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 shadow-sm transition-all hover:scale-105 active:scale-95">
                                            Approve
                                        </button>`
            }
                                </td>
                            </tr>
                            `).join('') : `<tr><td colspan="5" class="p-8 text-center text-slate-400">No ${type} records.</td></tr>`}
                        </tbody>
                    </table>
                `;

        window.closeVehicleDetail = () => {
            window.state.vehicleDetail = null;
            render();
        };

        // Multi-Select Helpers
        window.toggleDropdown = (key) => {
            state.openDropdown = (state.openDropdown === key) ? null : key;
            render();
        };

        window.toggleFilter = (key, value) => {
            // Ensure array
            let val = state.billingFilters[key];
            let arr = Array.isArray(val) ? val : [val]; // specific handling for 'All' string
            if (arr.length === 1 && arr[0] === 'All' && !Array.isArray(val)) arr = ['All']; // Ensure consistent start

            if (value === 'All') {
                arr = ['All'];
            } else {
                if (arr.includes('All')) arr = [];

                if (arr.includes(value)) {
                    arr = arr.filter(v => v !== value);
                } else {
                    arr.push(value);
                }

                if (arr.length === 0) arr = ['All'];
            }
            state.billingFilters[key] = arr;
            render();
        };

        const renderMultiSelect = (key, label, options, currentValues) => {
            const vals = Array.isArray(currentValues) ? currentValues : [currentValues];
            const isOpen = state.openDropdown === key;
            const displayLabel = vals.includes('All') ? label : `${vals.length} Selected`;

            return `
            <div class="relative min-w-[140px]">
                 <button onclick="event.stopPropagation(); window.toggleDropdown('${key}')" class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-900 border ${isOpen ? 'border-indigo-500 ring-2 ring-indigo-500/20' : 'border-slate-200 dark:border-slate-700'} rounded-xl text-sm font-medium outline-none flex items-center justify-between transition-all group">
                    <span class="${vals.includes('All') ? 'text-slate-500' : 'text-slate-800 dark:text-white font-bold'} truncate">${displayLabel}</span>
                    <i class="ph-bold ph-caret-down text-slate-400 text-xs transition-transform ${isOpen ? 'rotate-180' : ''}"></i>
                </button>
                
                ${isOpen ? `
                <div class="absolute top-full left-0 mt-1 z-50 w-full min-w-[180px] bg-white dark:bg-slate-800 shadow-xl rounded-xl border border-slate-100 dark:border-slate-700 max-h-60 overflow-y-auto p-1.5 animate-fade-in-up">
                      <div onclick="event.stopPropagation(); window.toggleFilter('${key}', 'All')" class="flex items-center p-2 hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer rounded-lg transition-colors gap-2">
                            <div class="w-4 h-4 rounded border ${vals.includes('All') ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300 dark:border-slate-600'} flex items-center justify-center transition-colors">
                                ${vals.includes('All') ? '<i class="ph-bold ph-check text-white text-[10px]"></i>' : ''}
                            </div>
                            <span class="text-sm ${vals.includes('All') ? 'font-bold text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-300'}">All</span>
                      </div>
                      <div class="h-px bg-slate-100 dark:bg-slate-700 my-1"></div>
                      ${options.map(opt => `
                        <div onclick="event.stopPropagation(); window.toggleFilter('${key}', '${opt}')" class="flex items-center p-2 hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer rounded-lg transition-colors gap-2">
                             <div class="w-4 h-4 rounded border ${vals.includes(opt) ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300 dark:border-slate-600'} flex items-center justify-center transition-colors">
                                ${vals.includes(opt) ? '<i class="ph-bold ph-check text-white text-[10px]"></i>' : ''}
                            </div>
                            <span class="text-sm ${vals.includes(opt) ? 'font-bold text-slate-800 dark:text-white' : 'text-slate-600 dark:text-slate-300'}">${opt}</span>
                        </div>
                      `).join('')}
                </div>
                <div class="fixed inset-0 z-40" onclick="event.stopPropagation(); window.toggleDropdown('${key}')"></div>
                ` : ''}
            </div>
            `;
        };


        // --- Vehicle RTO Management (Financial View) ---
        const formatDate = (dateStr) => {
            if (!dateStr) return 'N/A';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        };

        const getExpiryStatusClass = (dateStr) => {
            if (!dateStr) return 'text-slate-400';
            const today = new Date();
            const exp = new Date(dateStr);
            const diffTime = exp - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'text-red-600 font-bold'; // Expired
            if (diffDays < 30) return 'text-amber-600 font-bold'; // Expiring soon
            return 'text-green-600 font-bold';
        };

        window.openVehicleRTOModal = (vehicleId) => {
            state.editVehicle = state.vehicles.find(v => v.id === vehicleId);
            if (!state.editVehicle) return;
            state.modal = renderVehicleRTOModalContent();
            render();
        };

        const renderVehicleRTOModalContent = () => {
            const v = state.editVehicle || {};

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in" style="z-index: 60;" onclick="if(event.target === this) closeModal()">
                <div class="bg-white dark:bg-slate-800 w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden scale-in flex flex-col max-h-[90vh]">
                    <div class="bg-slate-50 dark:bg-slate-900/50 px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center flex-shrink-0">
                        <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            <i class="ph-bold ph-shield-check text-green-600"></i> Manage RTO & Compliance
                        </h3>
                        <div class="text-sm font-mono font-bold text-slate-500">${v.vehicleNumber || v.number}</div>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-slate-500"><i class="ph-bold ph-x"></i></button>
                    </div>
                    
                    <form onsubmit="saveVehicleRTO(event)" class="p-6 space-y-6 overflow-y-auto">
                        <!-- RTO Compliance -->
                         <div class="space-y-6">
                            
                            <!-- Tax -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 uppercase mb-3 flex items-center gap-2">
                                    <i class="ph-fill ph-receipt text-green-500"></i> Tax Details
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Payment Date</label>
                                        <input type="date" name="rtoTaxDate" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-green-500" value="${v.rtoTaxDate || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Amount (₹)</label>
                                        <input type="number" name="rtoTaxAmount" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-green-500" value="${v.rtoTaxAmount || ''}" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Expiry Date</label>
                                        <input type="date" name="rtoTaxExpiry" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-green-500" value="${v.rtoTaxExpiry || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Remarks</label>
                                        <input type="text" name="rtoTaxRemarks" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-medium text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-green-500" value="${v.rtoTaxRemarks || ''}" placeholder="Notes...">
                                    </div>
                                </div>
                            </div>

                            <!-- Fitness -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 uppercase mb-3 flex items-center gap-2">
                                    <i class="ph-fill ph-heartbeat text-blue-500"></i> Fitness Details
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Inspection Date</label>
                                        <input type="date" name="rtoFitnessDate" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-blue-500" value="${v.rtoFitnessDate || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Amount (₹)</label>
                                        <input type="number" name="rtoFitnessAmount" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-blue-500" value="${v.rtoFitnessAmount || ''}" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Expiry Date</label>
                                        <input type="date" name="rtoFitnessExpiry" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-blue-500" value="${v.rtoFitnessExpiry || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Remarks</label>
                                        <input type="text" name="rtoFitnessRemarks" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-medium text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-blue-500" value="${v.rtoFitnessRemarks || ''}" placeholder="Notes...">
                                    </div>
                                </div>
                            </div>

                            <!-- Pollution -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 uppercase mb-3 flex items-center gap-2">
                                    <i class="ph-fill ph-plant text-emerald-500"></i> Pollution Details
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Test Date</label>
                                        <input type="date" name="rtoPollutionDate" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-emerald-500" value="${v.rtoPollutionDate || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Amount (₹)</label>
                                        <input type="number" name="rtoPollutionAmount" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-emerald-500" value="${v.rtoPollutionAmount || ''}" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Expiry Date</label>
                                        <input type="date" name="rtoPollutionExpiry" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-emerald-500" value="${v.rtoPollutionExpiry || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Remarks</label>
                                        <input type="text" name="rtoPollutionRemarks" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-medium text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-emerald-500" value="${v.rtoPollutionRemarks || ''}" placeholder="Notes...">
                                    </div>
                                </div>
                            </div>

                            <!-- Permit -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 uppercase mb-3 flex items-center gap-2">
                                    <i class="ph-fill ph-file-text text-amber-500"></i> Permit Details
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Issue Date</label>
                                        <input type="date" name="rtoPermitDate" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-amber-500" value="${v.rtoPermitDate || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Amount (₹)</label>
                                        <input type="number" name="rtoPermitAmount" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-amber-500" value="${v.rtoPermitAmount || ''}" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Expiry Date</label>
                                        <input type="date" name="rtoPermitExpiry" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-amber-500" value="${v.rtoPermitExpiry || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Remarks</label>
                                        <input type="text" name="rtoPermitRemarks" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-medium text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-amber-500" value="${v.rtoPermitRemarks || ''}" placeholder="Notes...">
                                    </div>
                                </div>
                            </div>

                            <!-- Insurance -->
                            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 uppercase mb-3 flex items-center gap-2">
                                    <i class="ph-fill ph-shield-check text-purple-500"></i> Insurance Details
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="md:col-span-2">
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Provider & Policy No.</label>
                                        <div class="flex gap-2">
                                            <input type="text" name="insuranceProvider" class="flex-1 px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-purple-500" value="${v.insuranceProvider || ''}" placeholder="Provider Name">
                                            <input type="text" name="insurancePolicyNumber" class="flex-1 px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-purple-500" value="${v.insurancePolicyNumber || ''}" placeholder="Policy #">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Payment Date</label>
                                        <input type="date" name="insuranceDate" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-purple-500" value="${v.insuranceDate || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Amount (₹)</label>
                                        <input type="number" name="insuranceAmount" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-purple-500" value="${v.insuranceAmount || ''}" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Expiry Date</label>
                                        <input type="date" name="insuranceExpiry" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-purple-500" value="${v.insuranceExpiry || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-1">Remarks</label>
                                        <input type="text" name="insuranceRemarks" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-medium text-slate-700 dark:text-white outline-none focus:ring-1 focus:ring-purple-500" value="${v.insuranceRemarks || ''}" placeholder="Notes...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 flex justify-end gap-3 border-t border-slate-100 dark:border-slate-700 mt-6 sticky bottom-0 bg-white dark:bg-slate-800 py-3">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-700 transition-colors">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center gap-2">
                                <i class="ph-bold ph-floppy-disk"></i> Update Compliance
                            </button>
                        </div>
                    </form>
                </div>
            </div>`;
        };

        window.saveVehicleRTO = async (e) => {
            e.preventDefault();
            const form = e.target;
            const tripId = state.editVehicle.id; // Using tripId variable name for consistency/laziness but it is vehicleId

            try {
                // Existing RTO Values (to check for changes)
                const oldV = state.editVehicle || {};

                // Construct data
                const newRtoData = {
                    rtoTaxDate: form.rtoTaxDate ? form.rtoTaxDate.value : '',
                    rtoTaxAmount: form.rtoTaxAmount ? form.rtoTaxAmount.value : '',
                    rtoTaxExpiry: form.rtoTaxExpiry ? form.rtoTaxExpiry.value : '',
                    rtoTaxRemarks: form.rtoTaxRemarks ? form.rtoTaxRemarks.value : '',

                    rtoFitnessDate: form.rtoFitnessDate ? form.rtoFitnessDate.value : '',
                    rtoFitnessAmount: form.rtoFitnessAmount ? form.rtoFitnessAmount.value : '',
                    rtoFitnessExpiry: form.rtoFitnessExpiry ? form.rtoFitnessExpiry.value : '',
                    rtoFitnessRemarks: form.rtoFitnessRemarks ? form.rtoFitnessRemarks.value : '',

                    rtoPollutionDate: form.rtoPollutionDate ? form.rtoPollutionDate.value : '',
                    rtoPollutionAmount: form.rtoPollutionAmount ? form.rtoPollutionAmount.value : '',
                    rtoPollutionExpiry: form.rtoPollutionExpiry ? form.rtoPollutionExpiry.value : '',
                    rtoPollutionRemarks: form.rtoPollutionRemarks ? form.rtoPollutionRemarks.value : '',

                    rtoPermitDate: form.rtoPermitDate ? form.rtoPermitDate.value : '',
                    rtoPermitAmount: form.rtoPermitAmount ? form.rtoPermitAmount.value : '',
                    rtoPermitExpiry: form.rtoPermitExpiry ? form.rtoPermitExpiry.value : '',
                    rtoPermitRemarks: form.rtoPermitRemarks ? form.rtoPermitRemarks.value : '',

                    insuranceDate: form.insuranceDate ? form.insuranceDate.value : '',
                    insuranceAmount: form.insuranceAmount ? form.insuranceAmount.value : '',
                    insuranceExpiry: form.insuranceExpiry ? form.insuranceExpiry.value : '',
                    insuranceProvider: form.insuranceProvider ? form.insuranceProvider.value : '',
                    insurancePolicyNumber: form.insurancePolicyNumber ? form.insurancePolicyNumber.value : '',
                    insuranceRemarks: form.insuranceRemarks ? form.insuranceRemarks.value : ''
                };

                // Check for updates and build history
                const rtoHistory = oldV.rtoHistory || [];
                const types = [
                    { key: 'rtoTax', label: 'Tax' },
                    { key: 'rtoFitness', label: 'Fitness' },
                    { key: 'rtoPollution', label: 'Pollution' },
                    { key: 'rtoPermit', label: 'Permit' },
                    { key: 'insurance', label: 'Insurance' }
                ];

                types.forEach(t => {
                    const oldExpiry = oldV[`${t.key}Expiry`];
                    const newExpiry = newRtoData[`${t.key}Expiry`];
                    if (newExpiry && newExpiry !== oldExpiry) {
                        rtoHistory.push({
                            type: t.key,
                            label: t.label,
                            date: newRtoData[`${t.key}Date`],
                            amount: newRtoData[`${t.key}Amount`],
                            expiry: newExpiry,
                            remarks: newRtoData[`${t.key}Remarks`],
                            updatedAt: new Date().toISOString()
                        });
                    }
                });

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', state.editVehicle.id), {
                    ...newRtoData,
                    rtoHistory: rtoHistory,
                    updatedAt: serverTimestamp()
                });
                showToast('Compliance details updated', 'success');
                closeModal();
            } catch (error) {
                console.error("Error saving RTO:", error);
                showToast('Error saving RTO details', 'error');
            }
        };

        const renderFinancialManagement = () => {
            const drivers = getFilteredData(state.drivers);
            // Sort trips by date desc
            const trips = getFilteredData(state.trips)
                .filter(t => t.status === 'completed')
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            // Calculate Overview Stats (Rough Est)
            const totalRevenue = trips.reduce((sum, t) => sum + (t.billAmount || 0), 0);
            const verifiedRevenue = trips.filter(t => t.billingStatus === 'Approved').reduce((sum, t) => sum + (t.billAmount || 0), 0);
            const pendingRevenue = trips.filter(t => t.billingStatus !== 'Approved').reduce((sum, t) => sum + (t.billAmount || 0), 0);

            // Calculate Total Expense (Approved Only)
            const fuelLogs = getFilteredData(state.fuelLogs);
            const maintLogs = getFilteredData(state.maintenanceLogs).filter(l => l.status === 'Approved');
            const policeLogs = getFilteredData(state.policeFines).filter(l => l.status === 'Approved');
            const tollLogs = getFilteredData(state.tollLogs).filter(l => l.status === 'Approved');

            const totalFuel = fuelLogs.reduce((acc, l) => acc + (l.totalCost || 0), 0);
            const totalMaint = maintLogs.reduce((acc, l) => acc + (parseFloat(l.price) || 0), 0);
            const totalPolice = policeLogs.reduce((acc, l) => acc + (parseFloat(l.amount) || 0), 0);
            const totalToll = tollLogs.reduce((acc, l) => acc + (parseFloat(l.amount) || 0), 0);

            // Calculate Compliance Cost
            const totalCompliance = state.vehicles.reduce((sum, v) => {
                let vSum = 0;
                if (v.rtoTaxStatus === 'Approved') vSum += (parseFloat(v.rtoTaxAmount) || 0);
                if (v.rtoFitnessStatus === 'Approved') vSum += (parseFloat(v.rtoFitnessAmount) || 0);
                if (v.rtoPollutionStatus === 'Approved') vSum += (parseFloat(v.rtoPollutionAmount) || 0);
                if (v.rtoPermitStatus === 'Approved') vSum += (parseFloat(v.rtoPermitAmount) || 0);
                if (v.insuranceStatus === 'Approved') vSum += (parseFloat(v.insuranceAmount) || 0);
                return sum + vSum;
            }, 0);

            const totalExpense = totalFuel + totalMaint + totalPolice + totalToll + totalCompliance;






            const renderBillingFilters = () => {
                const isExpanded = !!state.showBillingFilters;

                if (!isExpanded) {
                    return `
                    <div class="mb-6 flex justify-end">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold text-slate-400">Filters Hiden</span>
                             <button onclick="state.showBillingFilters = true; render()" class="w-10 h-10 rounded-xl bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 transition-all flex items-center justify-center group" title="Show Filters">
                                <i class="ph-bold ph-faders text-lg group-hover:scale-110 transition-transform"></i>
                            </button>
                             <button onclick="document.getElementById('billing-excel-upload').click()" class="w-10 h-10 rounded-xl bg-green-50 dark:bg-green-900/20 text-green-600 hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors flex items-center justify-center" title="Import Excel">
                                 <i class="ph-bold ph-microsoft-excel-logo text-lg"></i>
                                 <input type="file" id="billing-excel-upload" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this)">
                             </button>
                             <button onclick="exportBillingToExcel()" class="w-10 h-10 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition-colors flex items-center justify-center" title="Export to Excel">
                                 <i class="ph-bold ph-download text-lg"></i>
                             </button>
                             <button onclick="printBillingPDF()" class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors flex items-center justify-center" title="Print PDF">
                                 <i class="ph-bold ph-printer text-lg"></i>
                             </button>
                        </div>
                    </div>`;
                }

                return `
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6 animate-fade-in-down">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                             <div class="w-8 h-8 rounded-full bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400">
                                 <i class="ph-fill ph-faders"></i>
                             </div>
                            <h3 class="text-sm font-bold uppercase text-slate-500 dark:text-slate-400 tracking-wider">Filter Operations</h3>
                        </div>
                        <div class="flex items-center gap-4">
                             <input type="file" id="billing-excel-upload" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this)">
                             <button onclick="document.getElementById('billing-excel-upload').click()" class="text-[11px] font-bold text-green-600 hover:text-green-700 flex items-center gap-1 transition-colors px-3 py-1.5 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg">
                                 <i class="ph-bold ph-microsoft-excel-logo"></i> Import
                             </button>
                             <button onclick="exportBillingToExcel()" class="text-[11px] font-bold text-emerald-600 hover:text-emerald-700 flex items-center gap-1 transition-colors px-3 py-1.5 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 rounded-lg">
                                 <i class="ph-bold ph-download"></i> Export
                             </button>
                             <button onclick="printBillingPDF()" class="text-[11px] font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1 transition-colors px-3 py-1.5 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg">
                                 <i class="ph-bold ph-printer"></i> Print
                             </button>
                             <button onclick="state.billingFilters={search:'',dateStart:'',dateEnd:'',status:['All'],vehicle:'',driverName:'',type:['New', 'Break Down'],class:['All'],pickup:'',drop:'',netMin:'',netMax:'',invMin:'',invMax:''}; render()" class="text-[11px] font-bold text-red-500 hover:text-red-600 flex items-center gap-1 transition-colors px-3 py-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg">
                                 <i class="ph-bold ph-trash"></i> Clear
                             </button>
                             <button onclick="state.showBillingFilters = false; render()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:bg-slate-200 transition-colors flex items-center justify-center" title="Collapse Filters">
                                <i class="ph-bold ph-caret-up"></i>
                             </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Row 1 -->
                        <div class="relative group">
                            <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                            <input type="text" id="filter-search" placeholder="Search Bill # or UTR..." value="${state.billingFilters.search}" oninput="updateBillingFilter('search', this.value)" 
                                class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 placeholder:text-slate-400">
                        </div>

                        <div class="relative group">
                            <i class="ph-bold ph-truck absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                            <input type="text" id="filter-vehicle" placeholder="Filter by Vehicle..." value="${state.billingFilters.vehicle}" oninput="updateBillingFilter('vehicle', this.value)" 
                                class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 placeholder:text-slate-400">
                        </div>

                        <div class="relative group">
                            <i class="ph-bold ph-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                            <input type="text" id="filter-driver" placeholder="Driver Name..." value="${state.billingFilters.driverName}" oninput="updateBillingFilter('driverName', this.value)" 
                                class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 placeholder:text-slate-400">
                        </div>

                        ${renderMultiSelect('status', 'All Status', ['Pending', 'submitted', 'Approved', 'Billed', 'Paid'], state.billingFilters.status)}


                        <!-- Row 2 -->
                        <div class="relative group">
                            <i class="ph-bold ph-map-pin absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                            <input type="text" id="filter-pickup" placeholder="Pick From..." value="${state.billingFilters.pickup}" oninput="updateBillingFilter('pickup', this.value)" 
                                class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 placeholder:text-slate-400">
                        </div>

                        <div class="relative group">
                            <i class="ph-bold ph-map-pin absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                            <input type="text" id="filter-drop" placeholder="Drop To..." value="${state.billingFilters.drop}" oninput="updateBillingFilter('drop', this.value)" 
                                class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 placeholder:text-slate-400">
                        </div>

                        ${renderMultiSelect('type', 'All Types', ['New', 'Break Down', 'Empty'], state.billingFilters.type)}


                        ${renderMultiSelect('class', 'All Classes', ['TVS', 'INT', 'FREE', 'Service', 'Direct'], state.billingFilters.class)}


                        <!-- Row 3 -->
                        <div class="flex items-center gap-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2 group">
                            <i class="ph-bold ph-currency-inr text-slate-400 group-focus-within:text-indigo-500"></i>
                            <input type="number" placeholder="Net Min" value="${state.billingFilters.netMin}" oninput="updateBillingFilter('netMin', this.value)" class="bg-transparent border-none p-0 text-sm font-medium w-full outline-none">
                            <span class="text-slate-300">-</span>
                            <input type="number" placeholder="Max" value="${state.billingFilters.netMax}" oninput="updateBillingFilter('netMax', this.value)" class="bg-transparent border-none p-0 text-sm font-medium w-full outline-none">
                        </div>

                        <div class="flex items-center gap-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2 group">
                            <i class="ph-bold ph-currency-inr text-slate-400 group-focus-within:text-indigo-500"></i>
                            <input type="number" placeholder="Inv Min" value="${state.billingFilters.invMin}" oninput="updateBillingFilter('invMin', this.value)" class="bg-transparent border-none p-0 text-sm font-medium w-full outline-none">
                            <span class="text-slate-300">-</span>
                            <input type="number" placeholder="Max" value="${state.billingFilters.invMax}" oninput="updateBillingFilter('invMax', this.value)" class="bg-transparent border-none p-0 text-sm font-medium w-full outline-none">
                        </div>

                        <div class="col-span-1 md:col-span-2 flex items-center gap-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2 group cursor-pointer" onclick="this.querySelector('input').showPicker()">
                            <i class="ph-bold ph-calendar-blank text-slate-400 group-focus-within:text-indigo-500"></i>
                            <input type="date" value="${state.billingFilters.dateStart}" onchange="updateBillingFilter('dateStart', this.value)" class="bg-transparent border-none p-0 text-sm font-medium w-full outline-none cursor-pointer">
                            <span class="text-slate-300">/</span>
                            <input type="date" value="${state.billingFilters.dateEnd}" onchange="updateBillingFilter('dateEnd', this.value)" class="bg-transparent border-none p-0 text-sm font-medium w-full outline-none cursor-pointer">
                        </div>
                    </div>
                </div>
            `;
            };

            const renderBilling = () => {
                const filters = state.billingFilters;

                // Init Pagination State
                if (!state.billingPage) state.billingPage = 1;
                const rowsPerPage = 50;

                // Check if searching for SI Number (e.g., "SI 5")
                const siMatch = filters.search.match(/^si\s*-?\s*(\d+)$/i);

                const filteredTrips = trips.filter((t, index) => {
                    // SI Filter Strategy
                    if (siMatch) {
                        return (index + 1) === parseInt(siMatch[1]);
                    }

                    const matchSearch = filters.search === '' || (t.billNumber?.toLowerCase().includes(filters.search.toLowerCase()) || t.utrNumber?.toLowerCase().includes(filters.search.toLowerCase()));
                    const matchVeh = filters.vehicle === '' || (t.truckNumber?.toLowerCase().includes(filters.vehicle.toLowerCase()) || t.vehicleNumber?.toLowerCase().includes(filters.vehicle.toLowerCase()));
                    const matchDriver = filters.driverName === '' || t.driverName?.toLowerCase().includes(filters.driverName.toLowerCase());

                    const statusArr = Array.isArray(filters.status) ? filters.status : [filters.status];
                    const matchStatus = statusArr.includes('All') || statusArr.includes(t.billingStatus || 'Pending');

                    const matchPickup = filters.pickup === '' || t.pickupLocation?.toLowerCase().includes(filters.pickup.toLowerCase());
                    const matchDrop = filters.drop === '' || t.dropLocation?.toLowerCase().includes(filters.drop.toLowerCase());

                    const typeArr = Array.isArray(filters.type) ? filters.type : [filters.type];
                    const matchType = typeArr.includes('All') || typeArr.includes(t.tripCategory);

                    const classArr = Array.isArray(filters.class) ? filters.class : [filters.class];
                    const matchClass = classArr.includes('All') || classArr.includes(t.tripType);

                    let matchDate = true;
                    if (filters.dateStart) matchDate = matchDate && (t.billDate || t.date) >= filters.dateStart;
                    if (filters.dateEnd) matchDate = matchDate && (t.billDate || t.date) <= filters.dateEnd;

                    let matchNet = true;
                    if (filters.netMin) matchNet = matchNet && (t.netAmount || 0) >= parseFloat(filters.netMin);
                    if (filters.netMax) matchNet = matchNet && (t.netAmount || 0) <= parseFloat(filters.netMax);

                    let matchInv = true;
                    if (filters.invMin) matchInv = matchInv && (t.billAmount || 0) >= parseFloat(filters.invMin);
                    if (filters.invMax) matchInv = matchInv && (t.billAmount || 0) <= parseFloat(filters.invMax);

                    return matchSearch && matchVeh && matchDriver && matchStatus && matchPickup && matchDrop && matchType && matchClass && matchDate && matchNet && matchInv;
                });

                // Pagination Logic
                const totalRows = filteredTrips.length;
                const totalPages = Math.ceil(totalRows / rowsPerPage);
                if (state.billingPage > totalPages) state.billingPage = Math.max(1, totalPages);

                const startIndex = (state.billingPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;
                const paginatedTrips = filteredTrips.slice(startIndex, endIndex);

                return `
                ${renderBillingFilters()}
                
                <!-- Bulk Action Bar -->
                <div id="bulk-action-bar" class="hidden mb-4 p-4 bg-indigo-600 rounded-2xl shadow-lg border border-indigo-500 animate-fade-in flex flex-col md:flex-row items-center justify-between gap-4 text-white">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                            <i class="ph-bold ph-check-square-offset text-xl text-white"></i>
                        </div>
                        <div>
                            <p id="checked-count" class="text-sm font-bold">0 Items Selected</p>
                            <p class="text-[10px] text-white/70">Perform actions on all selected trips</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1 bg-white/10 p-1 rounded-xl border border-white/20 mr-2">
                            <span class="text-[9px] font-bold uppercase tracking-wider ml-2 mr-2 opacity-70 text-white">Status:</span>
                            ${['Pending', 'Approved', 'Billed', 'Paid'].map(s => `
                                <button onclick="bulkUpdateStatus('${s}')" class="px-3 py-1.5 rounded-lg text-[10px] font-bold bg-white/10 hover:bg-white text-indigo-100 hover:text-indigo-600 transition-all border border-transparent hover:border-white">
                                    ${s}
                                </button>
                            `).join('')}
                        </div>
                        
                        <button onclick="bulkDeleteTrips()" class="px-5 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-xl text-xs font-bold shadow-lg shadow-red-500/30 transition-all active:scale-95 flex items-center gap-2">
                            <i class="ph-bold ph-trash"></i> Delete Selected
                        </button>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col h-[calc(100vh-340px)]">
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="sticky top-0 z-10 shadow-sm transition-all duration-300">
                                <tr class="text-[10px] font-extrabold uppercase text-slate-900 border-b border-slate-200 leading-tight">
                                    <th class="p-3 bg-white border-r border-slate-100 sticky left-0 z-30 min-w-[50px] text-center">SAVE</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[50px] text-center">SI NO.</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[40px] text-center">
                                        <input type="checkbox" class="rounded border-slate-300" onchange="window.toggleAllBilling(this.checked)">
                                        <div class="text-[8px] mt-0.5">ALL</div>
                                    </th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[80px]">DATE</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[100px]">VEH. NO</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[120px]">PICK FROM</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[120px]">DROP TO</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[160px]">VEHICLE ID</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[70px]">TYPE</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[70px]">CLASS</th>
                                    
                                    <th class="p-3 bg-[#92d050] border-r border-green-500 min-w-[90px]">NET AMOUNT</th>
                                    <th class="p-3 bg-[#92d050] border-r border-green-500 min-w-[90px]">INV. AMOUNT</th>
                                    <th class="p-3 bg-[#92d050] border-r border-green-500 min-w-[120px]">BILL STATUS</th>
                                    <th class="p-3 bg-[#92d050] border-r border-green-500 min-w-[90px]">BILL NUMBER</th>
                                    <th class="p-3 bg-[#92d050] border-r border-green-500 min-w-[110px]">BILL DATE</th>
                                    <th class="p-3 bg-[#92d050] border-r border-green-500 min-w-[140px]">UTR NUMBER WITH DATE</th>
                                    
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[120px]">DRIVER NAME</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[90px]">STARTING KM</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[90px]">CLOSING KM</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[70px]">TRIP KM</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[80px]">STARTING TIME</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[80px]">ENDING TIME</th>
                                    <th class="p-3 bg-[#00b0f0] border-r border-sky-400 text-white min-w-[70px]">DURATION (MIN)</th>
                                </tr>
                            </thead>
                            <tbody class="text-xs divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800 animate-fade-in">
                                ${paginatedTrips.map((t, idx) => {
                    const start = t.startTime ? new Date(t.startTime.seconds * 1000) : null;
                    const end = t.endTime ? new Date(t.endTime.seconds * 1000) : null;
                    const duration = (start && end) ? Math.round((end - start) / 60000) : '-';
                    const tripKm = (t.endOdo && t.startOdo) ? (t.endOdo - t.startOdo) : '-';
                    const currentStatus = t.billingStatus || 'Pending';
                    const realIndex = startIndex + idx + 1;

                    return `
                                 <tr id="fin-row-${t.id}" class="even:bg-slate-100 dark:even:bg-slate-800/50 hover:bg-indigo-50/30 dark:hover:bg-indigo-900/10 transition-colors group">
                                    <td class="p-2 border-r border-slate-200 sticky left-0 bg-inherit dark:bg-inherit shadow-sm z-20 text-center">
                                        <button onclick="updateTripFinancials('${t.id}')" class="fin-save-btn w-8 h-8 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 flex items-center justify-center transition-colors shadow-sm mx-auto">
                                            <i class="ph-bold ph-floppy-disk"></i>
                                        </button>
                                        <button onclick="softDeleteTrip('${t.id}', 'ams_trips', 'Financial Management > Billing Reconciliation')" class="w-8 h-8 mt-1 rounded-lg bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/50 flex items-center justify-center transition-colors shadow-sm mx-auto" title="Delete Trip">
                                            <i class="ph-bold ph-trash"></i>
                                        </button>
                                    </td>
                                    <td class="p-2 border-r border-slate-100 text-center text-slate-500 font-medium">${realIndex}</td>
                                    <td class="p-2 border-r border-slate-100 text-center">
                                        <input type="checkbox" class="rounded border-slate-300 billing-checkbox" data-id="${t.id}" onchange="onBillingCheckboxChange()">
                                    </td>
                                    <td class="p-2 border-r border-slate-100 font-medium">${t.date || '-'}</td>
                                    <td class="p-2 border-r border-slate-100 font-bold text-slate-800">${t.truckNumber || '-'}</td>
                                    <td class="p-2 border-r border-slate-100">${t.pickupLocation}</td>
                                    <td class="p-2 border-r border-slate-100">${t.dropLocation}</td>
                                    <td class="p-2 border-r border-slate-100">
                                        <input type="text" value="${t.vehicleNumber || ''}" class="fin-veh-id w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-[10px]">
                                    </td>
                                    <td class="p-2 border-r border-slate-100">
                                        <span class="px-2 py-0.5 rounded bg-slate-100 text-[10px] font-bold text-slate-600">${t.tripCategory || 'Empty'}</span>
                                    </td>
                                    <td class="p-2 border-r border-slate-100">
                                        <span class="px-2 py-0.5 rounded bg-slate-100 text-[10px] font-bold text-slate-600">${t.tripType || 'Empty'}</span>
                                    </td>
                                    
                                    <td class="p-2 border-r border-slate-100">
                                        <input type="number" onchange="updateTripFinancials('${t.id}')" class="fin-net-amount w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-[10px] font-bold text-right" value="${t.netAmount || '0.00'}">
                                    </td>
                                    <td class="p-2 border-r border-slate-100">
                                        <input type="number" onchange="updateTripFinancials('${t.id}')" class="fin-amount w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-[10px] font-bold text-right" value="${t.billAmount || '0.00'}">
                                    </td>
                                    <td class="p-2 border-r border-slate-100">
                                        <select onchange="updateTripFinancials('${t.id}')" class="fin-status w-full bg-white border border-slate-300 rounded px-2 py-1 text-[10px] font-bold ${currentStatus === 'Approved' ? 'text-green-600' : (currentStatus === 'Paid' ? 'text-indigo-600' : 'text-orange-500')}">
                                            <option value="Pending" ${currentStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="Approved" ${currentStatus === 'Approved' ? 'selected' : ''}>Approved</option>
                                            <option value="Billed" ${currentStatus === 'Billed' ? 'selected' : ''}>Billed</option>
                                            <option value="Paid" ${currentStatus === 'Paid' ? 'selected' : ''}>Paid</option>
                                        </select>
                                    </td>
                                    <td class="p-2 border-r border-slate-100">
                                        <input type="text" onchange="updateTripFinancials('${t.id}')" class="fin-bill-no w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-[10px]" value="${t.billNumber || ''}" placeholder="Bill #">
                                    </td>
                                    <td class="p-2 border-r border-slate-100">
                                        <input type="date" onchange="updateTripFinancials('${t.id}')" class="fin-bill-date w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-[10px]" value="${t.billDate || ''}">
                                    </td>
                                    <td class="p-2 border-r border-slate-100">
                                        <div class="flex flex-col gap-1">
                                            <input type="text" onchange="updateTripFinancials('${t.id}')" class="fin-utr w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-[10px]" value="${t.utrNumber || ''}" placeholder="UTR #">
                                            <input type="date" onchange="updateTripFinancials('${t.id}')" class="fin-utr-date w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-[10px]" value="${t.utrDate || ''}">
                                        </div>
                                    </td>
                                    
                                    <td class="p-2 border-r border-slate-100 font-bold text-slate-700">${t.driverName}</td>
                                    <td class="p-2 border-r border-slate-100 text-right font-mono text-slate-500">${t.startOdo}</td>
                                    <td class="p-2 border-r border-slate-100 text-right font-mono text-slate-500">${t.endOdo}</td>
                                    <td class="p-2 border-r border-slate-100 text-right font-bold text-blue-600">${tripKm}</td>
                                    <td class="p-2 border-r border-slate-100 text-right text-slate-500">${start ? start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) : '-'}</td>
                                    <td class="p-2 border-r border-slate-100 text-right text-slate-500">${end ? end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) : '-'}</td>
                                    <td class="p-2 border-r border-slate-100 text-right font-bold text-slate-800">${duration}</td>
                                </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                        ${filteredTrips.length === 0 ? '<div class="p-8 text-center text-slate-400">No completed trips found for this filter.</div>' : ''}
                    </div>

                    <!-- Pagination Footer -->
                    <div class="p-3 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex items-center justify-between">
                         <div class="text-xs text-slate-500 dark:text-slate-400 font-bold">
                            Showing ${Math.min(startIndex + 1, totalRows)}-${Math.min(endIndex, totalRows)} of ${totalRows} entries
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="state.billingPage = Math.max(1, state.billingPage - 1); render()" ${state.billingPage === 1 ? 'disabled' : ''} class="w-8 h-8 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center text-slate-500 hover:text-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="ph-bold ph-caret-left"></i>
                            </button>
                             <div class="px-3 py-1.5 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-700 dark:text-white">
                                Page ${state.billingPage} / ${Math.max(1, totalPages)}
                            </div>
                            <button onclick="state.billingPage = Math.min(${totalPages}, state.billingPage + 1); render()" ${state.billingPage >= totalPages ? 'disabled' : ''} class="w-8 h-8 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center text-slate-500 hover:text-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="ph-bold ph-caret-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            };

            const renderVehicleReport = () => {
                // Group by Truck
                const map = {};

                // Initialize map with trips
                trips.forEach(t => {
                    const k = t.truckNumber || 'Unknown';
                    if (!map[k]) map[k] = { count: 0, revenue: 0, verified: 0, expense: 0 };
                    map[k].count++;
                    map[k].revenue += (t.billAmount || 0);
                    if (t.billingStatus === 'Approved') map[k].verified += (t.billAmount || 0);
                });

                // Calculate Expenses (Fuel - all, others - approved only)
                (state.fuelLogs || []).forEach(l => {
                    const k = l.vehicleNumber;
                    if (k && map[k]) map[k].expense += (l.totalCost || 0);
                });

                (state.maintenanceLogs || []).forEach(l => {
                    const k = l.vehicleNumber;
                    if (k && map[k] && l.status === 'Approved') map[k].expense += (parseFloat(l.price) || 0);
                });

                (state.policeFines || []).forEach(l => {
                    const k = l.vehicleNumber;
                    if (k && map[k] && l.status === 'Approved') map[k].expense += (parseFloat(l.amount) || 0);
                });

                (state.tollLogs || []).forEach(l => {
                    const k = l.vehicleNumber;
                    if (k && map[k] && l.status === 'Approved') map[k].expense += (parseFloat(l.amount) || 0);
                });

                return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${Object.entries(map).map(([truck, stats]) => `
                    <div onclick="openVehicleDetail('${truck}')" class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between group hover:border-indigo-500 transition-colors cursor-pointer hover:shadow-md">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-lg text-slate-800 dark:text-white group-hover:text-indigo-600 transition-colors">${truck}</h4>
                                <p class="text-xs text-slate-500 dark:text-slate-400">${stats.count} Trips</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-slate-400 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-colors">
                                <i class="ph-fill ph-truck text-xl"></i>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs font-bold uppercase text-slate-400 mb-1">Total Revenue</p>
                                <div class="flex items-baseline gap-2">
                                    <p class="text-2xl font-bold text-slate-800 dark:text-white">₹${stats.revenue.toLocaleString()}</p>
                                    ${stats.verified > 0 ? `<span class="text-xs text-green-600 font-bold bg-green-50 px-1.5 py-0.5 rounded"><i class="ph-bold ph-check"></i> Verified</span>` : ''}
                                </div>
                            </div>
                            <div>
                                <p class="text-xs font-bold uppercase text-slate-400 mb-1">Total Expense</p>
                                <p class="text-2xl font-bold text-red-600 dark:text-red-400">₹${stats.expense.toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center">
                            <div>
                                <p class="text-[10px] font-bold uppercase text-slate-400">Net Profit</p>
                                <p class="text-lg font-bold ${stats.revenue - stats.expense >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                    ₹${(stats.revenue - stats.expense).toLocaleString()}
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-bold uppercase text-slate-400">Margin</p>
                                <p class="text-lg font-bold text-slate-700 dark:text-slate-300">
                                    ${stats.revenue > 0 ? Math.round(((stats.revenue - stats.expense) / stats.revenue) * 100) : 0}%
                                </p>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-slate-100 dark:border-slate-700 font-bold text-xs text-indigo-500 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            View Report <i class="ph-bold ph-arrow-right"></i>
                        </div>
                    </div>
                    `).join('')}
                </div>`;
            };

            const renderVehicleDetail = (veh) => {
                // 0. Find Vehicle Object
                const vehicleObj = state.vehicles.find(v => (v.vehicleNumber || v.number) === veh) || {};

                // --- NEW: Month Filter ---
                const todayStr = new Date().toISOString().slice(0, 7); // YYYY-MM
                if (!state.vehReportMonth) state.vehReportMonth = todayStr;
                const currentMonth = state.vehReportMonth;

                // 1. Gather Data (Filter by Month)
                const allVehTrips = trips.filter(t => (t.truckNumber === veh || t.vehicleNumber === veh) && t.status === 'completed');
                const allVehFuel = state.fuelLogs.filter(l => l.vehicleNumber === veh);
                const allVehMaint = state.maintenanceLogs.filter(l => l.vehicleNumber === veh);
                const allVehPolice = state.policeFines.filter(l => l.vehicleNumber === veh);
                const allVehToll = state.tollLogs.filter(l => l.vehicleNumber === veh);

                const filterByMonth = (items) => items.filter(i => (i.date || i.billDate || '').startsWith(currentMonth));

                const vehTrips = filterByMonth(allVehTrips);
                const vehFuel = filterByMonth(allVehFuel);
                const vehMaint = filterByMonth(allVehMaint);
                const vehPolice = filterByMonth(allVehPolice);
                const vehToll = filterByMonth(allVehToll);

                // 2. Initial Tabs State
                if (!state.vehReportTab) state.vehReportTab = 'fuel';

                // 3. Totals (Monthly)
                // Distance Calculation: Min/Max Odometer from Trips & Fuel for this month
                let odometers = [];
                vehTrips.forEach(t => {
                    if (t.startOdo) odometers.push(parseInt(t.startOdo));
                    if (t.endOdo) odometers.push(parseInt(t.endOdo));
                });
                vehFuel.forEach(f => {
                    if (f.odometer) odometers.push(parseInt(f.odometer));
                });
                // Remove NaNs and sort
                odometers = odometers.filter(o => !isNaN(o)).sort((a, b) => a - b);

                let totalKm = 0;
                if (odometers.length > 1) {
                    totalKm = odometers[odometers.length - 1] - odometers[0];
                } else {
                    // Fallback to sum if continuity is broken
                    totalKm = vehTrips.reduce((sum, t) => sum + ((t.endOdo && t.startOdo) ? (t.endOdo - t.startOdo) : 0), 0);
                }

                const totalFuelCost = vehFuel.reduce((sum, l) => sum + (l.totalCost || 0), 0);
                const totalMaintCost = vehMaint.filter(l => l.status === 'Approved').reduce((sum, l) => sum + (parseFloat(l.price) || 0), 0);
                const totalFineToll = vehPolice.filter(l => l.status === 'Approved').reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0) +
                    vehToll.filter(l => l.status === 'Approved').reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);

                // RTO Compliance Cost (Paid in this month)
                const complianceItems = [
                    { amt: vehicleObj.rtoTaxAmount, date: vehicleObj.rtoTaxDate, status: vehicleObj.rtoTaxStatus },
                    { amt: vehicleObj.rtoFitnessAmount, date: vehicleObj.rtoFitnessDate, status: vehicleObj.rtoFitnessStatus },
                    { amt: vehicleObj.rtoPollutionAmount, date: vehicleObj.rtoPollutionDate, status: vehicleObj.rtoPollutionStatus },
                    { amt: vehicleObj.rtoPermitAmount, date: vehicleObj.rtoPermitDate, status: vehicleObj.rtoPermitStatus },
                    { amt: vehicleObj.insuranceAmount, date: vehicleObj.insuranceDate, status: vehicleObj.insuranceStatus }
                ];
                const totalComplianceCost = complianceItems.reduce((sum, item) => {
                    const inMonth = (item.date || '').startsWith(currentMonth);
                    return (item.status === 'Approved' && inMonth) ? sum + (parseFloat(item.amt) || 0) : sum;
                }, 0);

                const totalExpense = totalFuelCost + totalMaintCost + totalFineToll + totalComplianceCost;

                // --- Fuel Cost Per KM & Mileage ---
                const costPerKm = totalKm > 0 ? (totalFuelCost / totalKm) : 0;
                const totalLitres = vehFuel.reduce((sum, l) => sum + (parseFloat(l.litres) || 0), 0);
                const kmPerLiter = totalLitres > 0 ? (totalKm / totalLitres) : 0;

                // --- Helper Functions for Updates ---
                window.updateFuelPrice = async (id, litres, val) => {
                    const price = parseFloat(val);
                    if (isNaN(price)) return;
                    const total = Math.round(price * litres);
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_fuel_logs', id), {
                            pricePerLiter: price,
                            totalCost: total
                        });
                        // Optimistic update for UI feel (optional, but render handles it via snapshot)
                    } catch (e) {
                        console.error("Fuel update failed", e);
                        showToast("Failed to save price", "error");
                    }
                };

                window.approveRTO = async (vehicleId, fieldPrefix) => {
                    if (!confirm('Approve this RTO payment?')) return;

                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', vehicleId), {
                            [`${fieldPrefix}Status`]: 'Approved',
                            updatedAt: serverTimestamp()
                        });
                        showToast('RTO Payment Approved', 'success');
                        // Optimistic update
                        const v = state.vehicles.find(v => v.id === vehicleId);
                        if (v) {
                            v[`${fieldPrefix}Status`] = 'Approved';
                            render(); // Re-render to show updated status
                        }
                    } catch (error) {
                        console.error("Error approving RTO:", error);
                        showToast('Failed to approve', 'error');
                    }
                };

                window.approveExpense = async (collectionName, id, priceVal) => {
                    try {
                        const payload = { status: 'Approved' };
                        if (priceVal !== undefined) payload.price = parseFloat(priceVal);
                        if (collectionName === 'ams_police_fines' || collectionName === 'ams_toll_logs') {
                            // For police/toll, field is 'amount' but we might want to edit it. 
                            // Assuming priceVal maps to 'amount' update if edited.
                            if (priceVal !== undefined) payload.amount = parseFloat(priceVal);
                        }

                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id), payload);
                        showToast("Expense Approved", "success");
                    } catch (e) {
                        console.error("Approval failed", e);
                        showToast("Failed to approve", "error");
                    }
                };

                // --- Tab Content Renderers ---
                const renderComplianceTab = () => {
                    const checkExpiry = (dateStr) => {
                        if (!dateStr) return { status: 'Missing', color: 'text-slate-400', bg: 'bg-slate-100 dark:bg-slate-700', days: null };
                        const today = new Date();
                        const exp = new Date(dateStr);
                        const diffTime = exp - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays < 0) return { status: 'Expired', color: 'text-red-700 dark:text-red-400', bg: 'bg-red-100 dark:bg-red-900/30', days: diffDays };
                        if (diffDays < 30) return { status: 'Expiring Soon', color: 'text-amber-700 dark:text-amber-400', bg: 'bg-amber-100 dark:bg-amber-900/30', days: diffDays };
                        return { status: 'Valid', color: 'text-green-700 dark:text-green-400', bg: 'bg-green-100 dark:bg-green-900/30', days: diffDays };
                    };

                    const items = [
                        { label: 'Tax', code: 'rtoTax', date: vehicleObj.rtoTaxDate, amount: vehicleObj.rtoTaxAmount, expiry: vehicleObj.rtoTaxExpiry, remarks: vehicleObj.rtoTaxRemarks, status: vehicleObj.rtoTaxStatus },
                        { label: 'Fitness', code: 'rtoFitness', date: vehicleObj.rtoFitnessDate, amount: vehicleObj.rtoFitnessAmount, expiry: vehicleObj.rtoFitnessExpiry, remarks: vehicleObj.rtoFitnessRemarks, status: vehicleObj.rtoFitnessStatus },
                        { label: 'Pollution', code: 'rtoPollution', date: vehicleObj.rtoPollutionDate, amount: vehicleObj.rtoPollutionAmount, expiry: vehicleObj.rtoPollutionExpiry, remarks: vehicleObj.rtoPollutionRemarks, status: vehicleObj.rtoPollutionStatus },
                        { label: 'Permit', code: 'rtoPermit', date: vehicleObj.rtoPermitDate, amount: vehicleObj.rtoPermitAmount, expiry: vehicleObj.rtoPermitExpiry, remarks: vehicleObj.rtoPermitRemarks, status: vehicleObj.rtoPermitStatus },
                        { label: 'Insurance', code: 'insurance', date: vehicleObj.insuranceDate, amount: vehicleObj.insuranceAmount, expiry: vehicleObj.insuranceExpiry, remarks: vehicleObj.insuranceRemarks, status: vehicleObj.insuranceStatus, sub: vehicleObj.insuranceProvider ? `${vehicleObj.insuranceProvider} (${vehicleObj.insurancePolicyNumber})` : '' }
                    ];

                    const lastServiceOdo = parseInt(vehicleObj.lastServiceOdometer) || 0;
                    const currentOdo = parseInt(vehicleObj.odometer) || 0;
                    const serviceDiffKm = currentOdo > 0 && lastServiceOdo > 0 ? (currentOdo - lastServiceOdo) : 0;

                    return `
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${items.map(item => {
                        const info = checkExpiry(item.expiry);
                        const isApproved = item.status === 'Approved';
                        const hasAmount = item.amount && parseFloat(item.amount) > 0;

                        return `
                                <div class="p-4 border rounded-xl ${info.bg} border-slate-200 dark:border-slate-700 relative overflow-hidden group">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-xs font-bold uppercase opacity-60 text-slate-700 dark:text-slate-300">${item.label}</span>
                                        <span class="text-[10px] font-bold uppercase px-2 py-0.5 bg-white/50 dark:bg-slate-800/50 rounded-lg ${info.color}">${info.status}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-end mb-2">
                                        <div>
                                            <div class="text-[10px] text-slate-500 uppercase font-bold">Expiry</div>
                                            <div class="font-bold text-lg text-slate-800 dark:text-white">${item.expiry ? item.expiry.split('-').reverse().join('-') : 'N/A'}</div>
                                        </div>
                                        <div class="text-right">
                                            ${item.date ? `<div class="text-[10px] text-slate-500">Paid: ${item.date.split('-').reverse().join('-')}</div>` : ''}
                                            ${hasAmount ? `<div class="font-bold text-slate-700 dark:text-white">₹${parseFloat(item.amount).toLocaleString()}</div>` : ''}
                                        </div>
                                    </div>
                                    
                                    ${item.sub ? `<div class="text-xs opacity-75 mb-2 truncate text-slate-600 dark:text-slate-400 font-medium" title="${item.sub}">${item.sub}</div>` : ''}
                                    ${item.remarks ? `<div class="text-xs italic opacity-60 mb-3 text-slate-600 dark:text-slate-400">"${item.remarks}"</div>` : ''}

                                    <div class="flex items-center justify-between pt-3 border-t border-slate-200/50 dark:border-slate-700/50">
                                         ${info.days !== null ? `<div class="text-xs font-medium ${info.color}">${Math.abs(info.days)} days ${info.days < 0 ? 'ago' : 'left'}</div>` : '<div></div>'}
                                         
                                         ${hasAmount ? (
                                isApproved ?
                                    `<span class="px-2 py-1 bg-green-200 dark:bg-green-900 text-green-800 dark:text-green-300 rounded text-[10px] font-bold flex items-center gap-1"><i class="ph-bold ph-check"></i> Approved</span>` :
                                    `<button onclick="approveRTO('${vehicleObj.id}', '${item.code}')" class="px-3 py-1 bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white rounded-lg text-[10px] font-bold shadow-lg shadow-slate-500/20 transition-all active:scale-95">Approve</button>`
                            ) : ''}
                                    </div>

                                    <!-- History Mini-View -->
                                    ${(() => {
                                const hist = (vehicleObj.rtoHistory || [])
                                    .filter(h => h.type === item.code)
                                    .sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt))
                                    .slice(0, 2); // Last 2 updates

                                if (hist.length > 0) {
                                    return `
                                            <div class="mt-3 pt-2 border-t border-dashed border-slate-200 dark:border-slate-700">
                                                <div class="text-[9px] font-bold text-slate-400 uppercase mb-2">History (Last 2)</div>
                                                <div class="space-y-2">
                                                    ${hist.map(h => `
                                                    <div class="flex justify-between items-start text-[10px] opacity-75">
                                                        <div>
                                                            <div class="font-bold text-slate-600 dark:text-slate-400">${h.date || 'No Date'}</div>
                                                            <div class="text-[9px] text-slate-400">${h.expiry ? 'Exp: ' + h.expiry.split('-').reverse().join('-') : ''}</div>
                                                        </div>
                                                        <div class="font-bold text-slate-600 dark:text-slate-300">₹${parseFloat(h.amount || 0).toLocaleString()}</div>
                                                    </div>
                                                    `).join('')}
                                                </div>
                                            </div>`;
                                }
                                return '';
                            })()}
                                </div>`;
                    }).join('')}
                        </div>

                        <div class="p-4 bg-indigo-50 dark:bg-blue-900/10 rounded-xl border border-indigo-100 dark:border-blue-900/30">
                             <h4 class="font-bold text-indigo-700 dark:text-indigo-400 mb-4 flex items-center gap-2"><i class="ph-fill ph-wrench"></i> Maintenance Status</h4>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <div class="text-xs text-slate-500 uppercase font-bold mb-1">Last Service</div>
                                    <div class="font-mono font-bold text-lg text-slate-800 dark:text-white">${vehicleObj.lastServiceDate ? vehicleObj.lastServiceDate.split('-').reverse().join('-') : 'N/A'}</div>
                                    <div class="text-xs text-slate-400 font-mono">${lastServiceOdo > 0 ? lastServiceOdo + ' km' : 'N/A'}</div>
                                </div>
                                 <div>
                                    <div class="text-xs text-slate-500 uppercase font-bold mb-1">Current Odo</div>
                                    <div class="font-mono font-bold text-lg text-slate-800 dark:text-white">${currentOdo > 0 ? currentOdo + ' km' : 'N/A'}</div>
                                    <div class="text-xs text-slate-400">Run since service: ${serviceDiffKm > 0 ? serviceDiffKm + ' km' : '-'}</div>
                                </div>
                                 <div class="flex items-center">
                                     ${serviceDiffKm > 10000 ?
                            `<div class="text-red-600 dark:text-red-400 font-bold flex items-center gap-2"><div class="p-2 bg-red-100 rounded-lg"><i class="ph-fill ph-warning"></i></div> <span>Due for Service</span></div>` :
                            `<div class="text-green-600 dark:text-green-400 font-bold flex items-center gap-2"><div class="p-2 bg-green-100 rounded-lg"><i class="ph-fill ph-check-circle"></i></div> <span>Good Condition</span></div>`
                        }
                                </div>
                             </div>
                        </div>
                    </div>
                    `;
                };

                const renderFuelTab = () => `
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-indigo-50/50 text-indigo-900 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4">Date/Time</th>
                                <th class="p-4">Driver</th>
                                <th class="p-4 text-right">Litres</th>
                                <th class="p-4 text-right">Price/L (₹)</th>
                                <th class="p-4 text-right">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${vehFuel.length ? vehFuel.map(f => `
                            <tr class="hover:bg-slate-50 transition-colors even:bg-slate-100 dark:even:bg-slate-800/50">
                                <td class="p-4 font-mono text-sm">${f.date}</td>
                                <td class="p-4 text-sm font-medium">${f.driverName || '-'}</td>
                                <td class="p-4 text-right font-bold">${f.litres} L</td>
                                <td class="p-4 text-right">
                                    <input type="number" value="${f.pricePerLiter || ''}" 
                                        onchange="updateFuelPrice('${f.id}', ${f.litres}, this.value)"
                                        class="w-20 px-2 py-1 border border-slate-200 rounded text-right font-medium focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="0.00">
                                </td>
                                <td class="p-4 text-right font-bold text-slate-800">
                                    ₹${(f.totalCost || 0).toLocaleString()}
                                </td>
                            </tr>
                            `).join('') : '<tr><td colspan="5" class="p-8 text-center text-slate-400">No fuel records.</td></tr>'}
                        </tbody>
                    </table>
                `;

                const renderMaintTab = () => `
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-red-50/50 text-red-900 text-xs uppercase font-bold">
                             <tr>
                                <th class="p-4">Date</th>
                                <th class="p-4">Driver</th>
                                <th class="p-4">Issue</th>
                                <th class="p-4">Place</th>
                                <th class="p-4 text-right">Cost (₹)</th>
                                <th class="p-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                             ${vehMaint.length ? vehMaint.map(m => `
                            <tr class="hover:bg-slate-50 transition-colors even:bg-slate-100 dark:even:bg-slate-800/50">
                                <td class="p-4 font-mono text-sm">${m.date}</td>
                                <td class="p-4 text-sm font-medium text-slate-700 dark:text-slate-300">${m.driverName || '-'}</td>
                                <td class="p-4 text-sm">
                                    <div class="flex flex-wrap gap-1">
                                         ${[...(m.general || []), ...(m.tyre || [])].map(i => `<span class="px-2 py-0.5 bg-slate-100 rounded text-xs">${i}</span>`).join('')}
                                    </div>
                                </td>
                                <td class="p-4 text-sm text-slate-600">${m.place}</td>
                                <td class="p-4 text-right">
                                     <input type="number" id="maint-price-${m.id}" value="${m.price || ''}" 
                                        class="w-24 px-2 py-1 border border-slate-200 rounded text-right font-bold text-slate-700 focus:ring-2 focus:ring-red-500 outline-none" placeholder="0.00">
                                </td>
                                <td class="p-4 text-center">
                                    ${m.status === 'Approved' ?
                        `<div class="flex items-center gap-2 justify-center">
                                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold"><i class="ph-bold ph-check"></i> Approved</span>
                                            <button onclick="approveExpense('ams_maintenance_logs', '${m.id}', document.getElementById('maint-price-${m.id}').value)" 
                                                class="w-6 h-6 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-indigo-600 flex items-center justify-center transition-colors" title="Update Amount">
                                                <i class="ph-bold ph-arrows-clockwise"></i>
                                            </button>
                                        </div>` :
                        `<button onclick="approveExpense('ams_maintenance_logs', '${m.id}', document.getElementById('maint-price-${m.id}').value)" 
                                            class="px-3 py-1 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 shadow-sm transition-all hover:scale-105 active:scale-95">
                                            Approve
                                        </button>`
                    }
                                </td>
                            </tr>
                            `).join('') : '<tr><td colspan="6" class="p-8 text-center text-slate-400">No maintenance records.</td></tr>'}
                        </tbody>
                    </table>
                `;

                const renderExpenseTab = (logs, type) => `
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-blue-50/50 text-blue-900 text-xs uppercase font-bold">
                             <tr>
                                <th class="p-4">Date</th>
                                <th class="p-4">Driver</th>
                                <th class="p-4">Trip / Location</th>
                                <th class="p-4 text-right">Amount (₹)</th>
                                <th class="p-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                             ${logs.length ? logs.map(l => `
                            <tr class="hover:bg-slate-50 transition-colors even:bg-slate-100 dark:even:bg-slate-800/50">
                                <td class="p-4 font-mono text-sm">${l.date ? l.date.replace('T', ' ') : '-'}</td>
                                <td class="p-4 text-sm font-medium text-slate-700 dark:text-slate-300">
                                    ${l.driverName || '-'}
                                </td>
                                <td class="p-4 text-sm">
                                     ${l.pickup ? `<span class="font-medium">${l.pickup}</span> <i class="ph-bold ph-arrow-right text-xs text-slate-400"></i> <span class="font-medium">${l.drop}</span>` : 'General Entry'}
                                </td>
                                <td class="p-4 text-right">
                                     <input type="number" id="${type}-amt-${l.id}" value="${l.amount || ''}" 
                                        class="w-24 px-2 py-1 border border-slate-200 rounded text-right font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                                </td>
                                <td class="p-4 text-center">
                                    ${l.status === 'Approved' ?
                        `<div class="flex items-center gap-2 justify-center">
                                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold"><i class="ph-bold ph-check"></i> Approved</span>
                                            <button onclick="approveExpense('${type === 'police' ? 'ams_police_fines' : 'ams_toll_logs'}', '${l.id}', document.getElementById('${type}-amt-${l.id}').value)" 
                                                class="w-6 h-6 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-indigo-600 flex items-center justify-center transition-colors" title="Update Amount">
                                                <i class="ph-bold ph-arrows-clockwise"></i>
                                            </button>
                                        </div>` :
                        `<button onclick="approveExpense('${type === 'police' ? 'ams_police_fines' : 'ams_toll_logs'}', '${l.id}', document.getElementById('${type}-amt-${l.id}').value)" 
                                            class="px-3 py-1 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 shadow-sm transition-all hover:scale-105 active:scale-95">
                                            Approve
                                        </button>`
                    }
                                </td>
                            </tr>
                            `).join('') : `<tr><td colspan="5" class="p-8 text-center text-slate-400">No ${type} records.</td></tr>`}
                        </tbody>
                    </table>
                `;

                return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <button onclick="closeVehicleDetail()" class="w-10 h-10 rounded-xl bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:text-slate-800 hover:border-slate-300 transition-all shadow-sm">
                                <i class="ph-bold ph-arrow-left"></i>
                            </button>
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">${veh} <span class="text-sm font-normal text-slate-500 ml-2">Report Details</span></h2>
                            </div>
                        </div>
                        <div>
                             <input type="month" value="${state.vehReportMonth}" onchange="state.vehReportMonth=this.value; render()" 
                                class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white shadow-sm outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <div class="bg-indigo-50 dark:bg-slate-800 p-5 rounded-2xl border border-indigo-100 dark:border-slate-700">
                             <div class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-1">Total Km Run</div>
                             <div class="text-2xl font-bold text-indigo-700 dark:text-white">${totalKm.toLocaleString()} <span class="text-sm font-medium opacity-60">km</span></div>
                        </div>
                        <div class="bg-amber-50 dark:bg-slate-800 p-5 rounded-2xl border border-amber-100 dark:border-slate-700">
                             <div class="text-xs font-bold text-amber-500 uppercase tracking-wider mb-1">Fuel Cost</div>
                             <div class="text-2xl font-bold text-amber-700 dark:text-white">₹${totalFuelCost.toLocaleString()}</div>
                        </div>
                        
                        <!-- KM Per Liter Indicator -->
                        <div class="bg-emerald-50 dark:bg-slate-800 p-5 rounded-2xl border border-emerald-100 dark:border-slate-700">
                             <div class="text-xs font-bold text-emerald-500 uppercase tracking-wider mb-1">KM Per Liter</div>
                             <div class="text-2xl font-bold text-emerald-700 dark:text-white">${kmPerLiter.toFixed(1)} <span class="text-sm font-medium opacity-60">km/L</span></div>
                        </div>

                        <div class="bg-red-50 dark:bg-slate-800 p-5 rounded-2xl border border-red-100 dark:border-slate-700">
                             <div class="text-xs font-bold text-red-400 uppercase tracking-wider mb-1">Maint. Cost</div>
                             <div class="text-2xl font-bold text-red-700 dark:text-white">₹${totalMaintCost.toLocaleString()}</div>
                        </div>
                        
                        <!-- Cost Per KM Indicator -->
                        <div class="bg-orange-50 dark:bg-slate-800 p-5 rounded-2xl border border-orange-100 dark:border-slate-700">
                             <div class="text-xs font-bold text-orange-400 uppercase tracking-wider mb-1">Cost / KM</div>
                             <div class="text-2xl font-bold text-orange-700 dark:text-white">₹${costPerKm.toFixed(2)}</div>
                        </div>
                        <div class="bg-blue-50 dark:bg-slate-800 p-5 rounded-2xl border border-blue-100 dark:border-slate-700">
                             <div class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-1">Fine & Toll</div>
                             <div class="text-2xl font-bold text-blue-700 dark:text-white">₹${totalFineToll.toLocaleString()}</div>
                        </div>
                         <div class="bg-slate-100 dark:bg-slate-800 p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
                             <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Total Expense</div>
                             <div class="text-2xl font-bold text-slate-800 dark:text-white">₹${totalExpense.toLocaleString()}</div>
                        </div>
                    </div>

                    <!-- Tabs & Content -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="flex border-b border-slate-100 dark:border-slate-700 px-6 pt-4 gap-6 overflow-x-auto">
                            ${['compliance', 'fuel', 'maintenance', 'police', 'toll'].map(t => `
                            <button onclick="window.state.vehReportTab = '${t}'; render()" 
                                class="pb-4 text-sm font-bold capitalize transition-all border-b-2 whitespace-nowrap ${state.vehReportTab === t ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}">
                                ${t === 'police' ? 'Police Fine' : (t === 'toll' ? 'Toll Gate' : t)}
                            </button>
                            `).join('')}
                        </div>
                        
                        <div class="p-0">
                            ${state.vehReportTab === 'compliance' ? renderComplianceTab() :
                        state.vehReportTab === 'fuel' ? renderFuelTab() :
                            state.vehReportTab === 'maintenance' ? renderMaintTab() :
                                state.vehReportTab === 'police' ? renderExpenseTab(vehPolice, 'police') :
                                    renderExpenseTab(vehToll, 'toll')}
                        </div>
                    </div>
                </div>`;
            };

            const renderDriverReport = () => {
                // 1. Group by Driver
                const map = {};

                // 2. Performance Metrics
                const metrics = {
                    category: { New: 0, Break: 0, Empty: 0 },
                    type: { TVS: 0, INT: 0, FREE: 0, SERVICE: 0, DIRECT: 0, Other: 0 },
                    billing: { Billed: 0, Unbilled: 0 }
                };

                trips.forEach(t => {
                    // Driver Aggregation
                    const k = t.driverName || 'Unknown';
                    if (!map[k]) map[k] = { count: 0, revenue: 0 };
                    map[k].count++;
                    map[k].revenue += (t.billAmount || 0);

                    // Category Counts
                    const cat = t.tripCategory || 'New';
                    if (cat.toLowerCase().includes('break')) metrics.category.Break++;
                    else if (cat === 'Empty') metrics.category.Empty++;
                    else metrics.category.New++;

                    // Type Counts
                    const type = (t.tripType || '').toUpperCase();
                    if (type.includes('TVS')) metrics.type.TVS++;
                    else if (type.includes('INT') || type.includes('INTER')) metrics.type.INT++;
                    else if (type.includes('FREE')) metrics.type.FREE++;
                    else if (type.includes('SERVICE')) metrics.type.SERVICE++;
                    else if (type.includes('DIRECT')) metrics.type.DIRECT++;
                    else metrics.type.Other++; // Optional: Hide or show if relevant

                    // Billing Counts
                    const isBilled = t.billingStatus === 'Approved' || (t.billAmount && parseFloat(t.billAmount) > 0);
                    if (isBilled) metrics.billing.Billed++;
                    else metrics.billing.Unbilled++;
                });

                return `
                 <div class="space-y-6 animate-fade-in">
                     <!-- Service Performance Dashboard -->
                     <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
                            <i class="ph-fill ph-chart-pie-slice text-indigo-500"></i> Service Performance
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <!-- Trip Category -->
                            <div class="space-y-4">
                                <h4 class="text-xs font-bold uppercase text-slate-400">Trip Category</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800/50">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-800 flex items-center justify-center text-indigo-600 dark:text-indigo-400"><i class="ph-bold ph-plus-circle"></i></div>
                                            <span class="font-bold text-slate-700 dark:text-slate-300">New</span>
                                        </div>
                                        <span class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${metrics.category.New}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-100 dark:border-red-800/50">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg bg-red-100 dark:bg-red-800 flex items-center justify-center text-red-600 dark:text-red-400"><i class="ph-bold ph-warning-octagon"></i></div>
                                            <span class="font-bold text-slate-700 dark:text-slate-300">Breakdown</span>
                                        </div>
                                        <span class="text-xl font-bold text-red-600 dark:text-red-400">${metrics.category.Break}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-slate-500 dark:text-slate-300"><i class="ph-bold ph-arrow-u-right-up"></i></div>
                                            <span class="font-bold text-slate-700 dark:text-slate-300">Empty</span>
                                        </div>
                                        <span class="text-xl font-bold text-slate-600 dark:text-slate-400">${metrics.category.Empty}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Trip Class (Type) -->
                            <div class="space-y-4">
                                <h4 class="text-xs font-bold uppercase text-slate-400">Trip Class</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    ${Object.entries(metrics.type).filter(([k, v]) => k !== 'Other' || v > 0).map(([k, v]) => `
                                        <div class="flex flex-col p-3 bg-emerald-50 dark:bg-emerald-900/10 rounded-xl border border-emerald-100 dark:border-emerald-800/30 text-center relative overflow-hidden group">
                                            <span class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase mb-1">${k}</span>
                                            <span class="text-2xl font-bold text-slate-800 dark:text-white">${v}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Billing Status -->
                            <div class="space-y-4">
                                <h4 class="text-xs font-bold uppercase text-slate-400">Billing Status</h4>
                                <div class="flex gap-4 h-32">
                                    <div class="flex-1 bg-green-50 dark:bg-green-900/20 rounded-2xl border border-green-100 dark:border-green-800/50 flex flex-col items-center justify-center p-4">
                                        <div class="text-3xl font-bold text-green-600 dark:text-green-400 mb-1">${metrics.billing.Billed}</div>
                                        <span class="text-xs font-bold uppercase text-green-700 dark:text-green-300">Billed</span>
                                    </div>
                                    <div class="flex-1 bg-amber-50 dark:bg-amber-900/20 rounded-2xl border border-amber-100 dark:border-amber-800/50 flex flex-col items-center justify-center p-4">
                                        <div class="text-3xl font-bold text-amber-600 dark:text-amber-400 mb-1">${metrics.billing.Unbilled}</div>
                                        <span class="text-xs font-bold uppercase text-amber-700 dark:text-amber-300">Unbilled</span>
                                    </div>
                                </div>
                                <div class="w-full h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden flex">
                                    <div class="h-full bg-green-500" style="width: ${metrics.billing.Billed + metrics.billing.Unbilled > 0 ? (metrics.billing.Billed / (metrics.billing.Billed + metrics.billing.Unbilled) * 100) : 0}%"></div>
                                    <div class="h-full bg-amber-500 flex-1"></div>
                                </div>
                            </div>
                        </div>
                     </div>

                     <!-- Individual Driver Cards -->
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                         ${Object.entries(map).map(([driver, stats]) => `
                         <div onclick="openDriverSummary('${driver}')" class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between group hover:border-indigo-500 cursor-pointer transition-colors relative overflow-hidden">
                             <div class="absolute inset-0 bg-indigo-50 dark:bg-indigo-900/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                             <div class="relative z-10 flex justify-between items-start mb-4">
                                 <div>
                                     <h4 class="font-bold text-lg text-slate-800 dark:text-white">${driver}</h4>
                                     <p class="text-xs text-slate-500 dark:text-slate-400">${stats.count} Trips</p>
                                 </div>
                                 <div class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-slate-400 group-hover:bg-indigo-500 group-hover:text-white transition-colors">
                                     <i class="ph-bold ph-caret-right text-xl"></i>
                                 </div>
                             </div>
                             <div class="relative z-10">
                                 <p class="text-xs font-bold uppercase text-slate-400 mb-1">Revenue Generated</p>
                                 <p class="text-2xl font-bold text-slate-800 dark:text-white">₹${stats.revenue.toLocaleString()}</p>
                             </div>
                         </div>
                         `).join('')}
                     </div>
                 </div>`;
            };



            const renderComplianceDashboard = () => `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden mt-6">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                         <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i class="ph-bold ph-shield-check text-green-600"></i> Vehicle Compliance Overview
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Vehicle</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Tax Exp</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Fitness Exp</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Insurance Exp</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Permit Exp</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                ${state.vehicles.map(v => `
                                    <tr class="border-b border-slate-100 dark:border-slate-700 even:bg-slate-50 dark:even:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                                        <td class="p-4 font-bold text-slate-700 dark:text-slate-300 font-mono">${v.vehicleNumber || v.number}</td>
                                        <td class="p-4 ${getExpiryStatusClass(v.rtoTaxExpiry)}">${formatDate(v.rtoTaxExpiry)}</td>
                                        <td class="p-4 ${getExpiryStatusClass(v.rtoFitnessExpiry)}">${formatDate(v.rtoFitnessExpiry)}</td>
                                        <td class="p-4 ${getExpiryStatusClass(v.insuranceExpiry)}">${formatDate(v.insuranceExpiry)}</td>
                                        <td class="p-4 ${getExpiryStatusClass(v.rtoPermitExpiry)}">${formatDate(v.rtoPermitExpiry)}</td>
                                        <td class="p-4 text-right">
                                            <button onclick="openVehicleRTOModal('${v.id}')" class="px-3 py-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg text-xs font-bold transition-colors">
                                                Edit RTO
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

            return `
            <div class="space-y-6">
                <!-- Header Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-wallet text-6xl text-indigo-600"></i></div>
                        <h3 class="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Total Revenue (Est.)</h3>
                        <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">₹${totalRevenue.toLocaleString()}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-check-circle text-6xl text-green-600"></i></div>
                        <h3 class="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Verified Amount</h3>
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400">₹${verifiedRevenue.toLocaleString()}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-clock-counter-clockwise text-6xl text-amber-600"></i></div>
                        <h3 class="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Pending Approval</h3>
                        <p class="text-3xl font-bold text-amber-600 dark:text-amber-400">₹${pendingRevenue.toLocaleString()}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-money text-6xl text-red-600"></i></div>
                        <h3 class="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Total Expense</h3>
                        <p class="text-3xl font-bold text-red-600 dark:text-red-400">₹${totalExpense.toLocaleString()}</p>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex gap-2 p-1 bg-white dark:bg-slate-800 rounded-xl w-fit border border-slate-200 dark:border-slate-700 flex-wrap">
                    <button onclick="state.financialTab='billing'; render()" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${state.financialTab === 'billing' ? 'bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'}">Billing Reconciliation</button>

                    <button onclick="state.financialTab='vehicle'; render()" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${state.financialTab === 'vehicle' ? 'bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'}">Vehicle Reports</button>
                    <button onclick="state.financialTab='compliance'; render()" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${state.financialTab === 'compliance' ? 'bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'}">Compliance Status</button>
                    <button onclick="state.financialTab='driver'; render()" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${state.financialTab === 'driver' ? 'bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'}">Driver Reports</button>
                </div>

                <!-- Content -->
                <div>
                    ${state.financialTab === 'billing' ? renderBilling() :

                    state.financialTab === 'compliance' ? renderComplianceDashboard() :
                        state.financialTab === 'vehicle' ? (state.vehicleDetail ? renderVehicleDetail(state.vehicleDetail) : renderVehicleReport()) :
                            renderDriverReport()}
                </div>
            </div>
        `;

        };


        const renderFuelMaintenance = () => {
            const drivers = getFilteredData(state.drivers);
            const vehicles = getFilteredData(state.vehicles);

            const fuelLogs = getFilteredData(state.fuelLogs);
            const maintLogs = getFilteredData(state.maintenanceLogs);
            const policeLogs = getFilteredData(state.policeFines || []);
            const tollLogs = getFilteredData(state.tollLogs);

            if (!state.fmTab) state.fmTab = 'fuel';

            const renderFuelTable = () => `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Date</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Vehicle</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Driver</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Litres</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Odometer</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-slate-100 dark:divide-slate-700">
                                ${fuelLogs.length === 0 ? '<tr><td colspan="5" class="p-8 text-center text-slate-400">No fuel records found.</td></tr>' :
                    fuelLogs.map(l => `
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors even:bg-slate-100 dark:even:bg-slate-800/50">
                                        <td class="p-4 font-mono text-slate-600 dark:text-slate-400">${l.date}</td>
                                        <td class="p-4 font-bold text-slate-800 dark:text-white">${l.vehicleNumber}</td>
                                        <td class="p-4 text-slate-600 dark:text-slate-400">${l.driverName}</td>
                                        <td class="p-4 text-right font-bold text-amber-600 dark:text-amber-400">${l.litres} L</td>
                                        <td class="p-4 text-right font-mono text-slate-600 dark:text-slate-400">${l.odometer}</td>
                                        <td class="p-4 text-right">
                                            <div class="flex items-center justify-end gap-2">
                                                <button onclick="openFuelModal('${l.id}')" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/50 rounded-lg transition-colors" title="Edit Log">
                                                    <i class="ph-bold ph-pencil-simple text-lg"></i>
                                                </button>
                                                <button onclick="softDeleteItem('${l.id}', 'ams_fuel_logs', 'fuelLogs', 'Fuel Log', 'Fuel & Maintenance > Fuel Logs')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 rounded-lg transition-colors" title="Delete Log">
                                                    <i class="ph-bold ph-trash text-lg"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const renderMaintTable = () => `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Date</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Vehicle</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Details</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Issues</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Cost</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-center">Approve</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-slate-100 dark:divide-slate-700">
                                ${maintLogs.length === 0 ? '<tr><td colspan="6" class="p-8 text-center text-slate-400">No maintenance records found.</td></tr>' :
                    maintLogs.map(l => {
                        const issues = [...(l.general || []), ...(l.tyre || [])];
                        return `
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors even:bg-slate-100 dark:even:bg-slate-800/50">
                                        <td class="p-4 font-mono text-slate-600 dark:text-slate-400">${l.date}</td>
                                        <td class="p-4 font-bold text-slate-800 dark:text-white">${l.vehicleNumber}</td>
                                        <td class="p-4">
                                            <div class="font-bold text-slate-700 dark:text-slate-300">${l.place}</div>
                                            <div class="text-xs text-slate-400">${l.driverName}</div>
                                        </td>
                                        <td class="p-4">
                                            <div class="flex flex-wrap gap-1">
                                                ${issues.map(i => `<span class="px-2 py-0.5 rounded-md bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-xs font-bold border border-red-100 dark:border-red-800/50">${i}</span>`).join('')}
                                            </div>
                                            ${l.remarks ? `<div class="text-xs text-slate-500 mt-2 italic"><i class="ph-bold ph-note-pencil text-indigo-400"></i> ${l.remarks}</div>` : ''}
                                        </td>
                                        <td class="p-4 text-center">
                                            <input type="number" id="maint-price-${l.id}" value="${l.price || ''}" 
                                                class="w-24 px-2 py-1 border border-slate-200 rounded text-right font-bold text-slate-700 focus:ring-2 focus:ring-red-500 outline-none" placeholder="0.00">
                                        </td>
                                         <td class="p-4 text-center">
                                        ${l.status === 'Approved' ?
                                `<div class="flex items-center gap-2 justify-center">
                                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold"><i class="ph-bold ph-check"></i> Approved</span>
                                                <button onclick="approveExpense('ams_maintenance_logs', '${l.id}', document.getElementById('maint-price-${l.id}').value)" 
                                                    class="w-6 h-6 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-indigo-600 flex items-center justify-center transition-colors" title="Update Amount">
                                                    <i class="ph-bold ph-arrows-clockwise"></i>
                                                </button>
                                            </div>` :
                                `<button onclick="approveExpense('ams_maintenance_logs', '${l.id}', document.getElementById('maint-price-${l.id}').value)" 
                                                class="px-3 py-1 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 shadow-sm transition-all hover:scale-105 active:scale-95">
                                                Approve
                                            </button>`
                            }
                                    </td>
                                    <td class="p-4 text-center">
                                        <div class="flex items-center justify-center gap-2">
                                            <button onclick="openMaintModal('${l.id}')" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/50 rounded-lg transition-colors" title="Edit Log">
                                                <i class="ph-bold ph-pencil-simple text-lg"></i>
                                            </button>
                                            <button onclick="softDeleteItem('${l.id}', 'ams_maintenance_logs', 'maintenanceLogs', 'Maintenance Log', 'Fuel & Maintenance > Maintenance')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 rounded-lg transition-colors" title="Delete Log">
                                                <i class="ph-bold ph-trash text-lg"></i>
                                            </button>
                                        </div>
                                    </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const renderExpenseTable = (logs, isPolice) => `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Date/Time</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Vehicle</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Driver</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Trip</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Amount</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-center">Approve</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-slate-100 dark:divide-slate-700">
                                ${logs.length === 0 ? `<tr><td colspan="6" class="p-8 text-center text-slate-400">No ${isPolice ? 'police fines' : 'toll records'} found.</td></tr>` :
                    logs.map(l => `
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors even:bg-slate-100 dark:even:bg-slate-800/50">
                                        <td class="p-4 font-mono text-slate-600 dark:text-slate-400">
                                            ${l.date ? l.date.replace('T', ' ') : '-'}
                                        </td>
                                        <td class="p-4 font-bold text-slate-800 dark:text-white">${l.vehicleNumber || '-'}</td>
                                        <td class="p-4 text-slate-600 dark:text-slate-400">${l.driverName}</td>
                                        <td class="p-4">
                                            ${l.pickup && l.drop ?
                            `<div class="flex items-center gap-1 text-xs font-bold text-slate-600 dark:text-slate-400">
                                                    <span>${l.pickup}</span>
                                                    <i class="ph-bold ph-arrow-right text-slate-400"></i>
                                                    <span>${l.drop}</span>
                                                </div>`
                            : '<span class="text-xs text-slate-400 italic">General Entry</span>'
                        }
                                        </td>
                                        <td class="p-4 text-center">
                                             <input type="number" id="${isPolice ? 'police' : 'toll'}-amt-${l.id}" value="${l.amount || ''}" 
                                                class="w-24 px-2 py-1 border border-slate-200 rounded text-right font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                                        </td>
                                    <td class="p-4 text-center">
                                    ${l.status === 'Approved' ?
                            `<div class="flex items-center gap-2 justify-center">
                                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold"><i class="ph-bold ph-check"></i> Approved</span>
                                            <button onclick="approveExpense('${isPolice ? 'ams_police_fines' : 'ams_toll_logs'}', '${l.id}', document.getElementById('${isPolice ? 'police' : 'toll'}-amt-${l.id}').value)" 
                                                class="w-6 h-6 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-indigo-600 flex items-center justify-center transition-colors" title="Update Amount">
                                                <i class="ph-bold ph-arrows-clockwise"></i>
                                            </button>
                                        </div>` :
                            `<button onclick="approveExpense('${isPolice ? 'ams_police_fines' : 'ams_toll_logs'}', '${l.id}', document.getElementById('${isPolice ? 'police' : 'toll'}-amt-${l.id}').value)" 
                                            class="px-3 py-1 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 shadow-sm transition-all hover:scale-105 active:scale-95">
                                            Approve
                                        </button>`
                        }
                                </td>
                                <td class="p-4 text-center">
                                     <div class="flex items-center justify-center gap-2">
                                        <button onclick="openExpenseModal('${isPolice ? 'police' : 'toll'}', '${l.id}')" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/50 rounded-lg transition-colors" title="Edit Log">
                                            <i class="ph-bold ph-pencil-simple text-lg"></i>
                                        </button>
                                        <button onclick="softDeleteItem('${l.id}', '${isPolice ? 'ams_police_fines' : 'ams_toll_logs'}', '${isPolice ? 'policeFines' : 'tollLogs'}', '${isPolice ? 'Police Fine' : 'Toll Entry'}', 'Fuel & Maintenance > ${isPolice ? 'Police Fine' : 'Toll Gate'}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 rounded-lg transition-colors" title="Delete Log">
                                            <i class="ph-bold ph-trash text-lg"></i>
                                        </button>
                                     </div>
                                </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            return `
            <div class="space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i class="ph-fill ph-wrench text-indigo-500"></i> Fuel & Maintenance
                        </h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Track fuel consumption, maintenance, and expenses</p>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                    <div class="flex gap-2 p-1 bg-white dark:bg-slate-800 rounded-xl w-fit border border-slate-200 dark:border-slate-700 overflow-x-auto">
                        <button onclick="state.fmTab='fuel'; render()" class="whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold transition-all ${state.fmTab === 'fuel' ? 'bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'} flex items-center gap-2">
                            <i class="ph-bold ph-gas-pump"></i> Fuel Logs
                        </button>
                        <button onclick="state.fmTab='maintenance'; render()" class="whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold transition-all ${state.fmTab === 'maintenance' ? 'bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'} flex items-center gap-2">
                            <i class="ph-bold ph-wrench"></i> Maintenance
                        </button>
                         <button onclick="state.fmTab='police'; render()" class="whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold transition-all ${state.fmTab === 'police' ? 'bg-rose-50 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'} flex items-center gap-2">
                            <i class="ph-bold ph-siren"></i> Police Fine
                        </button>
                         <button onclick="state.fmTab='toll'; render()" class="whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold transition-all ${state.fmTab === 'toll' ? 'bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'} flex items-center gap-2">
                            <i class="ph-bold ph-road-horizon"></i> Toll Gate
                        </button>
                    </div>

                    <button onclick="${state.fmTab === 'fuel' ? 'openFuelModal()' : (state.fmTab === 'maintenance' ? 'openMaintModal()' : (state.fmTab === 'police' ? `openExpenseModal('police')` : `openExpenseModal('toll')`))}" 
                        class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center gap-2">
                        <i class="ph-bold ph-plus"></i> Add New Entry
                    </button>
                </div>

                <div class="animate-fade-in">
                    ${state.fmTab === 'fuel' ? renderFuelTable() :
                    state.fmTab === 'maintenance' ? renderMaintTable() :
                        state.fmTab === 'police' ? renderExpenseTable(policeLogs, true) :
                            renderExpenseTable(tollLogs, false)}
                </div>
            </div>
            `;
        };

        // --- Trash Bin Logic ---
        window.savePayroll = async (driverName, month, type, value) => {
            const id = `${driverName}_${month}`;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'ams_payroll', id);
            try {
                await setDoc(ref, {
                    driverName,
                    month,
                    [type]: Number(value),
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                showToast('Saved', 'success');
            } catch (e) { console.error(e); showToast(e.message, 'error'); }
        };

        window.openAllowanceModal = (driverName, month) => {
            const payrollId = `${driverName}_${month}`;
            const record = state.payroll?.[payrollId] || {};
            state.selectedAllowanceDriver = driverName;
            state.selectedAllowanceMonth = month;
            state.allowanceEntries = record.allowanceEntries || [];
            if (!record.allowanceEntries && record.allowance) {
                // Migration: if no array but old total exists, we don't auto-create entry 
                // but user can see the old total in the input. 
                // Once they add an entry, the array will take over.
            }
            state.modal = 'allowance';
            render();
        };

        window.addAllowanceEntry = async () => {
            const start = document.getElementById('new-allowance-start').value;
            const end = document.getElementById('new-allowance-end').value;
            const amt = document.getElementById('new-allowance-amount').value;

            if (!start || !end || !amt) return showToast('Please fill all fields', 'error');

            const entry = { startDate: start, endDate: end, amount: Number(amt) };
            state.allowanceEntries.push(entry);

            const total = state.allowanceEntries.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
            const id = `${state.selectedAllowanceDriver}_${state.selectedAllowanceMonth}`;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'ams_payroll', id);

            try {
                await setDoc(ref, {
                    allowanceEntries: state.allowanceEntries,
                    allowance: total, // Keep total synced for legacy/display
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                showToast('Entry Added', 'success');
                render();
            } catch (e) { console.error(e); showToast(e.message, 'error'); }
        };

        window.deleteAllowanceEntry = async (index) => {
            if (!confirm('Delete this entry?')) return;
            state.allowanceEntries.splice(index, 1);

            const total = state.allowanceEntries.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
            const id = `${state.selectedAllowanceDriver}_${state.selectedAllowanceMonth}`;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'ams_payroll', id);

            try {
                await setDoc(ref, {
                    allowanceEntries: state.allowanceEntries,
                    allowance: total,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                showToast('Entry Deleted', 'success');
                render();
            } catch (e) { console.error(e); showToast(e.message, 'error'); }
        };

        window.openSalaryModal = (driverName, month) => {
            const payrollId = `${driverName}_${month}`;
            const record = state.payroll?.[payrollId] || {};
            state.selectedSalaryDriver = driverName;
            state.selectedSalaryMonth = month;
            state.salaryEntries = record.salaryEntries || [];
            state.modal = 'salary';
            render();
        };

        window.addSalaryEntry = async () => {
            const start = document.getElementById('new-salary-start').value;
            const end = document.getElementById('new-salary-end').value;
            const amt = document.getElementById('new-salary-amount').value;

            if (!start || !end || !amt) return showToast('Please fill all fields', 'error');

            const entry = { startDate: start, endDate: end, amount: Number(amt) };
            state.salaryEntries.push(entry);

            const total = state.salaryEntries.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
            const id = `${state.selectedSalaryDriver}_${state.selectedSalaryMonth}`;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'ams_payroll', id);

            try {
                await setDoc(ref, {
                    salaryEntries: state.salaryEntries,
                    salary: total,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                showToast('Entry Added', 'success');
                render();
            } catch (e) { console.error(e); showToast(e.message, 'error'); }
        };

        window.deleteSalaryEntry = async (index) => {
            if (!confirm('Delete this entry?')) return;
            state.salaryEntries.splice(index, 1);

            const total = state.salaryEntries.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
            const id = `${state.selectedSalaryDriver}_${state.selectedSalaryMonth}`;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'ams_payroll', id);

            try {
                await setDoc(ref, {
                    salaryEntries: state.salaryEntries,
                    salary: total,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                showToast('Entry Deleted', 'success');
                render();
            } catch (e) { console.error(e); showToast(e.message, 'error'); }
        };

        window.softDeleteTrip = async (id, collectionName, source) => {
            const reason = prompt("Please enter a reason for deleting this trip:");
            if (reason === null) return; // Cancelled
            if (!reason.trim()) return showToast('Deletion cancelled: Reason is required', 'error');

            const trip = (state.trips || []).find(t => t.id === id);
            if (!trip) return showToast('Trip not found', 'error');

            try {
                // 1. Copy to trash
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trash'), {
                    ...trip,
                    deletedAt: serverTimestamp(),
                    deletedBy: state.user.name,
                    originalCollection: collectionName,
                    source: source || 'Unknown',
                    deleteReason: reason
                });

                // 2. Delete from original
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id));

                showToast('Trip moved to Trash Bin', 'success');
                render();
            } catch (error) {
                console.error("Error soft deleting trip:", error);
                showToast('Failed to delete: ' + error.message, 'error');
            }
        };

        window.softDeleteItem = async (id, collectionName, stateKey, itemName, source) => {
            const reason = prompt(`Please enter a reason for deleting this ${itemName}:`);
            if (reason === null) return; // Cancelled
            if (!reason.trim()) return showToast('Deletion cancelled: Reason is required', 'error');

            const item = (state[stateKey] || []).find(i => i.id === id);
            if (!item) return showToast(`${itemName} not found`, 'error');

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trash'), {
                    ...item,
                    deletedAt: serverTimestamp(),
                    deletedBy: state.user.name,
                    originalCollection: collectionName,
                    itemType: itemName,
                    source: source || 'Unknown',
                    deleteReason: reason
                });

                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id));
                showToast(`${itemName} moved to Trash Bin`, 'success');
            } catch (error) {
                console.error(`Error deleting ${itemName}:`, error);
                showToast('Failed to delete: ' + error.message, 'error');
            }
        };

        window.toggleAllBilling = (checked) => {
            const checkboxes = document.querySelectorAll('.billing-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
            updateBulkActionBarVisibility();
        };

        const updateBulkActionBarVisibility = () => {
            const checkedCount = document.querySelectorAll('.billing-checkbox:checked').length;
            const bar = document.getElementById('bulk-action-bar');
            if (bar) {
                if (checkedCount > 0) {
                    bar.classList.remove('hidden');
                    bar.querySelector('#checked-count').textContent = `${checkedCount} Items Selected`;
                } else {
                    bar.classList.add('hidden');
                }
            }
        };

        // Add event listeners for individual checkboxes after render
        window.onBillingCheckboxChange = () => {
            updateBulkActionBarVisibility();
        };

        window.bulkDeleteTrips = async () => {
            const selectedIds = Array.from(document.querySelectorAll('.billing-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) return;

            const reason = prompt(`Please enter a reason for deleting ${selectedIds.length} trips:`);
            if (reason === null) return;
            if (!reason.trim()) return showToast('Deletion cancelled: Reason is required', 'error');

            try {
                showToast(`Moving ${selectedIds.length} items to trash...`, 'info');
                for (const id of selectedIds) {
                    const trip = (state.trips || []).find(t => t.id === id);
                    if (trip) {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trash'), {
                            ...trip,
                            deletedAt: serverTimestamp(),
                            deletedBy: state.user.name,
                            originalCollection: 'ams_trips',
                            source: 'Financial Management > Billing Reconciliation', // Bulk is only in Billing
                            deleteReason: reason
                        });
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', id));
                    }
                }
                showToast(`Successfully moved ${selectedIds.length} items to Trash Bin`, 'success');
                render();
            } catch (error) {
                console.error("Error bulk deleting:", error);
                showToast('Bulk delete failed: ' + error.message, 'error');
            }
        };

        window.bulkUpdateStatus = async (status) => {
            const selectedIds = Array.from(document.querySelectorAll('.billing-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) return;

            if (!confirm(`Update status to "${status}" for ${selectedIds.length} trips?`)) return;

            try {
                showToast(`Updating ${selectedIds.length} items...`, 'info');
                for (const id of selectedIds) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', id), {
                        billingStatus: status,
                        updatedAt: serverTimestamp(),
                        updatedBy: state.user.name
                    });
                }
                showToast(`Successfully updated ${selectedIds.length} items`, 'success');
                render();
            } catch (error) {
                console.error("Error bulk updating status:", error);
                showToast('Bulk update failed: ' + error.message, 'error');
            }
        };

        window.restoreTrip = async (trashId) => {
            const trip = (state.trashTrips || []).find(t => t.trashDocId === trashId);
            if (!trip) return showToast('Item not found in trash', 'error');

            try {
                const { trashDocId, deletedAt, deletedBy, originalCollection, ...originalData } = trip;

                // 1. Restore to original collection
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', originalCollection || 'ams_trips', originalData.id), {
                    ...originalData,
                    restoredAt: serverTimestamp(),
                    restoredBy: state.user.name
                });

                // 2. Remove from trash
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trash', trashId));

                showToast('Trip restored successfully', 'success');
                render();
            } catch (error) {
                console.error("Error restoring trip:", error);
                showToast('Failed to restore: ' + error.message, 'error');
            }
        };

        window.permanentDeleteTrip = async (trashId) => {
            if (!confirm('PERMANENT DELETE: Are you sure? This action cannot be undone.')) return;

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trash', trashId));
                showToast('Record deleted permanently', 'success');
                render();
            } catch (error) {
                console.error("Error permanently deleting:", error);
                showToast('Failed to delete permanently', 'error');
            }
        };

        const renderTrashBin = () => {
            const trashItems = getFilteredData(state.trashTrips || []);

            return `
            <div class="space-y-6 animate-fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i class="ph-bold ph-trash text-red-500"></i> Trash Bin
                        </h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Manage recently deleted items</p>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Type</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Source</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Reason</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Date</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Vehicle</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Driver</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Deleted By</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700">Deleted At</th>
                                    <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                ${trashItems.length === 0 ? '<tr><td colspan="9" class="p-8 text-center text-slate-400">Trash Bin is empty.</td></tr>' :
                    trashItems.map(t => {
                        // Deriving source if missing (backwards compatibility)
                        let displaySource = t.source;
                        if (!displaySource) {
                            if (t.originalCollection === 'ams_trips') displaySource = 'Trip Manager';
                            else if (t.originalCollection === 'ams_fuel_logs') displaySource = 'Fuel Logs';
                            else displaySource = 'General';
                        }
                        return `
                                    <tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                                        <td class="p-4 font-bold text-slate-600 dark:text-slate-400 text-xs uppercase">${t.itemType || 'Trip'}</td>
                                        <td class="p-4">
                                            <span class="px-2 py-1 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-bold border border-slate-200 dark:border-slate-600">
                                                ${displaySource}
                                            </span>
                                        </td>
                                        <td class="p-4 text-xs italic text-slate-500 max-w-[150px] truncate" title="${t.deleteReason || 'No reason provided'}">${t.deleteReason || '-'}</td>
                                        <td class="p-4 font-medium">${t.date || '-'}</td>
                                        <td class="p-4 font-bold text-slate-700 dark:text-slate-300">${t.truckNumber || t.vehicleNumber || '-'}</td>
                                        <td class="p-4">${t.driverName || '-'}</td>
                                        <td class="p-4 text-xs font-bold text-slate-500 uppercase">${t.deletedBy || 'Admin'}</td>
                                        <td class="p-4 text-slate-500 text-xs">${t.deletedAt ? new Date(t.deletedAt.seconds * 1000).toLocaleString() : '-'}</td>
                                    <td class="p-4 text-right">
                                        <div class="flex items-center justify-end gap-2">
                                            <button onclick="restoreTrip('${t.trashDocId}')" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-lg transition-colors flex items-center gap-1 font-bold text-xs" title="Restore">
                                                <i class="ph-bold ph-arrow-counter-clockwise"></i> Restore
                                            </button>
                                            <button onclick="permanentDeleteTrip('${t.trashDocId}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete Permanently">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            </div>`;
        };

        window.savePayroll = async (driverName, month, type, value) => {
            const val = parseFloat(value);
            if (isNaN(val)) return;

            const payrollId = `${driverName}_${month}`;
            // Sanitizing ID just in case, though name should be fine if simple. 
            // Ideally we use driverID, but current logic uses name.

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_payroll', payrollId), {
                    [type]: val,
                    driverName: driverName,
                    month: month,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                showToast('Saved', 'success');
            } catch (e) {
                console.error(e);
                showToast('Save failed', 'error');
            }
        };


        // --- Driver Summary Modal (Global) ---
        window.openDriverSummary = (driverName) => {
            state.selectedDriverSummary = driverName;
            state.modal = 'driverSummary';
            render();
        };

        const renderDriverSummaryModal = () => {
            if (state.modal !== 'driverSummary' || !state.selectedDriverSummary) return '';
            const driver = state.selectedDriverSummary;

            // 1. Filter Data
            const dTrips = (state.trips || []).filter(t => t.driverName === driver);
            const dFuel = (state.fuelLogs || []).filter(l => l.driverName === driver);
            const dMaint = (state.maintenanceLogs || []).filter(l => l.driverName === driver);
            const dPolice = (state.policeFines || []).filter(l => l.driverName === driver);
            const dToll = (state.tollLogs || []).filter(l => l.driverName === driver);

            // Payroll Data
            let totalSalary = 0;
            let totalAllowance = 0;
            if (state.payroll) {
                Object.values(state.payroll).forEach(p => {
                    if (p.driverName === driver) {
                        totalSalary += (p.salary || 0);
                        totalAllowance += (p.allowance || 0);
                    }
                });
            }

            // 2. Calculations
            const totalRevenue = dTrips.reduce((sum, t) => sum + (t.billAmount || 0), 0);
            const billedTrips = dTrips.filter(t => t.billingStatus === 'Approved' || (t.billAmount && t.billAmount > 0));
            const unbilledTrips = dTrips.filter(t => !t.billingStatus && (!t.billAmount || t.billAmount === 0));

            const totalBilled = billedTrips.reduce((sum, t) => sum + (parseFloat(t.billAmount) || 0), 0);
            const totalUnbilled = unbilledTrips.reduce((sum, t) => sum + (parseFloat(t.billAmount) || 0), 0);

            const costFuel = dFuel.reduce((sum, l) => sum + (parseFloat(l.totalCost) || 0), 0);
            const costMaint = dMaint.reduce((sum, l) => sum + (parseFloat(l.price) || 0), 0);
            const costPolice = dPolice.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
            const costToll = dToll.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);

            const totalExpense = costFuel + costMaint + costPolice + costToll + totalSalary + totalAllowance;

            // 3. Trip Analysis (Nested: Category -> Class)
            const analysis = {
                New: { total: 0, types: {} },
                Breakdown: { total: 0, types: {} },
                Empty: { total: 0, types: {} }
            };

            dTrips.forEach(t => {
                // Category
                let cat = (t.tripCategory || 'New');
                if (cat.toLowerCase().includes('break')) cat = 'Breakdown';
                else if (cat === 'Empty') cat = 'Empty';
                else cat = 'New';

                // Class (Type)
                let type = (t.tripType || 'TVS').toUpperCase();
                if (!['TVS', 'INT', 'FREE', 'SERVICE', 'DIRECT'].includes(type)) type = 'Other';

                // Increment Category Total
                analysis[cat].total++;

                // Increment Type Count within Category
                if (!analysis[cat].types[type]) analysis[cat].types[type] = 0;
                analysis[cat].types[type]++;
            });

            const renderCategoryBlock = (title, data, colorClass) => {
                return `
                <div class="bg-slate-50 dark:bg-slate-700/30 rounded-xl p-4 border border-slate-100 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-200 dark:border-slate-600">
                        <div class="flex items-center gap-2">
                             <div class="w-2.5 h-2.5 rounded-full ${colorClass}"></div>
                             <h4 class="font-bold text-slate-700 dark:text-slate-200">${title}</h4>
                        </div>
                        <span class="font-bold text-slate-800 dark:text-white bg-white dark:bg-slate-600 px-2 py-0.5 rounded-lg text-sm shadow-sm border border-slate-100 dark:border-slate-500">${data.total}</span>
                    </div>
                    <div class="space-y-2">
                        ${Object.entries(data.types).length > 0 ?
                        Object.entries(data.types).map(([type, count]) => `
                            <div class="flex justify-between items-center text-xs group">
                                <span class="text-slate-500 dark:text-slate-400 font-medium group-hover:text-indigo-500 transition-colors pl-4 border-l-2 border-slate-200 dark:border-slate-600">${type}</span>
                                <span class="font-mono font-bold text-slate-600 dark:text-slate-300">${count}</span>
                            </div>
                            `).join('')
                        : '<p class="text-xs text-slate-400 italic pl-4">No trips</p>'
                    }
                    </div>
                </div>
                `;
            };

            return `
            <div class="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-fade-in" onclick="if(event.target === this) closeModal()">
                <div class="bg-white dark:bg-slate-800 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col scale-in">
                    <!-- Header -->
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <i class="ph-fill ph-user-circle text-indigo-500"></i> ${driver}
                            </h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Performance & Expense Summary</p>
                        </div>
                        <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-500 hover:bg-rose-100 hover:text-rose-500 transition-colors flex items-center justify-center">
                            <i class="ph-bold ph-x text-xl"></i>
                        </button>
                    </div>

                    <div class="overflow-y-auto p-6 space-y-8">
                        <!-- Top Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-indigo-50 dark:bg-indigo-900/20 p-5 rounded-2xl border border-indigo-100 dark:border-indigo-800/50">
                                <div class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-1">Total Trips</div>
                                <div class="text-3xl font-bold text-indigo-700 dark:text-indigo-400">${dTrips.length}</div>
                            </div>
                            <div class="bg-emerald-50 dark:bg-emerald-900/20 p-5 rounded-2xl border border-emerald-100 dark:border-emerald-800/50">
                                <div class="text-xs font-bold text-emerald-500 uppercase tracking-wider mb-1">Total Revenue</div>
                                <div class="text-3xl font-bold text-emerald-700 dark:text-emerald-400">₹${totalRevenue.toLocaleString()}</div>
                            </div>
                            <div class="bg-rose-50 dark:bg-rose-900/20 p-5 rounded-2xl border border-rose-100 dark:border-rose-800/50">
                                <div class="text-xs font-bold text-rose-500 uppercase tracking-wider mb-1">Total Expense</div>
                                <div class="text-3xl font-bold text-rose-700 dark:text-rose-400">₹${totalExpense.toLocaleString()}</div>
                            </div>
                        </div>

                        <!-- Trip Analysis Section (Nested) -->
                        <div class="bg-white dark:bg-slate-700/30 rounded-xl p-6 border border-slate-200 dark:border-slate-700 shadow-sm">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2 mb-4">
                                <i class="ph-bold ph-chart-pie-slice text-purple-500"></i> Trip Analysis
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${renderCategoryBlock('New', analysis.New, 'bg-blue-500')}
                                ${renderCategoryBlock('Breakdown', analysis.Breakdown, 'bg-rose-500')}
                                ${renderCategoryBlock('Empty', analysis.Empty, 'bg-slate-400')}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Billing Status -->
                            <div class="space-y-4">
                                <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <i class="ph-bold ph-invoice text-indigo-500"></i> Billing Status
                                </h3>
                                <div class="bg-slate-50 dark:bg-slate-700/30 rounded-xl p-4 space-y-4 border border-slate-100 dark:border-slate-700">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-lg bg-green-100 text-green-600 flex items-center justify-center"><i class="ph-bold ph-check-circle text-xl"></i></div>
                                            <div>
                                                <p class="font-bold text-slate-700 dark:text-slate-300">Billed Trips</p>
                                                <p class="text-xs text-slate-500">${billedTrips.length} trips</p>
                                            </div>
                                        </div>
                                        <span class="text-xl font-bold text-green-600">₹${totalBilled.toLocaleString()}</span>
                                    </div>
                                    <div class="w-full h-px bg-slate-200 dark:bg-slate-600"></div>
                                    <div class="flex items-center justify-between">
                                         <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-lg bg-amber-100 text-amber-600 flex items-center justify-center"><i class="ph-bold ph-clock text-xl"></i></div>
                                            <div>
                                                <p class="font-bold text-slate-700 dark:text-slate-300">Unbilled / Pending</p>
                                                <p class="text-xs text-slate-500">${unbilledTrips.length} trips</p>
                                            </div>
                                        </div>
                                        <span class="text-xl font-bold text-amber-600">₹${totalUnbilled.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Expense Breakdown -->
                            <div class="space-y-4">
                                <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <i class="ph-bold ph-wallet text-rose-500"></i> Expense Breakdown
                                </h3>
                                <div class="bg-slate-50 dark:bg-slate-700/30 rounded-xl overflow-hidden border border-slate-100 dark:border-slate-700">
                                    <table class="w-full text-sm text-left">
                                        <tbody class="divide-y divide-slate-200 dark:divide-slate-600">
                                            <tr class="hover:bg-slate-100 dark:hover:bg-slate-600/50">
                                                <td class="p-3 text-slate-600 dark:text-slate-400">Fuel Cost</td>
                                                <td class="p-3 font-bold text-right text-slate-800 dark:text-white">₹${costFuel.toLocaleString()}</td>
                                            </tr>
                                            <tr class="hover:bg-slate-100 dark:hover:bg-slate-600/50">
                                                <td class="p-3 text-slate-600 dark:text-slate-400">Maintenance</td>
                                                <td class="p-3 font-bold text-right text-slate-800 dark:text-white">₹${costMaint.toLocaleString()}</td>
                                            </tr>
                                            <tr class="hover:bg-slate-100 dark:hover:bg-slate-600/50">
                                                <td class="p-3 text-slate-600 dark:text-slate-400">Police Fine & Toll</td>
                                                <td class="p-3 font-bold text-right text-slate-800 dark:text-white">₹${(costPolice + costToll).toLocaleString()}</td>
                                            </tr>
                                            <tr class="hover:bg-slate-100 dark:hover:bg-slate-600/50 bg-indigo-50/50 dark:bg-indigo-900/10">
                                                <td class="p-3 text-indigo-600 dark:text-indigo-400 font-bold">Salary</td>
                                                <td class="p-3 font-bold text-right text-indigo-700 dark:text-indigo-300">₹${totalSalary.toLocaleString()}</td>
                                            </tr>
                                            <tr class="hover:bg-slate-100 dark:hover:bg-slate-600/50 bg-indigo-50/50 dark:bg-indigo-900/10">
                                                <td class="p-3 text-indigo-600 dark:text-indigo-400 font-bold">Allowance</td>
                                                <td class="p-3 font-bold text-right text-indigo-700 dark:text-indigo-300">₹${totalAllowance.toLocaleString()}</td>
                                            </tr>
                                            <tr class="bg-slate-100 dark:bg-slate-800 border-t-2 border-slate-200 dark:border-slate-600">
                                                <td class="p-3 font-bold text-slate-800 dark:text-white uppercase text-xs">Total</td>
                                                <td class="p-3 font-bold text-right text-rose-600 text-lg">₹${totalExpense.toLocaleString()}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 flex justify-end">
                        <button onclick="closeModal()" class="px-6 py-2 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 transition-colors shadow-lg shadow-slate-900/20">Close</button>
                    </div>
                </div>
            </div>
            `;
        };

        window.render = () => {
            if (!state.user) { appDiv.innerHTML = renderLogin(); return; }

            const tabRenderers = {
                'ops': renderOps,
                'drivers': renderDrivers,
                'vehicles': renderVehicles,
                'locations': renderLocations,
                'hr': renderHR,
                'perf': renderPerf,
                'cfo': renderCFO,
                'reports': renderReports,
                'financial': renderFinancialManagement,
                'fuelMaint': renderFuelMaintenance,
                'trash': renderTrashBin
            };
            const content = (tabRenderers[state.adminTab] || renderOps)();

            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            const tabs = [
                { id: 'ops', icon: 'ph-wifi-high', label: 'Live Operations' },
                { id: 'cfo', icon: 'ph-chart-pie-slice', label: 'CFO Dashboard' },
                { id: 'drivers', icon: 'ph-steering-wheel', label: 'Driver Management' },
                { id: 'vehicles', icon: 'ph-truck', label: 'Vehicle Management' },
                { id: 'locations', icon: 'ph-map-pin', label: 'Locations' },
                { id: 'hr', icon: 'ph-users', label: 'HR & Reports' },
                { id: 'reports', icon: 'ph-chart-line-up', label: 'Daily Reports' },
                { id: 'financial', icon: 'ph-currency-inr', label: 'Financial Management' },
                { id: 'fuelMaint', icon: 'ph-wrench', label: 'Fuel & Maintenance' },
                { id: 'trash', icon: 'ph-trash', label: 'Trash Bin' },
                { id: 'perf', icon: 'ph-chart-bar', label: 'Performance' }
            ];

            const activeTabLabel = tabs.find(t => t.id === state.adminTab)?.label;

            appDiv.innerHTML = `
                <div class="flex h-screen bg-slate-50 dark:bg-slate-900 overflow-hidden">
                    <!-- Sidebar (Desktop) -->
                    <aside class="hidden md:flex flex-col ${state.sidebarCollapsed ? 'w-20' : 'w-64'} bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 h-full relative z-20 transition-all duration-300 overflow-hidden">
                        <!-- Sidebar Header (Logo) -->
                        <div class="p-4 flex flex-col items-center flex-shrink-0">
                            <div class="flex items-center gap-3 mb-8 w-full ${state.sidebarCollapsed ? 'justify-center' : ''}">
                                <img src="anaamalais-logo.png" alt="AMS Logo" class="w-12 h-12 object-contain flex-shrink-0 ${state.darkMode ? 'bg-white rounded-lg p-1' : 'mix-blend-multiply'}">
                                ${!state.sidebarCollapsed ? `
                                <div class="whitespace-nowrap overflow-hidden transition-all duration-300">
                                    <h1 class="font-bold text-lg text-slate-800 dark:text-white leading-tight">Admin Portal</h1>
                                    <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold tracking-wider uppercase">AMS Towing</p>
                                </div>` : ''}
                            </div>
                        </div>

                        <!-- Sidebar Body (Scrollable Navigation & Filters) -->
                        <div class="flex-1 overflow-y-auto no-scrollbar px-4">
                            <nav class="space-y-2 w-full">
                                ${tabs.map(t => {
                // Notification Logic
                let badgeCount = 0;

                if (t.id === 'hr') {
                    // Pending Leaves + Shift Requests
                    const pendingLeaves = (state.leaveRequests || []).filter(r => r.status === 'pending').length;
                    const pendingShifts = (state.shiftRequests || []).filter(r => r.status === 'pending').length;
                    badgeCount = pendingLeaves + pendingShifts;
                } else if (t.id === 'ops') {
                    // Trips with pending changes (reviews)
                    badgeCount = (state.trips || []).filter(trip => trip.hasPendingChanges).length;
                } else if (t.id === 'financial') {
                    // Completed trips pending billing
                    badgeCount = (state.trips || []).filter(trip => trip.status === 'completed' && (!trip.billingStatus || trip.billingStatus === 'Pending')).length;
                } else if (t.id === 'vehicles') {
                    // RTO & Insurance Approvals
                    badgeCount = (state.vehicles || []).reduce((acc, v) => {
                        let pending = 0;
                        // Check RTO & Insurance fields for positive amount but not approved
                        const checks = ['rtoTax', 'rtoFitness', 'rtoPollution', 'rtoPermit', 'insurance'];
                        checks.forEach(prefix => {
                            const amt = parseFloat(v[`${prefix}Amount`] || 0);
                            const status = v[`${prefix}Status`];
                            if (amt > 0 && status !== 'Approved') pending++;
                        });
                        return acc + pending;
                    }, 0);
                } else if (t.id === 'fuelMaint') {
                    // Maint + Police + Tolls
                    const pendingMaint = (state.maintenanceLogs || []).filter(l => l.status !== 'Approved').length;
                    const pendingFine = (state.policeFines || []).filter(l => l.status !== 'Approved').length;
                    const pendingToll = (state.tollLogs || []).filter(l => l.status !== 'Approved').length;
                    badgeCount = pendingMaint + pendingFine + pendingToll;
                }

                let badge = '';
                if (badgeCount > 0) {
                    // Simple dot for both collapsed and expanded states
                    // Positioned absolutely for collapsed, relative/flex for expanded
                    if (state.sidebarCollapsed) {
                        badge = `<span class="absolute top-2 right-4 w-2 h-2 bg-rose-500 border border-white dark:border-slate-800 rounded-full z-10 animate-pulse"></span>`;
                    } else {
                        badge = `<span class="ml-auto w-2 h-2 bg-rose-500 rounded-full shadow-sm animate-pulse"></span>`;
                    }
                }

                return `
                                    <button onclick="state.adminTab='${t.id}'; render()" title="${t.label}" class="relative w-full flex items-center ${state.sidebarCollapsed ? 'justify-center px-0' : 'justify-start gap-3 px-4'} py-3 rounded-xl text-sm font-medium transition-all group ${state.adminTab === t.id ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 shadow-sm border border-indigo-100 dark:border-indigo-900/50' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50 hover:text-slate-900 dark:hover:text-slate-200'}">
                                        <i class="ph-bold ${t.icon} text-xl flex-shrink-0 ${state.adminTab === t.id ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400 group-hover:text-slate-600 dark:text-slate-500 dark:group-hover:text-slate-300'}"></i> 
                                        ${!state.sidebarCollapsed ? `<span class="whitespace-nowrap transition-all duration-300 relative z-10">${t.label}</span>` : ''}
                                        ${badge}
                                    </button>
                                `;
            }).join('')}
                            </nav>
                            
                            ${state.user.role === 'superadmin' && !state.sidebarCollapsed ? `
                            <div class="mt-8 pb-4 whitespace-nowrap overflow-hidden transition-all duration-300 border-t border-slate-100 dark:border-slate-700 pt-6">
                                <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Filter Branch</label>
                                    <select onchange="state.selectedBranch = this.value; render()" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-xs font-bold rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="All" ${state.selectedBranch === 'All' ? 'selected' : ''}>All Branches</option>
                                        <option value="Coimbatore" ${state.selectedBranch === 'Coimbatore' ? 'selected' : ''}>Coimbatore</option>
                                        <option value="Trichy" ${state.selectedBranch === 'Trichy' ? 'selected' : ''}>Trichy</option>
                                        <option value="Salem" ${state.selectedBranch === 'Salem' ? 'selected' : ''}>Salem</option>
                                        <option value="Kumbakonam" ${state.selectedBranch === 'Kumbakonam' ? 'selected' : ''}>Kumbakonam</option>
                                    </select>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Sidebar Footer (User Profile) -->
                        <div class="flex-shrink-0 p-4 border-t border-slate-200 dark:border-slate-700">
                            <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-3 flex items-center ${state.sidebarCollapsed ? 'justify-center' : 'gap-3'} transition-all">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-700 dark:text-indigo-300 font-bold flex-shrink-0">
                                    ${state.user.id.slice(0, 2)}
                                </div>
                                ${!state.sidebarCollapsed ? `
                                <div class="flex-1 min-w-0 overflow-hidden whitespace-nowrap transition-all duration-300">
                                    <p class="text-sm font-bold text-slate-900 dark:text-white truncate">Administrator</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 truncate">ID: ${state.user.id}</p>
                                </div>
                                <button onclick="handleLogout()" class="text-slate-400 hover:text-rose-500 transition-colors" title="Logout"><i class="ph-bold ph-sign-out text-xl"></i></button>
                                ` : ''}
                            </div>
                            ${state.sidebarCollapsed ? `
                            <div class="mt-2 text-center">
                                <button onclick="handleLogout()" class="text-slate-400 hover:text-rose-500 transition-colors p-2" title="Logout"><i class="ph-bold ph-sign-out text-xl"></i></button>
                            </div>` : ''}
                            
                            ${!state.sidebarCollapsed ? `
                            <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 text-center">
                                <p class="text-[10px] uppercase font-extrabold text-slate-500 dark:text-slate-400 tracking-widest mb-1">Developed by</p>
                                <p class="text-xs font-black text-indigo-600 dark:text-indigo-400">Anaamalais Digital Service</p>
                            </div>
                            ` : ''}
                        </div>
                    </aside>

                    <!-- Main Area -->
            <div class="flex-1 flex flex-col h-full overflow-hidden relative">
                <!-- Top Header (Desktop & Mobile) -->
                <header class="flex-shrink-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 h-16 flex items-center justify-between px-4 md:px-8 z-10">
                    <div class="md:hidden flex items-center gap-2">
                        <img src="anaamalais-logo.png" alt="AMS Logo" class="w-8 h-8 object-contain ${state.darkMode ? 'bg-white rounded-md p-0.5' : 'mix-blend-multiply'}">
                        <span class="font-bold text-slate-800 dark:text-white">AMS Admin</span>
                    </div>

                    <div class="hidden md:flex items-center gap-3">
                         <button onclick="state.sidebarCollapsed = !state.sidebarCollapsed; render()" class="w-10 h-10 rounded-xl flex items-center justify-center transition-all bg-white dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-500 hover:text-indigo-600 shadow-sm border border-slate-200 dark:border-slate-600" title="Toggle Menu">
                            <i class="ph-bold ph-list text-xl"></i>
                        </button>
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white whitespace-nowrap flex items-center gap-2">
                            ${activeTabLabel}
                            <span class="text-[10px] px-2 py-0.5 rounded-lg bg-indigo-50 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-400 border border-indigo-100 dark:border-indigo-800 font-bold uppercase tracking-wider">
                                ${displayBranch}
                            </span>
                        </h2>
                    </div>

                    <!-- Global Search Bar -->
                    <div class="hidden md:flex flex-1 max-w-xl mx-8 relative group">
                        <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                        <input type="text" 
                            id="global-search-input"
                            placeholder="Search everything (Trips, Drivers, Vehicles, etc)..." 
                            value="${state.typingQuery || ''}"
                            oninput="state.typingQuery = this.value"
                            onkeydown="if(event.key === 'Enter') { state.searchQuery = this.value; render(); }"
                            class="w-full pl-12 pr-24 py-2.5 bg-slate-100 dark:bg-slate-700/50 border border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-700 rounded-2xl outline-none text-sm transition-all shadow-inner"
                        >
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1">
                            ${state.typingQuery ? `
                            <button onclick="state.typingQuery = ''; state.searchQuery = ''; render()" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-rose-500 transition-colors">
                                <i class="ph-bold ph-x-circle text-lg"></i>
                            </button>
                            ` : ''}
                            <button onclick="state.searchQuery = document.getElementById('global-search-input').value; render()" class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-[10px] font-bold rounded-xl shadow-md transition-all active:scale-95">
                                Search
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl flex items-center justify-center transition-all bg-slate-100 dark:bg-slate-700/50 text-slate-600 dark:text-yellow-400 hover:scale-105 active:scale-95 shadow-sm border border-slate-200 dark:border-slate-600">
                            <i class="${state.darkMode ? 'ph-fill ph-moon' : 'ph-fill ph-sun'} text-xl"></i>
                        </button>
                        <button onclick="handleLogout()" class="md:hidden w-10 h-10 rounded-xl flex items-center justify-center bg-rose-50 text-rose-600"><i class="ph-bold ph-sign-out text-xl"></i></button>
                    </div>
                </header>

                <!-- Mobile Navigation -->
                <div class="md:hidden overflow-x-auto bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 p-2 flex gap-2 no-scrollbar">
                    ${tabs.map(t => `
                                <button onclick="state.adminTab='${t.id}'; render()" class="flex-shrink-0 flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${state.adminTab === t.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400'}">
                                    <i class="ph-bold ${t.icon}"></i> ${t.label}
                                </button>
                            `).join('')}
                </div>

                <!-- Mobile Search Bar -->
                <div class="md:hidden px-4 py-2 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
                   <div class="relative group flex gap-2">
                       <div class="relative flex-1">
                           <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                           <input type="text" 
                               id="mobile-search-input"
                               placeholder="Search everything..." 
                               value="${state.typingQuery || ''}"
                               oninput="state.typingQuery = this.value"
                               onkeydown="if(event.key === 'Enter') { state.searchQuery = this.value; render(); }"
                               class="w-full pl-10 pr-8 py-2 bg-slate-100 dark:bg-slate-700/50 border border-transparent focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-700 rounded-xl outline-none text-xs transition-all"
                           >
                           ${state.typingQuery ? `
                           <button onclick="state.typingQuery = ''; state.searchQuery = ''; render()" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 transition-colors">
                               <i class="ph-bold ph-x-circle text-base"></i>
                           </button>
                           ` : ''}
                       </div>
                       <button onclick="state.searchQuery = document.getElementById('mobile-search-input').value; render()" class="px-3 py-2 bg-indigo-600 text-white text-xs font-bold rounded-xl shadow-md active:scale-95">
                           Search
                       </button>
                   </div>
                </div>

                <!-- Content Scroll Area -->
                <div class="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-8 scroll-smooth">
                    <div class="max-w-7xl mx-auto pb-10">
                        ${content}
                    </div>
                </div>
            </div>
                </div>
            ${renderReportModal()}
                ${renderVehicleModal()}
                ${renderSalaryModal()}
                ${renderAllowanceModal()}
                ${renderLocationModal()}
                ${renderEditTripModal()}
                ${renderReviewTripModal()}
                ${renderViewTripModal()}
                ${renderDriverSummaryModal()}
                ${renderCredentialsModal()}
                ${state.modal || ''}
            `;
        };


        // --- ADMIN CRUD LOGIC ---

        const closeModal = () => { state.modal = null; render(); };
        window.closeModal = closeModal;

        // -- APPROVE EXPENSE (Missing Function) --
        window.approveExpense = async (coll, id, val) => {
            if (!val) return alert("Value required");
            const btn = window.event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';
            btn.disabled = true;

            // Map collection to field name
            let field = 'amount';
            if (coll === 'ams_maintenance_logs') field = 'price';

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), {
                    [field]: parseFloat(val),
                    status: 'Approved',
                    lastUpdated: serverTimestamp()
                });
                render();
            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        // -- FUEL --
        window.openFuelModal = (id = null) => {
            state.editFuelLog = id ? state.fuelLogs.find(l => l.id === id) : null;
            state.modal = renderFuelModalContent();
            render();
        };

        const renderFuelModalContent = () => {
            const l = state.editFuelLog || {};
            const isEdit = !!l.id;
            const today = new Date().toISOString().split('T')[0];

            const vehicles = (state.vehicles || []).map(v => `<option value="${v.vehicleNumber || v.number}" ${l.vehicleNumber === (v.vehicleNumber || v.number) ? 'selected' : ''}>${v.vehicleNumber || v.number}</option>`).join('');
            const drivers = (state.drivers || []).map(d => `<option value="${d.name}" ${l.driverName === d.name ? 'selected' : ''}>${d.name}</option>`).join('');

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in" style="z-index: 60;" onclick="if(event.target === this) closeModal()">
                <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden scale-in">
                    <div class="bg-slate-50 dark:bg-slate-900/50 px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            <i class="ph-fill ph-gas-pump text-amber-500"></i> ${isEdit ? 'Edit Fuel Log' : 'Add Fuel Log'}
                        </h3>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-slate-500"><i class="ph-bold ph-x"></i></button>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <input type="hidden" id="fuel-id" value="${l.id || ''}">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Date</label>
                                <input type="date" id="fuel-date" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.date || today}">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Litres</label>
                                <input type="number" id="fuel-litres" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.litres || ''}" placeholder="0.0">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Vehicle</label>
                            <select id="fuel-vehicle" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">Select Vehicle</option>
                                ${vehicles}
                            </select>
                        </div>

                         <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Driver</label>
                            <select id="fuel-driver" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">Select Driver</option>
                                ${drivers}
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Odometer</label>
                            <input type="number" id="fuel-odo" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.odometer || ''}" placeholder="Current Odo">
                        </div>

                    </div>
                    
                    <div class="p-4 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3">
                        <button onclick="closeModal()" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-700 transition-colors">Cancel</button>
                        <button onclick="saveFuelLog()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center gap-2">
                            ${isEdit ? 'Update Log' : 'Save Log'}
                        </button>
                    </div>
                </div>
            </div>`;
        };

        window.saveFuelLog = async () => {
            const id = document.getElementById('fuel-id').value;
            const date = document.getElementById('fuel-date').value;
            const vehicle = document.getElementById('fuel-vehicle').value;
            const driver = document.getElementById('fuel-driver').value;
            const litres = document.getElementById('fuel-litres').value;
            const odo = document.getElementById('fuel-odo').value;

            if (!date || !vehicle || !litres || !odo) return alert("Please fill at least Date, Vehicle, Litres, and Odometer.");

            const data = {
                date, vehicleNumber: vehicle, driverName: driver || 'Unknown',
                litres: parseFloat(litres), odometer: parseInt(odo),
                status: 'Approved',
                lastUpdated: serverTimestamp()
            };

            const btn = window.event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
            btn.disabled = true;

            try {
                if (id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_fuel_logs', id), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_fuel_logs'), data);
                }
                closeModal();
            } catch (e) {
                console.error(e);
                alert("Error saving: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // -- MAINTENANCE --
        window.openMaintModal = (id = null) => {
            state.editMaintLog = id ? state.maintenanceLogs.find(l => l.id === id) : null;
            state.modal = renderMaintModalContent();
            render();
        };

        const renderMaintModalContent = () => {
            const l = state.editMaintLog || {};
            const isEdit = !!l.id;
            const today = new Date().toISOString().split('T')[0];
            const vehicles = (state.vehicles || []).map(v => `<option value="${v.vehicleNumber || v.number}" ${l.vehicleNumber === (v.vehicleNumber || v.number) ? 'selected' : ''}>${v.vehicleNumber || v.number}</option>`).join('');
            const drivers = (state.drivers || []).map(d => `<option value="${d.name}" ${l.driverName === d.name ? 'selected' : ''}>${d.name}</option>`).join('');

            const issues = [...(l.general || []), ...(l.tyre || [])].join(', ');

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in" style="z-index: 60;" onclick="if(event.target === this) closeModal()">
                <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden scale-in max-h-[90vh] flex flex-col">
                    <div class="bg-slate-50 dark:bg-slate-900/50 px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center flex-shrink-0">
                         <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            <i class="ph-fill ph-wrench text-red-500"></i> ${isEdit ? 'Edit Maintenance' : 'Add Maintenance'}
                        </h3>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-slate-500"><i class="ph-bold ph-x"></i></button>
                    </div>
                    
                    <div class="p-6 space-y-4 overflow-y-auto">
                        <input type="hidden" id="maint-id" value="${l.id || ''}">
                        
                         <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Date</label>
                                <input type="date" id="maint-date" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.date || today}">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Cost (₹)</label>
                                <input type="number" id="maint-cost" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.price || ''}" placeholder="0.00">
                            </div>
                        </div>

                         <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Vehicle</label>
                            <select id="maint-vehicle" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">Select Vehicle</option>
                                ${vehicles}
                            </select>
                        </div>

                         <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Driver (Optional)</label>
                            <select id="maint-driver" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">Select Driver</option>
                                ${drivers}
                            </select>
                        </div>
                        
                        <div>
                             <label class="block text-xs font-bold text-slate-500 mb-1">Place / Workshop</label>
                             <input type="text" id="maint-place" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.place || ''}" placeholder="e.g. Workshop Name">
                        </div>

                        <!-- Maintenance Options -->
                        <div class="space-y-4 pt-2">
                             <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">General Maintenance</label>
                                <div class="flex flex-wrap gap-2" id="general-opts-container">
                                    ${['AdBlue', 'Service', 'Breakdown', 'Washing', 'Greasing', 'Other'].map(item => {
                const isSelected = (l.general || []).some(i => i === item || (item === 'Other' && i.startsWith('Other:')));
                const activeClass = "bg-indigo-50 border-indigo-500 text-indigo-700 font-boldリング-1 ring-indigo-500";
                const inactiveClass = "bg-white border-slate-200 text-slate-500 hover:bg-slate-50";
                return `<button onclick="toggleMaintOption(this, 'general')" data-value="${item}" class="px-3 py-2 rounded-xl border text-xs transition-all ${isSelected ? activeClass + ' active' : inactiveClass}">${item}</button>`;
            }).join('')}
                                </div>
                                <input type="text" id="generalOtherInput" placeholder="Specify other general issue..." 
                                    class="w-full mt-2 p-2 text-sm border-2 border-slate-200 rounded-xl ${l.general?.find(i => i.startsWith('Other:')) ? '' : 'hidden'} focus:border-indigo-400 focus:outline-none"
                                    value="${(l.general?.find(i => i.startsWith('Other:')) || '').replace('Other: ', '')}">
                            </div>

                             <div class="pt-2 border-t border-slate-100 dark:border-slate-700">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-1">Tyre Maintenance</label>
                                <div class="flex flex-wrap gap-2" id="tyre-opts-container">
                                    ${['Puncture', 'Flap Replace', 'Powder Coating', 'Wheel Alignment', 'Other'].map(item => {
                const isSelected = (l.tyre || []).some(i => i === item || (item === 'Other' && i.startsWith('Other:')));
                const activeClass = "bg-indigo-50 border-indigo-500 text-indigo-700 font-bold ring-1 ring-indigo-500";
                const inactiveClass = "bg-white border-slate-200 text-slate-500 hover:bg-slate-50";
                return `<button onclick="toggleMaintOption(this, 'tyre')" data-value="${item}" class="px-3 py-2 rounded-xl border text-xs transition-all ${isSelected ? activeClass + ' active' : inactiveClass}">${item}</button>`;
            }).join('')}
                                </div>
                                <input type="text" id="tyreOtherInput" placeholder="Specify other tyre issue..." 
                                    class="w-full mt-2 p-2 text-sm border-2 border-slate-200 rounded-xl ${l.tyre?.find(i => i.startsWith('Other:')) ? '' : 'hidden'} focus:border-indigo-400 focus:outline-none"
                                    value="${(l.tyre?.find(i => i.startsWith('Other:')) || '').replace('Other: ', '')}">
                            </div>
                        </div>
                        
                        <div>
                             <label class="block text-xs font-bold text-slate-500 mb-1">Remarks (Optional)</label>
                             <textarea id="maint-remarks" rows="2" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-medium text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Additional notes...">${l.remarks || ''}</textarea>
                        </div>

                    </div>
                    
                    <div class="p-4 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3 flex-shrink-0">
                        <button onclick="closeModal()" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-700 transition-colors">Cancel</button>
                        <button onclick="saveMaintLog()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center gap-2">
                             ${isEdit ? 'Update Log' : 'Save Log'}
                        </button>
                    </div>
                </div>
            </div>`;
        }

        window.toggleMaintOption = (btn, type) => {
            const isActive = btn.classList.contains('active');

            if (isActive) {
                // Deactivate
                btn.classList.remove('active');
                btn.className = "px-3 py-2 rounded-xl border text-xs transition-all bg-white border-slate-200 text-slate-500 hover:bg-slate-50";
                if (btn.dataset.value === 'Other') {
                    document.getElementById(type + 'OtherInput').classList.add('hidden');
                }
            } else {
                // Activate
                btn.classList.add('active');
                btn.className = "px-3 py-2 rounded-xl border text-xs transition-all bg-indigo-50 border-indigo-500 text-indigo-700 font-bold ring-1 ring-indigo-500 active";
                if (btn.dataset.value === 'Other') {
                    document.getElementById(type + 'OtherInput').classList.remove('hidden');
                    document.getElementById(type + 'OtherInput').focus();
                }
            }
        };

        window.saveMaintLog = async () => {
            const id = document.getElementById('maint-id').value;
            const date = document.getElementById('maint-date').value;
            const vehicle = document.getElementById('maint-vehicle').value;
            const driver = document.getElementById('maint-driver').value;
            const cost = document.getElementById('maint-cost').value;
            const place = document.getElementById('maint-place').value;
            const remarks = document.getElementById('maint-remarks').value;

            // Gather General Options
            const generalBtns = Array.from(document.querySelectorAll('#general-opts-container button.active'));
            const general = generalBtns.map(b => b.dataset.value);
            if (general.includes('Other')) {
                const otherIdx = general.indexOf('Other');
                const otherText = document.getElementById('generalOtherInput').value;
                if (otherText) general[otherIdx] = `Other: ${otherText}`;
            }

            // Gather Tyre Options
            const tyreBtns = Array.from(document.querySelectorAll('#tyre-opts-container button.active'));
            const tyre = tyreBtns.map(b => b.dataset.value);
            if (tyre.includes('Other')) {
                const otherIdx = tyre.indexOf('Other');
                const otherText = document.getElementById('tyreOtherInput').value;
                if (otherText) tyre[otherIdx] = `Other: ${otherText}`;
            }

            if (!date || !vehicle || !place || !cost) return alert("Please fill at least Date, Vehicle, Place and Cost.");
            if (general.length === 0 && tyre.length === 0) return alert("Please select at least one maintenance issue.");

            const data = {
                date, vehicleNumber: vehicle, driverName: driver || 'Unknown',
                price: parseFloat(cost), place, events: [],
                general: general, tyre: tyre,
                remarks: remarks,
                status: 'Approved',
                lastUpdated: serverTimestamp()
            };

            const btn = window.event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
            btn.disabled = true;

            try {
                if (id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_maintenance_logs', id), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_maintenance_logs'), data);
                }
                closeModal();
            } catch (e) {
                console.error(e);
                alert("Error saving: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // -- EXPENSE (Police/Toll) --
        window.openExpenseModal = (type, id = null) => {
            const list = type === 'police' ? (state.policeLogs || state.policeFines) : state.tollLogs;
            state.editExpenseLog = id ? list.find(l => l.id === id) : null;
            state.editExpenseType = type;
            state.modal = renderExpenseModalContent();
            render();
        };

        const renderExpenseModalContent = () => {
            const l = state.editExpenseLog || {};
            const type = state.editExpenseType;
            const isEdit = !!l.id;
            const today = new Date().toISOString().split('T')[0];
            const vehicles = (state.vehicles || []).map(v => `<option value="${v.vehicleNumber || v.number}" ${l.vehicleNumber === (v.vehicleNumber || v.number) ? 'selected' : ''}>${v.vehicleNumber || v.number}</option>`).join('');
            const drivers = (state.drivers || []).map(d => `<option value="${d.name}" ${l.driverName === d.name ? 'selected' : ''}>${d.name}</option>`).join('');

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in" style="z-index: 60;" onclick="if(event.target === this) closeModal()">
                <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden scale-in">
                    <div class="bg-slate-50 dark:bg-slate-900/50 px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                         <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                             <i class="ph-bold ${type === 'police' ? 'ph-siren text-rose-500' : 'ph-road-horizon text-blue-500'}"></i> ${isEdit ? 'Edit Entry' : 'Add Entry'} (${type === 'police' ? 'Police' : 'Toll'})
                        </h3>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-slate-500"><i class="ph-bold ph-x"></i></button>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <input type="hidden" id="exp-id" value="${l.id || ''}">
                        
                         <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Date</label>
                                <input type="date" id="exp-date" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.date ? l.date.split('T')[0] : today}">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Amount (₹)</label>
                                <input type="number" id="exp-amount" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.amount || ''}" placeholder="0.00">
                            </div>
                        </div>

                         <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Vehicle</label>
                            <select id="exp-vehicle" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">Select Vehicle</option>
                                ${vehicles}
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Driver</label>
                            <select id="exp-driver" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">Select Driver</option>
                                ${drivers}
                            </select>
                        </div>
                        
                         <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Pickup (Optional)</label>
                                <input type="text" id="exp-pickup" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.pickup || ''}" placeholder="Loc">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Drop (Optional)</label>
                                <input type="text" id="exp-drop" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" value="${l.drop || ''}" placeholder="Loc">
                            </div>
                        </div>

                    </div>
                    
                    <div class="p-4 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3">
                        <button onclick="closeModal()" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-700 transition-colors">Cancel</button>
                        <button onclick="saveExpenseLog()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center gap-2">
                             ${isEdit ? 'Update Log' : 'Save Log'}
                        </button>
                    </div>
                </div>
            </div>`;
        }

        window.saveExpenseLog = async () => {
            const id = document.getElementById('exp-id').value;
            const date = document.getElementById('exp-date').value;
            const vehicle = document.getElementById('exp-vehicle').value;
            const driver = document.getElementById('exp-driver').value;
            const amount = document.getElementById('exp-amount').value;
            const pickup = document.getElementById('exp-pickup').value;
            const drop = document.getElementById('exp-drop').value;

            if (!date || !vehicle || !amount || !driver) return alert("Please fill Date, Amount, Vehicle and Driver.");

            const data = {
                date, vehicleNumber: vehicle, driverName: driver,
                amount: parseFloat(amount),
                pickup: pickup || null, drop: drop || null,
                status: 'Approved',
                lastUpdated: serverTimestamp()
            };

            const btn = window.event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
            btn.disabled = true;

            const type = state.editExpenseType;
            const coll = type === 'police' ? 'ams_police_fines' : 'ams_toll_logs';

            try {
                if (id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', coll), data);
                }
                closeModal();
            } catch (e) {
                console.error(e);
                alert("Error saving: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // -- CREDENTIAL MANAGEMENT --
        window.openCredentialsModal = (driverId) => {
            state.editDriver = state.drivers.find(d => d.id === driverId);
            if (!state.editDriver) return;
            state.modal = 'credentials';
            render();
        };

        const renderCredentialsModal = () => {
            if (state.modal !== 'credentials') return '';
            const d = state.editDriver || {};
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50">
                        <div>
                             <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <i class="ph-fill ph-key text-amber-500"></i> Manage Credentials
                             </h2>
                             <p class="text-xs text-slate-500 dark:text-slate-400 font-bold mt-0.5">${d.name}</p>
                        </div>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center transition-colors"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <form onsubmit="saveCredentials(event)" class="p-6 space-y-5">
                        <input type="hidden" name="driverId" value="${d.id}">
                        
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800/50 flex gap-3">
                            <i class="ph-fill ph-info text-blue-500 text-xl mt-0.5"></i>
                            <div>
                                <h4 class="text-blue-800 dark:text-blue-300 font-bold text-xs uppercase mb-1">Admin Access Only</h4>
                                <p class="text-xs text-blue-700 dark:text-blue-400 leading-relaxed">
                                    Use this to view or reset the driver's login details. If they forget their password, set a new one here.
                                </p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1.5 ml-1">Username</label>
                            <div class="relative group">
                                <i class="ph-bold ph-user absolute left-3 top-3 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                                <input type="text" name="username" value="${d.username || ''}" class="w-full pl-10 px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white font-bold" required placeholder="Enter new username">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1.5 ml-1">Password</label>
                            <div class="relative group">
                                <i class="ph-bold ph-lock-key absolute left-3 top-3 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                                <input type="text" name="password" value="${d.password || ''}" class="w-full pl-10 px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white font-mono font-bold text-lg tracking-wide" required placeholder="Enter new password">
                            </div>
                        </div>

                        <div class="pt-2">
                            <button type="submit" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i class="ph-bold ph-check-circle"></i> Update Credentials
                            </button>
                        </div>
                    </form>
                </div>
            </div > `;
        };

        window.saveCredentials = async (e) => {
            e.preventDefault();
            const form = e.target;
            const driverId = form.driverId.value;
            const username = form.username.value.trim();
            const password = form.password.value.trim();

            const btn = form.querySelector('button[type="submit"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Updating...';
            btn.disabled = true;

            try {
                // Check if username already exists (optional, but good practice - skipped for speed unless requested)
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_drivers', driverId), {
                    username: username,
                    password: password,
                    updatedAt: serverTimestamp()
                });

                showToast('Credentials updated successfully!', 'success');
                closeModal();
            } catch (error) {
                console.error("Error updating credentials:", error);
                showToast('Failed to update: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        // Initialize print container on load
        if (!document.getElementById('print-container')) {
            const printContainer = document.createElement('div');
            printContainer.id = 'print-container';
            document.body.appendChild(printContainer);
        }

        initAuth();
    </script>
</body>

</html>