<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMS Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --gradient-secondary: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f43f5e 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-dark: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --gradient-glass: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.6) 100%);
            --gradient-glass-dark: linear-gradient(145deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.6) 100%);
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
            overflow-x: hidden;
        }

        .dark body {
            background-color: #0f172a;
            color: #f8fafc;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .dark .glass-strong {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(0.98);
            }
        }

        .animate-pulse-soft {
            animation: pulse-soft 2s infinite ease-in-out;
        }

        .hover-lift {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:active {
            transform: scale(0.98);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body
    class="text-slate-800 dark:text-slate-200 antialiased min-h-screen transition-colors duration-300 bg-slate-50 dark:bg-slate-900">

    <div id="app" class="min-h-screen flex flex-col relative">
        <div id="loading-screen"
            class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center transition-opacity duration-500">
            <div class="flex flex-col items-center gap-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
                <p class="text-white text-sm font-medium animate-pulse">Connecting Admin Portal...</p>
            </div>
        </div>
    </div>

    <!-- Failsafe: Force remove loading screen after 3s no matter what -->
    <script>
        setTimeout(() => {
            const ls = document.getElementById('loading-screen');
            if (ls && ls.style.display !== 'none') {
                console.warn("Forcing loading screen removal via failsafe");
                ls.style.display = 'none';
                if (!document.getElementById('login-id')) { // If login form not rendered yet
                    // Try to manually trigger render if main script failed
                    if (window.render) window.render();
                    else document.getElementById('app').innerHTML = `<div class="p-8 text-center text-red-500">App failed to load. Please refresh.</div>`;
                }
            }
        }, 3000);
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { deleteField, getFirestore, collection, addDoc, updateDoc, setDoc, deleteDoc, doc, onSnapshot, query, where, orderBy, serverTimestamp, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD1YRKvTHkK0QNMEdxfWbNCrKSWRzVOxdg",
            authDomain: "ams-service-f923f.firebaseapp.com",
            projectId: "ams-service-f923f",
            storageBucket: "ams-service-f923f.firebasestorage.app",
            messagingSenderId: "31368661696",
            appId: "1:31368661696:web:61b78217d78ed9cec8fb25",
            measurementId: "G-C0JVW9GMZJ"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ams-towing-v1';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const DRIVER_IDS = ['4455', '5566', '6677'];
        const ACCESS_CODES = {
            '2233': { role: 'superadmin', branch: 'All', name: 'Super Admin' },
            '3344': { role: 'admin', branch: 'Coimbatore', name: 'Coimbatore Admin' },
            '4455': { role: 'admin', branch: 'Trichy', name: 'Trichy Admin' },
            '5566': { role: 'admin', branch: 'Salem', name: 'Salem Admin' },
            '6677': { role: 'admin', branch: 'Kumbakonam', name: 'Kumbakonam Admin' }
        };

        const SOURCE_DRIVERS = {
            '6380664123': { name: 'Nandha Kumar', phone: '6380664123', id: '6380664123' },
            '8973475204': { name: 'Vignesh Kumar', phone: '8973475204', id: '8973475204' },
            '9080180377': { name: 'Madhan', phone: '9080180377', id: '9080180377' },
            '9751204576': { name: 'Dinesh', phone: '9751204576', id: '9751204576' },
            '9042160596': { name: 'Nasarjun', phone: '9042160596', id: '9042160596' }
        };
        const SOURCE_VEHICLES = ['TN 38 DJ 6740', 'TN 38 DM 4315', 'TN 38 DR 1843'];
        const SOURCE_LOCATIONS = ['Coimbatore', 'Tiruppur', 'Erode', 'Ooty', 'Pollachi'];
        const SOURCE_MODELS = ['Innova Crysta', 'Innova Hycross', 'Fortuner', 'Legender', 'Glanza', 'Urban Cruiser Hyryder', 'Rumion', 'Taisor', 'Camry', 'Vellfire', 'Hilux', 'Etios', 'Corolla Altis', 'Yaris', 'Urban Cruiser', 'Land Cruiser 300'];
        const CATEGORIES = { NEW: ['TVS', 'INT', 'FREE'], BREAKDOWN: ['TVS', 'Service', 'Direct'], EMPTY: [] };

        window.state = {
            user: null,
            view: 'login',
            adminTab: 'ops',
            trips: [],
            drivers: [],
            vehicles: [],
            vehicles: [],
            models: [],
            locations: [],
            attendance: {},
            attendance: {},
            monthlyAttendance: [],
            leaveRequests: [],
            reportDate: new Date().toISOString().slice(0, 10),
            reportFilter: 'All',
            perfTab: 'drivers',
            editDriver: null,
            editVehicle: null,
            modal: null,
            darkMode: localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
        };

        const state = window.state;
        const appDiv = document.getElementById('app');
        const loadingScreen = document.getElementById('loading-screen');

        // Initialize Theme
        if (state.darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');

        window.toggleTheme = () => {
            state.darkMode = !state.darkMode;
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
            render();
        };

        const initAuth = async () => {
            // Failsafe: Remove loading screen quickly if Auth hangs
            setTimeout(() => {
                const ls = document.getElementById('loading-screen');
                if (ls && ls.style.display !== 'none' && !state.user) {
                    ls.style.opacity = '0';
                    setTimeout(() => { ls.style.display = 'none'; render(); }, 300);
                }
            }, 1500);

            try {
                let signedIn = false;
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        signedIn = true;
                    } catch (e) {
                        console.warn("Custom token mismatch, falling back to anonymous auth");
                    }
                }

                if (!signedIn) {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Failed", error);
                // Still allow entry to login screen on error
                loadingScreen.style.display = 'none';
                render();
            }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
                if (!state.user) render();
            }
        });

        let unsubscribers = [];

        const setupListeners = () => {
            const today = new Date().toISOString().split('T')[0];

            const qAtt = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'), where('date', '==', today));
            unsubscribers.push(onSnapshot(qAtt, (s) => {
                const map = {}; s.docs.forEach(d => { const data = d.data(); const id = data.driverId || data.driverPhone; if (id) map[id] = data.status; });
                state.attendance = map; render();
            }));

            const qTrips = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trips'));
            unsubscribers.push(onSnapshot(qTrips, (s) => {
                const all = s.docs.map(d => ({ id: d.id, ...d.data() }));
                all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.trips = all; render();
            }));

            const qAllAtt = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'));
            unsubscribers.push(onSnapshot(qAllAtt, (s) => { state.monthlyAttendance = s.docs.map(d => d.data()); render(); }));

            const qLeave = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_leave_requests'));
            unsubscribers.push(onSnapshot(qLeave, (s) => {
                const all = s.docs.map(d => ({ id: d.id, ...d.data() }));
                all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.leaveRequests = all; render();
            }));

            const qDrivers = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_drivers'));
            unsubscribers.push(onSnapshot(qDrivers, (s) => {
                state.drivers = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));

            const qVehicles = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles'));
            unsubscribers.push(onSnapshot(qVehicles, (s) => {
                state.vehicles = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));

            const qLocations = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_locations'));
            unsubscribers.push(onSnapshot(qLocations, (s) => {
                state.locations = s.docs.map(d => ({ id: d.id, ...d.data() }));
                state.locations = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));

            const qModels = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_vehicle_models'));
            unsubscribers.push(onSnapshot(qModels, (s) => {
                state.models = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            if (!auth.currentUser) await initAuth();
            const id = document.getElementById('login-id').value.trim();

            const user = ACCESS_CODES[id];
            if (user) {
                state.user = { ...user, id };
                state.selectedBranch = user.branch || 'All';
                state.view = 'dashboard';
                setupListeners();
            } else {
                alert('Invalid Access PIN');
            }
            render();
        };

        window.handleLogout = () => {
            state.user = null; state.view = 'login';
            unsubscribers.forEach(u => u()); unsubscribers = [];
            render();
        };

        window.seedDatabase = async (type) => {
            if (!confirm(`Import ${type} data from Driver App code to Database?`)) return;
            try {
                if (type === 'drivers') {
                    for (const [id, data] of Object.entries(SOURCE_DRIVERS)) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_drivers', id), { ...data, status: 'active', createdAt: serverTimestamp() }, { merge: true });
                    }
                    alert('Drivers Imported Successfully!');
                } else if (type === 'vehicles') {
                    for (const num of SOURCE_VEHICLES) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', num.replace(/\s/g, '')), { number: num, status: 'active', type: 'Truck', createdAt: serverTimestamp() }, { merge: true });
                    }
                    alert('Vehicles Imported Successfully!');
                } else if (type === 'locations') {
                    for (const loc of SOURCE_LOCATIONS) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_locations', loc), { name: loc, branch: 'All', status: 'Active', createdAt: serverTimestamp() }, { merge: true });
                    }
                    alert('Locations Imported Successfully!');
                } else if (type === 'models') {
                    for (const model of SOURCE_MODELS) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicle_models', model.replace(/\s/g, '')), { name: model, status: 'Active', createdAt: serverTimestamp() }, { merge: true });
                    }
                    alert('Models Imported Successfully!');
                }
            } catch (e) {
                console.error(e);
                alert('Import Failed: ' + e.message);
            }
        };

        window.updateLeaveStatus = async (id, status) => {
            if (!confirm(`Mark this as ${status}?`)) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_leave_requests', id), { status: status, updatedAt: serverTimestamp() });
        };

        window.clearAllTrips = async () => {
            if (!confirm("⚠️ CRITICAL WARNING ⚠️\n\nAre you sure you want to PERMANENTLY DELETE ALL TRIPS?\n\nThis action CANNOT be undone. All trip history will be erased.")) return;

            const pin = prompt("Please enter Admin PIN to confirm:");
            if (pin !== ADMIN_ID) return alert("Incorrect PIN. Action cancelled.");

            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trips'));
                const snapshot = await new Promise((resolve) => {
                    // Use getDocs inside logic or onSnapshot one-off
                    // Since we already have state.trips, we can iterate that, but better to fetch fresh to be safe
                    // We don't have getDocs imported in the import statement I recall seeing, let's allow using the state or add import
                    // Actually, let's just use the state.trips since it is live
                    resolve(state.trips);
                });

                let count = 0;
                for (const trip of state.trips) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', trip.id));
                    count++;
                }
                alert(`Successfully deleted ${count} trips.`);
            } catch (error) {
                console.error("Error clearing trips:", error);
                alert("Failed to clear trips: " + error.message);
            }
        };

        const renderLogin = () => `
            <div class="flex items-center justify-center min-h-screen p-4 relative overflow-hidden">
                <!-- Animated Background -->
                <div class="absolute inset-0 z-0">
                    <div class="absolute top-0 left-0 w-full h-full bg-slate-50 dark:bg-slate-900 transition-colors duration-500"></div>
                    <div class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] rounded-full opacity-20 blur-[100px] animate-pulse-soft" style="background: var(--gradient-primary);"></div>
                    <div class="absolute bottom-[-10%] left-[-10%] w-[400px] h-[400px] rounded-full opacity-20 blur-[80px] animate-pulse-soft" style="background: var(--gradient-secondary); animation-delay: 1s;"></div>
                </div>

                <div class="glass-strong rounded-3xl shadow-2xl p-8 md:p-12 w-full max-w-md text-center relative z-10 animate-fade-in hover-lift border border-white/20">
                    <div class="relative mb-8">
                        <div class="w-20 h-20 rounded-2xl flex items-center justify-center mx-auto shadow-2xl relative z-10" style="background: var(--gradient-primary);">
                            <i class="ph-fill ph-steering-wheel text-4xl text-white"></i>
                        </div>
                        <div class="absolute inset-0 bg-indigo-500 blur-2xl opacity-20 transform scale-150"></div>
                    </div>
                    
                    <h1 class="text-3xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">Admin Portal</h1>
                    <p class="text-slate-500 dark:text-slate-400 mb-10 text-lg">AMS Towing Service</p>
                    
                    <form onsubmit="handleLogin(event)" class="space-y-6">
                        <div class="space-y-2 text-left">
                            <label class="text-xs font-bold uppercase text-slate-400 ml-1">Access PIN</label>
                            <div class="relative group">
                                <i class="ph-bold ph-lock-key absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl transition-colors group-focus-within:text-indigo-500"></i>
                                <input type="password" id="login-id" inputmode="numeric" class="w-full pl-12 pr-4 py-4 bg-slate-50 dark:bg-slate-800/50 border-2 border-slate-100 dark:border-slate-700/50 rounded-2xl outline-none text-lg font-bold tracking-widest text-center transition-all focus:border-indigo-500 dark:focus:border-indigo-400 focus:bg-white dark:focus:bg-slate-800 focus:shadow-lg dark:text-white placeholder:text-slate-300 dark:placeholder:text-slate-600 placeholder:font-normal placeholder:tracking-normal" placeholder="Enter PIN" required>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-4 text-white rounded-2xl font-bold text-lg shadow-xl relative overflow-hidden group hover:scale-[1.02] active:scale-[0.98] transition-all" style="background: var(--gradient-primary);">
                            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                            <span class="relative flex items-center justify-center gap-2">
                                <i class="ph-bold ph-sign-in"></i> Access Dashboard
                            </span>
                        </button>
                    </form>
                    
                    <div class="mt-8">
                        <p class="text-xs text-slate-400 font-medium">Authorized Personnel Only</p>
                    </div>
                </div>
            </div>`;

        window.openReportModal = () => {
            state.adminTab = 'reports';
            render();
        };

        window.closeModal = () => {
            state.modal = null;
            state.editDriver = null;
            state.editVehicle = null;
            render();
        }

        /* --- Driver Management CRUD --- */
        window.openDriverModal = (driverId = null) => {
            if (driverId) {
                state.editDriver = state.drivers.find(d => d.id === driverId);
            } else {
                state.editDriver = null;
            }
            state.modal = 'driver';
            render();
        };

        window.saveDriver = async (e) => {
            e.preventDefault();
            const form = e.target;
            const driverData = {
                name: form.name.value,
                phone: form.phone.value,
                branch: form.branch ? form.branch.value : state.user.branch,
                licenseNumber: form.licenseNumber.value,
                licenseExpiry: form.licenseExpiry.value,
                status: form.status.value || 'Active'
            };

            try {
                if (state.editDriver) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_drivers', state.editDriver.id), driverData);
                    showToast('Driver updated successfully', 'success');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_drivers'), { ...driverData, createdAt: new Date() });
                    showToast('Driver added successfully', 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving driver:", error);
                showToast('Error saving driver', 'error');
            }
        };

        window.deleteDriver = async (driverId) => {
            if (confirm('Are you sure you want to delete this driver?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_drivers', driverId));
                    showToast('Driver deleted', 'success');
                } catch (e) {
                    console.error(e);
                    showToast('Error deleting driver', 'error');
                }
            }
        };

        window.resetDriverTrips = async (driverId) => {
            const driver = state.drivers.find(d => d.id === driverId);
            if (!driver) return;

            if (!confirm(`⚠️ WARNING ⚠️\n\nAre you sure you want to PERMANENTLY DELETE current trips for ${driver.name}?\n\nThis will remove all trip history for this driver for the Jan 2026 pre-launch reset.`)) return;

            const pin = prompt("Please enter Admin PIN to confirm:");
            if (pin !== ADMIN_ID) return alert("Incorrect PIN. Action cancelled.");

            try {
                const tripsToDelete = state.trips.filter(t => t.driverName === driver.name);

                if (tripsToDelete.length === 0) return alert(`No trips found for ${driver.name}.`);

                let count = 0;
                for (const trip of tripsToDelete) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', trip.id));
                    count++;
                }
                alert(`Successfully deleted ${count} trips for ${driver.name}.`);
                render();
            } catch (e) {
                console.error(e);
                alert('Error resetting driver trips: ' + e.message);
            }
        };

        /* --- Vehicle Management CRUD --- */
        window.openVehicleModal = (vehicleId = null) => {
            if (vehicleId) {
                state.editVehicle = state.vehicles.find(v => v.id === vehicleId);
            } else {
                state.editVehicle = null;
            }
            state.modal = 'vehicle';
            render();
        };

        window.saveVehicle = async (e) => {
            e.preventDefault();
            const form = e.target;
            const vehicleData = {
                vehicleNumber: form.vehicleNumber.value,
                number: form.vehicleNumber.value, // Save to legacy field for consistency
                branch: form.branch ? form.branch.value : state.user.branch,
                odometer: form.odometer.value,
                type: form.type.value,
                model: form.model.value,
                make: form.make.value,
                status: form.status.value || 'Active'
            };

            try {
                if (state.editVehicle) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', state.editVehicle.id), vehicleData);
                    showToast('Vehicle updated successfully', 'success');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles'), { ...vehicleData, createdAt: new Date() });
                    showToast('Vehicle added successfully', 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving vehicle:", error);
                showToast('Error saving vehicle', 'error');
            }
        };

        window.deleteVehicle = async (vehicleId) => {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', vehicleId));
                    showToast('Vehicle deleted', 'success');
                } catch (e) {
                    console.error(e);
                    showToast('Error deleting vehicle', 'error');
                }
            }
        };

        /* --- Location Management CRUD --- */
        window.openLocationModal = (locationId = null) => {
            if (locationId) {
                state.editLocation = state.locations.find(l => l.id === locationId);
            } else {
                state.editLocation = null;
            }
            state.modal = 'location';
            render();
        };

        window.saveLocation = async (e) => {
            e.preventDefault();
            const form = e.target;

            // Get selected branches
            const selectedBranches = Array.from(form.querySelectorAll('input[name="branches"]:checked')).map(cb => cb.value);

            const locationData = {
                name: form.name.value,
                branches: selectedBranches.length > 0 ? selectedBranches : ['All'], // Default to All if nothing selected
                branch: selectedBranches.includes('All') || selectedBranches.length === 0 ? 'All' : selectedBranches[0], // Legacy field compatibility
                status: form.status.value || 'Active'
            };

            try {
                if (state.editLocation) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_locations', state.editLocation.id), locationData);
                    showToast('Location updated successfully', 'success');
                } else {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_locations', locationData.name), { ...locationData, createdAt: new Date() });
                    showToast('Location added successfully', 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving location:", error);
                showToast('Error saving location', 'error');
            }
        };

        window.deleteLocation = async (locationId) => {
            if (confirm('Are you sure you want to delete this location?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_locations', locationId));
                    showToast('Location deleted', 'success');
                } catch (e) {
                    console.error(e);
                    showToast('Error deleting location', 'error');
                }
            }
        };

        window.deleteVehicle = async (vehicleId) => {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', vehicleId));
                    showToast('Vehicle deleted', 'success');
                } catch (e) {
                    console.error(e);
                    showToast('Error deleting vehicle', 'error');
                }
            }
        };

        const renderReportModal = () => {
            if (state.modal !== 'report') return '';
            const todayStr = new Date().toISOString().slice(0, 10);
            const trips = state.trips.filter(t => t.status === 'completed' && t.date === todayStr);

            let totalKm = 0;
            let totalMinutes = 0;

            const rows = trips.map(t => {
                const start = t.startTime?.seconds ? new Date(t.startTime.seconds * 1000) : null;
                const end = t.endTime?.seconds ? new Date(t.endTime.seconds * 1000) : null;
                const duration = start && end ? Math.round((end - start) / 60000) : 0; // minutes
                const km = (t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0;

                totalKm += km > 0 ? km : 0;
                totalMinutes += duration > 0 ? duration : 0;

                const durationStr = duration > 60 ? `${Math.floor(duration / 60)}h ${duration % 60}m` : `${duration}m`;

                return `
                    <tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                        <td class="p-3 font-bold text-slate-700 dark:text-slate-300">${t.truckNumber}</td>
                        <td class="p-3 text-slate-600 dark:text-slate-400 font-mono text-xs">${t.driverName}</td>
                        <td class="p-3 text-slate-600 dark:text-slate-400 text-xs">${t.pickupLocation} → ${t.dropLocation}</td>
                        <td class="p-3 text-right font-mono text-slate-700 dark:text-slate-300 font-bold">${km} km</td>
                        <td class="p-3 text-right font-mono text-slate-700 dark:text-slate-300 font-bold">${durationStr}</td>
                    </tr>
                `;
            }).join('');

            const totalHoursStr = totalMinutes > 60 ? `${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m` : `${totalMinutes}m`;

            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <i class="ph-fill ph-check-circle text-green-500"></i> Daily Report
                            </h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 font-mono mt-1">${todayStr}</p>
                        </div>
                        <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-red-100 hover:text-red-500 dark:hover:bg-red-900/30 dark:hover:text-red-400 flex items-center justify-center transition-colors">
                            <i class="ph-bold ph-x text-xl"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-3 gap-4 p-6 bg-slate-50 dark:bg-slate-900/30 border-b border-slate-100 dark:border-slate-700">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                            <p class="text-xs uppercase font-bold text-slate-400 mb-1">Total Trips</p>
                            <p class="text-3xl font-bold text-slate-800 dark:text-white">${trips.length}</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                            <p class="text-xs uppercase font-bold text-slate-400 mb-1">Total Distance</p>
                            <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 font-mono">${totalKm} <span class="text-sm text-slate-400">km</span></p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 text-center">
                            <p class="text-xs uppercase font-bold text-slate-400 mb-1">Total Duration</p>
                            <p class="text-3xl font-bold text-blue-600 dark:text-blue-400 font-mono">${totalHoursStr}</p>
                        </div>
                    </div>

                    <div class="overflow-y-auto flex-1 p-0">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold sticky top-0 backdrop-blur-md">
                                <tr>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700">Truck</th>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700">Driver</th>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700">Route</th>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700 text-right">Distance</th>
                                    <th class="p-3 border-b border-slate-100 dark:border-slate-700 text-right">Duration</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                ${rows || '<tr><td colspan="5" class="p-8 text-center text-slate-400">No completed trips for today.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }



        const getFilteredData = (data) => {
            if (!state.user) return data;
            const filterBranch = state.selectedBranch || state.user.branch || 'All';
            if (filterBranch === 'All') return data;

            return data.filter(item => {
                let itemBranch = item.branch;

                // Implicit branch lookup for Trips (which lack branch field)
                if (!itemBranch) {
                    // 1. Try Lookup by Vehicle (Truck Number)
                    const truckNo = item.truckNumber || item.vehicleNumber;
                    if (truckNo) {
                        const vehicle = state.vehicles.find(v => (v.vehicleNumber === truckNo || v.number === truckNo));
                        if (vehicle && vehicle.branch) itemBranch = vehicle.branch;
                    }
                }

                if (!itemBranch) {
                    // 2. Try Lookup by Driver
                    const dName = item.driverName || item.name;
                    // Only look up if it looks like a trip (has driverName) or checking a driver without branch?
                    // Drivers usually have branch. This is mostly for Trips.
                    if (item.driverName) {
                        const driver = state.drivers.find(d => d.name === item.driverName);
                        if (driver && driver.branch) itemBranch = driver.branch;
                    }
                }

                // Default to Coimbatore if still unknown (Legacy data support)
                return (itemBranch || 'Coimbatore') === filterBranch;
            });
        };

        const renderOps = () => {
            const drivers = getFilteredData(state.drivers);
            const trips = getFilteredData(state.trips);
            const leaveRequests = getFilteredData(state.leaveRequests);

            const activeTrips = trips.filter(t => t.status === 'active');
            const completedTrips = trips.filter(t => t.status === 'completed');
            const onlineDrivers = drivers.filter(d => (state.attendance[d.phone] || state.attendance[d.id]) === 'online').length;
            const todayStr = new Date().toISOString().slice(0, 10);
            const todayCompleted = completedTrips.filter(t => t.date === todayStr).length;

            return `
            <div class="space-y-6">
                <!-- Summary Stats -->
                <div class="flex justify-end">
                    <button onclick="clearAllTrips()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-xl text-sm font-bold transition-colors flex items-center gap-2">
                        <i class="ph-bold ph-trash"></i> Reset All Trips
                    </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-wifi-high text-4xl text-indigo-600 dark:text-indigo-400"></i></div>
                        <span class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">Online Drivers</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800 dark:text-white">${onlineDrivers}</span>
                            <span class="text-xs font-medium text-slate-400">/ ${drivers.length}</span>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-truck text-4xl text-blue-600 dark:text-blue-400"></i></div>
                        <span class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">Active Trips</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800 dark:text-white">${activeTrips.length}</span>
                            ${activeTrips.length > 0 ? '<span class="flex h-2 w-2 rounded-full bg-blue-500 animate-pulse"></span>' : ''}
                        </div>
                    </div>
                    <div onclick="state.adminTab='reports'; render()" class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24 relative overflow-hidden group cursor-pointer hover:border-green-500 hover:shadow-md transition-all">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-check-circle text-4xl text-green-600 dark:text-green-400"></i></div>
                        <span class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-green-600 transition-colors">Completed Today</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800 dark:text-white">${todayCompleted}</span>
                            <span class="text-[10px] font-bold text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/30 px-2 py-0.5 rounded-full flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                View Report <i class="ph-bold ph-arrow-right"></i>
                            </span>
                        </div>
                    </div>
                     <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="ph-fill ph-files text-4xl text-orange-600 dark:text-orange-400"></i></div>
                        <span class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">Pending Leave</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800 dark:text-white">${leaveRequests.filter(r => r.status === 'pending').length}</span>
                        </div>
                    </div>
                </div>

                <!-- Live Driver Grid -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                    <h2 class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-4 flex items-center gap-2">
                        <i class="ph-fill ph-broadcast text-indigo-500"></i> Live Fleet Status
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        ${drivers.map(d => {
                const hasActiveTrip = activeTrips.some(t => t.driverName === d.name);
                const status = hasActiveTrip ? 'online' : (state.attendance[d.phone] || state.attendance[d.id] || 'offline');
                return `
                            <div class="flex flex-col items-center justify-center p-3 rounded-xl border transition-all ${status === 'online' ? 'bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-900/30' : 'bg-slate-50 dark:bg-slate-700/30 border-slate-100 dark:border-slate-700 opacity-60'}">
                                <div class="relative mb-2">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 ${status === 'online' ? 'bg-white dark:bg-slate-800 border-green-500 text-green-700 dark:text-green-400' : 'bg-slate-200 dark:bg-slate-600 border-transparent text-slate-500'}">
                                        ${d.name.slice(0, 2)}
                                    </div>
                                    ${status === 'online' ? '<div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white dark:border-slate-800 rounded-full animate-pulse"></div>' : ''}
                                </div>
                                <span class="text-xs font-bold text-slate-700 dark:text-slate-300 text-center truncate w-full">${d.name}</span>
                                <span class="text-[10px] font-bold uppercase tracking-wider mt-1 ${status === 'online' ? 'text-green-600 dark:text-green-400' : 'text-slate-400'}">${status}</span>
                            </div>`;
            }).join('')}
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Active Trips Section (2/3 width) -->
                    <div class="lg:col-span-2 space-y-4">
                        <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            <span class="flex w-3 h-3 rounded-full bg-blue-500 animate-pulse"></span> Active Trips
                        </h3>
                        ${activeTrips.length > 0 ?
                    `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${activeTrips.map(t => `
                                    <div onclick="openEditTripModal('${t.id}')" class="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-blue-100 dark:border-blue-900/30 relative overflow-hidden cursor-pointer hover:shadow-md transition-all group">
                                        <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 dark:bg-blue-900/10 rounded-full -mr-10 -mt-10 blur-xl group-hover:bg-blue-100 dark:group-hover:bg-blue-900/20 transition-colors"></div>
                                        <div class="relative">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <div class="flex gap-2 mb-2">
                                                        <span class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded-lg inline-block">On-Going</span>
                                                        <span class="text-xs font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wider bg-purple-50 dark:bg-purple-900/30 px-2 py-1 rounded-lg inline-block">Type: ${t.tripType || 'TVS'}</span>
                                                    </div>
                                                    <h4 class="font-bold text-slate-800 dark:text-white">${t.truckNumber}</h4>
                                                </div>
                                                <div class="text-right">
                                                    <span class="block text-xs text-slate-400">Driver</span>
                                                    <span class="font-bold text-sm text-slate-700 dark:text-slate-300">${t.driverName}</span>
                                                </div>
                                            </div>
                                            
                                            <div class="flex items-center gap-4 mb-4">
                                                <div class="flex-1">
                                                    <p class="text-[10px] uppercase text-slate-400 font-bold">Pickup</p>
                                                    <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 truncate">${t.pickupLocation}</p>
                                                </div>
                                                <i class="ph-bold ph-arrow-right text-slate-300"></i>
                                                <div class="flex-1 text-right">
                                                    <p class="text-[10px] uppercase text-slate-400 font-bold">Drop</p>
                                                    <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 truncate">${t.dropLocation}</p>
                                                </div>
                                            </div>

                                            <div class="pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-700/20 -mx-4 -mb-4 px-4 py-3">
                                                <div class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1">
                                                    <i class="ph-fill ph-clock"></i> Started: ${t.startTime ? new Date(t.startTime.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Unknown'}
                                                </div>
                                                <button class="text-xs font-bold text-blue-600 dark:text-blue-400 flex items-center gap-1 hover:gap-2 transition-all">
                                                    Track Live <i class="ph-bold ph-arrow-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                    :
                    `<div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-8 text-center border-2 border-dashed border-slate-200 dark:border-slate-700">
                                <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400">
                                    <i class="ph-fill ph-coffee text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-slate-600 dark:text-slate-400">No Active Trips</h4>
                                <p class="text-xs text-slate-400 mt-1">All drivers are currently available or offline.</p>
                            </div>`
                }
                    </div>

                    <!-- Recent Activity (1/3 width) -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-end">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white">Recent Activity</h3>
                            <button class="text-xs font-bold text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 transition-colors">View All</button>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            ${completedTrips.slice(0, 5).map(t => `
                                <div class="p-4 border-b border-slate-100 dark:border-slate-700 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors cursor-pointer group">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-xs font-bold text-slate-800 dark:text-white group-hover:text-indigo-600 transition-colors">${t.truckNumber}</span>
                                        <span class="text-[10px] text-slate-400">${t.date}</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 mb-2">
                                        <span class="truncate max-w-[80px]">${t.pickupLocation}</span>
                                        <i class="ph-bold ph-arrow-right text-[10px] text-slate-300"></i>
                                        <span class="truncate max-w-[80px]">${t.dropLocation}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                       <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 uppercase">Completed</span>
                                       <span class="text-[10px] font-medium text-slate-400">${t.driverName}</span>
                                    </div>
                                </div>
                            `).join('')}
                            ${completedTrips.length === 0 ? '<div class="p-6 text-center text-xs text-slate-400">No recent history</div>' : ''}
                        </div>
                    </div>
                </div>
            </div>`;
        };

        const renderHR = () => {
            const drivers = getFilteredData(state.drivers);
            const leaveRequests = getFilteredData(state.leaveRequests);

            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthName = now.toLocaleString('default', { month: 'long' });

            return `
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Leave Approvals -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 h-full">
                    <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800 dark:text-white">
                        <i class="ph-fill ph-file-text text-indigo-500"></i> Leave Approvals
                    </h2>
                    <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                        ${leaveRequests.filter(r => r.status === 'pending').map(req => `
                            <div class="border border-slate-200 dark:border-slate-700 p-4 rounded-xl flex justify-between items-center bg-slate-50 dark:bg-slate-900/50 shadow-sm">
                                <div>
                                    <div class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                        ${req.driverName}
                                        <span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full uppercase">Pending</span>
                                    </div>
                                    <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                                        <span class="font-mono text-slate-700 dark:text-slate-300">${req.startDate}</span> to <span class="font-mono text-slate-700 dark:text-slate-300">${req.endDate}</span>
                                    </div>
                                    <div class="text-xs text-slate-400 italic mt-1">"${req.reason}"</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="updateLeaveStatus('${req.id}', 'approved')" class="w-10 h-10 flex items-center justify-center bg-green-100 hover:bg-green-200 text-green-700 dark:bg-green-900/30 dark:hover:bg-green-900/50 dark:text-green-400 rounded-xl transition-all shadow-sm hover:shadow-md" title="Approve">
                                        <i class="ph-bold ph-check text-xl"></i>
                                    </button>
                                    <button onclick="updateLeaveStatus('${req.id}', 'rejected')" class="w-10 h-10 flex items-center justify-center bg-red-100 hover:bg-red-200 text-red-700 dark:bg-red-900/30 dark:hover:bg-red-900/50 dark:text-red-400 rounded-xl transition-all shadow-sm hover:shadow-md" title="Reject">
                                        <i class="ph-bold ph-x text-xl"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        ${leaveRequests.filter(r => r.status === 'pending').length === 0 ?
                    `<div class="flex flex-col items-center justify-center py-10 text-slate-400">
                                <i class="ph-duotone ph-check-circle text-4xl mb-2 opacity-50"></i>
                                <p class="text-sm italic">No pending approvals</p>
                            </div>` : ''}
                    </div>
                </div>

                <!-- Monthly Overview -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            <i class="ph-fill ph-calendar-blank text-indigo-500"></i> Attendance: ${monthName}
                        </h2>
                         <div class="flex items-center gap-2 text-xs">
                            <span class="flex items-center gap-1 text-slate-500 dark:text-slate-400"><span class="w-2 h-2 rounded-full bg-green-500"></span> Present</span>
                            <span class="flex items-center gap-1 text-slate-500 dark:text-slate-400"><span class="w-2 h-2 rounded-full bg-slate-300 dark:bg-slate-600"></span> Absent</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto flex-1 custom-scrollbar pb-2">
                        <table class="w-full text-xs text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400">
                                    <th class="p-3 border border-slate-200 dark:border-slate-700 min-w-[120px] sticky left-0 bg-slate-50 dark:bg-slate-700/50 z-20 font-bold uppercase shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">Driver</th>
                                    ${Array.from({ length: daysInMonth }, (_, i) => `<th class="p-1 border border-slate-200 dark:border-slate-700 text-center min-w-[32px] font-medium">${i + 1}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${drivers.map(d => {
                        return `
                                    <tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                        <td class="p-3 font-bold border-r border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 sticky left-0 bg-white dark:bg-slate-800 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] truncate max-w-[120px]" title="${d.name}">${d.name}</td>
                                        ${Array.from({ length: daysInMonth }, (_, i) => {
                            const day = i + 1;
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const record = state.monthlyAttendance.find(a => (a.driverId === d.phone || a.driverId === d.id) && a.date === dateStr);
                            let cellContent = '·';
                            let cellClass = 'text-slate-300 dark:text-slate-600';

                            if (record) {
                                if (record.checkInTime) {
                                    const checkIn = record.checkInTime.seconds ? new Date(record.checkInTime.seconds * 1000) : null;
                                    const checkOut = record.checkOutTime?.seconds ? new Date(record.checkOutTime.seconds * 1000) : (record.status === 'online' && day === now.getDate() ? new Date() : null);

                                    if (checkIn && checkOut) {
                                        const diffMs = checkOut - checkIn;
                                        const hrs = Math.floor(diffMs / 3600000);
                                        const mins = Math.floor((diffMs % 3600000) / 60000);
                                        if (hrs > 0 || mins > 0) cellContent = `${hrs}h ${mins}m`;
                                        // Compact format if needed
                                        if (cellContent.length > 8) cellContent = `${hrs}h${mins}m`;
                                    } else if (record.status === 'online') {
                                        cellContent = 'On';
                                    } else {
                                        cellContent = 'P';
                                    }
                                } else if (record.status === 'online' || record.date) {
                                    cellContent = 'P';
                                }

                                if (cellContent !== '·') {
                                    cellClass = 'bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400 font-bold text-[10px]';
                                }
                            }

                            // Highlight today column
                            const isToday = day === now.getDate();
                            const borderClass = isToday ? 'border-indigo-300 dark:border-indigo-500 border-x-2' : 'border-slate-200 dark:border-slate-700';

                            return `<td class="border ${borderClass} text-center ${cellClass} transition-colors p-1" title="${cellContent}">${cellContent}</td>`;
                        }).join('')}
                                    </tr>`;
                    }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        const renderPerf = () => {
            // Initialize filter state if not set
            if (!state.perfFilterType) state.perfFilterType = 'month';
            if (!state.perfDate) state.perfDate = new Date().toISOString().slice(0, 7); // Default to current month YYYY-MM
            if (!state.perfDay) state.perfDay = new Date().toISOString().split('T')[0];
            if (!state.perfStart) state.perfStart = new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0];
            if (!state.perfEnd) state.perfEnd = new Date().toISOString().split('T')[0];

            const drivers = getFilteredData(state.drivers);
            const vehicles = getFilteredData(state.vehicles);
            const isDriver = state.perfTab === 'drivers';

            // Filter Trips Logic
            const rawTrips = getFilteredData(state.trips);
            let perfTrips = rawTrips.filter(t => t.status === 'completed');

            if (state.perfFilterType === 'day') {
                perfTrips = perfTrips.filter(t => t.date === state.perfDay);
            } else if (state.perfFilterType === 'month') {
                perfTrips = perfTrips.filter(t => t.date && t.date.startsWith(state.perfDate));
            } else if (state.perfFilterType === 'custom') {
                perfTrips = perfTrips.filter(t => t.date >= state.perfStart && t.date <= state.perfEnd);
            }

            const renderDriverCard = (d) => {
                const dTrips = perfTrips.filter(t => t.driverName === d.name);
                const total = dTrips.length;
                const tvs = dTrips.filter(t => t.tripType === 'TVS').length;
                const int = dTrips.filter(t => t.tripType === 'INT').length;
                const empty = dTrips.filter(t => t.tripType === 'Empty').length;
                const totalKm = dTrips.reduce((acc, t) => acc + ((t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0), 0);

                // Calculate participation (attendance)
                const presentDays = state.monthlyAttendance.filter(a => (a.driverId === d.phone || a.driverId === d.id) && a.status === 'online').length;

                return `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden hover:shadow-md transition-shadow">
                    <div class="bg-slate-50 dark:bg-slate-900/30 p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-bold text-lg shadow-sm border border-indigo-200 dark:border-indigo-800">${d.name.slice(0, 2).toUpperCase()}</div>
                            <div>
                                <h3 class="font-bold text-slate-800 dark:text-white text-lg">${d.name}</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1"><i class="ph-fill ph-check-circle text-green-500"></i> ${presentDays} Days Present (Month)</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${total}</span>
                            <p class="text-[10px] uppercase font-bold text-slate-400">Total Trips</p>
                        </div>
                    </div>
                    <div class="p-5 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                             <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-xl border border-indigo-100 dark:border-indigo-800/30">
                                <p class="text-[10px] uppercase font-bold text-indigo-400 mb-1">Total Distance</p>
                                <p class="text-xl font-bold text-slate-700 dark:text-slate-300 font-mono">${totalKm} <span class="text-xs text-slate-400">km</span></p>
                             </div>
                             <div class="bg-emerald-50 dark:bg-emerald-900/20 p-3 rounded-xl border border-emerald-100 dark:border-emerald-800/30">
                                <p class="text-[10px] uppercase font-bold text-emerald-400 mb-1">Efficiency</p>
                                <p class="text-xl font-bold text-slate-700 dark:text-slate-300 font-mono">${total ? Math.round(totalKm / total) : 0} <span class="text-xs text-slate-400">km/trip</span></p>
                             </div>
                        </div>

                        <div>
                             <p class="text-xs font-bold text-slate-400 mb-2 uppercase">Trip Category Breakdown</p>
                             <div class="space-y-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-bold text-slate-600 dark:text-slate-400 w-12">TVS</span>
                                    <div class="flex-1 bg-slate-100 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                                        <div class="bg-blue-500 h-full rounded-full" style="width: ${total ? (tvs / total) * 100 : 0}%"></div>
                                    </div>
                                    <span class="text-xs font-mono font-bold text-slate-700 dark:text-slate-300 w-8 text-right">${tvs}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-bold text-slate-600 dark:text-slate-400 w-12">INT</span>
                                    <div class="flex-1 bg-slate-100 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                                        <div class="bg-purple-500 h-full rounded-full" style="width: ${total ? (int / total) * 100 : 0}%"></div>
                                    </div>
                                    <span class="text-xs font-mono font-bold text-slate-700 dark:text-slate-300 w-8 text-right">${int}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-bold text-slate-600 dark:text-slate-400 w-12">Empty</span>
                                    <div class="flex-1 bg-slate-100 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                                        <div class="bg-slate-400 h-full rounded-full" style="width: ${total ? (empty / total) * 100 : 0}%"></div>
                                    </div>
                                    <span class="text-xs font-mono font-bold text-slate-700 dark:text-slate-300 w-8 text-right">${empty}</span>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>`;
            };

            const renderVehicleCard = (v) => {
                const vTrips = perfTrips.filter(t => (t.truckNumber === v || t.vehicleNumber === v));
                const total = vTrips.length;
                const totalKm = vTrips.reduce((acc, t) => acc + ((t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0), 0);

                // Analysis: Frequent Driver
                const driverCounts = {};
                vTrips.forEach(t => { driverCounts[t.driverName] = (driverCounts[t.driverName] || 0) + 1; });
                const topDriver = Object.keys(driverCounts).reduce((a, b) => driverCounts[a] > driverCounts[b] ? a : b, 'None');

                // Utilization Chart Data (Mock calculation for visual variety)
                const utilization = Math.min(100, Math.round((total / 30) * 100)); // Assuming 30 trips/month is 100%

                return `
                 <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden hover:shadow-md transition-shadow">
                    <div class="bg-slate-50 dark:bg-slate-900/30 p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg skew-x-[-10deg] flex items-center justify-center text-emerald-600 dark:text-emerald-400 font-bold text-lg shadow-sm border border-emerald-200 dark:border-emerald-800">
                                <i class="ph-fill ph-truck skew-x-[10deg]"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 dark:text-white text-lg">${v}</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1"><i class="ph-fill ph-user-focus text-purple-500"></i> Top: ${topDriver}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-3xl font-bold text-emerald-600 dark:text-emerald-400">${total}</span>
                            <p class="text-[10px] uppercase font-bold text-slate-400">Total Trips</p>
                        </div>
                    </div>
                    <div class="p-5 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                             <div class="bg-slate-100 dark:bg-slate-700/30 p-3 rounded-xl text-center">
                                <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Odometer Run</p>
                                <p class="text-xl font-bold text-slate-700 dark:text-slate-300 font-mono">${totalKm} <span class="text-xs text-slate-400">km</span></p>
                             </div>
                             <div class="bg-slate-100 dark:bg-slate-700/30 p-3 rounded-xl text-center">
                                <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Avg Distance</p>
                                <p class="text-xl font-bold text-slate-700 dark:text-slate-300 font-mono">${total ? Math.round(totalKm / total) : 0} <span class="text-xs text-slate-400">km</span></p>
                             </div>
                        </div>
                        
                        <div>
                             <div class="flex justify-between items-center mb-2">
                                <p class="text-xs font-bold text-slate-400 uppercase">Monthly Utilization</p>
                                <span class="text-xs font-bold text-indigo-500">${utilization}%</span>
                             </div>
                             <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full rounded-full relative" style="width: ${utilization}%">
                                    <div class="absolute inset-0 bg-white opacity-20 animate-pulse"></div>
                                </div>
                             </div>
                             <p class="text-[10px] text-slate-400 mt-1 italic text-right">Based on trip frequency</p>
                        </div>
                    </div>
                 </div>`;
            };

            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            return `
            <div class="space-y-6 animate-slide-up">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">Performance Analytics</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Fleet and Driver efficiency metrics</p>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3">
                         <!-- Filter Controls -->
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <select onchange="state.perfFilterType=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs font-bold text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0 cursor-pointer">
                                <option value="day" ${state.perfFilterType === 'day' ? 'selected' : ''}>Day View</option>
                                <option value="month" ${state.perfFilterType === 'month' ? 'selected' : ''}>Month View</option>
                                <option value="custom" ${state.perfFilterType === 'custom' ? 'selected' : ''}>Custom Range</option>
                            </select>
                            
                            <!-- Day Picker -->
                            ${state.perfFilterType === 'day' ? `
                                <input type="date" value="${state.perfDay}" onchange="state.perfDay=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                            ` : ''}

                            <!-- Month Picker -->
                             ${state.perfFilterType === 'month' ? `
                                <input type="month" value="${state.perfDate}" onchange="state.perfDate=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                            ` : ''}

                            <!-- Custom Range -->
                            ${state.perfFilterType === 'custom' ? `
                                <div class="flex items-center gap-1">
                                    <input type="date" value="${state.perfStart}" onchange="state.perfStart=this.value; render()" class="w-32 bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                                    <span class="text-slate-400">-</span>
                                    <input type="date" value="${state.perfEnd}" onchange="state.perfEnd=this.value; render()" class="w-32 bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                                </div>
                            ` : ''}
                        </div>

                        <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex gap-1 shadow-inner">
                            <button onclick="state.perfTab='drivers'; render()" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${isDriver ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400 hover:text-indigo-500'} flex items-center gap-2">
                                <i class="ph-bold ph-steering-wheel"></i> Drivers
                            </button>
                            <button onclick="state.perfTab='vehicles'; render()" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${!isDriver ? 'bg-white dark:bg-slate-600 shadow text-emerald-600 dark:text-emerald-400' : 'text-slate-500 dark:text-slate-400 hover:text-emerald-500'} flex items-center gap-2">
                                <i class="ph-bold ph-truck"></i> Vehicles
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${isDriver
                    ? (drivers.length ? drivers.filter(d => {
                        // Optional: Hide drivers with 0 trips if desired? For now showing all filtered
                        return true;
                    }).map(renderDriverCard).join('') : `<div class="col-span-3 text-center py-12 text-slate-400">No driver data available.</div>`)
                    : (vehicles.length ? vehicles.map(v => renderVehicleCard(v.vehicleNumber || v.number)).join('') : `<div class="col-span-3 text-center py-12 text-slate-400">No vehicle data available.</div>`)
                }
                </div>
            </div>`;
        };

        window.exportToExcel = () => {
            // Re-apply filters
            const trips = getFilteredData(state.trips);
            let reportTrips = trips.filter(t => t.status === 'completed');

            if (state.reportDateFilterType === 'day') {
                reportTrips = reportTrips.filter(t => t.date === state.reportDate);
            } else if (state.reportDateFilterType === 'month') {
                reportTrips = reportTrips.filter(t => t.date && t.date.startsWith(state.reportMonth));
            } else if (state.reportDateFilterType === 'custom') {
                reportTrips = reportTrips.filter(t => t.date >= state.reportStart && t.date <= state.reportEnd);
            }

            // Driver Filter
            if (state.reportDriverFilter && state.reportDriverFilter !== 'All') {
                reportTrips = reportTrips.filter(t => t.driverName === state.reportDriverFilter);
            }

            // Truck Filter
            if (state.reportTruckFilter && state.reportTruckFilter !== 'All') {
                reportTrips = reportTrips.filter(t => t.truckNumber === state.reportTruckFilter);
            }

            // Filter by Trip Type
            const displayTrips = state.reportFilter === 'All'
                ? reportTrips
                : reportTrips.filter(t => t.tripType === state.reportFilter);

            if (displayTrips.length === 0) return alert("No data to export.");

            // Build CSV Content
            let csvContent = "data:text/csv;charset=utf-8,";
            // Header
            csvContent += "Truck,Driver,Vehicle No,Pickup,Drop,Distance (km),Duration (min),Type,Date\n";

            // Rows
            displayTrips.forEach(t => {
                const start = t.startTime?.seconds ? new Date(t.startTime.seconds * 1000) : null;
                const end = t.endTime?.seconds ? new Date(t.endTime.seconds * 1000) : null;
                const duration = start && end ? Math.round((end - start) / 60000) : 0;
                const km = (t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0;

                // Escape fields that might contain commas
                const escape = (val) => `"${(val || '').toString().replace(/"/g, '""')}"`;

                const row = [
                    escape(t.truckNumber),
                    escape(t.driverName),
                    escape(t.vehicleNumber || '-'),
                    escape(t.pickupLocation),
                    escape(t.dropLocation),
                    km,
                    duration,
                    escape(t.tripType || 'Reg'),
                    escape(t.date)
                ].join(",");
                csvContent += row + "\r\n";
            });

            // Trigger Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = `Daily_Report_${state.reportDateFilterType}_${new Date().toISOString().slice(0, 10)}.csv`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const renderReports = () => {
            // Initialize report filter state if not set
            if (!state.reportDateFilterType) state.reportDateFilterType = 'day';
            if (!state.reportDate) state.reportDate = new Date().toISOString().split('T')[0];
            if (!state.reportMonth) state.reportMonth = new Date().toISOString().slice(0, 7);
            if (!state.reportStart) state.reportStart = new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0];
            if (!state.reportEnd) state.reportEnd = new Date().toISOString().split('T')[0];

            const trips = getFilteredData(state.trips);

            // Filter Logic
            let reportTrips = trips.filter(t => t.status === 'completed');

            if (state.reportDateFilterType === 'day') {
                reportTrips = reportTrips.filter(t => t.date === state.reportDate);
            } else if (state.reportDateFilterType === 'month') {
                reportTrips = reportTrips.filter(t => t.date && t.date.startsWith(state.reportMonth));
            } else if (state.reportDateFilterType === 'custom') {
                reportTrips = reportTrips.filter(t => t.date >= state.reportStart && t.date <= state.reportEnd);
            }

            // Initialize Filter States if unused
            if (!state.reportDriverFilter) state.reportDriverFilter = 'All';
            if (!state.reportTruckFilter) state.reportTruckFilter = 'All';

            // Apply Driver Filter
            if (state.reportDriverFilter !== 'All') {
                reportTrips = reportTrips.filter(t => t.driverName === state.reportDriverFilter);
            }

            // Apply Truck Filter
            if (state.reportTruckFilter !== 'All') {
                reportTrips = reportTrips.filter(t => t.truckNumber === state.reportTruckFilter);
            }

            // Calculate breakdown counts
            const counts = {
                'All': reportTrips.length,
                'TVS': reportTrips.filter(t => t.tripType === 'TVS').length,
                'INT': reportTrips.filter(t => t.tripType === 'INT').length,
                'Empty': reportTrips.filter(t => t.tripType === 'Empty').length
            };

            // Filter by Trip Type for Table Display
            const displayTrips = state.reportFilter === 'All'
                ? reportTrips
                : reportTrips.filter(t => t.tripType === state.reportFilter);

            let totalKm = 0;
            let totalMinutes = 0;

            const rows = displayTrips.map(t => {
                const start = t.startTime?.seconds ? new Date(t.startTime.seconds * 1000) : null;
                const end = t.endTime?.seconds ? new Date(t.endTime.seconds * 1000) : null;
                const duration = start && end ? Math.round((end - start) / 60000) : 0; // minutes
                const km = (t.endOdo && t.startOdo) ? (parseInt(t.endOdo) - parseInt(t.startOdo)) : 0;

                totalKm += km > 0 ? km : 0;
                totalMinutes += duration > 0 ? duration : 0;

                const durationStr = duration > 60 ? `${Math.floor(duration / 60)}h ${duration % 60}m` : `${duration}m`;

                return `
                    <tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                        <td class="p-4 font-bold text-slate-700 dark:text-slate-300">${t.truckNumber}</td>
                        <td class="p-4 text-slate-500 dark:text-slate-400 font-mono text-xs">${t.date}</td>
                        <td class="p-4 text-slate-600 dark:text-slate-400 font-mono text-sm">${t.driverName}</td>
                        <td class="p-4 text-slate-600 dark:text-slate-400 font-mono text-xs uppercase tracking-wider">${t.vehicleNumber || '-'}</td>
                        <td class="p-4 text-slate-600 dark:text-slate-400 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="truncate max-w-[100px]">${t.pickupLocation}</span>
                                <i class="ph-bold ph-arrow-right text-xs text-slate-300"></i>
                                <span class="truncate max-w-[100px]">${t.dropLocation}</span>
                            </div>
                        </td>
                        <td class="p-4 text-right font-mono text-slate-700 dark:text-slate-300 font-bold">${km} km</td>
                        <td class="p-4 text-right font-mono text-slate-700 dark:text-slate-300 font-bold">${durationStr}</td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${t.tripType === 'TVS' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' : (t.tripType === 'INT' ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400' : 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400')}">${t.tripType || 'Reg'}</span>
                        </td>
                        <td class="p-4 text-right">
                            ${t.hasPendingChanges ? `
                            <button onclick="openReviewTripModal('${t.id}')" class="p-2 bg-amber-100 text-amber-600 hover:bg-amber-200 rounded-lg transition-colors flex items-center gap-1 ml-auto" title="Review Pending Changes">
                                <i class="ph-bold ph-warning-circle text-lg"></i> <span class="text-xs font-bold">Review</span>
                            </button>
                            ` : `
                            <button onclick="openEditTripModal('${t.id}')" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/50 rounded-lg transition-colors" title="Edit Trip">
                                <i class="ph-bold ph-pencil-simple text-lg"></i>
                            </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');

            const totalHoursStr = totalMinutes > 60 ? `${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m` : `${totalMinutes}m`;

            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            let dateLabel = state.reportDate;
            if (state.reportDateFilterType === 'month') dateLabel = state.reportMonth;
            if (state.reportDateFilterType === 'custom') dateLabel = `${state.reportStart} to ${state.reportEnd}`;

            return `
            <div class="space-y-6 animate-fade-in">
                 <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">Daily Reports</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Detailed operational breakdown for <span class="font-mono font-bold text-slate-700 dark:text-slate-300">${dateLabel}</span></p>
                    </div>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex bg-slate-100 dark:bg-slate-700/50 p-1 rounded-xl">
                            ${['All', 'TVS', 'INT', 'Empty'].map(filter => `
                                <button onclick="state.reportFilter='${filter}'; render()" 
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${state.reportFilter === filter ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}">
                                    ${filter}
                                </button>
                            `).join('')}
                        </div>

                         <!-- Date Filters -->
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <select onchange="state.reportDateFilterType=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs font-bold text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0 cursor-pointer">
                                <option value="day" ${state.reportDateFilterType === 'day' ? 'selected' : ''}>Day View</option>
                                <option value="month" ${state.reportDateFilterType === 'month' ? 'selected' : ''}>Month View</option>
                                <option value="custom" ${state.reportDateFilterType === 'custom' ? 'selected' : ''}>Custom Range</option>
                            </select>
                            
                            <!-- Day Picker -->
                            ${state.reportDateFilterType === 'day' ? `
                                <input type="date" value="${state.reportDate}" onchange="state.reportDate=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                            ` : ''}

                            <!-- Month Picker -->
                             ${state.reportDateFilterType === 'month' ? `
                                <input type="month" value="${state.reportMonth}" onchange="state.reportMonth=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                            ` : ''}

                            <!-- Custom Range -->
                            ${state.reportDateFilterType === 'custom' ? `
                                <div class="flex items-center gap-1">
                                    <input type="date" value="${state.reportStart}" onchange="state.reportStart=this.value; render()" class="w-32 bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                                    <span class="text-slate-400">-</span>
                                    <input type="date" value="${state.reportEnd}" onchange="state.reportEnd=this.value; render()" class="w-32 bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0">
                                </div>
                            ` : ''}
                        </div>

                        <!-- Driver & Truck Filters -->
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <select onchange="state.reportTruckFilter=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0 w-32 truncate">
                                <option value="All">All Trucks</option>
                                ${getFilteredData(state.vehicles).map(v => `<option value="${v.vehicleNumber || v.number}" ${state.reportTruckFilter === (v.vehicleNumber || v.number) ? 'selected' : ''}>${v.vehicleNumber || v.number}</option>`).join('')}
                            </select>

                            <select onchange="state.reportDriverFilter=this.value; render()" class="bg-slate-50 dark:bg-slate-700 border-none text-xs text-slate-700 dark:text-slate-300 rounded-lg p-2 focus:ring-0 w-32 truncate">
                                <option value="All">All Drivers</option>
                                ${getFilteredData(state.drivers).map(d => `<option value="${d.name}" ${state.reportDriverFilter === d.name ? 'selected' : ''}>${d.name}</option>`).join('')}
                            </select>
                        </div>

                        <button onclick="window.exportToExcel()" class="px-3 py-2 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded-xl font-bold transition-all active:scale-95 flex items-center gap-2 text-xs border border-emerald-200">
                             <i class="ph-bold ph-microsoft-excel-logo text-lg"></i> Export Excel
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-100 dark:border-blue-800/30 flex flex-col justify-between h-24">
                        <div class="flex justify-between items-start">
                             <span class="text-[10px] font-bold uppercase text-blue-500 dark:text-blue-400 tracking-wider">TVS Trips</span>
                             <i class="ph-fill ph-steering-wheel text-blue-400 dark:text-blue-300 text-lg"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white">${counts['TVS']}</p>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-2xl border border-purple-100 dark:border-purple-800/30 flex flex-col justify-between h-24">
                        <div class="flex justify-between items-start">
                             <span class="text-[10px] font-bold uppercase text-purple-500 dark:text-purple-400 tracking-wider">INT Trips</span>
                             <i class="ph-fill ph-circles-three-plus text-purple-400 dark:text-purple-300 text-lg"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white">${counts['INT']}</p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24">
                        <div class="flex justify-between items-start">
                             <span class="text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 tracking-wider">Empty</span>
                             <i class="ph-fill ph-arrow-u-down-left text-slate-400 text-lg"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white">${counts['Empty']}</p>
                    </div>
                     <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 flex flex-col justify-between h-24">
                        <div class="flex justify-between items-start">
                             <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Total</span>
                             <i class="ph-fill ph-sigma text-slate-300 text-lg"></i>
                        </div>
                        <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${counts['All']}</p>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Truck</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Date</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Driver</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Vehicle No</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Route</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Distance</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Duration</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-center">Type</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            ${rows || '<tr><td colspan="9" class="p-8 text-center text-slate-400">No completed trips found for this filter.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>`;
        };



        const renderLocations = () => {
            const locations = getFilteredData(state.locations);

            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            return `
            <div class="h-full flex flex-col space-y-6">
                <!-- Header Section with Gradient -->
                <div class="relative overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 p-6 md:p-8">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-50 dark:bg-indigo-900/20 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                    <div class="relative flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2 flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center shadow-lg shadow-indigo-500/30">
                                    <i class="ph-fill ph-map-pin text-xl"></i>
                                </div>
                                Locations
                            </h2>
                            <p class="text-slate-500 dark:text-slate-400 font-medium">Manage pickup points for <span class="text-indigo-600 dark:text-indigo-400 font-bold">${displayBranch}</span></p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="window.seedDatabase('locations')" class="px-4 py-2.5 bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-600 rounded-xl text-sm font-bold transition-all hover:bg-slate-50 dark:hover:bg-slate-600 active:scale-95 flex items-center gap-2 shadow-sm">
                                <i class="ph-bold ph-cloud-arrow-up text-lg"></i> Sync Data
                            </button>
                            <button onclick="openLocationModal()" class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center gap-2">
                                <i class="ph-bold ph-plus text-lg"></i> Add Location
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Locations Table Card -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-200 dark:border-slate-700 overflow-hidden flex-1 flex flex-col">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/50 dark:bg-slate-700/30 border-b border-slate-100 dark:border-slate-700">
                                    <th class="p-5 pl-8 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Location Details</th>
                                    <th class="p-5 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Branch</th>
                                    <th class="p-5 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</th>
                                    <th class="p-5 pr-8 text-right text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${locations.length === 0 ? `
                                    <tr>
                                        <td colspan="4" class="p-12 text-center">
                                            <div class="flex flex-col items-center justify-center opacity-50">
                                                <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mb-4">
                                                    <i class="ph-duotone ph-map-pin text-3xl text-slate-400"></i>
                                                </div>
                                                <p class="text-slate-500 dark:text-slate-400 font-medium">No locations found</p>
                                                <button onclick="openLocationModal()" class="mt-4 text-indigo-600 font-bold hover:underline">Add your first location</button>
                                            </div>
                                        </td>
                                    </tr>` :
                    locations.map(l => `
                                    <tr class="group hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                        <td class="p-5 pl-8">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-12 rounded-2xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition-transform duration-300">
                                                    <i class="ph-fill ph-map-pin"></i>
                                                </div>
                                                <div>
                                                    <h3 class="font-bold text-slate-800 dark:text-white text-base">${l.name}</h3>
                                                    <p class="text-xs text-slate-400 dark:text-slate-500 font-mono mt-0.5">ID: ${l.id}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="p-5">
                                            <div class="flex flex-wrap gap-1.5">
                                                ${(l.branches && l.branches.length > 0 ? l.branches : [l.branch || 'All']).map(b => `
                                                <div class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50">
                                                    <i class="ph-bold ph-buildings text-slate-400 text-xs shadow-none"></i>
                                                    <span class="text-xs font-bold text-slate-600 dark:text-slate-300">${b}</span>
                                                </div>
                                                `).join('')}
                                            </div>
                                        </td>
                                        <td class="p-5">
                                            <div class="inline-flex items-center gap-2">
                                                <span class="relative flex h-2.5 w-2.5">
                                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full ${l.status === 'Inactive' ? 'bg-slate-400' : 'bg-green-400'} opacity-75"></span>
                                                  <span class="relative inline-flex rounded-full h-2.5 w-2.5 ${l.status === 'Inactive' ? 'bg-slate-500' : 'bg-green-500'}"></span>
                                                </span>
                                                <span class="text-sm font-bold ${l.status === 'Inactive' ? 'text-slate-500' : 'text-green-600 dark:text-green-400'}">
                                                    ${l.status || 'Active'}
                                                </span>
                                            </div>
                                        </td>
                                        <td class="p-5 pr-8 text-right">
                                            <div class="flex items-center justify-end gap-2">
                                                <button onclick="openLocationModal('${l.id}')" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/50 rounded-xl transition-all" title="Edit">
                                                    <i class="ph-bold ph-pencil-simple text-lg"></i>
                                                </button>
                                                <button onclick="deleteLocation('${l.id}')" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 rounded-xl transition-all" title="Delete">
                                                    <i class="ph-bold ph-trash text-lg"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        const renderLocationModal = () => {
            if (state.modal !== 'location') return '';
            const l = state.editLocation || {};
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">${l.id ? 'Edit Location' : 'Add New Location'}</h2>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <form onsubmit="saveLocation(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Location Name</label>
                            <input type="text" name="name" value="${l.name || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required placeholder="e.g. Coimbatore, Tiruppur">
                        </div>
                        <div>

                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-2">Branches</label>
                            <div class="grid grid-cols-2 gap-3">
                                ${['Coimbatore', 'Trichy', 'Salem', 'Kumbakonam', 'All'].map(b => {
                const isChecked = l.branches ? l.branches.includes(b) : (l.branch === b || (!l.branch && b === 'All'));
                return `
                                    <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer transition-colors ${isChecked ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800' : ''}">
                                        <input type="checkbox" name="branches" value="${b}" ${isChecked ? 'checked' : ''} class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-bold text-slate-700 dark:text-slate-200">${b}</span>
                                    </label>
                                    `;
            }).join('')}
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 italic">Select 'All' to make this location available to everyone, or select specific branches.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Status</label>
                            <select name="status" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                                <option value="Active" ${l.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${l.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/30">
                            ${l.id ? 'Save Changes' : 'Add Location'}
                        </button>
                    </form>
                </div>
            </div > `;
        };

        const renderDriverModal = () => {
            if (state.modal !== 'driver') return '';
            const d = state.editDriver || {};
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">${d.id ? 'Edit Driver' : 'Add New Driver'}</h2>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <form onsubmit="saveDriver(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Full Name</label>
                            <input type="text" name="name" value="${d.name || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Phone Number</label>
                            <input type="tel" name="phone" value="${d.phone || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-400 mb-1">License Number</label>
                                <input type="text" name="licenseNumber" value="${d.licenseNumber || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-400 mb-1">License Expiry</label>
                                <input type="date" name="licenseExpiry" value="${d.licenseExpiry || ''}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Branch</label>
                            <select name="branch" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" ${state.user.role !== 'superadmin' ? 'disabled' : ''}>
                                <option value="Coimbatore" ${d.branch === 'Coimbatore' || (!d.branch && state.user.branch === 'Coimbatore') ? 'selected' : ''}>Coimbatore</option>
                                <option value="Trichy" ${d.branch === 'Trichy' || (state.user.branch === 'Trichy') ? 'selected' : ''}>Trichy</option>
                                <option value="Salem" ${d.branch === 'Salem' || (state.user.branch === 'Salem') ? 'selected' : ''}>Salem</option>
                                <option value="Kumbakonam" ${d.branch === 'Kumbakonam' || (state.user.branch === 'Kumbakonam') ? 'selected' : ''}>Kumbakonam</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Status</label>
                            <select name="status" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                                <option value="Active" ${d.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${d.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/30">
                            ${d.id ? 'Save Changes' : 'Add Driver'}
                        </button>
                    </form>
                </div>
            </div > `;
        }

        const renderVehicleModal = () => {
            if (state.modal !== 'vehicle') return '';
            const v = state.editVehicle || {};
            return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">${v.id ? 'Edit Vehicle' : 'Add New Vehicle'}</h2>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <form onsubmit="saveVehicle(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Vehicle Number</label>
                            <input type="text" name="vehicleNumber" value="${v.vehicleNumber || v.number || ''}" placeholder="TN 38 DJ 1234" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white font-mono uppercase" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Make</label>
                                <input type="text" name="make" value="${v.make || ''}" placeholder="e.g. Tata" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Model</label>
                                <input type="text" name="model" value="${v.model || ''}" placeholder="e.g. 1109" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Branch</label>
                            <select name="branch" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" ${state.user.role !== 'superadmin' ? 'disabled' : ''}>
                                <option value="Coimbatore" ${v.branch === 'Coimbatore' || (!v.branch && state.user.branch === 'Coimbatore') ? 'selected' : ''}>Coimbatore</option>
                                <option value="Trichy" ${v.branch === 'Trichy' || (state.user.branch === 'Trichy') ? 'selected' : ''}>Trichy</option>
                                <option value="Salem" ${v.branch === 'Salem' || (state.user.branch === 'Salem') ? 'selected' : ''}>Salem</option>
                                <option value="Kumbakonam" ${v.branch === 'Kumbakonam' || (state.user.branch === 'Kumbakonam') ? 'selected' : ''}>Kumbakonam</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Current Odometer</label>
                            <input type="number" name="odometer" value="${v.odometer || ''}" placeholder="e.g. 50000" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Type</label>
                            <select name="type" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                                <option value="Truck" ${v.type === 'Truck' ? 'selected' : ''}>Truck</option>
                                <option value="Van" ${v.type === 'Van' ? 'selected' : ''}>Van</option>
                                <option value="Car" ${v.type === 'Car' ? 'selected' : ''}>Car</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Status</label>
                            <select name="status" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                                <option value="Active" ${v.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Maintenance" ${v.status === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                                <option value="Inactive" ${v.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/30">
                            ${v.id ? 'Save Changes' : 'Add Vehicle'}
                        </button>
                    </form>
                </div>
            </div > `;
        }



        const renderDrivers = () => {
            const drivers = getFilteredData(state.drivers);
            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-white">Driver Management</h2>
                     <div class="flex gap-2">
                        <button onclick="window.seedDatabase('drivers')" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-300 rounded-xl text-sm font-bold transition-colors flex items-center gap-2">
                            <i class="ph-bold ph-cloud-arrow-up"></i> Sync Data
                        </button>
                        <button onclick="openDriverModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold transition-colors flex items-center gap-2 shadow-lg shadow-indigo-500/30">
                            <i class="ph-bold ph-plus"></i> Add Driver
                        </button>
                     </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Name</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Phone</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">License Exp</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700">Status</th>
                                <th class="p-4 border-b border-slate-100 dark:border-slate-700 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            ${drivers.map(d => `
                                <tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group">
                                    <td class="p-4 font-bold text-slate-700 dark:text-slate-300 flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-600 flex items-center justify-center text-xs text-slate-500 dark:text-slate-300">${d.name.slice(0, 2)}</div>
                                        ${d.name}
                                    </td>
                                    <td class="p-4 text-slate-600 dark:text-slate-400 font-mono">${d.phone}</td>
                                    <td class="p-4 text-slate-600 dark:text-slate-400">${d.licenseExpiry || 'N/A'}</td>
                                    <td class="p-4">
                                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${d.status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}">${d.status || 'Active'}</span>
                                    </td>
                                    <td class="p-4 text-right">
                                        <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onclick="openDriverModal('${d.id}')" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                                <i class="ph-bold ph-pencil-simple"></i>
                                            </button>
                                            <button onclick="deleteDriver('${d.id}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete Driver">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                            <button onclick="resetDriverTrips('${d.id}')" class="p-2 text-slate-400 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors" title="Reset Driver Trips">
                                                <i class="ph-bold ph-clock-counter-clockwise"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        };

        const renderVehicles = () => {
            const vehicles = getFilteredData(state.vehicles);

            return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Vehicle Management</h2>
                     <div class="flex gap-2">
                        <button onclick="window.seedDatabase('models')" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-300 rounded-xl text-sm font-bold transition-colors flex items-center gap-2">
                            <i class="ph-bold ph-car"></i> Sync Models
                        </button>
                        <button onclick="window.seedDatabase('vehicles')" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-300 rounded-xl text-sm font-bold transition-colors flex items-center gap-2">
                           <i class="ph-bold ph-cloud-arrow-up"></i> Sync Vehicles
                        </button>
                        <button onclick="openVehicleModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold transition-colors flex items-center gap-2 shadow-lg shadow-indigo-500/30">
                            <i class="ph-bold ph-plus"></i> Add Vehicle
                        </button>
                     </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${vehicles.map(v => `
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition-all group relative">
                            <div class="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openVehicleModal('${v.id}')" class="p-2 bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-indigo-600 rounded-lg"><i class="ph-bold ph-pencil-simple"></i></button>
                                <button onclick="deleteVehicle('${v.id}')" class="p-2 bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-600 rounded-lg"><i class="ph-bold ph-trash"></i></button>
                            </div>
                            <div class="flex justify-between items-start mb-6">
                                <div class="w-12 h-12 rounded-xl bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                                    <i class="ph-fill ph-truck text-2xl"></i>
                                </div>
                                <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-[10px] font-bold uppercase rounded">${v.status || 'Active'}</span>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1 font-mono">${v.vehicleNumber || v.number || v.id}</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">${v.make || 'Truck'} ${v.model || ''}</p>
                            
                            <div class="pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase">Odometer</p>
                                    <p class="text-sm font-medium text-slate-600 dark:text-slate-300">${v.odometer || 'N/A'} km</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-bold text-slate-400 uppercase">Last Service</p>
                                    <p class="text-sm font-medium text-slate-600 dark:text-slate-300">N/A</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        };



        // --- Trip Editing ---
        window.openEditTripModal = (tripId) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip) return;
            state.editTrip = { ...trip };
            state.modal = 'editTrip';
            render();
        };

        window.saveTrip = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tripData = Object.fromEntries(formData.entries());
            const tripId = state.editTrip.id;

            // Basic validation
            if (tripData.endOdo && parseInt(tripData.endOdo) <= parseInt(tripData.startOdo)) {
                return showToast('End Odometer must be greater than Start Odometer', 'error');
            }

            // Data Sanitization based on Category
            if (tripData.tripCategory === 'Empty') {
                tripData.vehicleModel = '';
                tripData.vehicleNumber = ''; // Manual vehicle no
                tripData.customerName = '';
                tripData.referrer = '';
                tripData.tripType = 'Empty';
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), {
                    ...tripData,
                    updatedAt: serverTimestamp()
                });
                showToast('Trip updated successfully', 'success');
                state.modal = null;
                render();
            } catch (error) {
                console.error("Error updating trip:", error);
                showToast('Failed to update trip: ' + error.message, 'error');
            }
        };

        // --- Trip Approval Workflow ---
        window.openReviewTripModal = (tripId) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip || !trip.pendingChanges) return;
            state.reviewTrip = { ...trip };
            state.modal = 'reviewTrip';
            render();
        };

        window.approveTripChange = async (tripId) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip || !trip.pendingChanges) return;
            const changes = trip.pendingChanges;

            try {
                // Apply changes and clear pending flag
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), {
                    ...changes,
                    hasPendingChanges: false,
                    pendingChanges: deleteField(),
                    lastApprovedBy: state.user.name,
                    lastApprovedAt: serverTimestamp()
                });
                showToast('Changes approved and applied', 'success');
                state.modal = null;
                render();
            } catch (error) {
                console.error("Error approving trip:", error);
                showToast('Error approving changes', 'error');
            }
        };

        window.rejectTripChange = async (tripId) => {
            try {
                // Clear pending flag without applying changes
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), {
                    hasPendingChanges: false,
                    pendingChanges: deleteField(),
                    lastRejectedBy: state.user.name,
                    lastRejectedAt: serverTimestamp()
                });
                showToast('Changes rejected', 'info');
                state.modal = null;
                render();
            } catch (error) {
                console.error("Error rejecting trip:", error);
                showToast('Error rejecting changes', 'error');
            }
        };

        const renderReviewTripModal = () => {
            if (state.modal !== 'reviewTrip') return '';
            const t = state.reviewTrip || {};
            const p = t.pendingChanges || {};

            // Helper to show diff
            const diffRow = (label, oldVal, newVal) => {
                // If newVal is undefined/null, it means no change requested for this field, so don't show unless we want to show everything
                // Usually pendingChanges only contains changed fields + metadata.
                // But for "Review", we usually want to see what IS changing.
                if (newVal === undefined || newVal === null) return '';

                const isChanged = oldVal != newVal; // loose equality
                // If not changed and not explicitly in pendingChanges (which it is if we are here), skip?
                // Actually pendingChanges usually contains the whole form from Driver App?
                // Driver App: `state.editTrip = { ...trip };` -> user modifies -> `saveTripEdit` sends `...tripData`.
                // `tripData` comes from `new FormData`. So it contains ALL fields in the form.
                // So pendingChanges contains fields that might NOT have changed.

                if (!isChanged) return ''; // Only show actual changes

                return `
                 <div class="grid grid-cols-3 gap-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg mb-2">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">${label}</span>
                    <span class="text-sm font-mono text-slate-600 dark:text-slate-400 break-all">${oldVal || '-'}</span>
                    <span class="text-sm font-mono font-bold text-slate-800 dark:text-white break-all flex items-center gap-2">
                        ${newVal || '-'}
                        <i class="ph-bold ph-arrow-left text-amber-500"></i>
                    </span>
                 </div>`;
            };

            return `
             <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                 <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                     <div class="p-6 border-b border-slate-100 dark:border-slate-700 bg-amber-50 dark:bg-amber-900/20 flex justify-between items-center flex-shrink-0">
                         <div>
                            <h2 class="text-xl font-bold text-amber-800 dark:text-amber-400 flex items-center gap-2"><i class="ph-fill ph-warning-circle"></i> Review Changes</h2>
                            <p class="text-xs text-amber-600 dark:text-amber-500">Requested by ${p.requestedBy || 'Driver'}</p>
                         </div>
                         <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white/50 hover:bg-white text-slate-500 hover:text-red-500 flex items-center justify-center transition-all"><i class="ph-bold ph-x"></i></button>
                     </div>
                     <div class="p-6 overflow-y-auto">
                        <div class="grid grid-cols-3 gap-4 mb-2 px-3">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Field</span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Current</span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Proposed</span>
                        </div>
                        
                        ${diffRow('Start Odo', t.startOdo, p.startOdo)}
                        ${diffRow('End Odo', t.endOdo, p.endOdo)}
                        ${diffRow('Date', t.date, p.date)}
                        ${diffRow('Pickup', t.pickupLocation, p.pickupLocation)}
                        ${diffRow('Drop', t.dropLocation, p.dropLocation)}
                        ${diffRow('Vehicle', t.truckNumber, p.truckNumber)}
                        ${diffRow('Driver', t.driverName, p.driverName)}
                        ${diffRow('Category', t.tripCategory, p.tripCategory)}
                        ${diffRow('Type', t.tripType, p.tripType)}
                        ${diffRow('Model', t.vehicleModel, p.vehicleModel)}
                        ${diffRow('Manual Veh.', t.vehicleNumber, p.vehicleNumber)}
                        ${diffRow('Customer', t.customerName, p.customerName)}
                        
                        ${!Object.keys(p).some(key => ['startOdo', 'endOdo', 'date', 'pickupLocation', 'dropLocation', 'truckNumber', 'driverName', 'tripCategory', 'tripType', 'vehicleModel', 'vehicleNumber', 'customerName'].includes(key) && p[key] != t[key]) ? '<p class="text-center text-slate-500 italic py-4">No significant changes detected.</p>' : ''}

                     </div>
                     <div class="p-6 border-t border-slate-100 dark:border-slate-700 flex gap-3 bg-slate-50 dark:bg-slate-800/50 flex-shrink-0">
                         <button onclick="rejectTripChange('${t.id}')" class="flex-1 py-3 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 font-bold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors shadow-sm text-sm">
                             Reject Changes
                         </button>
                         <button onclick="approveTripChange('${t.id}')" class="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-colors shadow-lg shadow-green-500/30 text-sm flex items-center justify-center gap-2">
                             <i class="ph-bold ph-check"></i> Approve & Apply
                         </button>
                     </div>
                 </div>
             </div > `;
        };

        const renderEditTripModal = () => {
            if (state.modal !== 'editTrip') return '';
            const t = state.editTrip || {};

            // Determine available types based on category
            const cat = t.tripCategory || 'New';
            let typeOptions = [];
            if (cat === 'New') typeOptions = CATEGORIES.NEW;
            else if (cat === 'Break Down') typeOptions = CATEGORIES.BREAKDOWN;

            // Helper to update local state logic without full render (or we rely on render)
            // We'll use onchange="state.editTrip[field] = value; render()" pattern for fields that affect others

            return `
             <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm scale-in">
                 <div class="bg-white dark:bg-slate-800 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
                     <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50">
                         <div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Edit Trip Details</h2>
                            <p class="text-xs text-slate-500 font-mono">ID: ${t.id}</p>
                         </div>
                         <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-red-500 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
                     </div>
                     
                     <form onsubmit="saveTrip(event)" class="flex-1 overflow-y-auto p-6 space-y-5">
                        <!-- Primary Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Vehicle (Truck)</label>
                                 <select name="truckNumber" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                                     <option value="" disabled>Select Truck</option>
                                     ${state.vehicles.map(v => `<option value="${v.vehicleNumber || v.number}" ${t.truckNumber === (v.vehicleNumber || v.number) ? 'selected' : ''}>${v.vehicleNumber || v.number}</option>`).join('')}
                                     ${!state.vehicles.find(v => (v.vehicleNumber || v.number) === t.truckNumber) && t.truckNumber ? `<option value="${t.truckNumber}" selected>${t.truckNumber} (Current)</option>` : ''}
                                 </select>
                             </div>
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Driver</label>
                                 <select name="driverName" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                                    <option value="" disabled>Select Driver</option>
                                    ${state.drivers.map(d => `<option value="${d.name}" ${t.driverName === d.name ? 'selected' : ''}>${d.name}</option>`).join('')}
                                    ${!state.drivers.find(d => d.name === t.driverName) && t.driverName ? `<option value="${t.driverName}" selected>${t.driverName} (Current)</option>` : ''}
                                 </select>
                             </div>
                        </div>

                        <!-- Trip Metadata -->
                        <div class="p-4 bg-slate-50 dark:bg-slate-900/30 rounded-xl border border-slate-100 dark:border-slate-700 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Category</label>
                                    <select name="tripCategory" onchange="state.editTrip.tripCategory=this.value; state.editTrip.tripType=''; render()" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm">
                                        <option value="New" ${cat === 'New' ? 'selected' : ''}>New</option>
                                        <option value="Break Down" ${cat === 'Break Down' ? 'selected' : ''}>Break Down</option>
                                        <option value="Empty" ${cat === 'Empty' ? 'selected' : ''}>Empty</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Type</label>
                                    ${cat === 'Empty' ?
                    `<input type="text" name="tripType" value="Empty" readonly class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 text-slate-500 border border-slate-200 dark:border-slate-600 rounded-lg text-sm">`
                    :
                    `<select name="tripType" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm" required>
                                            <option value="" disabled ${!t.tripType ? 'selected' : ''}>Select Type</option>
                                            ${typeOptions.map(type => `<option value="${type}" ${t.tripType === type ? 'selected' : ''}>${type}</option>`).join('')}
                                        </select>`
                }
                                </div>
                            </div>

                             ${cat !== 'Empty' ? `
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Model</label>
                                    <select name="vehicleModel" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm">
                                        <option value="">Select Model</option>
                                        ${(state.models && state.models.length ? state.models.map(m => m.name) : SOURCE_MODELS).map(m => `<option value="${m}" ${t.vehicleModel === m ? 'selected' : ''}>${m}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Vehicle No (Manual)</label>
                                    <input type="text" name="vehicleNumber" value="${t.vehicleNumber || ''}" placeholder="ABC-1234" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm uppercase">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Customer Name</label>
                                    <input type="text" name="customerName" value="${t.customerName || ''}" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Referred By</label>
                                    <input type="text" name="referrer" value="${t.referrer || ''}" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white text-sm">
                                </div>
                            </div>
                            ` : ''}
                        </div>

                         <!-- Odometer & Date -->
                         <div class="grid grid-cols-3 gap-4">
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Date</label>
                                 <input type="date" name="date" value="${t.date}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                             </div>
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Start Odo</label>
                                 <input type="number" name="startOdo" value="${t.startOdo}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white" required>
                             </div>
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">End Odo</label>
                                 <input type="number" name="endOdo" value="${t.endOdo}" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white">
                             </div>
                         </div>

                         <!-- Locations -->
                         <div class="grid grid-cols-2 gap-4">
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Pickup</label>
                                 <div class="relative">
                                    <select name="pickupLocation" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white appearance-none" required>
                                        <option value="" disabled>Select Pickup</option>
                                        ${state.locations.map(l => `<option value="${l.name}" ${t.pickupLocation === l.name ? 'selected' : ''}>${l.name}</option>`).join('')}
                                        ${!state.locations.find(l => l.name === t.pickupLocation) && t.pickupLocation ? `<option value="${t.pickupLocation}" selected>${t.pickupLocation} (Current)</option>` : ''}
                                    </select>
                                    <i class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                 </div>
                             </div>
                             <div>
                                 <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Drop</label>
                                 <div class="relative">
                                     <select name="dropLocation" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white appearance-none" required>
                                         <option value="" disabled>Select Drop</option>
                                         ${state.locations.map(l => `<option value="${l.name}" ${t.dropLocation === l.name ? 'selected' : ''}>${l.name}</option>`).join('')}
                                         ${!state.locations.find(l => l.name === t.dropLocation) && t.dropLocation ? `<option value="${t.dropLocation}" selected>${t.dropLocation} (Current)</option>` : ''}
                                     </select>
                                     <i class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                 </div>
                             </div>
                         </div>

                         <div class="pt-2">
                             <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/30 ring-offset-2 focus:ring-2 focus:ring-indigo-500">
                                 <i class="ph-bold ph-floppy-disk mr-2"></i> Save Changes
                             </button>
                         </div>
                     </form>
                 </div>
             </div > `;
        };

        window.render = () => {
            if (!state.user) { appDiv.innerHTML = renderLogin(); return; }

            const tabRenderers = {
                'ops': renderOps,
                'drivers': renderDrivers,
                'vehicles': renderVehicles,
                'locations': renderLocations,
                'hr': renderHR,
                'perf': renderPerf,
                'reports': renderReports
            };
            const content = (tabRenderers[state.adminTab] || renderOps)();

            const branchLabel = state.selectedBranch || state.user?.branch || 'All';
            const displayBranch = branchLabel === 'All' ? 'All Branches' : branchLabel;

            const tabs = [
                { id: 'ops', icon: 'ph-wifi-high', label: 'Live Operations' },
                { id: 'drivers', icon: 'ph-steering-wheel', label: 'Driver Management' },
                { id: 'vehicles', icon: 'ph-truck', label: 'Vehicle Management' },
                { id: 'locations', icon: 'ph-map-pin', label: 'Locations' },
                { id: 'hr', icon: 'ph-users', label: 'HR & Reports' },
                { id: 'reports', icon: 'ph-chart-line-up', label: 'Daily Reports' },
                { id: 'perf', icon: 'ph-chart-bar', label: 'Performance' }
            ];

            const activeTabLabel = tabs.find(t => t.id === state.adminTab)?.label;

            appDiv.innerHTML = `
                <div class="flex h-screen bg-slate-50 dark:bg-slate-900 overflow-hidden">
                    <!-- Sidebar (Desktop) -->
                    <aside class="hidden md:flex flex-col w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 h-full relative z-20">
                        <div class="p-6">
                            <div class="flex items-center gap-3 mb-8">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg" style="background: var(--gradient-primary);">
                                    <i class="ph-fill ph-steering-wheel text-2xl text-white"></i>
                                </div>
                                <div>
                                    <h1 class="font-bold text-lg text-slate-800 dark:text-white leading-tight">Admin Portal</h1>
                                    <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold tracking-wider uppercase">AMS Towing</p>
                                </div>
                            </div>

                            <nav class="space-y-2">
                                ${tabs.map(t => `
                                    <button onclick="state.adminTab='${t.id}'; render()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all group ${state.adminTab === t.id ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 shadow-sm border border-indigo-100 dark:border-indigo-900/50' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50 hover:text-slate-900 dark:hover:text-slate-200'}">
                                        <i class="ph-bold ${t.icon} text-xl ${state.adminTab === t.id ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400 group-hover:text-slate-600 dark:text-slate-500 dark:group-hover:text-slate-300'}"></i> 
                                        ${t.label}
                                    </button>
                                `).join('')}
                            </nav>
                        </div>
                        
                        ${state.user.role === 'superadmin' ? `
                        <div class="px-6 pb-2">
                             <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700">
                                <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Filter Branch</label>
                                <select onchange="state.selectedBranch = this.value; render()" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-xs font-bold rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="All" ${state.selectedBranch === 'All' ? 'selected' : ''}>All Branches</option>
                                    <option value="Coimbatore" ${state.selectedBranch === 'Coimbatore' ? 'selected' : ''}>Coimbatore</option>
                                    <option value="Trichy" ${state.selectedBranch === 'Trichy' ? 'selected' : ''}>Trichy</option>
                                    <option value="Salem" ${state.selectedBranch === 'Salem' ? 'selected' : ''}>Salem</option>
                                    <option value="Kumbakonam" ${state.selectedBranch === 'Kumbakonam' ? 'selected' : ''}>Kumbakonam</option>
                                </select>
                            </div>
                        </div>
                        ` : ''}

                        <div class="mt-auto p-4 border-t border-slate-200 dark:border-slate-700">
                            <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-4 flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-700 dark:text-indigo-300 font-bold">
                                    ${state.user.id.slice(0, 2)}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold text-slate-900 dark:text-white truncate">Administrator</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 truncate">ID: ${state.user.id}</p>
                                </div>
                                <button onclick="handleLogout()" class="text-slate-400 hover:text-rose-500 transition-colors"><i class="ph-bold ph-sign-out text-xl"></i></button>
                            </div>
                        </div>
                    </aside>

                    <!-- Main Area -->
            <div class="flex-1 flex flex-col h-full overflow-hidden relative">
                <!-- Top Header (Desktop & Mobile) -->
                <header class="flex-shrink-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 h-16 flex items-center justify-between px-4 md:px-8 z-10">
                    <div class="md:hidden flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-md bg-indigo-600 text-white"><i class="ph-fill ph-steering-wheel"></i></div>
                        <span class="font-bold text-slate-800 dark:text-white">AMS Admin</span>
                    </div>

                    <h2 class="hidden md:block text-xl font-bold text-slate-800 dark:text-white">${activeTabLabel} - ${displayBranch}</h2>

                    <div class="flex items-center gap-3">
                        <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl flex items-center justify-center transition-all bg-slate-100 dark:bg-slate-700/50 text-slate-600 dark:text-yellow-400 hover:scale-105 active:scale-95 shadow-sm border border-slate-200 dark:border-slate-600">
                            <i class="${state.darkMode ? 'ph-fill ph-moon' : 'ph-fill ph-sun'} text-xl"></i>
                        </button>
                        <button onclick="handleLogout()" class="md:hidden w-10 h-10 rounded-xl flex items-center justify-center bg-rose-50 text-rose-600"><i class="ph-bold ph-sign-out text-xl"></i></button>
                    </div>
                </header>

                <!-- Mobile Navigation -->
                <div class="md:hidden overflow-x-auto bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 p-2 flex gap-2 no-scrollbar">
                    ${tabs.map(t => `
                                <button onclick="state.adminTab='${t.id}'; render()" class="flex-shrink-0 flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${state.adminTab === t.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400'}">
                                    <i class="ph-bold ${t.icon}"></i> ${t.label}
                                </button>
                            `).join('')}
                </div>

                <!-- Content Scroll Area -->
                <div class="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-8 scroll-smooth">
                    <div class="max-w-7xl mx-auto animate-fade-in pb-10">
                        ${content}
                    </div>
                </div>
            </div>
                </div>
            ${renderReportModal()}
                ${renderDriverModal()}
                ${renderVehicleModal()}
                ${renderLocationModal()}
                ${renderEditTripModal()}
                ${renderReviewTripModal()}
            `;
        };

        initAuth();
    </script>
</body>

</html>